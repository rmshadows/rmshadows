<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  

  <!-- Baidu Tongji -->
  

  <!-- Baidu Push -->
  

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc" />
  <meta name="baidu-site-verification" content="PpzM9WxOJU" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="This is CIVICCCCC&#39;s blog..." />
  <meta name="keyword" content="rmshadows,civiccccc,blog,Blog" />
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg" />

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>
  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/beantech.min.css" />

  <!-- Pygments Highlight CSS -->
  
<link rel="stylesheet" href="../../css/highlight.css">
<link rel="stylesheet" href="../../css/widget.css">
<link rel="stylesheet" href="../../css/rocket.css">
<link rel="stylesheet" href="../../css/signature.css">
<link rel="stylesheet" href="../../css/catalog.css">
<link rel="stylesheet" href="../../css/livemylife.css">


  
  <!-- wave start -->
  <link rel="stylesheet" href="/css/wave.css" />
  <!-- wave end -->
  

  
  <!-- top start (article top hot config) -->
  <link rel="stylesheet" href="/css/top.css" />
  <!-- top end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/scroll.css" />
  <!-- ThemeColor end -->
  

  
  <!-- viewer start (Picture preview) -->
  <link rel="stylesheet" href="/css/viewer.min.css" />
  <!-- viewer end -->
  

  
  <!-- Search start -->
  <link rel="stylesheet" href="/css/search.css" />
  <!-- Search end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/themecolor.css" />
  <!-- ThemeColor end -->
  

  

  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
    href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://rmshadows.gitee.io/2024/Shorewall-Firewall/">
  <title>
    
    Shorewall Firewall - RYAN | be yourself
    
  </title>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="atom.xml" title="Hello ~(○｀ 3′○)~ I'm Ryan Yim" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->

<body ontouchstart="" class="body--home">
    <!-- ThemeColor -->
    
    <!-- ThemeColor -->
<!-- <div class="toggle" onclick="document.body.classList.toggle('body--dark')">Switch Color</div> -->

<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons bright-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>

    

    <!-- Navigation (contains search)-->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Hello ~(○｀ 3′○)~ I&#39;m Ryan Yim</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">Home</a>
          </li>

          

          
          

          
          <li>
            <a href="/about/">About</a>
          </li>
          
          

          
          <li>
            <a href="/archive/">Archives</a>
          </li>
          
          

          
          <li>
            <a href="/categories/">Categories</a>
          </li>
          
          

          
          <li>
            <a href="/tags/">Tags</a>
          </li>
          
          

          
          <li><a class="popup-trigger" title="Search"><span class="search-icon"></span>Search</a></li>
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>


<script>
  // Drop Bootstarp low-performance Navbar
  // Use customize navbar with high-quality material design animation
  // in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


    <!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
    <!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    header.intro-header {
       /*post*/
        background-image: url('https://rmshadows.gitee.io//img/header_img/lml_bg.jpg');
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/rmshadows.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#Firewall" title="Firewall">Firewall</a>
              
            </div>
            <h1>Shorewall Firewall</h1>
            <h2 class="subheading">Shorewall防火墙配置</h2>
            <span class="meta">
              Posted by Ryan Yim on
              2024-07-27
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">201</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">51.1k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



    <!-- Main Content (Post contains
    Pager、
    tip、
    socialshare、
    gitalk、gitment、disqus-comment、
    Catalog、
    Sidebar、
    Featured-Tags、
    Friends Blog、
    anchorjs、
    ) -->
    <!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1 id="Shorewall防火墙配置"><a href="#Shorewall防火墙配置" class="headerlink" title="Shorewall防火墙配置"></a>Shorewall防火墙配置</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><code>sudo apt-get install shorewall shorewall6</code></p>
<p>启用Universal配置：</p>
<p><code>sudo cp /usr/share/doc/shorewall/examples/Universal/* /etc/shorewall/</code></p>
<h2 id="包介绍"><a href="#包介绍" class="headerlink" title="包介绍"></a>包介绍</h2><blockquote>
<p>在 Shorewall 版本 4.5.* 中，常用 Shell 库被分离到单独的 Shorewall-core 包中。从 Shorewall 4.5 开始，共有六个包：</p>
</blockquote>
<ul>
<li>Shorewall-core — 安装 Shorewall、Shorewall6、Shorewall-lite 或 Shorewall6-lite 所需。</li>
<li>Shorewall — 与 Shorewall-core 一起，包含创建 IPv4 防火墙所需的一切。</li>
<li>Shorewall6 — 需要 Shorewall 软件包并添加创建 IPv6 防火墙的功能。</li>
<li>Shorewall-lite — 轻量级 Shorewall 版本，将运行在安装了 Shorewall 的系统上生成的编译防火墙脚本。</li>
<li>Shorewall6-lite — 轻量级 Shorewall6 版本，将运行在安装了 Shorewall6 的系统上生成的编译防火墙脚本。</li>
<li>Shorewall-init — 上述任何软件包的附加组件，允许根据接口的启动和关闭更改防火墙状态。在未使用 Upstart 的情况下，还可以将此软件包配置为在启动网络接口之前将防火墙置于安全状态。</li>
</ul>
<p>如果你正在安装 Shorewall 4.4 或更高版本：</p>
<ul>
<li>在网络中的至少一台系统上，你必须安装 Shorewall 软件包。如果你需要 IPv6 防火墙，那么还必须安装 Shorewall6 软件包。</li>
<li>如果你只有一个防火墙，那么那台系统应当是你的防火墙系统。</li>
<li>如果你有多个防火墙，你可能希望在一个单独的管理系统上安装 Shorewall（可能还包括 Shorewall6），并在各防火墙上安装 Shorewall-lite 和/或 Shorewall6-lite。这样做可以实现防火墙的集中管理和配置。</li>
</ul>
<p>手动下载：<a href="https://shorewall.org/pub/shorewall/" target="_blank" rel="noopener">https://shorewall.org/pub/shorewall/</a></p>
<h2 id="须知"><a href="#须知" class="headerlink" title="须知"></a>须知</h2><p><strong>警告</strong>:</p>
<p>不要尝试在远程系统上安装 Shorewall。你肯定会将自己锁在外面。</p>
<p><strong>快速入门指南</strong>：</p>
<p>如果你只是想保护一个系统：（需要 Shorewall 4.4.12-Beta3 或更高版本）</p>
<ul>
<li><a href="https://shorewall.org/Universal.html" target="_blank" rel="noopener">通用配置</a> — 无需配置即可保护单个系统。<ul>
<li>警告：这种配置将所有接口置于网络区域。如果你添加了另一个接口或 VPN，你将需要选择不同的快速入门指南。</li>
</ul>
</li>
</ul>
<p>如果你只有一个公共 IP 地址：</p>
<ul>
<li>带<a href="https://shorewall.org/standalone.htm" target="_blank" rel="noopener">单个网络</a>接口的独立 Linux 系统（如果你运行的是 Shorewall 4.4.12 Beta 3 或更高版本，请改用<a href="https://shorewall.org/Universal.html" target="_blank" rel="noopener">通用配置</a>）。</li>
<li>带<a href="https://shorewall.org/two-interface.htm" target="_blank" rel="noopener">两个接口</a>的 Linux 系统，作为小型本地网络的防火墙/路由器。有关 Redhat 特定的安装/配置信息，请参阅 Digimer 提供的<a href="https://shorewall.org/GettingStarted.html???" target="_blank" rel="noopener">这篇文章</a>。</li>
<li>带<a href="https://shorewall.org/three-interface.htm" target="_blank" rel="noopener">三个接口</a>的 Linux 系统，作为小型本地网络和 DMZ 的防火墙/路由器。</li>
</ul>
<p>如果你有多个公共 IP 地址：</p>
<ul>
<li>Shorewall 设置<a href="https://shorewall.org/shorewall_setup_guide.htm" target="_blank" rel="noopener">指南</a>概述了在涉及多个公共 IP 地址时设置防火墙的必要步骤，或如果你想了解比单地址指南中更多的 Shorewall 信息，请参阅该指南。</li>
</ul>
<p>以下文章也推荐给新手阅读：</p>
<ul>
<li><a href="https://shorewall.org/configuration_file_basics.htm" target="_blank" rel="noopener">配置文件基础</a><ul>
<li><a href="https://shorewall.org/configuration_file_basics.htm#Manpages" target="_blank" rel="noopener">ManPages</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#MAC" target="_blank" rel="noopener">在 Shorewall 中使用 MAC 地址</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#Comments" target="_blank" rel="noopener">在配置文件中添加注释</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#Variables" target="_blank" rel="noopener">使用Shell变量</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#dnsnames" target="_blank" rel="noopener">使用 DNS 名称</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#COMMENT" target="_blank" rel="noopener">将注释附加到 Netfilter 规则</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#Compliment" target="_blank" rel="noopener">补充 IP 地址或子网</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#Continuation" target="_blank" rel="noopener">Line Continuation - 行续</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#INCLUDE" target="_blank" rel="noopener">INCLUDE 指令</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#Ports" target="_blank" rel="noopener">端口号/服务名</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#Levels" target="_blank" rel="noopener">Shorewall 配置（制作测试配置）</a></li>
<li><a href="https://shorewall.org/configuration_file_basics.htm#Ranges" target="_blank" rel="noopener">端口范围</a></li>
</ul>
</li>
<li><a href="https://shorewall.org/starting_and_stopping_shorewall.htm" target="_blank" rel="noopener">操作 Shorewall 和 Shorewall Lite</a> 包含许多有用的操作提示。</li>
<li><a href="http://linuxman.wikispaces.com/PPPPPPS" target="_blank" rel="noopener">PPPPPPPS</a>（即 Paul’s Principles for Practical Provision of Packet Processing with Shorewall）</li>
</ul>
<h2 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h2><h3 id="Universal"><a href="#Universal" class="headerlink" title="Universal"></a>Universal</h3><p><strong>通用配置的功能</strong></p>
<p>通用 Shorewall 配置要求您只需将配置文件复制到 <code>/etc/shorewall</code> 并启动 Shorewall。这种示例配置：</p>
<ul>
<li>允许所有出站流量。</li>
<li>阻止所有入站连接，除非是：<ul>
<li>安全外壳协议（Secure Shell）</li>
<li>Ping</li>
</ul>
</li>
<li>允许转发流量，前提是系统具有多个接口或被设置为在单个接口上进行网络之间的路由。</li>
</ul>
<p>示例配置文件的位置取决于您的发行版和 Shorewall 的安装方式。</p>
<ul>
<li><p>如果您使用 RPM 安装，示例文件将在 Shorewall 文档目录的 <code>Samples/Universal</code> 子目录中。如果您不知道 Shorewall 文档目录的位置，可以使用以下命令找到示例文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~<span class="comment"># rpm -ql shorewall-common | fgrep Universal</span></span><br><span class="line">/usr/share/doc/packages/shorewall/Samples/Universal</span><br><span class="line">/usr/share/doc/packages/shorewall/Samples/Universal/interfaces</span><br><span class="line">/usr/share/doc/packages/shorewall/Samples/Universal/policy</span><br><span class="line">/usr/share/doc/packages/shorewall/Samples/Universal/rules</span><br><span class="line">/usr/share/doc/packages/shorewall/Samples/Universal/zones</span><br><span class="line">~<span class="comment">#</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果您使用 tarball 安装，示例文件位于 tarball 的 <code>Samples/Universal</code> 目录中。</p>
</li>
<li><p>如果您使用 Shorewall 4.x 的 .deb 包安装，示例文件位于 <code>/usr/share/doc/shorewall-common/examples/Universal</code>。您不需要 shorewall-doc 包来访问这些示例文件。</p>
</li>
</ul>
<p>只需将 Universal 目录中的文件复制到 <code>/etc/shorewall</code> 即可。</p>
<p><strong>启用Shorewall</strong></p>
<p><strong>如何启动防火墙</strong></p>
<p>在首次启动 Shorewall 之前，建议先停止现有的防火墙。对于 Redhat/CentOS/Fedora 系统，在根提示符下输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service iptables stop</span><br></pre></td></tr></table></figure>
<p>如果您使用的是 SuSE，使用 Yast 或 Yast2 来停止 SuSEFirewall。</p>
<p>一旦 Shorewall 按您的满意运行后，您应完全禁用现有的防火墙。在 Redhat/CentOS/Fedora 系统上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chkconfig --del iptables</span><br></pre></td></tr></table></figure>
<p>然后在根提示符下输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/shorewall start</span><br></pre></td></tr></table></figure>
<p>这样，Shorewall 将会在重启时自动再次启动。</p>
<p><strong>如何停止防火墙？</strong></p>
<p>在根提示符下输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/shorewall clear</span><br></pre></td></tr></table></figure>
<p>此时系统将变为“完全开放”。</p>
<p><strong>如何阻止防火墙响应 Ping？</strong></p>
<p>编辑 <code>/etc/shorewall/rules</code> 文件，并删除以下行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ping(ACCEPT) net <span class="variable">$FW</span></span><br></pre></td></tr></table></figure>
<p>然后在根提示符下输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/shorewall restart</span><br></pre></td></tr></table></figure>
<p><strong>如何允许其他类型的传入连接？</strong></p>
<p>Shorewall 包含一组宏，可以用来快速允许或拒绝服务。你可以使用以下命令找到你版本的 Shorewall 包含的宏列表：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ls /usr/share/shorewall/macro.*</span><br></pre></td></tr></table></figure>
<p>或者在 shell 提示符下输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/shorewall show macros</span><br></pre></td></tr></table></figure>
<p>如果你希望允许从互联网到防火墙的连接，并且在 <code>/etc/shorewall/macro.*</code> 中找到合适的宏，则在 <code>/etc/shorewall/rules</code> 中添加规则的一般格式是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION         SOURCE    DESTINATION     PROTO       DPORT</span></span><br><span class="line">&lt;宏&gt;(ACCEPT)    net       <span class="variable">$FW</span></span><br></pre></td></tr></table></figure>
<p><strong>重要提示</strong> 确保在添加规则时放在 <code>SECTION NEW</code> 行之后。</p>
<p><strong>示例 1：你希望在防火墙系统上运行 Web 服务器和 IMAP 服务器</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION     SOURCE    DESTINATION     PROTO       DPORT</span></span><br><span class="line">Web(ACCEPT) net       <span class="variable">$FW</span></span><br><span class="line">IMAP(ACCEPT) net      <span class="variable">$FW</span></span><br></pre></td></tr></table></figure>
<p>你也可以选择直接编写规则，而不使用预定义的宏。如果没有适合你需求的预定义宏，这种方法是必要的。在这种情况下，<code>/etc/shorewall/rules</code> 中规则的一般格式是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION   SOURCE    DESTINATION     PROTO       DPORT</span></span><br><span class="line">ACCEPT    net       <span class="variable">$FW</span>             &lt;协议&gt;      &lt;端口&gt;</span><br></pre></td></tr></table></figure>
<p><strong>示例 2：你希望在防火墙系统上运行 Web 服务器和 IMAP 服务器</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION   SOURCE    DESTINATION     PROTO       DPORT</span></span><br><span class="line">ACCEPT    net       <span class="variable">$FW</span>             tcp          80</span><br><span class="line">ACCEPT    net       <span class="variable">$FW</span>             tcp          143</span><br></pre></td></tr></table></figure>
<p>如果你不知道特定应用程序使用哪个端口和协议，请参阅相关文档(<a href="https://shorewall.org/ports.htm)。" target="_blank" rel="noopener">https://shorewall.org/ports.htm)。</a></p>
<p><strong>如何让防火墙在拒绝传入连接时记录消息？</strong></p>
<p>Shorewall 本身不维护日志，而是依赖于系统的日志配置。以下命令依赖于知道 Netfilter 消息的日志位置：</p>
<ul>
<li><strong><code>shorewall show log</code></strong>（显示最后 20 条 Netfilter 日志消息）</li>
<li><strong><code>shorewall logwatch</code></strong>（以可设置的间隔轮询日志）</li>
<li><strong><code>shorewall dump</code></strong>（生成详细报告以供 Shorewall 问题报告使用）</li>
</ul>
<p>确保这些命令正常工作，因为当 Shorewall 运行时遇到连接问题时，第一步是查看 Netfilter 日志。通过参考 Shorewall FAQ 17，通常可以快速解决问题。</p>
<p>Netfilter 日志位置因发行版而异：</p>
<ul>
<li>Debian 及其衍生版将 Netfilter 消息记录到 <code>/var/log/kern.log</code>。</li>
<li>最近的 SuSE/OpenSuSE™ 版本预配置了 syslog-ng，并将 Netfilter 消息记录到 <code>/var/log/firewall</code>。</li>
<li>对于其他发行版，Netfilter 消息最常记录到 <code>/var/log/messages</code>。</li>
</ul>
<p>修改 <code>/etc/shorewall/shorewall.conf</code> 中的 <code>LOGFILE</code> 设置以指定你的日志名称。</p>
<p><strong>重要提示</strong></p>
<p><code>LOGFILE</code> 设置不控制 Netfilter 日志的位置——它只是告诉 <code>/sbin/shorewall</code> 实用程序在哪里找到日志。</p>
<p>现在，编辑 <code>/etc/shorewall/policy</code> 并修改以下行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net all DROP</span><br></pre></td></tr></table></figure>
<p>改为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net all DROP info</span><br></pre></td></tr></table></figure>
<p>然后在 root 提示符下输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/shorewall reload</span><br></pre></td></tr></table></figure>
<p><strong>如何防止防火墙转发连接请求？</strong></p>
<p>编辑 <code>/etc/shorewall/interfaces</code>，并从接口中移除 <code>routeback</code> 选项。例如，将以下行更改为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net all - dhcp,physical=+,optional</span><br></pre></td></tr></table></figure>
<p>然后在 root 提示符下输入：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/shorewall reload</span><br></pre></td></tr></table></figure>
<h3 id="one-interface-TODO"><a href="#one-interface-TODO" class="headerlink" title="one-interface(TODO)"></a>one-interface(TODO)</h3><h3 id="two-interfaces-TODO"><a href="#two-interfaces-TODO" class="headerlink" title="two-interfaces(TODO)"></a>two-interfaces(TODO)</h3><h3 id="three-interfaces-TODO"><a href="#three-interfaces-TODO" class="headerlink" title="three-interfaces(TODO)"></a>three-interfaces(TODO)</h3><h2 id="Manpages"><a href="#Manpages" class="headerlink" title="Manpages"></a>Manpages</h2><p>MAN：<a href="https://shorewall.org/Manpages.html" target="_blank" rel="noopener">https://shorewall.org/Manpages.html</a></p>
<h3 id="第5节-—-文件和概念"><a href="#第5节-—-文件和概念" class="headerlink" title="第5节 — 文件和概念"></a>第5节 — 文件和概念</h3><ol>
<li><p><strong>accounting</strong><br>定义 IP 计费规则。</p>
</li>
<li><p><strong>actions</strong><br>声明用户定义的操作。</p>
</li>
<li><p><strong>addresses</strong><br>描述在 Shorewall 配置中如何指定 IP 地址和端口。</p>
</li>
<li><p><strong>arprules</strong><br>(在 Shorewall 4.5.12 中新增) 定义 ARP 过滤规则。</p>
</li>
<li><p><strong>blrules</strong><br>Shorewall 黑名单文件。</p>
</li>
<li><p><strong>conntrack</strong><br>指定连接帮助程序或豁免某些流量的 netfilter 连接跟踪。</p>
</li>
<li><p><strong>ecn</strong><br>禁用显式拥塞通知。</p>
</li>
<li><p><strong>exclusion</strong><br>从网络或区域中排除主机。</p>
</li>
<li><p><strong>files</strong><br>描述 Shorewall 配置文件及其用途。</p>
</li>
<li><p><strong>hosts</strong><br>定义通过单个接口访问的多个区域。</p>
</li>
<li><p><strong>interfaces</strong><br>定义系统接口，并可选择将其与区域关联。</p>
</li>
<li><p><strong>ipsets</strong><br>描述如何在 Shorewall 配置文件中指定集合名称。</p>
</li>
<li><p><strong>logging</strong><br>提供 Shorewall 数据包日志记录设施的概述。</p>
</li>
<li><p><strong>maclist</strong><br>定义 MAC 地址验证。</p>
</li>
<li><p><strong>mangle</strong><br>替代 tcrules，描述数据包和连接标记。</p>
</li>
<li><p><strong>masq</strong><br>定义伪装/SNAT（已被 snat 替代）。</p>
</li>
<li><p><strong>modules</strong><br>指定要加载的内核模块（在 Shorewall 5.2.3 中删除）。</p>
</li>
<li><p><strong>names</strong><br>描述 Shorewall 配置中的对象命名规则。</p>
</li>
<li><p><strong>nat</strong><br>定义一对一 NAT。</p>
</li>
<li><p><strong>nesting</strong><br>解释如何定义嵌套区域。</p>
</li>
<li><p><strong>netmap</strong><br>描述如何将地址从一个网络映射到另一个网络。</p>
</li>
<li><p><strong>params</strong><br>为其他 Shorewall 文件中使用的 shell 变量分配值。</p>
</li>
<li><p><strong>policy</strong><br>定义区域之间连接的高级策略。</p>
</li>
<li><p><strong>providers</strong><br>定义路由表，通常用于多个互联网链接。</p>
</li>
<li><p><strong>proxyarp</strong><br>定义 IPv4 的代理 ARP。</p>
</li>
<li><p><strong>proxyndp</strong><br>定义 IPv6 的代理 NDP。</p>
</li>
<li><p><strong>rtrules</strong><br>定义路由规则。</p>
</li>
<li><p><strong>routes</strong><br>(在 Shorewall 4.4.15 中新增) 向提供者路由表添加额外的路由。</p>
</li>
<li><p><strong>rules</strong><br>指定对策略的例外，包括 DNAT 和 REDIRECT。</p>
</li>
<li><p><strong>secmarks</strong><br>将 SELinux 上下文附加到数据包。</p>
</li>
<li><p><strong>snat</strong><br>定义伪装/SNAT。</p>
</li>
<li><p><strong>tcclasses</strong><br>定义用于流量整形的 HTB 类别。</p>
</li>
<li><p><strong>tcdevices</strong><br>指定用于流量整形的设备速度。</p>
</li>
<li><p><strong>tcfilters</strong><br>对流量进行分类以便整形，通常与 IFB 一起使用来整形流入流量。</p>
</li>
<li><p><strong>tcinterfaces</strong><br>指定用于简化流量整形的设备。</p>
</li>
<li><p><strong>tcpri</strong><br>对简化流量整形的流量进行分类。</p>
</li>
<li><p><strong>tunnels</strong><br>定义具有防火墙端点的 VPN 连接。</p>
</li>
<li><p><strong>shorewall.conf</strong><br>指定 Shorewall 的全局选项。</p>
</li>
<li><p><strong>shorewall6.conf</strong><br>指定 Shorewall6 的全局选项。</p>
</li>
<li><p><strong>shorewall-lite.conf</strong><br>指定 Shorewall Lite 的全局选项。</p>
</li>
<li><p><strong>shorewall6-lite.conf</strong><br>指定 Shorewall6 Lite 的全局选项。</p>
</li>
<li><p><strong>vardir</strong><br>重新定义 Shorewall 保存其状态信息的目录。</p>
</li>
<li><p><strong>vardir-lite</strong><br>重新定义 Shorewall Lite 保存其状态信息的目录。</p>
</li>
<li><p><strong>zones</strong><br>声明 Shorewall 区域。</p>
</li>
</ol>
<h3 id="第8节-—-管理命令"><a href="#第8节-—-管理命令" class="headerlink" title="第8节 — 管理命令"></a>第8节 — 管理命令</h3><ul>
<li><strong>shorewall</strong><br><code>/sbin/shorewall</code>、<code>/sbin/shorewall6/</code>、<code>/sbin/shorewall-lite</code> 和 <code>/sbin/shorewall6-lite</code> 命令的语法和语义。</li>
</ul>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><h3 id="etc-shorewall-zones"><a href="#etc-shorewall-zones" class="headerlink" title="/etc/shorewall/zones"></a><code>/etc/shorewall/zones</code></h3><p>在配置 Shorewall 时，你需要先定义网络区域（zones），然后将实际的网络接口（interfaces）分配给这些区域。这样，Shorewall 就能基于区域之间的规则来处理流量，并通过接口来实际管理数据流动。</p>
<p><strong>区域（Zones）</strong>: 是逻辑上的分组，定义网络的分类和访问策略。它们并不直接对应物理接口，而是描述网络的不同部分。</p>
<p><strong>定义</strong>: <code>zones</code> 文件定义了网络区域，每个区域代表一个网络或网络的一部分。区域是 Shorewall 用于组织和分类网络接口的一种方式。</p>
<p><strong>作用</strong>: 区域帮助 Shorewall 理解不同网络之间的关系，例如内部网络、外部网络、DMZ 等。它们用于指定网络流量的处理策略。</p>
<p><strong>配置</strong>: 在 <code>/etc/shorewall/zones</code> 文件中定义。每个区域都需要一个唯一的名称，并且指定其类型（如 <code>ipv4</code>、<code>ipv6</code>、<code>firewall</code>）。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ZONE   TYPE</span></span><br><span class="line"><span class="attr">net</span>     <span class="string">ipv4</span></span><br><span class="line"><span class="attr">loc</span>     <span class="string">ipv4</span></span><br></pre></td></tr></table></figure>
<p><strong>解释</strong>: 上述示例中定义了两个区域：<code>net</code>（外部网络）和 <code>loc</code>（本地网络）。这两个区域都使用 IPv4 地址。</p>
<p><strong>参数：</strong></p>
<h4 id="类型（TYPE）"><a href="#类型（TYPE）" class="headerlink" title="类型（TYPE）"></a><strong>类型（TYPE）</strong></h4><p><code>ip</code>：这是标准的 Shorewall 区域类型，也是默认类型。如果这一列留空或输入“-”，则默认为 <code>ip</code>。与某些区域主机的通信可能是加密的。加密主机在 <code>shorewall-hosts(5)</code> 文件中使用 <code>ipsec</code> 选项指定。为了清晰起见，在 IPv4 配置中可以将此区域类型指定为 <code>ipv4</code>，在 IPv6 配置中可以指定为 <code>ipv6</code>。</p>
<p><code>ipsec</code>：与所有区域主机的通信都是加密的。你的内核和 iptables 必须包含策略匹配支持。为了清晰起见，在 IPv4 配置中可以将此区域类型指定为 <code>ipsec4</code>，在 IPv6 配置中可以指定为 <code>ipsec6</code>。</p>
<p><code>firewall</code>：指定防火墙本身。你<strong>必须有</strong>一个 <code>firewall</code> 区域。防火墙区域不允许任何选项。你在 ZONE 列中输入的名称将存储在 shell 变量 <code>$FW</code> 中，你可以在其他配置文件中使用它来指定防火墙区域。</p>
<p><code>bport</code>：该区域与单个桥接上的一个或多个端口相关联。为了清晰起见，在 IPv4 配置中可以将此区域类型指定为 <code>bport4</code>，在 IPv6 配置中可以指定为 <code>bport6</code>。</p>
<p><code>vserver</code>：在 Shorewall 4.4.11 Beta 2 中新增 - 一个由 Linux-vserver 客户机组成的区域。区域内容必须在 <code>shorewall-hosts(5)</code> 文件中定义。Vserver 区域隐式地作为防火墙区域的子区域处理。</p>
<p><code>loopback</code>：在 Shorewall 4.5.17 中新增。通常，Shorewall 以下列方式处理回环接口（lo）：</p>
<ul>
<li>默认情况下，所有通过该接口的流量都被接受（ACCEPT）。</li>
<li>如果定义了 $FW -&gt; $FW 策略或 $FW -&gt; $FW 规则，它们会被放置在名为 <code>${FW}2${F2}</code> 或 <code>${FW}-${FW}</code> 的链中（例如，<code>fw2fw</code> 或 <code>fw-fw</code>），具体取决于 <code>shorewall.conf(5)</code> 中的 ZONE2ZONE 设置。</li>
<li>$FW -&gt; $FW 流量仅在 OUTPUT 链中被过滤。</li>
</ul>
<p>通过定义一个 loopback 区域并在 <code>shorewall-interfaces(5)</code> 中将其与回环接口关联，可以实现稍微不同的模型。假设回环区域名称是 <code>local</code>，那么：</p>
<ul>
<li>将创建 $FW -&gt; local 和 local -&gt; $FW 链。</li>
<li>$FW -&gt; local 和 local -&gt; $FW 策略可以不同。</li>
<li>可以指定 $FW -&gt; local 和 local -&gt; $FW 规则。</li>
<li>对回环区域和除防火墙区域以外的任何区域的规则将被忽略，并发出警告。</li>
<li>回环区域可以嵌套在其他回环区域内。</li>
</ul>
<p><code>local</code>：在 Shorewall 4.5.17 中新增。<code>local</code> 与 <code>ipv4</code> 相同，唯一的区别是该区域只能从防火墙和 vserver 区域访问。</p>
<h4 id="选项-OPTIONS"><a href="#选项-OPTIONS" class="headerlink" title="选项 (OPTIONS)"></a><strong>选项 (OPTIONS)</strong></h4><p>这些选项是逗号分隔的列表。除 <code>mss</code> 和 <code>blacklist</code> 选项外，这些选项仅适用于 <code>TYPE ipsec</code> 区域。</p>
<ul>
<li><strong>dynamic_shared</strong><br>在 Shorewall 4.5.9 中新增。只能在 OPTIONS 列中指定，表示如果此区域在 <code>shorewall-hosts(5)</code> 中有多个动态条目，则只应创建一个 ipset。没有此选项时，会为每个接口创建单独的 ipset。</li>
<li><strong>reqid=number</strong><br>使用 <code>setkey(8)</code> 指定，其中 <code>number</code> 使用 SPD 级别的 <code>unique:number</code> 选项指定。</li>
<li><strong>spi=<number></strong><br>其中 <code>number</code> 是用于加密/解密数据包的 SA 的 SPI。</li>
<li><strong>proto=ah|esp|ipcomp</strong><br>IPSEC 封装协议。</li>
<li><strong>mss=number</strong><br>设置 TCP 数据包中的 MSS 字段。如果提供此选项，还应在 <code>shorewall.conf(5)</code> 中设置 <code>FASTACCEPT=No</code>，以确保 SYN 和 SYN,ACK 数据包的 MSS 字段都得到调整。</li>
<li><strong>mode=transport|tunnel</strong><br>IPSEC 模式。</li>
<li><strong>tunnel-src=address[/mask]</strong><br>仅在 <code>mode=tunnel</code> 时可用。</li>
<li><strong>tunnel-dst=address[/mask]</strong><br>仅在 <code>mode=tunnel</code> 时可用。</li>
<li><strong>strict</strong><br>意味着数据包必须匹配所有规则。</li>
<li><strong>next</strong><br>分隔规则，仅可与 <code>strict</code> 一起使用。</li>
</ul>
<h4 id="IN-OPTIONS-和-OUT-OPTIONS"><a href="#IN-OPTIONS-和-OUT-OPTIONS" class="headerlink" title="IN OPTIONS 和 OUT OPTIONS"></a><strong>IN OPTIONS 和 OUT OPTIONS</strong></h4><p>这些选项分别应用于传入和传出流量（除了 OPTIONS 中的选项外）。如果你希望留空某列，但需要在后续列中输入内容，请使用 “-” 作为占位符。</p>
<h4 id="Universal示例"><a href="#Universal示例" class="headerlink" title="Universal示例"></a>Universal示例</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Shorewall version <span class="number">4</span> - Zones File</span><br><span class="line">#</span><br><span class="line"># For information about this file, type <span class="string">"man shorewall-zones"</span></span><br><span class="line">#</span><br><span class="line"># The manpage is also online at</span><br><span class="line"># http:<span class="comment">//www.shorewall.net/manpages/shorewall-zones.html</span></span><br><span class="line">#</span><br><span class="line">###############################################################################</span><br><span class="line">#ZONE	TYPE		OPTIONS		IN			OUT</span><br><span class="line">#					OPTIONS			OPTIONS</span><br><span class="line">fw	firewall</span><br><span class="line">net	ip</span><br></pre></td></tr></table></figure>
<p><strong>三接口示例</strong></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Shorewall - Sample Zones File for three-interface configuration.</span><br><span class="line"># Copyright (C) <span class="number">2006</span><span class="number">-2015</span> by the Shorewall Team</span><br><span class="line">#</span><br><span class="line"># This library is free software; you can redistribute it and/or</span><br><span class="line"># modify it under the terms <span class="keyword">of</span> the GNU Lesser General Public</span><br><span class="line"># License <span class="keyword">as</span> published by the Free Software Foundation; either</span><br><span class="line"># version <span class="number">2.1</span> <span class="keyword">of</span> the License, or (at your option) any later version.</span><br><span class="line">#</span><br><span class="line"># See the file README.txt for further details.</span><br><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"># For information about entries <span class="keyword">in</span> this file, type <span class="string">"man shorewall-zones"</span></span><br><span class="line">###############################################################################</span><br><span class="line">#ZONE	TYPE	OPTIONS			IN			OUT</span><br><span class="line">#					OPTIONS			OPTIONS</span><br><span class="line">fw	firewall</span><br><span class="line">net	ipv4</span><br><span class="line">loc	ipv4</span><br><span class="line">dmz	ipv4</span><br></pre></td></tr></table></figure>
<h3 id="etc-shorewall-interfaces"><a href="#etc-shorewall-interfaces" class="headerlink" title="/etc/shorewall/interfaces"></a><code>/etc/shorewall/interfaces</code></h3><p><strong>定义</strong>: <code>interfaces</code> 文件定义了网络接口及其与区域的关联。接口是实际的网络设备或虚拟接口，Shorewall 使用它们来确定数据流动的物理路径。</p>
<p><strong>作用</strong>: 接口将实际的网络硬件（如网卡）与 Shorewall 的区域模型连接起来。它们告诉 Shorewall 哪些接口属于哪些区域，以及这些接口的附加选项（如是否启用路由回传）。</p>
<p><strong>配置</strong>: 在 <code>/etc/shorewall/interfaces</code> 文件中定义。每个接口都需要指定所属区域及其他选项。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ZONE   INTERFACE   OPTIONS</span></span><br><span class="line"><span class="attr">net</span>     <span class="string">eth0        dhcp,routeback</span></span><br><span class="line"><span class="attr">loc</span>     <span class="string">eth1        dhcp</span></span><br></pre></td></tr></table></figure>
<p><strong>解释</strong>: 上述示例中，<code>eth0</code> 接口被分配到 <code>net</code> 区域，并启用了 DHCP 和路由回传功能。<code>eth1</code> 接口被分配到 <code>loc</code> 区域，并启用了 DHCP。</p>
<p><strong>接口（Interfaces）</strong>: 是物理或虚拟的网络接口，实际连接到网络。它们与区域相关联，告诉 Shorewall 哪些接口属于哪些区域，以及如何处理这些接口的流量。</p>
<h4 id="区域-Zone"><a href="#区域-Zone" class="headerlink" title="区域 (Zone)"></a><strong>区域 (Zone)</strong></h4><ul>
<li><strong>Zone for this interface</strong>：必须匹配 <code>/etc/shorewall/zones</code> 文件中声明的区域名称。在这个列中不能列出防火墙区域。</li>
<li><strong>多个区域</strong>：如果接口服务于多个将在 <code>shorewall-hosts(5)</code> 文件中定义的区域，应在此列中放置“-”。(通常，一个接口只能属于一个区域，除非使用更高级的 Shorewall 配置（如 <code>multi-ZONE</code> 配置），否则这种配置会导致冲突和不明确的区域划分。)</li>
<li><strong>多个接口同一区域</strong>：如果有多个接口指向同一区域，必须在单独的条目中列出它们。</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">If</span> the<span class="built_in"> interface </span>serves multiple zones that will be defined <span class="keyword">in</span> the shorewall-hosts[1](5) file, you should place <span class="string">"-"</span> <span class="keyword">in</span> this column.</span><br><span class="line"></span><br><span class="line"><span class="keyword">If</span> there are multiple interfaces <span class="keyword">to</span> the same zone, you must list them <span class="keyword">in</span> separate entries.</span><br></pre></td></tr></table></figure>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Shorewall interfaces file</span></span><br><span class="line"><span class="comment"># Zone  Interface   Options</span></span><br><span class="line"><span class="attr">net</span>     <span class="string">eth0        dhcp,routeback</span></span><br><span class="line"><span class="attr">loc</span>     <span class="string">eth1        optional</span></span><br><span class="line"><span class="attr">dmz</span>     <span class="string">eth2        -</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Interface for multiple zones</span></span><br><span class="line"><span class="meta">-</span>       <span class="string">eth3        -</span></span><br></pre></td></tr></table></figure>
<p><strong>解释</strong></p>
<ul>
<li><strong>net</strong> 区域与 <code>eth0</code> 接口相关联，启用 DHCP 和 routeback 选项。</li>
<li><strong>loc</strong> 区域与 <code>eth1</code> 接口相关联，并设置为可选。</li>
<li><strong>dmz</strong> 区域与 <code>eth2</code> 接口相关联，没有额外选项。</li>
<li><strong>eth3</strong> 接口服务于多个区域，因此在区域列中使用“-”。</li>
</ul>
<h4 id="接口（INTERFACE）"><a href="#接口（INTERFACE）" class="headerlink" title="接口（INTERFACE）"></a>接口（INTERFACE）</h4><ol>
<li><strong>逻辑名称和端口</strong></li>
</ol>
<ul>
<li><strong>接口名称</strong>：指定接口的逻辑名称。每个接口在文件中只能列出一次。例如，您可以使用 <code>eth0</code>、<code>eth1</code> 等。</li>
<li><strong>端口</strong>：如果指定了端口，则接口必须之前定义为桥接接口（使用 <code>bridge</code> 选项）。在这种情况下，<code>OPTIONS</code> 列中不能包含一些特定的选项（见下文）。</li>
</ul>
<ol>
<li><strong>虚拟接口</strong></li>
</ol>
<ul>
<li><strong>虚拟接口</strong>：您不能在此列中指定虚拟接口（例如，<code>eth0:0</code>）。虚拟接口的配置有特殊要求，请参考 <a href="https://shorewall.org/FAQ.htm#faq18" target="_blank" rel="noopener">Shorewall FAQ</a> 了解更多信息。</li>
</ul>
<ol>
<li><strong>通配符</strong></li>
</ol>
<ul>
<li><strong>通配符</strong>：可以使用通配符指定接口。例如，使用 <code>ppp+</code> 可以匹配所有 PPP 接口，如 <code>ppp0</code>、<code>ppp1</code>、<code>ppp2</code> 等。</li>
<li><strong>旧版本警告</strong>：在 Shorewall 版本 4.1.4 之前使用通配符时，如果还有其他区域使用了匹配的具体接口，可能会引发问题。有关此问题的讨论，请参见 <code>shorewall-nesting(5)</code>。</li>
</ul>
<ol>
<li><strong><code>+</code> 作为接口名</strong></li>
</ol>
<ul>
<li><strong>废弃用法</strong>：Shorewall 允许使用 <code>+</code> 作为接口名称，但这种用法已被废弃。建议使用 <code>physical=+</code> 选项代替（在 <code>OPTIONS</code> 列中指定）。</li>
</ul>
<ol>
<li><strong>Loopback 接口</strong></li>
</ol>
<ul>
<li><strong>Loopback 接口</strong>：无需在此文件中定义 loopback 接口（<code>lo</code>）。在 Shorewall 4.5.17 及之后的版本中，如果为 <code>lo</code> 接口指定了区域，则该区域必须在 <code>shorewall6-zones(5)</code> 中定义为 <code>local</code> 类型。</li>
</ul>
<ol>
<li><strong>不允许的选项（当指定了端口时）</strong></li>
</ol>
<p>如果在 <code>INTERFACE</code> 列中指定了端口，则以下选项不能出现在 <code>OPTIONS</code> 列中：</p>
<ul>
<li><code>arp_filter</code></li>
<li><code>arp_ignore</code></li>
<li><code>bridge</code></li>
<li><code>log_martians</code></li>
<li><code>mss</code></li>
<li><code>optional</code></li>
<li><code>proxyarp</code></li>
<li><code>required</code></li>
<li><code>routefilter</code></li>
<li><code>sourceroute</code></li>
<li><code>upnp</code></li>
<li><code>wait</code></li>
</ul>
<h4 id="广播（BROADCAST）"><a href="#广播（BROADCAST）" class="headerlink" title="广播（BROADCAST）"></a>广播（BROADCAST）</h4><ol>
<li><strong>值的选择</strong></li>
</ol>
<ul>
<li><strong><code>-</code></strong>：表示不为 <code>BROADCAST</code> 列提供值。如果在 <code>OPTIONS</code> 列中需要配置值，可以在 <code>BROADCAST</code> 列中使用 <code>-</code>。</li>
<li><strong><code>detect</code></strong>：Shorewall 会自动检测广播地址（适用于 FORMAT 1）。这要求您的 iptables 和内核支持地址类型匹配（Address Type Match）。如果您选择这个选项，Shorewall 将尝试自动识别和配置广播地址。</li>
<li><strong><code>address[,address]...</code></strong>：指定一个或多个广播地址。您可以使用逗号分隔的地址列表来列出多个广播地址。如果接口有多个子网和地址，则应列出这些地址。如果接口是点对点（P-T-P），则此列应留空。</li>
</ul>
<ol>
<li><strong>使用场景</strong></li>
</ol>
<ul>
<li><strong>FORMAT 1</strong>（已弃用）：在此格式下，您需要提供广播地址。FORMAT 1 中的 <code>BROADCAST</code> 列允许指定广播地址或使用 <code>detect</code> 选项。</li>
<li><strong>FORMAT 2</strong>（当前推荐）：此格式省略了 <code>BROADCAST</code> 列，广播地址的配置不再需要明确列出。</li>
</ul>
<h4 id="选项（OPTIONS）"><a href="#选项（OPTIONS）" class="headerlink" title="选项（OPTIONS）"></a>选项（OPTIONS）</h4><ol>
<li><strong>常见选项</strong></li>
</ol>
<ul>
<li><p><strong><code>accept_ra[={0|1|2}]</code></strong><br>IPv6 专用。控制是否接受路由器通告（Router Advertisements）。如果未指定值，默认为 <code>1</code>。（0:不接受，1:如果转发被禁用，则接受路由通告。2:否决转发行为。  即使启用了转发，也接受路由通告）注意：此选项不适用于通配符物理名称（例如，eth0.+）。  从 Shorewall 5.1.10 开始，如果指定此选项，则会发出警告并忽略该选项。</p>
</li>
<li><p><strong><code>arp_filter[={0|1}]</code></strong><br>IPv4 专用。指定是否只响应 ARP 请求的目标 IP 地址配置在接口上。</p>
</li>
<li><p><strong><code>arp_ignore[=number]</code></strong><br>IPv4 专用。指定如何响应 ARP 请求。<code>number</code> 取值范围从 <code>1</code> 到 <code>8</code>，控制对 ARP 请求的响应策略。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1 - 仅在目标<span class="built_in"> IP </span>地址是本地地址且配置在传入接口上时才回复</span><br><span class="line"></span><br><span class="line">2 - 仅在目标<span class="built_in"> IP </span>地址是本地地址且配置在传入接口上，并且发送者的<span class="built_in"> IP </span>地址来自相同子网时才回复</span><br><span class="line"></span><br><span class="line">3 - 不回复具有主机作用域的本地地址，仅对全局和链路的解析进行回复</span><br><span class="line"></span><br><span class="line">4-7 - 保留</span><br><span class="line"></span><br><span class="line">8 - 不对所有本地地址进行回复</span><br><span class="line"></span><br><span class="line">警告：</span><br><span class="line">不要为涉及代理 ARP 的任何接口指定 arp_ignore。</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>blacklist</code></strong><br>检查到达此接口的包是否在 <code>shorewall-blacklist</code> 文件中。对于多区域接口，该选项会被忽略并发出警告。<code>WARNING: The &#39;blacklist&#39; option is ignored on multi-zone interfaces</code></p>
</li>
<li><p><strong><code>bridge</code></strong><br>指定接口作为桥接接口。设置 <code>bridge</code> 选项同时也会设置 <code>routeback</code>。</p>
</li>
<li><p><strong><code>dbl={none|src|dst|src-dst}</code></strong><br>定义是否应用动态黑名单，及其比较的 IP 地址。动态黑名单适用于进出防火墙的包。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">自 Shorewall 5.0.10 起。此选项定义是否对通过该接口进入防火墙的数据包应用动态黑名单，以及是否要将源地址和/或目的地址与基于 ipset 的动态黑名单（<span class="attribute">DYNAMIC_BLACKLIST</span>=ipset... 在 shorewall.conf(5) 中）进行比较。默认值由 DYNAMIC_BLACKLIST 的设置确定：</span><br><span class="line">    <span class="attribute">DYNAMIC_BLACKLIST</span>=<span class="literal">No</span></span><br><span class="line">    默认值为 none（例如，不进行动态黑名单检查）。</span><br><span class="line">    <span class="attribute">DYNAMIC_BLACKLIST</span>=<span class="literal">Yes</span></span><br><span class="line">    默认值为 src（例如，源<span class="built_in"> IP </span>地址进行检查）。</span><br><span class="line">    <span class="attribute">DYNAMIC_BLACKLIST</span>=ipset[-only]</span><br><span class="line">    默认值为 src。</span><br><span class="line">    <span class="attribute">DYNAMIC_BLACKLIST</span>=ipset[-only],src-dst<span class="built_in">..</span>.</span><br><span class="line">    默认值为 src-dst（例如，输入的数据包中的源<span class="built_in"> IP </span>地址与 ipset 进行检查，而离开防火墙并通过该接口的数据包中的目的<span class="built_in"> IP </span>地址与 ipset 进行检查）。</span><br><span class="line">对于内部接口，正常设置为 dst 或 none，对于面向互联网的接口，正常设置为 src 或 src-dst。</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>destonly</code></strong><br>指示编译器忽略处理来自此接口的流量的规则。</p>
</li>
<li><p><strong><code>dhcp</code></strong><br>允许 DHCP 数据包通过接口。适用于通过 DHCP 获取 IP 地址的接口或运行 DHCP 服务器的接口。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">当以下任何情况成立时，指定此选项：</span><br><span class="line">    接口通过 DHCP 获取其<span class="built_in"> IP </span>地址</span><br><span class="line">    接口用于运行在防火墙上的 DHCP 服务器</span><br><span class="line">    接口具有静态 IP，但在具有大量 DHCP 客户端的<span class="built_in"> LAN </span>段上。</span><br><span class="line">    接口是一个简单的桥接，其中一个端口有一个 DHCP 服务器，另一个端口有 DHCP 客户端。</span><br><span class="line">注意</span><br><span class="line">如果您使用 Shorewall-perl 进行防火墙/桥接，则需要在 shorewall-rules(5) 中包含 DHCP 特定规则。DHCP 使用 UDP 端口 67 和 68。</span><br></pre></td></tr></table></figure>
<p><strong>此选项允许 DHCP 数据报进出接口。</strong></p>
</li>
<li><p><strong><code>forward[={0|1}]</code></strong><br>IPv6 专用。设置接口的 IPv6 转发选项。未指定值时默认为 <code>1</code>。</p>
</li>
<li><p><strong><code>ignore[=1]</code></strong><br>忽略来自 Shorewall-init 的上/下事件，免除 hairpin 过滤。当指定时，会使生成的脚本忽略来自 Shorewall-init 的此设备的 up/down 事件。此外，该选项使接口免于环回过滤。省略 ‘=1’ 时，ZONE 列必须包含 ‘-‘，并且 ignore 必须是唯一的选项。</p>
</li>
<li><p><strong><code>loopback</code></strong><br>指定接口为回环接口（<code>lo</code>）。只有一个接口可以指定为回环接口。</p>
</li>
<li><p><strong><code>logmartians[={0|1}]</code></strong><br>IPv4 专用。启用内核的 Martian 日志记录，记录不可能的源地址的包。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">仅适用于 IPv4。启用内核 martian 日志记录（记录具有不可能源地址的数据包）。强烈建议如果您在接口上设置了 routefilter，也设置 logmartians。即使您不指定 routefilter 选项，指定 logmartians 也是个好主意，因为您的发行版可能在您不知道的情况下启用了路由过滤。</span><br><span class="line"></span><br><span class="line">只有那些具有 logmartians 选项的接口将更改其设置；指定的值（如果有）将被应用，或者如果没有指定值，则默认为 <span class="number">1</span>。</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>maclist</code></strong><br>将来自此接口的连接请求与 <code>shorewall-maclist</code> 文件进行比较。接口必须是以太网 NIC，并在 Shorewall 启动之前处于启用状态。来自该接口的连接请求与 shorewall-maclist(5) 文件中的内容进行比较。如果指定了这个选项，接口必须是以太网 NIC，并且必须在 Shorewall 启动之前处于启用状态。</p>
</li>
<li><p><strong><code>mss=number</code></strong><br>设置 TCP SYN 包的 MSS 字段为指定值。</p>
</li>
<li><p><strong><code>nets=(net[,...])</code></strong><br>限制区域仅限于列出的网络。可以支持多播流量。将 ZONE 列中指定的区域限制为仅列出的网络。如果只有一个网络，则可以省略括号（例如，nets=192.168.1.0/24）。区域支持有限广播。自 Shorewall 4.4.1 起，也支持对区域的多播流量。</p>
</li>
<li><p><strong><code>nets=dynamic</code></strong></p>
<p>将区域定义为动态。需要 ipset 匹配支持在您的 iptables 和内核中。有关更多信息，请参见 <a href="https://shorewall.org/Dynamic.html" target="_blank" rel="noopener">Dynamic</a>。</p>
</li>
<li><p><strong><code>nodbl</code></strong><br>禁用动态黑名单。与 <code>dbl=none</code> 等效。</p>
</li>
<li><p><strong><code>nosmurfs</code></strong><br>IPv4 专用。过滤源地址为广播地址的 smurf 包。</p>
<figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">仅适用于 IPv4。过滤 smurf 数据包（源地址为广播地址的数据包）。Smurf 数据包将根据源地址的子网和目标地址的广播地址进行过滤。</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>omitanycast</code></strong><br>IPv6 专用。抑制对 IPv6 anycast 地址的规则生成和处理。</p>
</li>
<li><p><strong><code>optional</code></strong><br>指示即使接口不可用，防火墙也应启动。允许使用启用和禁用命令。自 Shorewall 4.5.0 起。当接口不可用时，防火墙应该启动。如果使用这个选项，您必须确保接口可以启动并且在防火墙启动之前处于可用状态。<code>optional</code> 不能与 <code>required</code> 一起使用。</p>
</li>
<li><p><strong><code>physical=name</code></strong><br>指定接口或端口名称的实际物理名称。这对于在多个桥接中使用相同的通配符端口名称时很有用。</p>
</li>
<li><p><strong><code>proxyarp[={0|1}]</code></strong><br>IPv4 专用。设置接口的 Proxy ARP 选项。</p>
</li>
<li><p><strong><code>proxyndp[={0|1}]</code></strong><br>IPv6 专用。设置接口的 Proxy NDP 选项。</p>
</li>
<li><p><strong><code>required</code></strong><br>如果设置，则防火墙将在接口不可用时启动失败。不能与 <code>optional</code> 一起使用。</p>
</li>
<li><p><strong><code>routeback[={0|1}]</code></strong><br>指示 Shorewall 包括允许通过该接口返回流量的规则。</p>
</li>
<li><p><strong><code>routefilter[={0|1|2}]</code></strong><br>IPv4 专用。启用内核路由过滤（防伪造措施）。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">自 Shorewall 4.4.0 起。仅适用于 IPv4。启用内核路由过滤。默认为 1。如果设置为 2，进一步指定 rpfilter 选项。</span><br><span class="line">    1 - 仅对接口上配置的<span class="built_in"> IP </span>地址和路由表中的条目进行检查。</span><br><span class="line">    2 - 与 1 相同，但包括其他所有检查，包括来自相同接口的流量。</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong><code>rpfilter</code></strong><br>更高效的防伪造措施，适用于多 ISP 配置。</p>
</li>
<li><p><strong><code>sfilter=(net[,...])</code></strong><br>作为 <code>routefilter</code> 的替代，提供反欺骗保护。自 Shorewall 5.0.5 起。仅适用于 IPv4。作为 <code>routefilter</code> 选项的替代。提供对防伪造保护的增强设置。如果指定的网络匹配，流量将被允许。否则，它会被丢弃。可以指定多个网络。</p>
</li>
<li><p><strong><code>sourceroute[={0|1}]</code></strong><br>控制是否接受源路由包。通常不建议启用，因为可能存在安全风险。</p>
</li>
<li><p><strong><code>tcpflags[={0|1}]</code></strong><br>检查包中的 TCP 标志组合是否合法。<code>1</code> 为默认设置，表示启用检查。</p>
</li>
<li><p><strong><code>unmanaged</code></strong><br>使所有流量在防火墙和接口之间被接受。只允许与 <code>unmanaged</code> 配合使用的选项。自 Shorewall 4.4.0 起。如果指定，所有流量都将被接受，无论是进入还是离开防火墙。此选项仅与 <code>unmanaged</code> 配合使用的选项一起使用。</p>
</li>
<li><p><strong><code>upnp</code></strong><br>允许来自接口的请求通过 UPNP 进行映射。</p>
</li>
<li><p><strong><code>upnpclient</code></strong><br>允许 Shorewall 通过 UPNP 客户端应用程序检测默认网关并接受 UDP 数据包。</p>
</li>
<li><p><strong><code>wait=seconds</code></strong><br>设置脚本在接口变为可用之前的等待时间（秒）。</p>
</li>
</ul>
<p><strong>案例解析：</strong></p>
<p><strong>IPv4 示例 1</strong></p>
<p>假设你有如下网络配置：</p>
<ul>
<li><code>eth0</code> 连接到 DSL 调制解调器。</li>
<li><code>eth1</code> 连接到你的本地网络，本地子网为 <code>192.168.1.0/24</code>。</li>
<li><code>eth2</code> 用于 DMZ，DMZ 子网为 <code>192.168.2.0/24</code>。</li>
<li>接口通过 DHCP 从 <code>206.191.149.192/27</code> 子网获取 IP 地址。</li>
<li>你的 <code>iptables</code> 和/或内核不支持 “地址类型匹配”，你更愿意显式指定广播地址，而不是让 Shorewall 自动检测。</li>
</ul>
<p><strong>配置</strong>:</p>
<p><strong>FORMAT 1</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ZONE   INTERFACE BROADCAST        OPTIONS</span><br><span class="line">net     eth0      206.191.149.223  dhcp</span><br><span class="line">loc     eth1      192.168.1.255</span><br><span class="line">dmz     eth2      192.168.2.255</span><br></pre></td></tr></table></figure>
<p><strong>示例 2</strong></p>
<p>相同配置，但不指定广播地址：</p>
<p><strong>FORMAT 2</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ZONE   INTERFACE OPTIONS</span><br><span class="line">net     eth0      dhcp</span><br><span class="line">loc     eth1      </span><br><span class="line">dmz     eth2</span><br></pre></td></tr></table></figure>
<p><strong>示例 3</strong></p>
<p>你有一个简单的拨号系统，没有以太网连接。</p>
<p><strong>FORMAT 2</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ZONE   INTERFACE OPTIONS</span><br><span class="line">net     ppp0      -</span><br></pre></td></tr></table></figure>
<p><strong>示例 4 (Shorewall 4.4.9 及以后版本)</strong></p>
<p>你有一个没有 IP 地址的桥接设备，并且你想允许流量通过桥接设备。</p>
<p><strong>FORMAT 2</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ZONE   INTERFACE OPTIONS</span><br><span class="line">-       br0       bridge</span><br></pre></td></tr></table></figure>
<p><strong>解释</strong></p>
<ol>
<li><p><strong>FORMAT 1</strong>: 这种格式需要显式指定广播地址。适用于需要手动设置广播地址的环境，通常在老旧系统或不支持自动检测的环境中使用。</p>
</li>
<li><p><strong>FORMAT 2</strong>: 这种格式省略了广播地址的指定，适用于较新版本的 Shorewall，能够自动处理广播地址的环境。</p>
</li>
<li><p><strong>拨号系统</strong>: 对于拨号连接（如 PPP 接口），可以用 <code>-</code> 代替广播地址。</p>
</li>
<li><p><strong>桥接设备</strong>: 在配置没有 IP 地址的桥接设备时，使用 <code>bridge</code> 选项来指定该接口为桥接设备。</p>
</li>
</ol>
<h4 id="Universal示例-1"><a href="#Universal示例-1" class="headerlink" title="Universal示例"></a>Universal示例</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Shorewall version <span class="number">4</span> - Interfaces File</span><br><span class="line">#</span><br><span class="line"># For information about entries <span class="keyword">in</span> this file, type <span class="string">"man shorewall-interfaces"</span></span><br><span class="line">#</span><br><span class="line"># The manpage is also online at</span><br><span class="line"># http:<span class="comment">//www.shorewall.net/manpages/shorewall-interfaces.html</span></span><br><span class="line">#</span><br><span class="line">###############################################################################</span><br><span class="line">?FORMAT <span class="number">2</span></span><br><span class="line">###############################################################################</span><br><span class="line">#ZONE	INTERFACE	OPTIONS</span><br><span class="line">-	lo		ignore</span><br><span class="line">net	all		dhcp,physical=+,routeback</span><br></pre></td></tr></table></figure>
<p><strong>三接口示例</strong></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Shorewall - Sample Interfaces File for three-interface configuration.</span><br><span class="line"># Copyright (C) <span class="number">2006</span><span class="number">-2017</span> by the Shorewall Team</span><br><span class="line">#</span><br><span class="line"># This library is free software; you can redistribute it and/or</span><br><span class="line"># modify it under the terms <span class="keyword">of</span> the GNU Lesser General Public</span><br><span class="line"># License <span class="keyword">as</span> published by the Free Software Foundation; either</span><br><span class="line"># version <span class="number">2.1</span> <span class="keyword">of</span> the License, or (at your option) any later version.</span><br><span class="line">#</span><br><span class="line"># See the file README.txt for further details.</span><br><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"># For information about entries <span class="keyword">in</span> this file, type <span class="string">"man shorewall-interfaces"</span></span><br><span class="line">###############################################################################</span><br><span class="line">?FORMAT <span class="number">2</span></span><br><span class="line">###############################################################################</span><br><span class="line">#ZONE	INTERFACE	OPTIONS</span><br><span class="line">net     NET_IF          tcpflags,dhcp,nosmurfs,routefilter,logmartians,sourceroute=<span class="number">0</span>,physical=eth0</span><br><span class="line">loc     LOC_IF          tcpflags,nosmurfs,routefilter,logmartians,physical=eth1</span><br><span class="line">dmz     DMZ_IF          tcpflags,nosmurfs,routefilter,logmartians,physical=eth2</span><br></pre></td></tr></table></figure>
<h3 id="etc-shorewall-policy"><a href="#etc-shorewall-policy" class="headerlink" title="/etc/shorewall/policy"></a><code>/etc/shorewall/policy</code></h3><p><strong>功能</strong>: <code>policy</code> 文件用于<strong>定义默认的策略</strong>。它确定了<strong>默认情况下防火墙如何处理流量</strong>，通常是那些没有被 <code>rules</code> 文件中的具体规则所处理的流量。换句话说，<code>policy</code> 文件定义了“默认行为”，即当没有匹配到特定规则时，防火墙应采取的行动。</p>
<p><strong>内容</strong>: 策略通常包括源区域、目的区域以及默认行为（如 ACCEPT、DROP、REJECT）。你可以设置不同区域之间的默认流量处理方式。</p>
<p><strong>描述</strong></p>
<p>这个文件定义了在 <code>shorewall-zones(5)</code> 中定义的区域之间的高层次连接策略。</p>
<p><strong>重要</strong></p>
<p><strong>文件中的条目顺序很重要</strong></p>
<p>这个文件决定了如果在 <code>shorewall-blrules(5)</code> 或 <code>shorewall-rules(5)</code> 文件中没有匹配到新连接请求时该如何处理。对于每一对源/目的地，文件按顺序处理，直到找到匹配项（”all” 将匹配任何源或目的地）。</p>
<p><strong>重要</strong></p>
<p><strong>区域间的策略是预定义的</strong></p>
<p>对于 <code>$FW</code> 和 <code>shorewall-zones(5)</code> 中定义的所有区域，从一个区域到自身的连接策略默认为 ACCEPT（没有日志记录或 TCP 连接速率限制），但可以被此文件中的条目覆盖。覆盖条目必须是明确的（在 SOURCE 和 DEST 中指定区域名称）或使用 “all+”（Shorewall 4.5.17 或更高版本）。</p>
<p>类似地，如果 <code>shorewall.conf(5)</code> 中的 <code>IMPLICIT_CONTINUE=Yes</code>，那么对任何子区域的隐式策略是 CONTINUE。这些隐式的 CONTINUE 策略也可以被此文件中的显式条目覆盖。</p>
<p><strong>文件中的列说明</strong></p>
<h4 id="SOURCE-zone-…-FW-all-ezone-…"><a href="#SOURCE-zone-…-FW-all-ezone-…" class="headerlink" title="SOURCE - zone[,…[+]]|$FW|all[+][!ezone[,…]]"></a><strong>SOURCE - zone[,…[+]]|$FW|all[+][!ezone[,…]]</strong></h4><ul>
<li><p><strong>源区域</strong>。必须是 <code>shorewall-zones(5)</code> 中定义的区域名称、<code>$FW</code>、”all” 或 “all+”。</p>
</li>
<li><p>Shorewall 4.5.17 版本增加了对 “all+” 的支持。”all” 不会覆盖隐式的区域内 ACCEPT 策略，而 “all+” 会。</p>
</li>
<li><p>从 Shorewall 5.0.12 开始，可以列出多个区域，以逗号分隔。如上所述，如果在两个或更多区域名称后指定了 ‘+’，那么如果相同的区域出现在 SOURCE 和 DEST 列中，则该策略会覆盖隐式的区域内 ACCEPT 策略。</p>
</li>
<li><p>从 Shorewall 5.2.3 开始，”all” 或 “all+” 后可以跟随以 “!” 开头的排除区域的逗号分隔列表。</p>
</li>
</ul>
<h4 id="DEST-zone-…-FW-all-ezone-…"><a href="#DEST-zone-…-FW-all-ezone-…" class="headerlink" title="DEST - zone[,…[+]]|$FW|all[+][!ezone[,…]]"></a><strong>DEST - zone[,…[+]]|$FW|all[+][!ezone[,…]]</strong></h4><ul>
<li><p><strong>目标区域</strong>。必须是 <code>shorewall-zones(5)</code> 中定义的区域名称、<code>$FW</code>、”all” 或 “all+”。如果 DEST 是 bport 区域，则 SOURCE 必须是 “all”、”all+”、另一个与相同桥相关联的 bport 区域，或者是仅与同一桥相关联的 ipv4 区域。</p>
</li>
<li><p>Shorewall 4.5.17 版本增加了对 “all+” 的支持。”all” 不会覆盖隐式的区域内 ACCEPT 策略，而 “all+” 会。</p>
</li>
<li><p>从 Shorewall 5.0.12 开始，可以列出多个区域，以逗号分隔。如上所述，如果在两个或更多区域名称后指定了 ‘+’，那么如果相同的区域出现在 SOURCE 和 DEST 列中，则该策略会覆盖隐式的区域内 ACCEPT 策略。</p>
</li>
<li><p>从 Shorewall 5.2.3 开始，”all” 或 “all+” 后可以跟随以 “!” 开头的排除区域的逗号分隔列表。</p>
</li>
</ul>
<h4 id="政策-POLICY-ACCEPT-DROP-REJECT-BLACKLIST-CONTINUE-QUEUE-NFQUEUE-queuenumber1-queuenumber2-c-bypass-bypass-NONE-policy-action-level-None"><a href="#政策-POLICY-ACCEPT-DROP-REJECT-BLACKLIST-CONTINUE-QUEUE-NFQUEUE-queuenumber1-queuenumber2-c-bypass-bypass-NONE-policy-action-level-None" class="headerlink" title="政策 (POLICY) - {ACCEPT|DROP|REJECT|BLACKLIST|CONTINUE|QUEUE|NFQUEUE[([queuenumber1[:queuenumber2[c]][,bypass]]|bypass)]|NONE}[:{[+]policy-action[:level][,...]|None}]"></a>政策 (POLICY) - <code>{ACCEPT|DROP|REJECT|BLACKLIST|CONTINUE|QUEUE|NFQUEUE[([queuenumber1[:queuenumber2[c]][,bypass]]|bypass)]|NONE}[:{[+]policy-action[:level][,...]|None}]</code></h4><ul>
<li><p><strong>没有从规则文件中找到匹配项时的处理策略</strong>。</p>
</li>
<li><p>如果策略既不是 <code>CONTINUE</code> 也不是 <code>NONE</code>，则可以跟随 “:” 和以下其中之一：</p>
<ul>
<li><p><strong>“None”</strong> 或 <strong>“none”</strong>。这会导致此策略省略在 <code>shorewall.conf(5)</code> 中定义的任何默认操作。</p>
</li>
<li><p><strong>一个操作名称</strong>，可以带有可选的参数括在括号中。操作将在策略执行之前被调用。</p>
</li>
</ul>
</li>
<li><p>操作可以指定参数。</p>
</li>
<li><p>从 Shorewall 4.5.10 开始，操作名称可以后跟可选的冒号和日志级别。级别将应用于操作或规则体中没有日志级别的每条规则。</p>
</li>
<li><p>从 Shorewall 5.1.2 开始，可以列出多个 <code>action[:level]</code> 规范，用逗号分隔。操作按列出的顺序调用。从 Shorewall 5.1.2 开始，<code>policy-action</code> 列表可以用加号 (“+”) 前缀，表示列出的操作是附加于 <code>shorewall.conf(5)</code> 中相关的 <code>_DEFAULT</code> 设置的。</p>
</li>
</ul>
<p><strong>可能的策略包括：</strong></p>
<ul>
<li><p><strong>ACCEPT</strong>：接受连接。</p>
</li>
<li><p><strong>DROP</strong>：忽略连接请求。</p>
</li>
<li><p><strong>REJECT</strong>：对于 TCP，发送 RST；对于其他协议，发送 “不可达” ICMP。</p>
</li>
<li><p><strong>BLACKLIST</strong>：从 Shorewall 5.1.1 开始，要求 <code>shorewall.conf(5)</code> 中的 <code>DYNAMIC_BLACKLIST</code> 设置指定基于 ipset 的动态黑名单。源 IP 地址将添加到黑名单 ipset 中，连接请求被忽略。</p>
</li>
<li><p><strong>QUEUE</strong>：将请求排队以供用户空间应用程序（如 Snort-inline）处理。</p>
</li>
<li><p><strong>NFQUEUE</strong>：将请求排队以供用户空间应用程序使用 nfnetlink_queue 机制处理。如果没有给定 <code>queuenumber1</code>，则默认使用队列零 (0)。从 Shorewall 4.6.10 开始，可以给定第二个队列号 (<code>queuenumber2</code>)。这指定了一系列要使用的队列。数据包在这些队列之间进行负载均衡。这对多核系统很有用：在队列 x、x+1、.. x+n 上启动多个用户空间程序，并使用 “x:x+n”。属于同一连接的数据包被放入相同的 nfqueue。从 Shorewall 5.1.0 开始，<code>queuenumber2</code> 后可以跟随字母 ‘c’，表示将使用 CPU ID 作为索引来将数据包映射到队列。这可以改善性能，如果每个 CPU 有一个队列。需要在内核和 iptables 中启用 NFQUEUE CPU Fanout 功能。</p>
<ul>
<li>从 Shorewall 4.6.10 开始，可以给定关键字 <code>bypass</code>。默认情况下，如果没有用户空间程序监听 NFQUEUE，则所有要排队的数据包都会被丢弃。当使用此选项时，NFQUEUE 规则表现得像 ACCEPT。</li>
</ul>
</li>
<li><p><strong>CONTINUE</strong>：将连接请求传递过任何其他可能匹配的规则（这些规则中的源或目标区域是此策略中的 SOURCE 或 DEST 的超集）。有关更多信息，请参阅 <code>shorewall-nesting(5)</code>。</p>
</li>
<li><p><strong>NONE</strong>：假设 SOURCE 到 DEST 永远不会有数据包。Shorewall 将不会创建处理这些数据包的基础设施，你在 <code>/etc/shorewall/rules</code> 文件中可能没有任何使用此 SOURCE 和 DEST 的规则。如果收到这样的数据包，结果是未定义的。如果 SOURCE 或 DEST 列中包含防火墙区域（<code>$FW</code>）或 “all”，则不能使用 NONE。</p>
</li>
</ul>
<h4 id="日志级别-LOGLEVEL-log-level-ULOG-NFLOG"><a href="#日志级别-LOGLEVEL-log-level-ULOG-NFLOG" class="headerlink" title="日志级别 (LOGLEVEL) - [log-level|ULOG|NFLOG]"></a>日志级别 (LOGLEVEL) - <code>[log-level|ULOG|NFLOG]</code></h4><ul>
<li><p>可选的 - 如果提供，则每个在默认 POLICY 下处理的连接将记录在该级别。如果未提供，则不会生成日志消息。有关日志级别的描述，请参阅 <code>syslog.conf(5)</code>。</p>
</li>
<li><p>你还可以指定 ULOG 或 NFLOG（必须大写）。这将记录到 ULOG 或 NFLOG 目标，并通过使用 ulogd 发送到单独的日志 (<a href="http://www.netfilter.org/projects/ulogd/index.html)。" target="_blank" rel="noopener">http://www.netfilter.org/projects/ulogd/index.html)。</a></p>
</li>
<li><p>有关日志记录的描述，请参阅 <code>shorewall-logging(5)</code>。</p>
</li>
<li><p>如果不想记录但需要指定以下列，请在此处填写 “-“。</p>
</li>
</ul>
<h4 id="速率-RATE-limit"><a href="#速率-RATE-limit" class="headerlink" title="速率 (RATE) - [-|limit]"></a>速率 (RATE) - <code>[-|limit]</code></h4><ul>
<li><p><code>limit</code> 是以下之一：</p>
<ul>
<li><code>[-|[{s|d}[/vlsm]:[[name][(ht-buckets,ht-max)]:]]]rate/{sec|min|hour|day}[:burst]</code></li>
<li><code>[name1:]rate1/{sec|min|hour|day}[:burst1],[name2:]rate2/{sec|min|hour|day}[:burst2]</code></li>
</ul>
</li>
<li><p>如果传递，指定每秒的最大 TCP 连接速率和可接受的突发大小。如果未指定，则不限制 TCP 连接。如果省略了突发参数，则假设值为 5。</p>
</li>
<li><p>当指定 <code>s:</code> 或 <code>d:</code> 时，速率适用于每个源 IP 地址或每个目标 IP 地址。名称可以由用户选择，并指定一个哈希表，用于计算匹配连接。如果未给出，则假设名称为 shorewall。对于指定相同名称的多个 POLICY 或规则，策略的连接计数将汇总，并且各自的速率适用于汇总计数。从 Shorewall 5.2.1 开始，<code>s</code> 或 <code>d</code> 可以后跟一个斜杠 (“/) 和一个整数 vlsm。当指定了 vlsm 时，所有遇到的源或目标地址将根据给定的前缀长度进行分组，所创建的子网将受到速率限制。</p>
</li>
<li><p>从 Shorewall 4.6.5 开始，可以指定两个限制，用逗号分隔。在这种情况下，第一个限制 (name1, rate1, burst1) 指定每个源 IP 限制，第二个限制指定每个目标 IP 限制。</p>
<ul>
<li>示例： <code>client:10/sec:20,:60/sec:100</code></li>
</ul>
</li>
<li><p>从 Shorewall 5.2.1 开始，如果有表名，则表名后可以跟随两个整数，用逗号分隔并括在括号中。第一个整数 (ht-buckets) 指定生成的哈希表中的桶数。第二个整数 (ht-max) 指定哈希表中的最大条目数。</p>
<ul>
<li>示例： <code>s:client(1024,65536):10/sec</code></li>
</ul>
</li>
</ul>
<h4 id="连接限制-CONNLIMIT-limit-mask"><a href="#连接限制-CONNLIMIT-limit-mask" class="headerlink" title="连接限制 (CONNLIMIT) - limit[:mask]"></a>连接限制 (CONNLIMIT) - <code>limit[:mask]</code></h4><ul>
<li>可以用来限制每个主机的同时连接数，以限制连接数。虽然该限制仅检查可能适用此策略的连接，但当前连接的数量是计算所有来自 SOURCE 主机的连接数。默认情况下，限制适用于每个主机，但可以通过指定掩码来使其适用于主机网络。掩码指定要应用于源地址的 VLSM 掩码宽度；然后当前连接数将在子网 <code>source-address/mask</code> 中的所有主机上进行计算。</li>
</ul>
<p><strong>示例</strong></p>
<ol>
<li><p><strong>允许从本地网络到互联网的所有连接</strong></p>
</li>
<li><p><strong>忽略来自互联网的所有连接，但在 syslog 级别 KERNEL.INFO 记录这些连接</strong></p>
</li>
<li><p><strong>拒绝所有其他连接请求，并在级别 KERNEL.INFO 记录这些请求</strong></p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#SOURCE         DEST            POLICY          LOG           BURST:LIMIT</span><br><span class="line">#                                               LEVEL</span><br><span class="line">loc             net             ACCEPT</span><br><span class="line">net             all             DROP            info</span><br><span class="line">#</span><br><span class="line"># THE FOLLOWING POLICY MUST BE LAST</span><br><span class="line">#</span><br><span class="line">all             all             REJECT          info</span><br></pre></td></tr></table></figure>
<p><strong>解释：</strong></p>
<ul>
<li><p><code>loc</code> 到 <code>net</code> 的连接被接受 (<code>ACCEPT</code>)。即所有来自本地网络 (<code>loc</code>) 的连接可以访问互联网 (<code>net</code>)。</p>
</li>
<li><p><code>net</code> 到 <code>all</code> 的连接被丢弃 (<code>DROP</code>)，并在日志中记录为 <code>info</code> 级别。这表示来自互联网 (<code>net</code>) 的连接请求将被忽略，但会以 <code>info</code> 级别记录到 syslog。</p>
</li>
<li><p>最后的规则处理所有其他连接请求：<code>all</code> 到 <code>all</code> 的连接请求将被拒绝 (<code>REJECT</code>)，并以 <code>info</code> 级别记录。这确保了任何不符合前面规则的连接请求将被拒绝，并记录到日志中。</p>
</li>
</ul>
<h4 id="Universal示例-2"><a href="#Universal示例-2" class="headerlink" title="Universal示例"></a>Universal示例</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Shorewall version <span class="number">4</span> - Policy File</span><br><span class="line">#</span><br><span class="line"># For information about entries <span class="keyword">in</span> this file, type <span class="string">"man shorewall-policy"</span></span><br><span class="line">#</span><br><span class="line"># The manpage is also online at</span><br><span class="line"># http:<span class="comment">//www.shorewall.net/manpages/shorewall-policy.html</span></span><br><span class="line">#</span><br><span class="line">###############################################################################</span><br><span class="line">#SOURCE	DEST	POLICY		LOGLEVEL	RATE		CONNLIMIT</span><br><span class="line">$FW	net	ACCEPT</span><br><span class="line">net	all	DROP		$LOG_LEVEL</span><br></pre></td></tr></table></figure>
<p><strong>三接口示例</strong></p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Shorewall - Sample Policy File for three-interface configuration.</span><br><span class="line"># Copyright (C) <span class="number">2006</span><span class="number">-2015</span> by the Shorewall Team</span><br><span class="line">#</span><br><span class="line"># This library is free software; you can redistribute it and/or</span><br><span class="line"># modify it under the terms <span class="keyword">of</span> the GNU Lesser General Public</span><br><span class="line"># License <span class="keyword">as</span> published by the Free Software Foundation; either</span><br><span class="line"># version <span class="number">2.1</span> <span class="keyword">of</span> the License, or (at your option) any later version.</span><br><span class="line">#</span><br><span class="line"># See the file README.txt for further details.</span><br><span class="line">#------------------------------------------------------------------------------</span><br><span class="line"># For information about entries <span class="keyword">in</span> this file, type <span class="string">"man shorewall-policy"</span></span><br><span class="line">###############################################################################</span><br><span class="line">#SOURCE	DEST		POLICY		LOGLEVEL	RATE	CONNLIMIT</span><br><span class="line"></span><br><span class="line">loc	net		ACCEPT</span><br><span class="line">net	all		DROP		$LOG_LEVEL</span><br><span class="line"># THE FOLLOWING POLICY MUST BE LAST</span><br><span class="line">all	all		REJECT		$LOG_LEVEL</span><br></pre></td></tr></table></figure>
<h3 id="etc-shorewall-rules"><a href="#etc-shorewall-rules" class="headerlink" title="/etc/shorewall/rules"></a><code>/etc/shorewall/rules</code></h3><p><strong>功能</strong>: <code>rules</code> 文件用于定义具体的流量规则。这些规则决定了如何处理进入和离开防火墙的流量。你可以在这个文件中指定哪些流量允许通过，哪些流量被阻止或拒绝。</p>
<p><strong>内容</strong>: 规则通常包括源地址、目的地址、协议、端口号等信息。例如，你可以设置规则来允许从特定 IP 地址访问特定端口，或者阻止来自某个子网的所有流量。</p>
<p><strong>描述</strong></p>
<p>此文件中的条目通过定义对 <code>shorewall-policy(5)</code> 中规定的策略的例外来管理连接的建立。默认情况下，使用连接跟踪会自动允许后续的请求和响应。对于特定的（源，目的地）区域对，规则按它们在文件中的出现顺序进行评估，第一个终止匹配的规则决定请求的处理方式。所有规则都是终止规则，除了 <code>LOG</code> 和 <code>COUNT</code> 规则。</p>
<p><strong>警告</strong></p>
<p>如果你从本地系统到互联网使用了伪装或源地址转换（SNAT），你不能使用 <code>ACCEPT</code> 规则来允许来自互联网的流量进入该系统。你必须使用 <code>DNAT</code> 规则。</p>
<p><strong>文件结构</strong></p>
<p>规则文件被分成多个部分。每个部分由“部分头”引入，部分头是一行以 <code>?SECTION</code> 开头，后面跟着部分名称。</p>
<p><strong>部分列表（按照列出的顺序出现）：</strong></p>
<ol>
<li><strong>默认策略</strong></li>
<li><strong>例外规则</strong></li>
<li><strong>日志规则</strong></li>
<li><strong>计数规则</strong></li>
</ol>
<p>每个部分的具体内容如下：</p>
<ul>
<li><strong>默认策略</strong>：定义基本的处理策略，适用于所有未被其他规则覆盖的连接。</li>
<li><strong>例外规则</strong>：定义对默认策略的例外情况。</li>
<li><strong>日志规则</strong>：定义用于记录连接尝试的规则。</li>
<li><strong>计数规则</strong>：定义用于计数和限制连接的规则。</li>
</ul>
<p><strong>规则文件的结构</strong></p>
<h4 id="SECTION"><a href="#SECTION" class="headerlink" title="?SECTION"></a>?SECTION</h4><p>规则文件被分成多个部分，每个部分由“部分头”引入，部分头是一行以 <code>?SECTION</code> 开头，后面跟着部分名称。部分的顺序非常重要，必须按照以下列出的顺序出现：</p>
<ol>
<li><p><strong>ALL</strong></p>
<ul>
<li>此部分在 Shorewall 4.4.23 中添加。该部分中的规则将被应用于所有连接请求，无论数据包的连接跟踪状态如何，并且在其他部分的规则之前应用。</li>
</ul>
</li>
<li><p><strong>ESTABLISHED</strong></p>
<ul>
<li>处理处于 ESTABLISHED 状态的数据包的规则。</li>
<li>该部分中允许的操作（ACTION）包括 ACCEPT、DROP、REJECT、LOG、NFLOG、NFQUEUE 和 QUEUE。</li>
<li>此部分的末尾会隐式添加一个 ACCEPT 规则。</li>
</ul>
</li>
<li><p><strong>RELATED</strong></p>
<ul>
<li>处理处于 RELATED 状态的数据包的规则。</li>
<li>该部分中允许的操作（ACTION）包括 ACCEPT、DROP、REJECT、LOG、NFLOG、NFQUEUE 和 QUEUE。</li>
<li>此部分的末尾会隐式添加一个规则，该规则调用 <code>RELATED_DISPOSITION</code>（参见 <code>shorewall.conf(5)</code>）。</li>
</ul>
</li>
<li><p><strong>INVALID</strong></p>
<ul>
<li>在 Shorewall 4.5.13 中添加。处理处于 INVALID 状态的数据包的规则。</li>
<li>该部分中允许的操作（ACTION）包括 ACCEPT、DROP、REJECT、LOG、NFLOG、NFQUEUE 和 QUEUE。</li>
<li>此部分的末尾会隐式添加一个规则，该规则调用 <code>INVALID_DISPOSITION</code>（参见 <code>shorewall.conf(5)</code>）。</li>
</ul>
</li>
<li><p><strong>UNTRACKED</strong></p>
<ul>
<li>在 Shorewall 4.5.13 中添加。处理处于 UNTRACKED 状态的数据包的规则。</li>
<li>该部分中允许的操作（ACTION）包括 ACCEPT、DROP、REJECT、LOG、NFLOG、NFQUEUE 和 QUEUE。</li>
<li>此部分的末尾会隐式添加一个规则，该规则调用 <code>UNTRACKED_DISPOSITION</code>（参见 <code>shorewall.conf(5)</code>）。</li>
</ul>
</li>
<li><p><strong>NEW</strong></p>
<ul>
<li>处理处于 NEW 状态的数据包的规则。如果 INVALID 和/或 UNTRACKED 部分为空或未包含，则对应状态的数据包也会在此部分中处理。</li>
<li><strong>注意</strong>：如果你对 Netfilter 的各种连接跟踪状态不够熟悉，建议将所有规则放在 NEW 部分（即在 <code>?SECTION NEW</code> 行之后）。</li>
</ul>
</li>
</ol>
<p><strong>注意事项</strong></p>
<ul>
<li><p>如果你在 <code>shorewall.conf(5)</code> 中指定了 <code>FASTACCEPT=Yes</code>，则 ALL、ESTABLISHED 和 RELATED 部分必须为空。</p>
<p>例外情况是，如果你运行的是 Shorewall 4.4.27 或更高版本，并且你为 <code>RELATED_DISPOSITION</code> 或 <code>RELATED_LOG_LEVEL</code> 指定了非默认值，则可以在 RELATED 部分中包含规则。</p>
</li>
<li><p>你可以省略任何不需要的部分。如果文件中没有出现任何部分头，则所有规则将被视为在 NEW 部分中。</p>
</li>
</ul>
<p><strong>规则定义注意事项</strong></p>
<p>在定义重写目标 IP 地址和/或端口号的规则（即 DNAT 和 REDIRECT 规则）时，重要的是要区分文件中哪些列指定了重写前的数据包特征，哪些列指定了重写后的数据包特征：</p>
<ul>
<li><strong>DEST 列</strong> 指定了重写后数据包的最终目标，可以包括最终的 IP 地址和/或端口号。</li>
<li>其余列指定了重写前数据包的特征。特别是，<strong>ORIGDEST 列</strong> 给出了数据包的原始目标 IP 地址，<strong>DPORT 列</strong> 给出了原始目标端口。</li>
</ul>
<p><strong>这是文件中的列说明（其中列名后跟一个不同的名称，括号中的不同名称用于备用规格语法）：</strong></p>
<h4 id="ACTION-target-log-level-none-tag"><a href="#ACTION-target-log-level-none-tag" class="headerlink" title="ACTION - target[:{log-level|none}[!][:tag]]"></a>ACTION - target[:{log-level|none}[!][:tag]]</h4><p>以下是对匹配规则的连接请求采取的操作。target 必须是以下之一。</p>
<ol>
<li><p><strong>ACCEPT</strong>：允许连接请求。</p>
</li>
<li><p><strong>ACCEPT+</strong>：类似于 ACCEPT，但还排除了该连接在后续匹配的任何 DNAT[-] 或 REDIRECT[-] 规则。使用 IPv6 需要 Shorewall 4.5.14 或更高版本。</p>
</li>
<li><p><strong>ACCEPT!</strong>：类似于 ACCEPT，但规则在 <a href="https://shorewall.org/manpages/shorewall.conf.html" target="_blank" rel="noopener">shorewall.conf(5) </a>中通过 OPTIMIZE=1 设置时，不会被抑制。</p>
<blockquote>
<p>action</p>
<p>在[ shorewall-actions(5) ](<a href="https://shorewall.org/manpages/shorewall-actions.html或" target="_blank" rel="noopener">https://shorewall.org/manpages/shorewall-actions.html或</a> /usr/share/shorewall[6]/actions.std 中声明的操作名称。</p>
</blockquote>
</li>
<li><p><strong>ADD(*<code>ipset</code>*:*<code>flags</code>*[:*<code>timeout</code>*])</strong></p>
<p>在 Shorewall 4.4.12 中添加。使地址和/或端口号添加到指定的 ipset 中。标志指定要添加到集合中的地址或元组，必须与所涉及的 ipset 类型匹配。例如，对于 iphash ipset，可以使用 src 或 dst 标志分别添加源地址或目标地址（请参见 ipset (8) 中的 -A 命令）。<br>从 Shorewall 5.0.3 开始，可以指定一个可选的超时。这是 ipset 中新条目保持有效的秒数，覆盖创建 ipset 时指定的任何超时。<br>ADD 是非终止的。即使数据包匹配规则，也会传递到下一个规则。</p>
</li>
<li><p><strong>AUDIT</strong>[(accept|drop|reject)]：在 Shorewall 4.5.10 中添加。按指定类型审核数据包；如果省略类型，则假定为 drop。需要内核和 iptables 中的 AUDIT_TARGET 支持。</p>
</li>
<li><p><strong>A_ACCEPT</strong>, <strong>A_ACCEPT**</strong>+<strong> and </strong>A_ACCEPT<strong>**!</strong>：在 Shorewall 4.4.20 中添加。分别是 ACCEPT、ACCEPT+ 和 ACCEPT! 的审计版本。需要内核和 iptables 中的 AUDIT_TARGET 支持。A_ACCEPT+ 使用 IPv6 需要 Shorewall 4.5.14 或更高版本。</p>
</li>
<li><p><strong>A_DROP</strong> and <strong>A_DROP!</strong>：在 Shorewall 4.4.20 中添加。分别是 DROP 和 DROP! 的审计版本。需要内核和 iptables 中的 AUDIT_TARGET 支持。</p>
</li>
<li><p><strong>A_REJECT</strong> AND <strong>A_REJECT!</strong>：在 Shorewall 4.4.20 中添加。分别是 REJECT 和 REJECT! 的审计版本。需要内核和 iptables 中的 AUDIT_TARGET 支持。</p>
</li>
<li><p><strong>?COMMENT</strong>：该行的其余部分将作为注释附加到由以下条目生成的 Netfilter 规则中。在 “shorewall show <chain>” 的输出中，注释将用 “/<em> … </em>/“ 分隔。要阻止注释附加到后续规则，只需在单独一行中包含 ?COMMENT。</p>
</li>
<li><p><strong>CONMARK({*<code>mark</code>*})</strong>：在 Shorewall 5.0.7 中添加，CONNMARK 与 MARK 相同，只不过标记的是连接而不是数据包。</p>
</li>
<li><p><strong>CONTINUE</strong>：仅适用于专家。不要处理此（源区域，目标区域）的任何后续规则。如果源和/或目标 IP 地址落入 shorewall-zones(5) 中稍后定义的区域或源或目标区域的父区域中，则该连接请求将传递给为该（些）区域定义的规则。有关更多信息，请参见 shorewall-nesting(5)。</p>
</li>
<li><p><strong>CONTINUE!</strong>：类似于 CONTINUE，但该规则不会被 shorewall.conf(5) 中的 OPTIMIZE=1 抑制。</p>
</li>
<li><p><strong>COUNT</strong>：仅增加规则的数据包和字节计数，然后将数据包传递到下一条规则。</p>
</li>
<li><p><strong>DEL(*<code>ipset</code>*:*<code>flags</code>*)</strong>：在 Shorewall 4.4.12 中添加。从指定的 ipset 中删除一个条目。标志指定要从集合中删除的地址或元组，并且必须匹配涉及的 ipset 类型。例如，对于 iphash ipset，可以分别使用 src 或 dst 标志删除源或目标地址（参见 ipset(8) 中的 -D 命令）。DEL 是非终止的。即使数据包匹配规则，它也会传递到下一条规则。</p>
</li>
<li><p><strong>DNAT</strong>：将请求转发到另一系统（可选地到另一个端口）。使用 IPv6 需要 Shorewall 4.5.14 或更高版本。</p>
</li>
<li><p><strong>DNAT-</strong>：仅限高级用户。类似于 DNAT，但只生成 DNAT iptables 规则，而不生成伴随的 ACCEPT 规则。使用 IPv6 需要 Shorewall 4.5.14 或更高版本。</p>
</li>
<li><p><strong>DROP</strong>：忽略请求。</p>
</li>
<li><p><strong>DROP!</strong>：类似于 DROP，但该规则不会被 shorewall.conf(5) 中的 OPTIMIZE=1 抑制。</p>
</li>
<li><p><strong>HELPER</strong>：在 Shorewall 4.5.7 中添加。该操作要求 HELPER 列包含要与匹配此连接的连接关联的 Netfilter 帮助程序的名称。只能在 NEW 部分中指定，并且在适用的策略为 ACCEPT 时非常有用。在 HELPER 规则中不应指定目标区域。</p>
</li>
<li><p><strong>INLINE</strong>[(<em><code>action</code></em>)]：</p>
<p>在 Shorewall 4.5.16 中添加。此操作允许您使用 iptables 语法自行构建大部分规则。您指定的部分必须跟随两个分号（’;;’），并且完全是自由格式的。如果规则的目标（即 ‘j’ 后面的部分）是 Shorewall 在 ACTION 列中支持的内容，则可以将其括在括号中（例如，INLINE(ACCEPT)）。否则，您可以在分号后包含它。在这种情况下，您必须将目标声明为 shorewall-actions(5) 中的内置操作。</p>
<p>使用 INLINE 时需要注意的一些事项：</p>
<ul>
<li>p、s、d、i、o、policy 和 state 匹配（state 或 conntrack —ctstate）匹配将始终出现在规则的前面，顺序如上所述。</li>
<li>当指定多个匹配项时，编译器将按出现的顺序保留它们（不包括上述列出的匹配项），但它们不一定会出现在生成规则的末尾。例如，如果在 SOURCE 和/或 DEST 列中指定了地址，它们生成的匹配项将出现在使用 ‘;;’ 或 ‘;’ 指定的匹配项之后。</li>
</ul>
</li>
<li><p><strong>IPTABLES</strong>({<em><code>iptables-target</code></em>              [<em><code>option</code></em> …])：</p>
<p>仅限 IPv4。此操作允许您指定一个带选项的 iptables 目标（例如，’IPTABLES(MARK —set-xmark 0x01/0xff)’）。如果 iptables-target 不是 Shorewall 识别的目标，将会出现以下错误消息：</p>
<pre><code>ERROR: Unknown target (iptables-target)
</code></pre><p>如果您将 iptables-target 添加为 shorewall-actions(5) 中的内置操作，则可以消除此错误消息。</p>
<p><strong>重要</strong></p>
<p>如果您将 REJECT 作为 iptables-target，则规则的目标将是 iptables 的 REJECT 目标，而不是 Shorewall 内置的 ‘reject’ 链，后者在 ACTION 列中指定 REJECT 时使用。</p>
</li>
<li><p><strong>IP6TABLES</strong>({<em><code>ip6tables-target</code></em>              [<em><code>option</code></em> …])：</p>
<p>仅限 IPv4。此操作允许您指定一个带选项的 iptables 目标（例如，’IPTABLES(MARK —set-xmark 0x01/0xff)’）。如果 iptables-target 不是 Shorewall 识别的目标，将会出现以下错误消息：</p>
<pre><code>ERROR: Unknown target (iptables-target)
</code></pre><p>如果您将 iptables-target 添加为 shorewall-actions(5) 中的内置操作，则可以消除此错误消息。</p>
<p><strong>重要</strong></p>
<p>如果您将 REJECT 作为 iptables-target，则规则的目标将是 iptables 的 REJECT 目标，而不是 Shorewall 内置的 ‘reject’ 链，后者在 ACTION 列中指定 REJECT 时使用。</p>
</li>
<li><p><strong>LOG:*<code>level</code>*</strong>：仅记录数据包并继续处理下一个规则。</p>
<p><em>macro**</em>[(*<code>macrotarget</code>*)]**</p>
<p>指定在名为 <code>macro.macro</code> 的文件中定义的宏。如果宏接受一个操作参数（查看宏源代码以确定其 TARGET 列中是否有 PARAM），则宏名称后跟带括号的 macrotarget（ACCEPT、DROP、REJECT 等），作为参数的替代。</p>
<p>示例：FTP(ACCEPT)。</p>
<p>以前的语法，其中宏名称和目标通过斜杠分隔（例如，FTP/ACCEPT），仍然允许使用，但已被弃用。</p>
</li>
<li><p><strong>MARK({*<code>mark</code>*})</strong>：</p>
<p>指定一个数据包标记值。</p>
<p>在 Shorewall 5.0.7 中添加，MARK 需要内核和 iptables 中的 “Mark in filter table” 支持。</p>
<p>通常会设置当前数据包的标记值。如果前面有一个竖线 (“|”)，则标记值将与当前标记值进行逻辑 OR 运算以产生新的标记值。如果前面有一个&amp;符号 (“&amp;”)，则将与当前标记值进行逻辑 AND 运算以产生新的标记值。</p>
<p>“|” 和 “&amp;” 都需要内核和 iptables 中的 Extended MARK Target 支持。</p>
<p>标记值后面可以选择性地跟一个 “/“ 和一个掩码值（用于确定实际设置的连接标记位）。当指定掩码时，将标记值与掩码进行逻辑 AND 运算的结果必须与标记值相同。</p>
</li>
<li><p><strong>NFLOG</strong>[(<em><code>nflog-parameters</code></em>)]：</p>
<p>在 Shorewall 4.5.9.3 中添加。通过 netlink 套接字将匹配的数据包队列到后台日志守护进程，然后继续处理下一个规则。有关更多信息，请参见 <a href="https://shorewall.org/shorewall_logging.html" target="_blank" rel="noopener">Shorewall Logging</a>。</p>
<p>nflog-parameters 是一个由最多 3 个数字组成的逗号分隔列表：</p>
<ul>
<li>第一个数字指定 netlink 组（0-65535）。如果省略（例如，NFLOG(,0,10)），则假设为 0。</li>
<li>第二个数字指定要复制的最大字节数。如果省略，则假设为 0（没有限制）。</li>
<li>第三个数字指定应在内核中缓冲的日志消息数量，然后再发送到用户空间。默认值为 1。</li>
</ul>
<p>NFLOG 类似于 LOG:NFLOG[(nflog-parameters)]，但当在动作或宏体中使用此 ACTION 时，日志级别不会改变，而调用该动作或宏时指定了日志级别。</p>
</li>
<li><p><strong>NFQUEUE[([queuenumber1[:queuenumber2[c]][,bypass]]|bypass)]</strong>：</p>
<p>使用 nfnetlink_queue 机制将数据包排队到用户空间应用程序。如果未指定 queuenumber1，则默认为队列零（0）。从 Shorewall 4.6.10 开始，可以使用关键字 bypass。如果没有用户空间程序监听 NFQUEUE，默认情况下所有要排队的数据包都会被丢弃。当使用此选项时，NFQUEUE 规则的行为类似于 ACCEPT。还可以从 Shorewall 4.6.10 开始指定第二个队列号（queuenumber2）。这指定了要使用的队列范围。数据包将在指定的队列中进行负载均衡。这对于多核系统非常有用：在队列 x、x+1、… x+n 上启动多个用户空间程序实例，并使用 “x:x+n”。属于同一连接的数据包将放入同一 nfqueue 中。</p>
<p>从 Shorewall 5.1.0 开始，queuenumber2 后面可以跟随字母 ‘c’，表示将使用 CPU ID 作为索引来将数据包映射到队列中。这样可以提高性能，如果每个 CPU 都有一个队列。需要内核和 iptables 中的 NFQUEUE CPU Fanout 功能。</p>
</li>
<li><p><strong>NFQUEUE![([queuenumber1[:queuenumber2[c]][,bypass]]|bypass)]</strong>：与 NFQUEUE 类似，但排除了规则被 <code>shorewall.conf</code> 中的 <code>OPTIMIZE=1</code> 配置抑制的情况。</p>
</li>
<li><p><strong>NONAT</strong>：将连接排除在任何后续的 DNAT[-] 或 REDIRECT[-] 规则之外，但不生成接收流量的规则。使用 IPv6 时需要 Shorewall 4.5.14 或更高版本。</p>
</li>
<li><p><strong>QUEUE</strong>：将数据包排队到用户空间应用程序（例如 ftwall）。应用程序可以重新插入数据包以进行进一步处理。</p>
</li>
<li><p><strong>QUEUE!</strong>：类似于 QUEUE，但免于被 shorewall.conf(5) 中的 OPTIMIZE=1 设置抑制。</p>
</li>
<li><p><strong>REJECT[(*<code>option</code>*)]</strong>：</p>
<p>拒绝请求并返回一个 icmp-unreachable 或 RST 数据包。如果没有传递选项，Shorewall 将根据数据包的协议选择适当的选项。</p>
<p>从 Shorewall 5.0.8 开始，可以在选项参数中指定拒绝的类型。有效的 IPv4 选项值包括：</p>
<ul>
<li>icmp-net-unreachable</li>
<li>icmp-host-unreachable</li>
<li>icmp-port-unreachable</li>
<li>icmp-proto-unreachable</li>
<li>icmp-net-prohibited</li>
<li>icmp-host-prohibited</li>
<li>icmp-admin-prohibited</li>
<li>icmp-tcp-reset（PROTO 列必须指定 TCP）。从 Shorewall 5.1.3 开始，也可以指定为 tcp-reset。</li>
</ul>
<p>有效的 IPv6 选项值包括：</p>
<ul>
<li>icmp6-no-route</li>
<li>no-route</li>
<li>icmp6-adm-prohibited</li>
<li>adm-prohibited</li>
<li>icmp6-addr-unreachable</li>
<li>addr-unreach</li>
<li>icmp6-port-unreachable</li>
<li>tcp-reset（PROTO 列必须指定 TCP）</li>
</ul>
</li>
<li><p><strong>REJECT!</strong>：类似于 REJECT，但免于被 shorewall.conf(5) 中的 OPTIMIZE=1 设置抑制。</p>
</li>
<li><p><strong>REDIRECT</strong>：将请求重定向到运行在防火墙上的服务器。使用 IPv6 时需要 Shorewall 4.5.14 或更高版本。</p>
</li>
<li><p><strong>REDIRECT-</strong>：高级用户专用。类似于 REDIRECT，但仅生成 REDIRECT iptables 规则，而不生成伴随的 ACCEPT 规则。使用 IPv6 时需要 Shorewall 4.5.14 或更高版本。</p>
</li>
<li><p><strong>TARPIT</strong> [(<strong>tarpit</strong> | <strong>honeypot</strong> | <strong>reset</strong>)]：</p>
<p>从 Shorewall 4.6.6 开始添加。</p>
<p>TARPIT 捕获并保持传入的 TCP 连接而不使用本地每连接资源。</p>
<p>TARPIT 仅在 PROTO 列设置为 TCP (6) 时有效，并且对应用程序是完全无关的。此模块会响应 TCP 请求并像监听服务器一样进行交互，但除了发送 ACK 或 RST 之外，不会发送数据。传入的数据包会被忽略和丢弃。攻击者最终会终止会话。此模块允许将攻击的初始数据包捕获供其他软件检查。在大多数情况下，这足以确定攻击的性质。</p>
<p>这提供了类似 LaBrea 的功能，但不需要专用的硬件或 IP。任何通常会 DROP 或 REJECT 的 TCP 端口都可以转而成为 tarpit。</p>
<p>目标接受一个可选参数：</p>
<ul>
<li><p><strong>tarpit</strong></p>
<p>这是默认模式，完成与攻击者的连接，但将窗口大小限制为 0，从而使攻击者等待很长时间。虽然他在保持连接状态并尝试继续每 60-240 秒时，我们保持状态轻量。尝试关闭连接会被忽略，迫使远程方在 12-24 分钟内超时连接。</p>
</li>
<li><p><strong>honeypot</strong></p>
<p>这种模式与攻击者完成连接，但信号正常的窗口大小，以便远程方尝试发送数据，通常带有一些非常恶意的攻击尝试。我们可以捕获这些数据包以进行解码和进一步分析。该模块不发送任何数据，因此，如果远程方期望应用程序级别的响应，则游戏结束。</p>
</li>
<li><p><strong>reset</strong></p>
<p>这种模式很方便，因为我们可以发送内联的 RST（重置）。没有其他功能。</p>
</li>
</ul>
</li>
<li><p><strong>ULOG</strong>[(<em><code>ulog-parameters</code></em>)]：</p>
<p>仅支持 IPv4。从 Shorewall 4.5.10 开始添加。将匹配的数据包排队到后端日志记录守护程序，通过 netlink 套接字，然后继续执行下一个规则。请参见 shorewall-logging(5)。</p>
<p>类似于 LOG:ULOG[(ulog-parameters)]，只是当此 ACTION 用于动作或宏体时，日志级别不会更改，并且该动作或宏的调用指定了一个日志级别。</p>
</li>
</ol>
<p><strong>日志记录相关的动作说明：</strong></p>
<ul>
<li><p>目标可以选择性地跟随 “:” 和 syslog 日志级别（例如，REJECT:info 或 Web(ACCEPT):debug）。这会将数据包记录到指定的级别。请注意，如果 ACTION 涉及目的网络地址转换（如 DNAT、REDIRECT 等），则数据包会在目标地址被重写之前进行记录。</p>
</li>
<li><p>如果 ACTION 指定了在 <code>shorewall-actions(5)</code> 或 <code>/usr/share/shorewall/actions.std</code> 中声明的动作：</p>
<ul>
<li>如果日志级别后跟 “!”，则动作中的所有规则都以该日志级别记录。</li>
<li>如果日志级别后未跟 “!”，则仅记录那些未指定日志的动作规则。</li>
</ul>
<p>特殊日志级别 <code>none!</code> 可以抑制动作的日志记录。</p>
</li>
<li><p>你也可以指定 ULOG（仅限 IPv4）或 NFLOG（必须是大写）作为日志级别。这将把日志记录到 ULOG 或 NFLOG 目标，以通过 ulogd 进行路由（见 <code>shorewall-logging(5)</code>）。</p>
</li>
<li><p>指定日志记录的动作可以跟随一个日志标签（一个字母数字字符串），该标签会附加到由 LOGPREFIX（在 <code>shorewall.conf(5)</code> 中）生成的字符串的末尾。</p>
<p>例如：<code>ACCEPT:info:ftp</code> 将在由 LOGPREFIX 设置生成的日志前缀末尾添加 ‘ftp ‘。</p>
</li>
</ul>
<h4 id="SOURCE-source-spec-…"><a href="#SOURCE-source-spec-…" class="headerlink" title="SOURCE - source-spec[,…]"></a>SOURCE - source-spec[,…]</h4><p><strong>源主机的规则适用说明：</strong></p>
<p><code>source-spec</code> 是以下之一：</p>
<ul>
<li><p><strong>zone[,…[+]]</strong></p>
<p>区域名称，定义在 <code>shorewall-zones(5)</code> 中。当仅指定区域名称时，数据包源可以是该区域中的任何主机。</p>
<p>区域名称还可以是以下之一：</p>
<ul>
<li><p><strong>all[+]</strong></p>
<p>“all” 表示“所有区域，包括防火墙区域”。通常，“all” 忽略区域内的流量，但可以通过指定“+”来包括区域内流量。</p>
</li>
<li><p><strong>any[+]</strong></p>
<p>“any” 在没有嵌套区域的情况下等同于“all”。当有嵌套区域时，“any” 仅指顶级区域（没有父区域的区域）。注意，“any” 排除了所有 vserver 区域，因为这些区域嵌套在防火墙区域内。</p>
</li>
<li><p><strong>none</strong></p>
<p>当在 <code>SOURCE</code> 或 <code>DEST</code> 列中使用“none”时，规则将被忽略。</p>
</li>
<li><p>类似于 <code>all</code> 和 <code>any</code>，在列出多个区域时，区域内流量通常会被排除。通过在列表末尾添加加号（“+”），可以包括区域内流量。</p>
</li>
<li><p><code>all</code> 和 <code>any</code> 可以跟随感叹号（“!”）和逗号分隔的区域名称列表，以排除指定的区域。</p>
</li>
</ul>
</li>
<li><p><strong>zone:[!]interface</strong></p>
<p>当使用这种形式时，<code>interface</code> 必须是与命名区域相关联的接口名称，定义在 <code>shorewall-interfaces(5)</code> 或 <code>shorewall-hosts(5)</code> 中。仅从通过指定接口到达的区域内主机的包将匹配规则。</p>
<p>从 Shorewall 5.2.1 开始，接口前可以加上“!”以匹配与区域相关联的所有接口，但排除指定的接口。</p>
</li>
<li><p><strong>zone:address[,…]</strong></p>
<p>其中 <code>address</code> 可以是：</p>
<ul>
<li><p>主机或网络 IP 地址。网络地址后可以跟随排除（见 <code>shorewall-exclusion(5)</code>）。</p>
</li>
<li><p>地址范围，使用低地址-高地址的语法指定。</p>
</li>
<li><p><strong>+ipset</strong>，其中 <code>ipset</code> 是 ipset 的名称，前面必须加上加号（“+”）。</p>
</li>
<li><p>Shorewall 格式的 MAC 地址（前面加上波浪号（“~”），并用短横线分隔十六进制字节值，例如“~00-0a-f6-04-9c-7d”）。</p>
</li>
<li><p><strong>^country-code</strong>，其中 <code>country-code</code> 是两个字符的 ISO-3661 国家代码，前面加上插入符（“^”）。</p>
</li>
<li><p><strong>^country-code-list</strong>，其中 <code>country-code-list</code> 是最多 15 个 ISO-3661 国家代码的逗号分隔列表，括在方括号中（“[…]”）。</p>
</li>
<li><p>防火墙接口的主要 IP 地址可以通过使用与 <code>shorewall-interfaces(5)</code> 中的 INTERFACE 列中的逻辑名称相同的接口名称，并在前面加上“&amp;”符号来指定。</p>
</li>
</ul>
</li>
<li><p><strong>zone:interface:address[,…]</strong></p>
<p>这种形式结合了前面的两个规则，要求数据包的来源接口和地址都必须匹配。</p>
</li>
<li><p><strong>zone:exclusion</strong></p>
<p>这种形式匹配源主机 IP 地址不匹配排除列表中的任何条目的数据包（见 <code>shorewall-exclusion(5)</code>）。</p>
</li>
<li><p><strong>zone:interface:exclusion</strong></p>
<p>这种形式匹配从指定接口进入的，源主机地址不匹配排除列表中的任何条目的数据包。</p>
</li>
</ul>
<p>从 Shorewall 5.1.0 开始，可以列出多个 <code>source-spec</code>，只要使用扩展形式的 <code>source-spec</code>：</p>
<ul>
<li><p><strong>zone:(interface)</strong></p>
</li>
<li><p><strong>zone:(address[,…])</strong></p>
</li>
<li><p><strong>zone:(interface:address[,…])</strong></p>
</li>
<li><p><strong>zone:(exclusion)</strong></p>
</li>
<li><p><strong>zone:(interface:exclusion)</strong></p>
</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li><p><strong>dmz:192.168.2.2</strong></p>
<p>DMZ 区域中的主机 192.168.2.2</p>
</li>
<li><p><strong>net:155.186.235.0/24</strong></p>
<p>互联网中的子网 155.186.235.0/24</p>
</li>
<li><p><strong>loc:192.168.1.1,192.168.1.2</strong></p>
<p>本地区域中的主机 192.168.1.1 和 192.168.1.2</p>
</li>
<li><p><strong>loc:~00-A0-C9-15-39-78</strong></p>
<p>本地区域中 MAC 地址为 00:A0:C9:15:39:78 的主机</p>
</li>
<li><p><strong>net:192.0.2.11-192.0.2.17</strong></p>
<p>net 区域中的主机 192.0.2.11-192.0.2.17</p>
</li>
<li><p><strong>net:!192.0.2.11-192.0.2.17</strong></p>
<p>net 区域中除 192.0.2.11-192.0.2.17 外的所有主机</p>
</li>
<li><p><strong>net:155.186.235.0/24!155.186.235.16/28</strong></p>
<p>互联网中的子网 155.186.235.0/24 除了 155.186.235.16/28</p>
</li>
<li><p><strong>$FW:&amp;eth0</strong></p>
<p>防火墙区域中 eth0 的主要 IP 地址</p>
</li>
<li><p><strong>loc,dmz</strong></p>
<p>loc 和 dmz 区域中的主机</p>
</li>
<li><p><strong>all!dmz</strong></p>
<p>除了 dmz 区域的所有区域</p>
</li>
<li><p><strong>all+!$FW</strong></p>
<p>除了防火墙区域，并适用于区域内流量</p>
</li>
<li><p><strong>net:^CN</strong></p>
<p>中国</p>
</li>
<li><p><strong>loc:(eth1:1.2.3.4,2.3.4.5),dmz:(eth2:5.6.7.8,9.10.11.12),net</strong></p>
<p>当数据包通过 eth1 到达时，loc 区域中的主机 1.2.3.4 和 2.3.4.5；当数据包通过 eth2 到达时，dmz 区域中的主机 5.6.7.8 和 9.10.11.12；以及所有 net 区域中的主机。</p>
</li>
<li><p><strong>dmz:[2002:ce7c:2b4:1::2]</strong></p>
<p>DMZ 区域中的主机 2002:ce7c:2b4:1::2</p>
</li>
<li><p><strong>net:2001:4d48:ad51:24::/64</strong></p>
<p>互联网中的子网 2001:4d48:ad51:24::/64</p>
</li>
<li><p><strong>loc:[2002:cec792b4:1::2],[2002:cec792b4:1::44]</strong></p>
<p>本地区域中的主机 2002:cec792b4:1::2 和 2002:cec792b4:1::44</p>
</li>
<li><p><strong>net:[2001:4d48:ad51:24::]/64![2001:4d48:ad51:24:6::]/80</strong></p>
<p>互联网中的子网 2001:4d48:ad51:24::/64 除了 2001:4d48:ad51:24:6::/80</p>
</li>
</ul>
<h4 id="DEST-dest-spec-…"><a href="#DEST-dest-spec-…" class="headerlink" title="DEST - dest-spec[,…]"></a>DEST - dest-spec[,…]</h4><p><strong>目标主机规则的详细说明：</strong></p>
<ul>
<li><p><strong>zone[,…[+]]</strong></p>
<p>匹配目标为指定区域中的任何主机。区域名称可以是：</p>
<ul>
<li><p><strong>all[+]</strong></p>
<p>匹配所有区域，包括防火墙区域。通常情况下，<code>all</code> 排除区域内流量，但通过添加 <code>+</code> 可以包含区域内流量。</p>
</li>
<li><p><strong>any[+]</strong></p>
<p>当没有嵌套区域时，<code>any</code> 等同于 <code>all</code>。如果有嵌套区域，则 <code>any</code> 仅指顶层区域（没有父区域）。<code>any</code> 不包括所有虚拟服务器区域，因为这些区域嵌套在防火墙区域内。</p>
</li>
<li><p><strong>none</strong></p>
<p>使用 <code>none</code> 作为 SOURCE 或 DEST 列时，规则被忽略。</p>
</li>
<li><p><strong>all</strong> 和 <strong>any</strong> 可以用感叹号 (<code>!</code>) 和逗号分隔的区域名称列表来排除某些区域。</p>
</li>
</ul>
</li>
<li><p><strong>zone:[!]interface</strong></p>
<p>目标必须是通过指定接口发送到的区域中的主机。接口名称必须与 <code>shorewall-interfaces(5)</code> 或 <code>shorewall-hosts(5)</code> 中指定的区域关联。自 Shorewall 5.2.1 起，可以使用 <code>!</code> 前缀来匹配所有与区域关联的接口，除了指定的那个。</p>
</li>
<li><p><strong>zone:address[,…]</strong></p>
<p>地址可以是：</p>
<ul>
<li><p>主机或网络 IP 地址。网络地址可以附加排除条件（见 <code>shorewall-exclusion(5)</code>）。</p>
</li>
<li><p>使用低地址-高地址语法指定的地址范围。</p>
</li>
<li><p>+ipset，<code>ipset</code> 是一个 ipset 的名称，必须以加号（<code>+</code>）前缀。</p>
</li>
<li><p>^country-code，其中 <code>country-code</code> 是一个两位的 ISO-3661 国家代码，前面有一个插入符号（<code>^</code>）。</p>
</li>
<li><p>^country-code-list，其中 <code>country-code-list</code> 是一个最多包含 15 个 ISO-3661 国家代码的逗号分隔列表，放在方括号（<code>[...]</code>）中。</p>
</li>
<li><p>防火墙接口的主要 IP 地址可以通过 <code>&amp;</code> 后跟接口的逻辑名称来指定，该名称在 <code>shorewall-interfaces(5)</code> 的 INTERFACE 列中找到。</p>
</li>
</ul>
</li>
<li><p><strong>zone:[!]interface:address[,…]</strong></p>
<p>这种形式结合了前面的两种形式，要求目标接口和地址都匹配。自 Shorewall 5.2.1 起，可以使用 <code>!</code> 前缀来匹配所有与区域关联的接口，除了指定的那个。</p>
</li>
<li><p><strong>zone:exclusion</strong></p>
<p>匹配目标 IP 地址不匹配排除列表中的任何条目的数据包（见 <code>shorewall-exclusion(5)</code>）。</p>
</li>
<li><p><strong>zone:[!]interface:exclusion</strong></p>
<p>匹配目标为指定区域，通过指定接口离开的数据包，其中目标地址不匹配排除列表中的任何条目。自 Shorewall 5.2.1 起，可以使用 <code>!</code> 前缀来匹配所有与区域关联的接口，除了指定的那个。</p>
</li>
<li><p><strong>[zone]:[server-IP][:port-or-port-range[:random]]</strong></p>
<p>适用于 DNAT[-] 或 REDIRECT[-] 操作。如果是 REDIRECT 规则，区域可以省略（假设为 <code>$FW</code>），而在 DNAT-、REDIRECT- 和 NONAT 规则中必须省略区域。</p>
<ul>
<li><p><code>server-IP</code> 不是 REDIRECT 规则允许的，并且在 DNAT[-] 规则中可以省略，只要包含 <code>port-or-port-range</code>。</p>
<ul>
<li><code>server-IP</code>：要发送数据包的服务器 IP 地址。可以是一个 IP 地址范围，低地址和高地址用破折号（<code>-</code>）分隔，连接在范围内的 IP 地址之间分配。</li>
</ul>
</li>
<li><p><code>port-or-port-range</code>：</p>
<ul>
<li><p>整数端口号，范围为 1 - 65535。</p>
</li>
<li><p>/etc/services 中的服务名称。</p>
</li>
<li><p>端口范围，低整数端口号和高整数端口号用破折号（<code>-</code>）分隔。连接在范围内的端口之间分配。</p>
</li>
</ul>
</li>
<li><p>如果指定了 <code>random</code>，端口映射将被随机化。</p>
</li>
</ul>
</li>
</ul>
<p>如果 DEST 区域是一个 bport 区域，则：</p>
<ul>
<li><p>SOURCE 必须是 <code>all[+]</code>，或</p>
</li>
<li><p>SOURCE 区域必须是与相同桥接器关联的另一个 bport 区域，或</p>
</li>
<li><p>SOURCE 区域必须是与仅相同桥接器关联的 ipv4 区域。</p>
</li>
</ul>
<p><strong>目标主机（DEST）规则的详细说明：</strong></p>
<p>从 Shorewall 5.1.0 开始，可以列出多个 <code>dest-spec</code>，前提是使用扩展形式的 <code>source-spec</code>：</p>
<ul>
<li><p><strong>zone:(interface)</strong></p>
<p>匹配目标为指定区域中的主机，并且数据包通过指定接口发送。</p>
</li>
<li><p><strong>zone:(address[,…])</strong></p>
<p>匹配目标为指定区域中的主机，并且数据包的目标地址与给定地址匹配。</p>
</li>
<li><p><strong>zone:(interface:address[,…])</strong></p>
<p>匹配目标为指定区域中的主机，并且数据包的目标地址与给定地址匹配，且数据包通过指定接口发送。</p>
</li>
<li><p><strong>zone:(exclusion)</strong></p>
<p>匹配目标为指定区域中的主机，但目标地址不在排除列表中（见 <code>shorewall-exclusion(5)</code>）。</p>
</li>
<li><p><strong>zone:(interface:exclusion)</strong></p>
<p>匹配目标为指定区域中的主机，数据包通过指定接口发送，且目标地址不在排除列表中。</p>
</li>
</ul>
<p><strong>多个 <code>dest-spec</code> 在 DNAT[-] 和 REDIRECT[-] 规则中不被允许。</strong></p>
<p><strong>示例：</strong></p>
<ul>
<li><p><strong>dmz:192.168.2.2</strong></p>
<p>匹配 DMZ 区域中的主机 192.168.2.2。</p>
</li>
<li><p><strong>net:155.186.235.0/24</strong></p>
<p>匹配 Internet 上的子网 155.186.235.0/24。</p>
</li>
<li><p><strong>loc:192.168.1.1,192.168.1.2</strong></p>
<p>匹配本地区域中的主机 192.168.1.1 和 192.168.1.2。</p>
</li>
<li><p><strong>net:192.0.2.11-192.0.2.17</strong></p>
<p>匹配 net 区域中的主机 192.0.2.11 到 192.0.2.17。</p>
</li>
<li><p><strong>net:!192.0.2.11-192.0.2.17</strong></p>
<p>匹配 net 区域中的所有主机，但排除 192.0.2.11 到 192.0.2.17。</p>
</li>
<li><p><strong>net:155.186.235.0/24!155.186.235.16/28</strong></p>
<p>匹配 Internet 上的子网 155.186.235.0/24，但排除 155.186.235.16/28。</p>
</li>
<li><p><strong>$FW:&amp;eth0</strong></p>
<p>匹配防火墙区域中 eth0 接口的主要 IP 地址。</p>
</li>
<li><p><strong>loc,dmz</strong></p>
<p>匹配本地和 DMZ 区域中的主机。</p>
</li>
<li><p><strong>all!dmz</strong></p>
<p>匹配除 DMZ 区域外的所有区域中的主机。</p>
</li>
<li><p><strong>net:^CN</strong></p>
<p>匹配来自中国的主机。</p>
</li>
<li><p><strong>dmz:192.168.10.4:25</strong></p>
<p>在 DMZ 区域中，匹配目标 IP 为 192.168.10.4 的服务器上的端口 25（适用于 DNAT 规则）。</p>
</li>
<li><p><strong>loc:(eth1:1.2.3.4,2.3.4.5),dmz:(eth2:5.6.7.8,9.10.11.12),net</strong></p>
<p>匹配：</p>
<ul>
<li>在 loc 区域中，通过 eth1 接口到达的主机 1.2.3.4 和 2.3.4.5。</li>
<li>在 DMZ 区域中，通过 eth2 接口到达的主机 5.6.7.8 和 9.10.11.12。</li>
<li>以及 net 区域中的所有主机。</li>
</ul>
</li>
</ul>
<h4 id="PROTO-tcp-syn-ipp2p-ipp2p-udp-ipp2p-all-protocol-number-protocol-name-all"><a href="#PROTO-tcp-syn-ipp2p-ipp2p-udp-ipp2p-all-protocol-number-protocol-name-all" class="headerlink" title="PROTO- {-|tcp:[!]syn|ipp2p|ipp2p:udp|ipp2p:all|protocol-number|protocol-name|all}"></a>PROTO- {-|tcp:[!]syn|ipp2p|ipp2p:udp|ipp2p:all|protocol-number|protocol-name|all}</h4><p><strong>可选协议 - ipp2p* 需要内核和 iptables 支持 ipp2p 匹配模块。</strong></p>
<ul>
<li><p><strong>tcp:syn</strong> 表示匹配 TCP 数据包，要求 SYN 标志被设置，同时 RST、ACK 和 FIN 标志必须被重置。 </p>
</li>
<li><p>从 Shorewall 5.1.3 开始，你还可以指定 <strong>tcp:!syn</strong>，这表示匹配 SYN 标志未设置，或者 RST、ACK 或 FIN 标志被设置的 TCP 数据包。</p>
</li>
<li><p>从 Shorewall 4.4.19 开始，此字段可以包含以逗号分隔的协议号和/或协议名称的列表。</p>
</li>
</ul>
<h4 id="DPORT-port-name-number-or-range-port-name-number-or-range-…-ipset"><a href="#DPORT-port-name-number-or-range-port-name-number-or-range-…-ipset" class="headerlink" title="DPORT - {-|port-name-number-or-range[,port-name-number-or-range]…|+ipset}"></a>DPORT - {-|port-name-number-or-range[,port-name-number-or-range]…|+ipset}</h4><p><strong>可选目标端口。</strong></p>
<ul>
<li><p>这是一个用逗号分隔的端口名称列表（来自 services(5)）、端口号或端口范围；如果协议是 ICMP，这一列被解释为目标 ICMP 类型。ICMP 类型可以指定为数字类型、带有斜杠分隔的数字类型和代码（例如，3/4），或者类型名称。有关更多信息，请参见 <a href="https://shorewall.org/configuration_file_basics.htm#ICMP" target="_blank" rel="noopener">ICMP 参考</a>。请注意，在 Shorewall 4.4.19 之前，只能列出一个 ICMP 类型。</p>
</li>
<li><p>如果协议是 ipp2p，则此列被解释为一个 ipp2p 选项，不包括前导的 “—“（例如 bit-torrent）。如果未给出端口，则默认使用 ipp2p。</p>
</li>
<li><p>端口范围的表示方式为低端口:高端口。</p>
</li>
<li><p>如果协议为 all，则此列被忽略，但如果提供了其他任何列，则必须填写此列。在这种情况下，建议将此字段设置为破折号（-）。</p>
</li>
<li><p>如果你的内核支持多端口匹配，那么在下列条件下，仅会生成一个 Netfilter 规则：</p>
<ol>
<li>列表中列出了 15 个或更少的端口。</li>
<li>不包含端口范围，或你的内核和 iptables 支持扩展的多端口匹配。</li>
</ol>
</li>
<li><p>从 Shorewall 4.6.0 开始，可以在此列中指定一个 ipset 名称。这用于与 bitmap:port ipsets 配合使用。</p>
</li>
<li><p>此列之前标记为 DEST PORT(S)。</p>
</li>
</ul>
<h4 id="SPORT-port-name-number-or-range-port-name-number-or-range-…-ipset"><a href="#SPORT-port-name-number-or-range-port-name-number-or-range-…-ipset" class="headerlink" title="SPORT - {-|port-name-number-or-range[,port-name-number-or-range]…|+ipset}"></a>SPORT - {-|port-name-number-or-range[,port-name-number-or-range]…|+ipset}</h4><p><strong>客户端使用的可选端口。</strong> 如果省略此项，则接受任何源端口。指定方式为用逗号分隔的端口名称、端口号或端口范围。</p>
<ul>
<li>从 Shorewall 4.5.15 开始，如果 DPORT 列不为空，你可以在此列中使用 “=”。这将使规则在数据包的源端口或目标端口与 DEST PORTS(S) 中指定的端口之一匹配时生效。使用 “=” 需要你的 iptables 和内核支持多端口匹配。</li>
</ul>
<p><strong>警告</strong></p>
<ul>
<li><p>除非你真正理解 IP，否则应将此列留空或填入破折号（-）。大多数尝试使用此列的人会出错。</p>
</li>
<li><p>如果你不想限制客户端端口，但需要在下一列指定 ORIGDEST，则请在此列中填入 “-“。</p>
</li>
<li><p>如果你的内核支持多端口匹配，则在以下条件下，仅会生成一个 Netfilter 规则：</p>
<ol>
<li>列表中列出了 15 个或更少的端口。</li>
<li>不包含端口范围，或你的内核和 iptables 支持扩展的多端口匹配。</li>
</ol>
</li>
<li><p>从 Shorewall 4.6.0 开始，可以在此列中指定一个 ipset 名称。这用于与 bitmap:port ipsets 配合使用。</p>
</li>
<li><p>此列之前标记为 SOURCE PORT(S)。</p>
</li>
</ul>
<h4 id="ORIGDEST-address-address-…-exclusion-exclusion"><a href="#ORIGDEST-address-address-…-exclusion-exclusion" class="headerlink" title="ORIGDEST - [-|address[,address]…[exclusion]|exclusion]"></a>ORIGDEST - [-|address[,address]…[exclusion]|exclusion]</h4><p><strong>可选项。</strong> 如果 ACTION 是 DNAT[-] 或 REDIRECT[-]，则如果此列包含的地址与 DEST 列中给定的 IP 地址不同，则目标为该地址的连接将被转发到 DEST 列中指定的 IP 和端口。</p>
<ul>
<li><p>还可以使用逗号分隔的地址列表。这在使用 REDIRECT 目标时特别有用，你可以将流量重定向到特定主机集合。最后，如果地址列表以 “!”（排除）开头，则规则仅在连接请求中的原始目标地址与列出的任何地址不匹配时才会生效。</p>
</li>
<li><p>从 Shorewall 4.4.17 开始，可以通过在接口逻辑名称前加上与号（’&amp;’）来指定防火墙接口的主要 IP 地址，接口逻辑名称可在 shorewall-interfaces (5) 的 INTERFACE 列中找到。</p>
</li>
<li><p>对于其他操作，此列可以包含一个或多个用逗号分隔的地址（主机或网络）。不允许地址范围。如果提供此列，则生成的规则要求原始目标地址匹配列出的地址之一。此功能在你想生成与 DNAT- 或 REDIRECT- 规则相对应的过滤规则时最有用。在这种用法中，地址列表不应以 “!” 开头。</p>
</li>
<li><p>还可以指定一组地址然后排除其中的一部分。例如，192.168.1.0/24!192.168.1.16/28 指定了地址 192.168.1.0-182.168.1.15 和 192.168.1.32-192.168.1.255。见 shorewall-exclusion(5)。</p>
</li>
<li><p>参见 <a href="https://shorewall.org/PortKnocking.html" target="_blank" rel="noopener">https://shorewall.org/PortKnocking.html</a> 以获取有关如何使用此列中的条目与用户定义的操作规则的示例。</p>
</li>
<li><p>此列之前标记为 ORIGINAL DEST。</p>
</li>
</ul>
<h4 id="RATE-limit"><a href="#RATE-limit" class="headerlink" title="RATE - limit"></a>RATE - limit</h4><p><strong>可选。</strong> 如果要对规则进行速率限制，可以在此列中指定一个值：</p>
<ul>
<li><p><strong>rate</strong> 是每个时间间隔（秒或分钟）内的连接数，<strong>burst</strong> 是允许的最大突发流量。如果没有指定突发流量，则假定值为 5。说明中不能包含空格。</p>
<p>示例：<code>10/sec:20</code></p>
</li>
<li><p>当指定 <code>s:</code> 或 <code>d:</code> 时，速率分别适用于每个源 IP 地址或目标 IP 地址。名称可以由用户选择，指定一个哈希表，用于计算匹配连接的数量。如果未指定，则假定名称为 <code>shorewallN</code>（其中 N 是唯一整数）。当多个规则或策略指定相同名称时，这些规则的连接计数会汇总在一起，个别速率适用于汇总计数。从 Shorewall 5.2.1 开始，<code>s</code> 或 <code>d</code> 后可以跟斜杠（”/“）和一个整数 VLSM。当指定了 VLSM 时，所有遇到的源或目标地址将根据给定的前缀长度进行分组，创建的子网将受到速率限制。</p>
<p>示例：<code>s/24::10/sec</code></p>
</li>
<li><p>从 Shorewall 4.6.5 开始，可以指定两个限制，用逗号分隔。在这种情况下，第一个限制（<code>name1</code>，<code>rate1</code>，<code>burst1</code>）指定每个源 IP 的限制，第二个限制指定每个目标 IP 的限制。</p>
<p>示例：<code>client:10/sec:20,:60/sec:100</code></p>
<p>在这个例子中，<code>client</code> 哈希表将用于强制执行每个源的限制，而编译器将为每个目标的限制选择一个唯一的哈希表名称。</p>
</li>
<li><p>从 Shorewall 5.2.1 开始，表名（如果有的话）后可以跟两个整数，用逗号分隔并括在圆括号中。第一个整数（<code>ht-buckets</code>）指定生成哈希表中的桶数。第二个整数（<code>ht-max</code>）指定哈希表中的最大条目数。</p>
<p>示例：<code>s:netfw(1024,65536):10/sec</code></p>
</li>
<li><p>此列以前标记为 <strong>RATE LIMIT</strong>。</p>
</li>
</ul>
<h4 id="USER-user-name-or-number-group-name-or-number-…"><a href="#USER-user-name-or-number-group-name-or-number-…" class="headerlink" title="USER - [!][user-name-or-number][:group-name-or-number][,…]"></a>USER - [!][user-name-or-number][:group-name-or-number][,…]</h4><p><strong>可选。</strong> 仅当 <strong>SOURCE</strong> 为防火墙本身时，此列才能非空。</p>
<ul>
<li><p>当此列非空时，规则仅适用于生成输出的程序在指定的有效用户和/或组下运行（如果给出“！”则表示程序<strong>不</strong>在该用户或组下运行）。</p>
</li>
<li><p>从 Shorewall 4.5.8 开始，可以用逗号分隔指定多个用户或组名称/ID。</p>
</li>
</ul>
<p><strong>示例：</strong></p>
<ul>
<li><p><code>joe</code><br>程序必须由 <code>joe</code> 运行</p>
</li>
<li><p><code>:kids</code><br>程序必须由 <code>kids</code> 组的成员运行</p>
</li>
<li><p><code>!:kids</code><br>程序必须<strong>不</strong>由 <code>kids</code> 组的成员运行</p>
</li>
<li><p><code>2001-2099</code><br>UID 从 2001 到 2099（Shorewall 4.5.6 及更高版本）</p>
</li>
<li><p>此列以前标记为 <strong>USER/GROUP</strong>。</p>
</li>
</ul>
<h4 id="MARK-value-mask-C"><a href="#MARK-value-mask-C" class="headerlink" title="MARK - [!]value[/mask][:C]"></a>MARK - [!]value[/mask][:C]</h4><p><strong>定义对现有数据包或连接标记的测试。规则仅在测试返回真时匹配。</strong></p>
<ul>
<li><p>如果不想定义测试但需要在以下列中指定任何内容，请在此字段中放置一个“-”。</p>
</li>
<li><p><code>!</code><br>反转测试（不等于）</p>
</li>
<li><p><code>value</code><br>数据包或连接标记的值。</p>
</li>
<li><p><code>mask</code><br>在测试之前应用于标记的掩码。</p>
</li>
<li><p><code>:C</code><br>指定连接标记。如果省略，则测试数据包标记的值。</p>
</li>
</ul>
<h4 id="CONNLIMIT-d-limit-mask"><a href="#CONNLIMIT-d-limit-mask" class="headerlink" title="CONNLIMIT - [d:][!]limit[:mask]"></a>CONNLIMIT - [d:][!]limit[:mask]</h4><p><strong>可以用于限制每个单独主机或网络的同时连接数，以限制连接数量。需要在内核和 iptables 中支持 connlimit 匹配。</strong></p>
<ul>
<li><p>虽然限制仅在指定 CONNLIMIT 的规则中检查，但当前连接的数量是计算所有来自 SOURCE 或 DESTINATION 主机的连接。默认情况下，限制是按 SOURCE 主机或网络进行的，但如果规范以 <code>d:</code> 开头，则限制将按目的主机或网络进行。</p>
</li>
<li><p>默认情况下，限制适用于每个主机，但可以通过指定掩码使其适用于主机的网络。掩码指定要应用于源地址的 VLSM 掩码的宽度；然后计算子网 <code>source-address/mask</code> 中所有主机的当前连接数。当指定 <code>!</code> 时，规则在连接数量超过限制时匹配。</p>
</li>
</ul>
<h4 id="TIME-timeelement-amp-timeelement…"><a href="#TIME-timeelement-amp-timeelement…" class="headerlink" title="TIME - timeelement[&amp;timeelement…]"></a>TIME - timeelement[&amp;timeelement…]</h4><p><strong>可以用于限制规则在特定时间段、特定星期几或月份中的特定天数，或者在由日期和时间定义的范围内生效。需要内核和 iptables 支持时间匹配。</strong></p>
<ul>
<li><p><code>timestart=hh:mm[:ss]</code><br>定义一天的开始时间。</p>
</li>
<li><p><code>timestop=hh:mm[:ss]</code><br>定义一天的结束时间。</p>
</li>
<li><p><code>contiguous</code><br>从 Shorewall 5.0.12 开始。当 <code>timestop</code> 小于 <code>timestart</code> 的值时，将其匹配为单一时间段，而不是不同的时间段。</p>
</li>
<li><p><code>utc</code><br>时间以格林威治标准时间表示。</p>
</li>
<li><p><code>localtz</code><br>被 Netfilter 团队弃用，推荐使用 <code>kerneltz</code>。时间以本地标准时间表示（默认值）。</p>
</li>
<li><p><code>kerneltz</code><br>从 Shorewall 4.5.2 开始。时间以本地内核时间表示（需要 iptables 1.4.12 或更高版本）。</p>
</li>
<li><p><code>weekdays=ddd[,ddd]...</code><br>其中 <code>ddd</code> 是其中一个：Mon、Tue、Wed、Thu、Fri、Sat 或 Sun。</p>
</li>
<li><p><code>monthdays=dd[,dd],...</code><br>其中 <code>dd</code> 是月份中的顺序日。</p>
</li>
<li><p><code>datestart=yyyy[-mm[-dd[Thh[:mm[:ss]]]]]</code><br>定义开始日期和时间。</p>
</li>
<li><p><code>datestop=yyyy[-mm[-dd[Thh[:mm[:ss]]]]]</code><br>定义结束日期和时间。</p>
</li>
</ul>
<h4 id="HEADERS-any-exactly-header-list-Optional-Added-in-Shorewall-4-4-15"><a href="#HEADERS-any-exactly-header-list-Optional-Added-in-Shorewall-4-4-15" class="headerlink" title="HEADERS - [!][any:|exactly:]header-list (Optional - Added in Shorewall 4.4.15)"></a>HEADERS - [!][any:|exactly:]header-list (Optional - Added in Shorewall 4.4.15)</h4><p><strong>此列仅在 IPv6 中使用。在 IPv4 中，如果您希望在以下列中填写值，请在此列中提供 “-“。</strong></p>
<p><strong>header-list</strong> 由以下列表中的标头组成，使用逗号分隔：</p>
<ul>
<li><p><code>auth</code>、<code>ah</code> 或 <code>51</code><br>认证头扩展标头。</p>
</li>
<li><p><code>esp</code> 或 <code>50</code><br>加密安全负载扩展标头。</p>
</li>
<li><p><code>hop</code>、<code>hop-by-hop</code> 或 <code>0</code><br>按跳选项扩展标头。</p>
</li>
<li><p><code>route</code>、<code>ipv6-route</code> 或 <code>43</code><br>IPv6 路由扩展标头。</p>
</li>
<li><p><code>frag</code>、<code>ipv6-frag</code> 或 <code>44</code><br>IPv6 分片扩展标头。</p>
</li>
<li><p><code>none</code>、<code>ipv6-nonxt</code> 或 <code>59</code><br>无下一个标头。</p>
</li>
<li><p><code>proto</code>、<code>protocol</code> 或 <code>255</code><br>任何协议标头。</p>
</li>
</ul>
<p>如果指定了 <code>any:</code>，则规则将在列出的任何标头存在时匹配。如果指定了 <code>exactly:</code>，则规则将匹配恰好包括所有指定标头的数据包。如果两者都未给出，则默认为 <code>any:</code>。</p>
<p>如果输入 <code>!</code>，则规则将匹配那些在省略 <code>!</code> 时不匹配的数据包。</p>
<h4 id="SWITCH-switch-name-0-1"><a href="#SWITCH-switch-name-0-1" class="headerlink" title="SWITCH - [!]switch-name[={0|1}]"></a>SWITCH - [!]switch-name[={0|1}]</h4><p><strong>在 Shorewall 4.4.24 中添加，允许在不需要重新加载 Shorewall 的情况下启用和禁用规则。</strong></p>
<ul>
<li><p>如果 <code>/proc/net/nf_condition/switch-name</code> 中存储的值为 1，则规则被启用。如果该文件包含 0（默认值），则规则被禁用。如果提供了 <code>!</code>，则测试结果将被取反，即如果文件包含 0，则规则被启用。</p>
</li>
<li><p>在 <code>switch-name</code> 中，<code>@0</code> 和 <code>@{0}</code> 将被替换为规则所在链的名称。<code>switch-name</code>（在 <code>@...</code> 扩展后）必须以字母开头，并由字母、数字、下划线或连字符组成。开关名称长度不得超过 30 个字符。</p>
</li>
<li><p>开关默认是关闭的。要启用开关，可以执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/net/nf_condition/switch-name</span><br></pre></td></tr></table></figure>
</li>
<li><p>要再次关闭开关，可以执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /proc/net/nf_condition/switch-name</span><br></pre></td></tr></table></figure>
</li>
<li><p>开关设置在 Shorewall 重新加载后会保留。</p>
</li>
<li><p>从 Shorewall 4.5.10 开始，当 <code>switch-name</code> 后跟 <code>=0</code> 或 <code>=1</code> 时，开关会在启动命令时初始化为关闭或开启状态。其他命令不会影响开关设置。</p>
</li>
</ul>
<h4 id="HELPER-helper"><a href="#HELPER-helper" class="headerlink" title="HELPER - [helper]"></a>HELPER - [helper]</h4><p><strong>在 Shorewall 4.5.7 中添加。</strong></p>
<ul>
<li><p>在 <code>NEW</code> 部分，指定的 conntrack helper 将与此连接关联；除非 ACTION 是 ACCEPT<em>、DNAT</em> 或 REDIRECT*，否则此列的内容将被忽略。</p>
</li>
<li><p>在 <code>RELATED</code> 部分，只有当相关连接具有指定的 helper 时才会匹配。</p>
</li>
<li><p>可以使用以下 helper 之一：</p>
<ul>
<li>amanda</li>
<li>ftp</li>
<li>irc</li>
<li>netbios-ns</li>
<li>pptp</li>
<li>Q.931</li>
<li>RAS</li>
<li>sane</li>
<li>sip</li>
<li>snmp</li>
<li>tftp</li>
</ul>
</li>
<li><p>如果在 <code>shorewall.conf(5)</code> 中指定了 HELPERS 选项，则此列中指定的任何模块必须在 HELPERS 设置中列出。</p>
</li>
</ul>
<h4 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h4><p><strong>示例 1:</strong></p>
<pre><code>允许从 DMZ 到互联网的 SMTP 请求

        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST
        ACCEPT dmz net tcp smtp
</code></pre><p><strong>示例 2:</strong></p>
<pre><code>将所有从互联网发出的 SSH 和 HTTP 连接请求转发到本地系统 192.168.1.3
        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST
        DNAT net loc:192.168.1.3 tcp ssh,http
</code></pre><p><strong>示例 3:</strong></p>
<pre><code>将所有从互联网发出的 HTTP 连接请求转发到本地系统 192.168.1.3，每秒限制为 3 个连接，最大突发为 10 个
        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST RATE
        DNAT net loc:192.168.1.3 tcp http - - 3/sec:10
</code></pre><p><strong>示例 4:</strong></p>
<pre><code>将所有本地发起的 WWW 连接请求重定向到防火墙的 3128 端口（防火墙系统上运行的 Squid），但当目标地址为 192.168.2.2 时除外

        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST
        REDIRECT loc 3128 tcp www - !192.168.2.2
</code></pre><p><strong>示例 5:</strong></p>
<pre><code>将所有来自互联网的 HTTP 请求转发到地址 130.252.100.69 的 80 端口，转发到 192.168.1.3

        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST
        DNAT net loc:192.168.1.3 tcp 80 - 130.252.100.69
</code></pre><p><strong>示例 6:</strong></p>
<pre><code>只接受来自互联网 IP 地址 130.252.100.69 和 130.252.100.70 的 SSH 连接

        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST
        ACCEPT net:130.252.100.69,130.252.100.70 $FW tcp 22
</code></pre><p><strong>示例 7:</strong></p>
<pre><code>你希望接受到防火墙的 2222 端口的连接，并将它们转发到本地系统 192.168.1.3 的 22 端口

        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST
        DNAT net loc:192.168.1.3:22 tcp 2222
</code></pre><p><strong>示例 8:</strong></p>
<pre><code>你希望将连接请求到端口 80 随机重定向到端口范围 81-90

        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST
        REDIRECT net $FW::81-90:random tcp www
</code></pre><p><strong>示例 9:</strong></p>
<pre><code>Shorewall 对 ‘nat’ 表中的 Netfilter 规则不像对过滤表中的规则那样施加结构限制。因此，在使用 Shorewall 4.1.4 版本之前，使用带有通配符接口（以 &#39;+&#39; 结尾的接口）定义的区域时，必须小心使用 DNAT 和 REDIRECT 规则。示例如下：

shorewall-zones(5):

        #ZONE TYPE OPTIONS
        fw firewall
        net ipv4
        dmz ipv4
        loc ipv4

shorewall-interfaces(5):

        #ZONE INTERFACE BROADCAST OPTIONS
        net ppp0
        loc eth1 detect
        dmz eth2 detect
        - ppp+ # 地址从 192.168.3.0/24 分配

shorewall-host(5):

        #ZONE HOST(S) OPTIONS
        loc ppp+:192.168.3.0/24

规则：

        #ACTION SOURCE DEST PROTO DPORT
        REDIRECT loc 3128 tcp 80

注意，可能会有人倾向于在 shorewall-interfaces(8) 中完全定义 loc 区域：

        #******************* 错误 *****************
        #ZONE INTERFACE BROADCAST OPTIONS
        net ppp0
        loc eth1 detect
        loc ppp+
        dmz eth2

这将使在 DMZ 中运行的可以被访问的 Web 服务器变得不可能，因为所有进入 ppp+ 接口的流量都将被重定向到防火墙上的 3128 端口，而没有适用于这些流量的 net-&gt;fw ACCEPT 规则。
</code></pre><p><strong>示例 10:</strong></p>
<pre><code>将传入的 SSH 连接的元组（源 IP、目标端口、目标 IP）添加到 ipset S：

        #ACTION SOURCE DEST PROTO DPORT
        ADD(+S:dst,src,dst) net fw tcp 22
</code></pre><p><strong>示例 11:</strong></p>
<pre><code>你希望将远程系统的 SSH 连接限制为每分钟 1 个连接，允许最多 3 次突发（以便有限的重试）：

        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST RATE
        SSH(ACCEPT) net all - - - - s:1/min:3
</code></pre><p><strong>示例 12:</strong></p>
<pre><code>如果开关 &#39;primary_down&#39; 打开，将端口 80 转发到 DMZ 主机 $BACKUP

        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST RATE USER MARK CONNLIMIT TIME HEADERS SWITCH
        DNAT net dmz:$BACKUP tcp 80 - - - - - - primary_down
</code></pre><p><strong>示例 13:</strong></p>
<pre><code>丢弃来自匿名代理和卫星提供商地址范围的所有电子邮件：

        #ACTION SOURCE DEST PROTO DPORT
        DROP net:^A1,A2 fw tcp 25
</code></pre><p><strong>示例 14:</strong></p>
<pre><code>你希望生成涉及不受 Shorewall 支持的 iptables 目标和匹配的规则。

        #ACTION SOURCE DEST PROTO DPORT
        INLINE $FW net ; -p 6 -m mickey-mouse --name test -m set --match-set set1 src -m mickey-mouse --name test2 -j SECCTX --name test3

上述将生成以下 iptables-restore 输入：

        -A fw2net -p 6 -m mickey-mouse --name test -m set --match-set set1 src -m mickey-mouse --name test2 -j SECCTX --name test3

注意，SECCTX 必须在 shorewall-actions(5) 中定义为内置操作：

        #ACTION OPTIONS
        SECCTX builtin
</code></pre><p><strong>示例 15:</strong></p>
<pre><code>你希望只接受来自互联网 IP 地址 2002:ce7c::92b4:1::2 和 2002:ce7c::92b4:1::22 的 SSH 连接

        #ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST
        ACCEPT net:&lt;2002:ce7c::92b4:1::2,2002:ce7c::92b4:1::22&gt; $FW tcp 22
</code></pre><h4 id="Universal示例-3"><a href="#Universal示例-3" class="headerlink" title="Universal示例"></a>Universal示例</h4><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#</span><br><span class="line"># Shorewall version <span class="number">4</span> - Rules File</span><br><span class="line">#</span><br><span class="line"># For information on the settings <span class="keyword">in</span> this file, type <span class="string">"man shorewall-rules"</span></span><br><span class="line">#</span><br><span class="line"># The manpage is also online at</span><br><span class="line"># http:<span class="comment">//www.shorewall.net/manpages/shorewall-rules.html</span></span><br><span class="line">#</span><br><span class="line">######################################################################################################################################################################################################</span><br><span class="line">#ACTION		SOURCE		DEST		PROTO	DEST	SOURCE		ORIGINAL	RATE		USER/	MARK	CONNLIMIT	TIME		HEADERS		SWITCH		HELPER</span><br><span class="line">#							PORT	PORT(S)		DEST		LIMIT		GROUP</span><br><span class="line">?SECTION ALL</span><br><span class="line">?SECTION ESTABLISHED</span><br><span class="line">?SECTION RELATED</span><br><span class="line">?SECTION INVALID</span><br><span class="line">?SECTION UNTRACKED</span><br><span class="line">?SECTION NEW</span><br><span class="line">Invalid(DROP)	net		$FW		tcp</span><br><span class="line">SSH(ACCEPT)	net		$FW</span><br><span class="line">Ping(ACCEPT)	net		$FW</span><br></pre></td></tr></table></figure>
<p><strong>三接口示例</strong></p>
<figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Shorewall - Sample Rules File for three-interface configuration.</span></span><br><span class="line"><span class="comment"># Copyright (C) 2006-2015 by the Shorewall Team</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This library is free software; you can redistribute it and/or</span></span><br><span class="line"><span class="comment"># modify it under the terms of the GNU Lesser General Public</span></span><br><span class="line"><span class="comment"># License as published by the Free Software Foundation; either</span></span><br><span class="line"><span class="comment"># version 2.1 of the License, or (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See the file README.txt for further details.</span></span><br><span class="line"><span class="comment">#--------------------------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># For information about entries in this file, type "man shorewall-rules"</span></span><br><span class="line"><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span><span class="comment">######</span></span><br><span class="line"><span class="comment">#ACTION		SOURCE		DEST		PROTO	DEST	SOURCE		ORIGINAL	RATE		USER/	MARK	CONNLIMIT	TIME		HEADERS		SWITCH		HELPER</span></span><br><span class="line"><span class="comment">#							PORT	PORT(S)		DEST		LIMIT		GROUP</span></span><br><span class="line">?SECTION ALL</span><br><span class="line">?SECTION ESTABLISHED</span><br><span class="line">?SECTION RELATED</span><br><span class="line">?SECTION INVALID</span><br><span class="line">?SECTION UNTRACKED</span><br><span class="line">?SECTION NEW</span><br><span class="line"></span><br><span class="line"><span class="comment">#       Don't allow connection pickup from the net</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">Invalid(DROP)	net		all		tcp</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	Accept DNS connections from the firewall to the Internet</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">DNS(ACCEPT)	$FW		net</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	Accept SSH connections from the local network to the firewall and DMZ</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">SSH(ACCEPT)     loc             $FW</span><br><span class="line">SSH(ACCEPT)     loc             dmz</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#	DMZ DNS access to the Internet</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">DNS(ACCEPT)	dmz		net</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Drop Ping from the "bad" net zone.</span></span><br><span class="line"></span><br><span class="line">Ping(DROP)   	net             $FW</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#       Make ping work bi-directionally between the dmz, net, Firewall and local zone</span></span><br><span class="line"><span class="comment">#       (assumes that the loc-&gt; net policy is ACCEPT).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line">Ping(ACCEPT)    loc             $FW</span><br><span class="line">Ping(ACCEPT)    dmz             $FW</span><br><span class="line">Ping(ACCEPT)    loc             dmz</span><br><span class="line">Ping(ACCEPT)    dmz             loc</span><br><span class="line">Ping(ACCEPT)    dmz             net</span><br><span class="line"></span><br><span class="line">ACCEPT		$FW		net		icmp</span><br><span class="line">ACCEPT		$FW		loc		icmp</span><br><span class="line">ACCEPT		$FW		dmz		icmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment this if using Proxy ARP and static NAT and you want to allow ping from</span></span><br><span class="line"><span class="comment"># the net zone to the dmz and loc</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Ping(ACCEPT)    net             dmz</span></span><br><span class="line"><span class="comment">#Ping(ACCEPT)    net             loc</span></span><br></pre></td></tr></table></figure>
<p><strong>See ALSO</strong></p>
<p><a href="https://shorewall.org/manpages/shorewall-logging.html" target="_blank" rel="noopener">shorewall-logging(5)</a></p>
<p><a href="https://shorewall.org/ipsets.html" target="_blank" rel="noopener">https://shorewall.org/ipsets.html</a></p>
<p><a href="https://shorewall.org/configuration_file_basics.htm#Pairsee" target="_blank" rel="noopener">https://shorewall.org/configuration_file_basics.htm#Pairsee</a> ALSO</p>
<p><a href="https://shorewall.org/manpages/shorewall-logging.html" target="_blank" rel="noopener">shorewall-logging(5)</a></p>
<p><a href="https://shorewall.org/ipsets.html" target="_blank" rel="noopener">https://shorewall.org/ipsets.html</a></p>
<p><a href="https://shorewall.org/configuration_file_basics.htm#Pairs" target="_blank" rel="noopener">https://shorewall.org/configuration_file_basics.htm#Pairs</a></p>
<h3 id="etc-shorewall-routes"><a href="#etc-shorewall-routes" class="headerlink" title="/etc/shorewall/routes"></a><code>/etc/shorewall/routes</code></h3><p><strong>主要功能</strong></p>
<ul>
<li><strong>定义静态路由</strong><br>通过该文件，您可以指定静态路由，将流量从一个网络传递到另一个网络或设备。您可以为每个目标地址或网络指定路由。</li>
<li><strong>指定网关和设备</strong><br>文件允许您指定到目标的网关地址，或指定设备（网络接口）用于路由。</li>
<li><strong>路由选项</strong><br>您可以设置一些选项，例如 <code>persistent</code>，使得路由即使在提供者被禁用时仍然存在于路由表中。</li>
</ul>
<p><strong>描述</strong></p>
<p>此文件在 Shorewall 4.4.15 中新增，用于定义要添加到提供者路由表的路由。</p>
<p>文件中的列如下：</p>
<ul>
<li><p><strong>PROVIDER</strong><br>提供者的名称或编号，在 <code>shorewall-providers (5)</code> 中定义。从 Shorewall 4.5.14 开始，您还可以在此列中输入 <code>main</code> 以将路由添加到主路由表。</p>
</li>
<li><p><strong>DEST</strong><br>目标主机地址或网络地址。</p>
</li>
<li><p><strong>GATEWAY (可选)</strong><br>如果指定，提供目标地址的网关 IP 地址。</p>
<p>从 Shorewall 4.5.14 开始，您可以在此列中指定 <code>blackhole</code> 以创建黑洞路由。</p>
<p>从 Shorewall 4.5.15 开始，您可以在此列中指定 <code>prohibit</code> 或 <code>unreachable</code> 以分别创建禁止路由或不可达路由。</p>
</li>
<li><p><strong>DEVICE (可选)</strong><br>指定设备路由。如果未指定 DEVICE 或 GATEWAY，则使用在 <code>shorewall-providers (5)</code> 中为 PROVIDER 指定的 INTERFACE。如果在 GATEWAY 列中指定了 <code>blackhole</code>、<code>prohibit</code> 或 <code>unreachable</code>，则此列必须省略。</p>
</li>
<li><p><strong>OPTIONS (可选)</strong><br>从 Shorewall 5.0.2 开始增加。</p>
<p>允许的选项包括：</p>
<ul>
<li><strong>persistent</strong><br>如果指定，则即使提供者被禁用，该路由仍保留在提供者的路由表中。</li>
</ul>
</li>
</ul>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># PROVIDER  DESTINATION    GATEWAY          DEVICE   OPTIONS</span><br><span class="line"><span class="built_in">int</span>ernet    <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>  <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>      eth0     persistent</span><br><span class="line">vpn         <span class="number">10.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span>    blackhole</span><br></pre></td></tr></table></figure>
<h3 id="etc-shorewall-hosts"><a href="#etc-shorewall-hosts" class="headerlink" title="/etc/shorewall/hosts"></a><code>/etc/shorewall/hosts</code></h3><p>在 Shorewall 的配置中，<code>shorewall-zones</code> 文件用于定义区域 (zones) 以及这些区域的子网和/或单独的 IP 地址。这个文件对大多数简单设置<strong>不是必需的</strong>，但当你有多个区域通过一个接口连接时，它就变得非常重要。</p>
<p><strong>文件描述</strong></p>
<p>这个文件的主要作用是将网络区域与其相应的子网或 IP 地址关联起来。通常情况下，简单的网络设置不需要在这个文件中放置任何内容。然而，当涉及到通过单一接口连接多个区域时，这个文件变得重要。</p>
<p><strong>文件的结构和使用</strong></p>
<ul>
<li><strong>文件的顺序</strong>: 文件中条目的顺序对区域的组成没有影响。实际上，<code>shorewall-zones</code> 文件中的区域声明顺序决定了记录在文件中的解释顺序。</li>
<li><strong>警告</strong>:<ul>
<li><strong>如果在 <code>shorewall-interfaces</code> 文件中有针对特定区域和接口的条目，则不应在这个文件中为相同的区域和接口对添加任何条目。</strong></li>
<li><strong>只有在多个区域通过单一接口连接时，才需要这个文件。</strong></li>
</ul>
</li>
</ul>
<p><strong>列的说明</strong></p>
<p>以下是 <code>shorewall-zones</code> 文件中各列的说明：</p>
<ol>
<li><strong>ZONE</strong>: 该列指定了区域的名称。区域名称应与 <code>shorewall-zones</code> 文件中的区域定义相匹配。</li>
<li><strong>NETS</strong>: 该列列出了与区域相关联的子网或 IP 地址。多个子网或 IP 地址用逗号分隔。例如，可以指定一个子网 <code>192.168.1.0/24</code>，或者多个子网 <code>192.168.1.0/24,192.168.2.0/24</code>。</li>
<li><strong>OPTIONS</strong>: 可选的列，用于指定与区域相关的额外选项，如访问控制规则、黑名单、动态黑名单等。</li>
</ol>
<p><strong>ZONE</strong> -        <em>zone-name</em>——不再解释</p>
<p><strong>HOST(S)</strong> - <code>interface:{[{address-or-range[,address-or-range]...|+ipset|dynamic}[exclusion]</code></p>
<p><strong>解释</strong>:</p>
<ul>
<li><code>interface</code>: <code>shorewall-interfaces(5)</code> 文件中定义的接口名称，后跟冒号（”:”）。</li>
<li><code>{...}</code>: 逗号分隔的列表，其中的元素可以是：<ul>
<li>主机的 IP 地址。</li>
<li>以 CIDR 格式表示的网络。</li>
<li>IP 地址范围，例如 <code>low.address-high.address</code>。你的内核和 iptables 必须支持 iprange 匹配。</li>
<li>ipset 的名称。</li>
<li>关键字 <code>dynamic</code>，使区域动态，这样你可以使用 <code>shorewall add</code> 和 <code>shorewall delete</code> 命令来更改区域的组成。</li>
<li>你也可以通过使用排除（<code>exclusion</code>，见 <code>shorewall-exclusion(5)</code>）来排除某些主机。</li>
</ul>
</li>
</ul>
<p><strong>OPTIONS（可选） - <code>[option[,option]...]</code></strong></p>
<p>一个用逗号分隔的选项列表。选项的顺序没有特定要求，但列表中不能有嵌入的空白字符。</p>
<ul>
<li><p><strong>blacklist</strong></p>
<p>检查到达此端口的报文是否符合 <code>shorewall-blacklist(5)</code> 文件中的规则。</p>
</li>
<li><p><strong>broadcast</strong></p>
<p>当你想要包含来自防火墙到这个区域的有限广播（目标 IP 地址为 255.255.255.255）时使用。仅在以下情况下需要：</p>
<ul>
<li><code>HOST(S)</code> 列中指定的网络不包括 255.255.255.255。</li>
<li>此区域在 <code>shorewall-interfaces(5)</code> 中没有该接口的条目。</li>
</ul>
</li>
<li><p><strong>destonly</strong></p>
<p>通常与多播 IP 地址范围（224.0.0.0/4）一起使用。指定流量将发送到指定的网络，但不会从这些网络接收流量。</p>
</li>
<li><p><strong>ipsec</strong></p>
<p>该区域通过内核 2.6 IPsec SA 访问。请注意，如果在 <code>shorewall-zones(5)</code> 文件中将 <code>ZONE</code> 列中命名的区域指定为 IPSEC 区域，则在此处不需要指定 <code>ipsec</code> 选项。</p>
</li>
<li><p><strong>maclist</strong></p>
<p>来自这些主机的连接请求会与 <code>shorewall-maclist(5)</code> 文件的内容进行比较。如果指定了此选项，则接口必须是以太网 NIC 或等效设备，并且必须在 Shorewall 启动之前处于启用状态。</p>
</li>
<li><p><strong>mss=mss</strong></p>
<p>Shorewall 4.5.2 中添加的选项。当存在时，会将 <code>HOST(S)</code> 列中指定的主机的新连接的 TCP MSS 限制为指定的 MSS。</p>
</li>
<li><p><strong>nosmurfs</strong></p>
<p>这个选项仅对桥上的端口有意义。过滤源地址为广播地址的 smurf 报文。Smurf 报文会根据 <code>shorewall.conf(5)</code> 中的 <code>SMURF_LOG_LEVEL</code> 设置进行选择性记录，记录后报文会被丢弃。</p>
</li>
<li><p><strong>routeback</strong></p>
<p>Shorewall 应设置基础设施以将来自这些地址的报文传回到它们自己。如果这些主机组使用了一个透明代理，该代理是该组的成员，或者如果使用 DNAT 将来自该组的请求发送到组内的服务器，这个选项是必要的。</p>
</li>
<li><p><strong>tcpflags</strong></p>
<p>检查来自这些主机的报文是否包含某些非法的 TCP 标志组合。找到这样的标志组合的报文会根据 <code>TCP_FLAGS_DISPOSITION</code> 设置进行处理，并根据 <code>TCP_FLAGS_LOG_LEVEL</code> 设置进行记录。</p>
</li>
</ul>
<p><strong>Examples</strong></p>
<p>防火墙运行一个 PPTP 服务器，该服务器为每个远程客户端创建一个 ppp 接口。  为客户端分配了网络 192.168.3.0/24 和名为“vpn”的区域中的 IP 地址。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ZONE       HOST(S)               OPTIONS</span><br><span class="line">vpn         ppp+:<span class="number">192.168</span><span class="number">.3</span><span class="number">.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ZONE     HOST(S)                         OPTIONS</span><br><span class="line">loc        enxa446b4906694:<span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line">net        enxa446b4906694:!<span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line"># ZONE     INTERFACE       OPTIONS</span><br><span class="line">-         lo              ignore</span><br><span class="line">loc       enxa446b4906694 dhcp,nosmurfs,routefilter,logmartians</span><br><span class="line">net       enxa446b4906694 dhcp,nosmurfs,routefilter,logmartians</span><br></pre></td></tr></table></figure>
<h2 id="Debian：已知问题"><a href="#Debian：已知问题" class="headerlink" title="Debian：已知问题"></a>Debian：已知问题</h2><p><code>/usr/share/doc/shorewall/known_problems.txt</code></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>) 在运行 Upstart 的系统上，shorewall-init 不能在接口启动之前可靠地保护防火墙。</span><br><span class="line"><span class="number">2</span>) <span class="string">'enable'</span>、<span class="string">'reenable'</span> 和 <span class="string">'disable'</span> 命令在配置中 USE_DEFAULT_RT=No 和 DUPLICATE 列中列出的可选提供程序的情况下无法正常工作。</span><br><span class="line"><span class="number">3</span>) 尽管 <span class="string">'ip'</span> 工具现在接受具有多个 <span class="string">'nexthop'</span> 目的地的 IPv6 路由，这些路由并没有被平衡。它们被实例化为具有不同度量的单一路由序列。此外，<span class="string">'ip route replace'</span> 命令在这些路由上失败。从 Shorewall6 <span class="number">5.0</span><span class="number">.15</span> 开始，生成的脚本使用 <span class="string">"delete..add.."</span> 序列而不是单个 <span class="string">"replace"</span> 命令。</span><br><span class="line"><span class="number">4</span>) 如果在策略文件条目中排除了多个区域，会出现类似以下的错误：</span><br><span class="line">    ERROR: <span class="string">'all'</span> <span class="keyword">is</span> <span class="keyword">not</span> allowed <span class="keyword">in</span> a source zone list</span><br><span class="line">    /etc/shorewall/policy (line <span class="number">8</span>) </span><br><span class="line">    在 Shorewall <span class="number">5.2</span><span class="number">.3</span><span class="number">.1</span> 中已修正。</span><br><span class="line"><span class="number">5</span>) Shorewall <span class="number">5.2</span> 会自动将现有的 <span class="string">'masq'</span> 文件转换为等效的 <span class="string">'snat'</span> 文件。遗憾的是，Shorewall <span class="number">5.2</span><span class="number">.3</span> 破坏了这一自动更新，导致出现以下错误消息：</span><br><span class="line">    Use of uninitialized value $Shorewall::Nat::rawcurrentline <span class="keyword">in</span></span><br><span class="line">    pattern match (m<span class="comment">//) at /usr/share/shorewall/Shorewall/Nat.pm</span></span><br><span class="line">    line <span class="number">511</span>, &lt;$currentfile&gt; line nnn.</span><br><span class="line">    并且生成的 <span class="string">'masq'</span> 文件仅包含初始注释。</span><br><span class="line">    解决方法：</span><br><span class="line">    升级到 <span class="number">5.2</span><span class="number">.3</span> 后，执行以下命令：</span><br><span class="line">    <span class="string">'shorewall[6] update'</span></span><br><span class="line">    在 <span class="number">5.2</span><span class="number">.3</span><span class="number">.2</span> 中已修正。</span><br><span class="line"><span class="number">6</span>) 如果在 SPORT 列中列出了一个 ipset，编译器会引发类似以下的错误：</span><br><span class="line">    ERROR: Invalid ipset name () /etc/shorewall/rules (line <span class="number">44</span>)</span><br><span class="line">    在 <span class="number">5.2</span><span class="number">.3</span><span class="number">.3</span> 中已修正。</span><br><span class="line"><span class="number">7</span>) 如果使用多队列 NFQUEUE（例如，NFQUEUE(<span class="number">0</span>:<span class="number">1</span>)）作为策略，会错误地引发类似以下的错误：</span><br><span class="line">    ERROR: Invalid policy (NFQUEUE(<span class="number">0</span>) /etc/shorewall/policy (line <span class="number">15</span>)</span><br><span class="line">    在 <span class="number">5.2</span><span class="number">.3</span><span class="number">.4</span> 中已修正。</span><br><span class="line"><span class="number">8</span>) 如果将多队列 NFQUEUE（例如，NFQUEUE(<span class="number">0</span>:<span class="number">1</span>,bypass)）传递给宏，会错误地引发类似以下的错误：</span><br><span class="line">    ERROR: Invalid ACTION (PARAM:<span class="number">1</span>c,bypass)))</span><br><span class="line">    /usr/share/shorewall/macro.BitTorrent (line <span class="number">12</span>)</span><br><span class="line">    <span class="keyword">from</span> /etc/shorewall/rules (line <span class="number">40</span>)</span><br><span class="line">    在 <span class="number">5.2</span><span class="number">.3</span><span class="number">.4</span> 中已修正。</span><br><span class="line"><span class="number">9</span>) 如果 shorewall[<span class="number">6</span>].conf 未设置 AUTOMAKE，<span class="string">'update'</span> 命令将生成一个带有 <span class="string">'AUTOMAKE=Yes'</span> 的新文件。这会导致意外的行为变化。</span><br><span class="line">    在 <span class="number">5.2</span><span class="number">.3</span><span class="number">.4</span> 中已修正。</span><br><span class="line"><span class="number">10</span>) Shorewall-rules(<span class="number">5</span>) 错误地声明了 NFQUEUE 的 <span class="string">'bypass'</span> 选项，如果没有附加应用程序到队列，则规则会被静默跳过。实际行为是规则像 ACCEPT 一样处理。</span><br><span class="line">    在 <span class="number">5.2</span><span class="number">.3</span><span class="number">.4</span> 中已修正。</span><br></pre></td></tr></table></figure>
<h2 id="FAQs"><a href="#FAQs" class="headerlink" title="FAQs"></a>FAQs</h2><h3 id="Installing-Shorewall——安装-Shorewall"><a href="#Installing-Shorewall——安装-Shorewall" class="headerlink" title="Installing Shorewall——安装 Shorewall"></a><a href="https://shorewall.org/FAQ.htm#Install" target="_blank" rel="noopener">Installing Shorewall</a>——安装 Shorewall</h3><p><strong>（FAQ 92）有很多 Shorewall 软件包；我应该安装哪一个？</strong></p>
<p>回答：首次安装 Shorewall 4.4.0 或更高版本时，你必须安装 shorewall 软件包。如果你想配置 IPv6 防火墙，还必须安装 shorewall6。从 Shorewall 4.5 开始，你必须首先安装 shorewall-core 软件包。</p>
<p><strong>（FAQ 92a）有人曾告诉我安装 shorewall-perl；这有用吗？</strong></p>
<p>回答：在 Shorewall 4.2 及更早版本中，这是一个很好的建议。在那些版本中，有两个提供基本防火墙功能的软件包：shorewall-shell 和 shorewall-perl。从 Shorewall 4.4.0 开始，shorewall-shell 被停用，shorewall-perl 被重命名为 shorewall。</p>
<p><strong>（FAQ 37）我刚在 Debian 上安装了 Shorewall，但 /etc/shorewall 目录几乎是空的！！！</strong></p>
<p>回答：重要：在你安装 .deb 包并在尝试配置 Shorewall 之前，请遵循前 Shorewall Debian 维护者 Lorenzo Martignoni 的建议：<br>“关于在 Debian 系统上使用 Shorewall 的更多信息，请查看由 shorewall-common Debian 包提供的 /usr/share/doc/shorewall-common/README.Debian。”<br>如果你使用 .deb 包进行安装，你会发现 /etc/shorewall 目录几乎是空的。这是故意的。发布的配置文件骨架可以在你的系统上的 /usr/share/doc/shorewall-common/default-config 目录中找到。只需将所需文件从该目录复制到 /etc/shorewall 并修改这些副本。</p>
<p><strong>（FAQ 37a）我刚在 Debian 上安装了 Shorewall，但找不到示例配置文件。</strong></p>
<p>回答：从 Shorewall 4.4 开始，示例文件在 shorewall 软件包中，安装在 /usr/share/doc/shorewall/examples/ 目录下。</p>
<p><strong>（FAQ 14）我找不到 Shorewall 4.4 的 shorewall-common、shorewall-shell 和 shorewall-perl 软件包？它们在哪里？</strong></p>
<p>回答：在 Shorewall 4.4 中，shorewall-shell 软件包被停用了。shorewall-common 和 shorewall-perl 软件包合并为一个单一的 shorewall 软件包。在 Shorewall 4.5 中，添加了 shorewall-core 软件包，所有其他软件包都依赖于 shorewall-core。</p>
<p><strong>（FAQ 1.5）在安装了最新版本（&gt; 5.1.10.1）的 Shorewall 后，当我更改配置并执行 ‘shorewall reload’ 或 ‘shorewall restart’ 时，我的更改没有应用到正在运行的规则集中。为什么会这样？</strong></p>
<p>回答：这种情况发生在以下情况下：</p>
<ol>
<li>你使用了 INCLUDE (?INCLUDE)。</li>
<li>包含的文件位于 /etc/shorewall[6] 的子目录中或单独的目录中。</li>
<li>你在 shorewall[6].conf(5) 中设置了 AUTOMAKE=Yes。（<a href="https://shorewall.org/manpages/shorewall.conf.html）" target="_blank" rel="noopener">https://shorewall.org/manpages/shorewall.conf.html）</a><br>当 AUTOMAKE=Yes 时，编译器会在 CONFIG_PATH 中的每个目录中查找比最后生成的防火墙脚本更新的文件。如果没有找到更新的文件，则使用旧的脚本。在 5.1.10.2 版本之前，这个搜索是递归的，所以 /etc/shorewall[6] 的子目录中的更改会自动被搜索到。这在 CONFIG_PATH 中的目录深度嵌套时会影响性能。因此，从 5.1.10.2 版本开始，只搜索目录本身。你可以通过设置 AUTOMAKE=recursive 或 AUTOMAKE=integer 来恢复 5.1.10.2 之前的行为，其中 integer 指定搜索深度。如果你的包含文件在单独的目录中，那么该目录必须添加到 CONFIG_PATH 以使 AUTOMAKE 正常工作。</li>
</ol>
<h3 id="Upgrading-Shorewall——升级-Shorewall"><a href="#Upgrading-Shorewall——升级-Shorewall" class="headerlink" title="Upgrading Shorewall——升级 Shorewall"></a><a href="https://shorewall.org/FAQ.htm#Upgrading" target="_blank" rel="noopener">Upgrading Shorewall</a>——升级 Shorewall</h3><p><strong>（FAQ 66）我正在尝试升级到 Shorewall 4.x 或更高版本；我需要安装哪些软件包？</strong></p>
<p>回答：请参阅升级问题(<a href="https://shorewall.org/upgrade_issues.htm)。" target="_blank" rel="noopener">https://shorewall.org/upgrade_issues.htm)。</a></p>
<p><strong>（FAQ 34）我正在尝试升级到 Shorewall 4.4 或更高版本，但找不到 shorewall-common、shorewall-shell 和 shorewall-perl 软件包？它们在哪里？</strong></p>
<p>回答：在 Shorewall 4.4 中，shorewall-shell 软件包被停用。shorewall-common 和 shorewall-perl 软件包合并为一个单一的 shorewall 软件包。更多信息请参阅升级问题(<a href="https://shorewall.org/upgrade_issues.htm)。" target="_blank" rel="noopener">https://shorewall.org/upgrade_issues.htm)。</a></p>
<p><strong>（FAQ 34a）我正在尝试升级到 Shorewall 4.4，但在尝试启动 Shorewall 时遇到错误。我在哪里可以找到这些问题的信息？</strong></p>
<p>回答：请参阅升级问题(<a href="https://shorewall.org/upgrade_issues.htm)。" target="_blank" rel="noopener">https://shorewall.org/upgrade_issues.htm)。</a></p>
<p><strong>（FAQ 34b）我正在尝试升级到 Shorewall 4.4，但在尝试启动 Shorewall 时看到警告信息。我在哪里可以找到这些问题的信息？</strong></p>
<p>回答：请参阅升级问题(<a href="https://shorewall.org/upgrade_issues.htm)。" target="_blank" rel="noopener">https://shorewall.org/upgrade_issues.htm)。</a></p>
<p><strong>（FAQ 76）我刚升级了系统，现在伪装（masquerading）不工作了？发生了什么？</strong></p>
<p>回答：这是因为一些人忽略了我们的建议(<a href="https://shorewall.org/Install.htm#Upgrade_Deb)，让安装程序用默认设置替换了他们正在使用的" target="_blank" rel="noopener">https://shorewall.org/Install.htm#Upgrade_Deb)，让安装程序用默认设置替换了他们正在使用的</a> /etc/shorewall/shorewall.conf。不能转发流量（例如，本地网络访问互联网时的伪装问题）通常是因为 /etc/shorewall/shorewall.conf (<a href="https://shorewall.org/manpages/shorewall.conf.html)包含默认设置" target="_blank" rel="noopener">https://shorewall.org/manpages/shorewall.conf.html)包含默认设置</a> IP_FORWARDING=Keep；它应该是 IP_FORWARDING=On。<br>更新：从 Shorewall 4.4.21 开始，有一个 shorewall update 命令，可以智能地合并现有的 shorewall.conf 和新的配置文件。</p>
<p><strong>（FAQ 2.6）在升级到最新版本（&gt; 5.1.10.1）的 Shorewall 后，当我更改配置并执行 ‘shorewall reload’ 或 ‘shorewall restart’ 时，我的更改没有应用到正在运行的规则集中。为什么会这样？</strong></p>
<p>回答：请参阅 FAQ 1.5(<a href="https://shorewall.org/FAQ.htm#faq1.5)。" target="_blank" rel="noopener">https://shorewall.org/FAQ.htm#faq1.5)。</a></p>
<h3 id="Port-Forwarding-Port-Redirection-——端口转发（端口重定向）"><a href="#Port-Forwarding-Port-Redirection-——端口转发（端口重定向）" class="headerlink" title="Port Forwarding (Port Redirection)——端口转发（端口重定向）"></a><a href="https://shorewall.org/FAQ.htm#PortForwarding" target="_blank" rel="noopener">Port Forwarding (Port Redirection)</a>——端口转发（端口重定向）</h3><p><strong>（FAQ 1）我想将 UDP 端口 7777 转发到我的个人电脑，其 IP 地址是 192.168.1.5。我找遍了所有地方，但找不到如何操作的方法。</strong></p>
<p>回答：从外网到本地系统的端口转发规则格式如下：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION    SOURCE      DEST                                   PROTO        DPORT</span></span><br><span class="line">DNAT       net         <span class="symbol">loc:</span>local-IP-address[<span class="symbol">:local-port</span>]      protocol     port-number</span><br></pre></td></tr></table></figure>
<p>所以，要将 UDP 端口 7777 转发到内部系统 192.168.1.5，规则是：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ACTION    SOURCE   DEST             PROTO    DPORT</span><br><span class="line">DNAT       net      loc:<span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span>  udp      <span class="number">7777</span></span><br></pre></td></tr></table></figure>
<p>如果要将请求定向到防火墙上的特定地址（external-IP）并转发到内部系统：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION SOURCE DEST                                   PROTO       DPORT         SPORT   ORIGDEST</span></span><br><span class="line">DNAT    net    loc:<span class="keyword">local</span>-IP-address[:<span class="keyword">local</span>-port]      protocol    port-<span class="built_in">number</span>   -       external-IP</span><br></pre></td></tr></table></figure>
<p>如果要将来自特定互联网地址（address）的请求转发：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION SOURCE        DEST                                   PROTO       DPORT         SPORT   ORIGDEST</span></span><br><span class="line">DNAT    net:address   loc:<span class="keyword">local</span>-IP-address[:<span class="keyword">local</span>-port]      protocol    port-<span class="built_in">number</span>   -</span><br></pre></td></tr></table></figure>
<p>最后，如果需要转发一段端口，在 DEST PORT 列中指定范围为 low-port。</p>
<p>重要: 上述方法不适用于从本地网络转发。如果需要这样做，请参阅 FAQ 2(<a href="https://shorewall.org/FAQ.htm#faq2)。" target="_blank" rel="noopener">https://shorewall.org/FAQ.htm#faq2)。</a></p>
<p><strong>（FAQ 1a）好的，我按照说明操作，但它不起作用。</strong></p>
<p>回答：这通常是以下五个原因之一造成的：</p>
<ol>
<li><p>您尝试重定向一个 UDP 端口，并且已经存在通过 ACCEPT 规则创建的 conntrack 表条目。<br>例子：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DNAT loc:<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span> dmz:<span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span> udp <span class="number">53</span></span><br></pre></td></tr></table></figure>
<p>假设您已经安装了 conntrack 软件包，可以使用以下命令删除所有此类 conntrack 表条目：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conntrack -D -s <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span> -p udp --dport <span class="number">53</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>您尝试从防火墙内部进行测试（不，这不行，请参阅“（FAQ 2）我将 www.mydomain.com（IP 130.151.100.69）的 www 请求端口转发到我本地网络中的系统 192.168.1.5。外部客户端可以浏览 <a href="http://www.mydomain.com，但内部客户端不行。”）。(https://shorewall.org/FAQ.htm#faq2" target="_blank" rel="noopener">http://www.mydomain.com，但内部客户端不行。”）。(https://shorewall.org/FAQ.htm#faq2</a>)</p>
</li>
<li><p>您的本地系统（您尝试转发到的系统）存在更基本的问题，例如默认网关错误（必须设置为防火墙内部接口的 IP 地址；如果由于某种原因不可能，请参阅 FAQ 1f）。</p>
</li>
<li><p>您的 ISP 正在阻止该特定端口的入站流量，或者，对于 TCP，您的 ISP 正在丢弃出站的 SYN,ACK 响应。</p>
</li>
<li><p>您运行的是 Mandriva Linux 10.0 之前的版本，并且已配置了互联网连接共享。在这种情况下，本地区域的名称是 ‘masq’ 而不是 ‘loc’（在规则中将所有 ‘loc’ 替换为 ‘masq’）。您可能需要重新安装符合 Shorewall 文档的配置的 Shorewall。有关详细信息，请参阅双接口快速入门指南。</p>
</li>
</ol>
<p><strong>（FAQ 1b）我仍然在端口转发方面遇到问题。</strong></p>
<p>回答：要进一步诊断此问题：</p>
<ul>
<li>以 root 用户身份输入 “shorewall reset”（如果您运行的是 Shorewall Lite，则输入 “shorewall-lite reset”）。这会清除所有 Netfilter 计数器。</li>
<li>尝试从外部主机连接到重定向的端口。</li>
<li>以 root 用户身份输入 “shorewall show nat”（如果您运行的是 Shorewall Lite，则输入 “shorewall-lite show nat”）。<br>找到相应的 DNAT 规则。它会在名为 <source zone>_dnat 的链中（在上述示例中为“net_dnat”）。<br>第一列中的数据包计数是否非零？如果是这样，则连接请求已到达防火墙并被重定向到服务器。在这种情况下，问题通常是本地系统（您尝试转发到的系统）缺少或错误的默认网关设置（该系统的默认网关必须是防火墙接口的 IP 地址，除非您使用 FAQ 1f 中描述的 hack）。</li>
<li>如果数据包计数为零：<ul>
<li>连接请求未到达服务器（可能被您的 ISP 阻止）；或</li>
<li>您尝试连接到防火墙上的次要 IP 地址，而您的规则仅重定向主要 IP 地址（您需要在 DNAT 规则的“ORIG. DEST.”列中指定次要 IP 地址）；或</li>
<li>您的 DNAT 规则与连接请求不匹配。在这种情况下，您可能需要使用数据包嗅探器（如 tcpdump 或 Wireshark）进一步诊断问题。</li>
<li>流量通过不同的接口进入防火墙（在 /etc/shorewall/interfaces 中接口顺序是否反了？）。</li>
</ul>
</li>
<li>如果数据包计数非零，请检查日志以查看连接是否被丢弃或拒绝。如果是，则您可能有区域定义问题，即服务器所在的区域与 DEST 列中指定的区域不同。在 root 提示符下输入 “shorewall show zones”（如果运行的是 Shorewall Lite，则输入 “shorewall-lite show zones”），然后确保在 DEST 列中指定的区域匹配 REJECT/DROP 日志消息中的 OUT=<dev> 和 DEST=<ip>。</li>
<li>如果一切似乎都正确但连接仍然不起作用，可能是您的 ISP 正在阻止 SYN,ACK 响应。这种技术允许您的 ISP 检测您是否在运行服务器（通常违反您的服务协议），并阻止与该服务器的连接建立。</li>
</ul>
<p><strong>（FAQ 1c）从互联网，我想连接到我的防火墙上的端口 1022，并让防火墙将连接转发到本地系统 192.168.1.3 的端口 22。我该怎么做？</strong></p>
<p>回答：在 /etc/shorewall/rules 中：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ACTION SOURCE DEST PROTO DPORT</span><br><span class="line">DNAT net loc:<span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span>:<span class="number">22</span> tcp <span class="number">1022</span></span><br></pre></td></tr></table></figure>
<p><strong>（FAQ 1d）我在 DMZ 中有一个 Web 服务器，并使用端口转发使该服务器可以从互联网访问。这工作正常，但当我的本地用户尝试使用防火墙的外部 IP 地址连接到服务器时，它不起作用。</strong></p>
<p>回答：请参阅 FAQ 2b(<a href="https://shorewall.org/FAQ.htm#faq2b)。" target="_blank" rel="noopener">https://shorewall.org/FAQ.htm#faq2b)。</a></p>
<p><strong>（FAQ 1e）为了防止暴力攻击，我希望将所有在非标准端口（4104）上的连接重定向到路由器/防火墙上的端口 22。我注意到设置一个 REDIRECT 规则会导致防火墙同时打开来自 net 的端口 4104 和 22 的连接。是否有可能只将 4104 重定向到本地主机的端口 22，并丢弃来自 net 的端口 22 的连接尝试？</strong></p>
<p>重要: 在具有“扩展 conntrack 匹配”（NEW_CONNTRACK_MATCH）功能的系统上（参见 shorewall show capabilities 的输出），端口 22 仅对原始目标端口为 4104 的连接打开，本常见问题不适用。</p>
<p>Ryan 提供的答案：假设本地防火墙接口的 IP 地址是 192.168.1.1。如果您将 SSHD 配置为仅监听该地址，并添加以下规则，则您将能够从 net 在端口 4104 上访问，并从 LAN 在端口 22 上访问。</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ACTION SOURCE DEST PROTO DPORT</span><br><span class="line">DNAT net fw:<span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span>:<span class="number">22</span> tcp <span class="number">4104</span></span><br></pre></td></tr></table></figure>
<p><strong>（FAQ 1f）为什么我端口转发的服务器的默认网关必须设置为我的 Shorewall 系统的 IP 地址？</strong></p>
<p>回答：让我们举个例子。假设：</p>
<ul>
<li><p>您的 Shorewall 防火墙的外部 IP 地址是 206.124.146.176（eth0），内部 IP 地址是 192.168.1.1（eth1）。</p>
</li>
<li><p>您有另一个网关路由器，外部 IP 地址为 130.252.100.109，内部 IP 地址为 192.168.1.254。</p>
</li>
<li><p>您在两个路由器后面有一个 FTP 服务器，IP 地址为 192.168.1.4。</p>
</li>
<li><p>FTP 服务器的默认网关通过第二个路由器（192.168.1.254）。</p>
</li>
<li><p>您在 Shorewall 系统上有以下规则：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span><br><span class="line">DNAT net loc:<span class="number">192.168</span><span class="number">.1</span><span class="number">.4</span> tcp <span class="number">21</span> - <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>互联网主机 16.105.221.4 发出命令 ftp 206.124.146.176。</p>
</li>
</ul>
<p>这导致以下事件序列：</p>
<ol>
<li><p>16.105.221.4 向 206.124.146.176 发送一个目标端口为 21 的 TCP SYN 数据包。</p>
</li>
<li><p>Shorewall 防火墙将目标 IP 地址重写为 192.168.1.4 并转发数据包。</p>
</li>
<li><p>FTP 服务器接收到数据包并接受连接，生成一个 SYN,ACK 数据包返回给 16.105.221.4。由于服务器的默认网关是通过第二台路由器，它将数据包发送到该路由器。</p>
</li>
</ol>
<p>此时，可能会发生以下两种情况之一：第二台路由器要么丢弃或拒绝数据包，要么将源 IP 地址重写为 130.252.100.109 并将数据包返回给 16.105.221.4。不论发生哪种情况，连接都注定失败。显然，如果数据包被拒绝或丢弃，连接将不会成功。但即使数据包到达 16.105.221.4，该主机也会拒绝它，因为源 IP 地址（130.252.100.109）与原始 SYN 数据包的目标 IP 地址（206.124.146.176）不匹配。</p>
<p>解决此问题的最佳方法是将 FTP 服务器的默认网关更改为 Shorewall 系统的内部 IP 地址（192.168.1.1）。但如果不可能，可以使用以下“黑客”方法来解决问题，修改 <code>/etc/shorewall/masq</code> 文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#INTERFACE              SOURCE             ADDRESS         PROTO   PORT</span></span><br><span class="line">eth1:192.168.1.4        0.0.0.0/0          192.168.1.1     tcp     21</span><br></pre></td></tr></table></figure>
<p>在 Shorewall 5.0.14 或更高版本中，等效的 <code>/etc/shorewall/snat</code> 文件规则是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION                 SOURCE              DEST              PROTO  PORT</span></span><br><span class="line">SNAT(192.168.1.1)       0.0.0.0/0           eth1:192.168.1.4  tcp    21</span><br></pre></td></tr></table></figure>
<p>这个规则有一个不良副作用，即所有来自网络的 FTP 连接在 FTP 服务器上看起来像是源自 Shorewall 系统。但它将强制 FTP 服务器通过 Shorewall 系统回复，从而使 Shorewall 系统能够正确地重写响应中的源 IP 地址。</p>
<p><strong>(FAQ 1g) 我想将我的公共 IP 地址 (206.124.146.176) 上的端口 80 重定向到互联网主机 66.249.93.111 上的端口 993</strong></p>
<p>答：这需要一个类似于 FAQ 2(<a href="https://shorewall.org/FAQ.htm#faq2" target="_blank" rel="noopener">https://shorewall.org/FAQ.htm#faq2</a>) 中的黑客方法。假设你的互联网区域名为 net，并连接在接口 eth0 上：</p>
<p>在 /etc/shorewall/rules 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION    SOURCE        DEST                   PROTO    DPORT   SPORT   ORIGDEST</span></span><br><span class="line"></span><br><span class="line">?SECTION ALL</span><br><span class="line">?SECTION ESTABLISHED</span><br><span class="line">?SECTION RELATED</span><br><span class="line">?SECTION INVALID</span><br><span class="line">?SECTION UNTRACKED</span><br><span class="line">?SECTION NEW</span><br><span class="line"></span><br><span class="line">DNAT       net           net:66.249.93.111:993  tcp      80      -       206.124.146.176</span><br></pre></td></tr></table></figure>
<p>在 /etc/shorewall/interfaces 中，指定 eth0 上的 routeback 选项：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?FORMAT 2</span><br><span class="line"><span class="comment">#ZONE		INTERFACE		OPTIONS</span></span><br><span class="line">net             eth0                    routeback</span><br></pre></td></tr></table></figure>
<p>在 /etc/shorewall/masq 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#INTERFACE              SOURCE          ADDRESS         PROTO   PORT</span></span><br><span class="line">eth0:66.249.93.111      0.0.0.0/0       206.124.146.176 tcp     993</span><br></pre></td></tr></table></figure>
<p>当运行 Shorewall 5.0.14 或更高版本时，等效的 /etc/shorewall/snat 文件是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION                 SOURCE          DEST                PROTO   PORT</span></span><br><span class="line">SNAT(206.124.146.176)   0.0.0.0/0       eth0:66.249.93.111  tcp     993</span><br></pre></td></tr></table></figure>
<p>并在 /etc/shorewall/shorewall.conf 中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IP_FORWARDING=On</span><br></pre></td></tr></table></figure>
<p>如 FAQ 2 中的黑客方法，这种方法会导致所有转发的连接在服务器 (66.249.93.111) 上看起来像是源自你的防火墙 (206.124.146.176)。</p>
<p><strong>(FAQ 1h) 如何设置 shorewall 允许从 net 访问端口 9022 的 ssh？SSHD 监听的是端口 22。</strong></p>
<p>答：使用以下规则。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION         SOURCE          DEST            PROTO   DPORT</span></span><br><span class="line">REDIRECT        net             22              tcp     9022</span><br></pre></td></tr></table></figure>
<p>请注意，上述规则也将允许来自 net 的连接访问 TCP 端口 22。如果你不希望这样，请参见 FAQ 1e。</p>
<p><strong>(FAQ 1j) 为什么这个 DNAT 规则不起作用？</strong></p>
<p>我添加了这个规则，但仍然看到以下日志消息：</p>
<p>规则：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DNAT           scnet:172.19.41.2       dmz0:10.199.198.145             udp     2055</span><br></pre></td></tr></table></figure>
<p>日志：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sep <span class="number">21</span> <span class="number">12</span>:<span class="number">55</span>:<span class="number">37</span> fw001 kernel: [<span class="number">10357687.114928</span>] Shorewall:scnet2fw:DROP:IN=eth2 OUT=</span><br><span class="line">MAC=<span class="number">00</span>:<span class="number">26</span>:<span class="number">33</span>:dd:aa:<span class="number">05</span>:<span class="number">00</span>:<span class="number">24</span>:f7:<span class="number">19</span>:ce:<span class="number">44</span>:<span class="number">08</span>:<span class="number">00</span> SRC=<span class="number">172.19</span><span class="number">.41</span><span class="number">.2</span> DST=<span class="number">172.19</span><span class="number">.1</span><span class="number">.1</span> LEN=<span class="number">1492</span></span><br><span class="line">TOS=<span class="number">0x00</span> PREC=<span class="number">0x00</span> TTL=<span class="number">63</span> ID=<span class="number">23035</span> PROTO=UDP SPT=<span class="number">6376</span> DPT=<span class="number">2055</span> LEN=<span class="number">1472</span></span><br></pre></td></tr></table></figure>
<p>答：在你添加规则之前，已经存在一个 conntrack 条目导致连接失败。安装 conntrack 工具程序并使用它删除该条目。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conntrack -D -s 172.19.41.2 -d 172.19.1.1 -p udp -sport 6367 -dport 2055</span><br></pre></td></tr></table></figure>
<p><strong>(FAQ 30) 我对何时使用 DNAT 规则和何时使用 ACCEPT 规则感到困惑。</strong></p>
<p>答：查看适合你设置的 QuickStart Guide (<a href="https://shorewall.org/shorewall_quickstart_guide.htm" target="_blank" rel="noopener">https://shorewall.org/shorewall_quickstart_guide.htm</a>) 是一个好主意；这些指南以教程的形式涵盖了这个主题。DNAT 规则应在需要与 SNAT/MASQUERADE 方向相反的连接时使用。因此，如果你从本地网络到互联网使用伪装或 SNAT，则需要使用 DNAT 规则以允许从互联网到你的本地网络的连接。</p>
<p>注意</p>
<p>如果你同时使用 1:1 NAT 和 SNAT/MASQUERADE，那么那些涉及 1:1 NAT 的连接应使用 ACCEPT 而不是 DNAT。注意，DNAT 可以用来覆盖 1:1 NAT，从而将连接重定向到不同的内部系统或端口，而不是使用 1:1 NAT 的情况。</p>
<p>你还需要在有意重写目标 IP 地址或端口号时使用 DNAT 规则。在所有其他情况下，你使用 ACCEPT，除非你需要劫持连接并在防火墙本身上处理它们；在这种情况下，你使用 REDIRECT 规则。</p>
<p>注意</p>
<p>前面的答案不应被解读为 DNAT 只能与 SNAT 一起使用。但在常见的使用私有本地地址的配置中，这种使用是最常见的。</p>
<p><strong>(FAQ 8) 我有多个外部 IP 地址，并使用 /etc/shorewall/nat 将它们与 DMZ 中的系统关联。当我添加 DNAT 规则，例如针对端口 80 和 443 时，Shorewall 会将这些端口的连接重定向到我所有的地址。我如何将 DNAT 限制为仅单个地址？</strong></p>
<p>答：在 ORIGDEST 列中指定你想要重定向的外部地址。</p>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ACTION         SOURCE          DEST                    PROTO   DPORT   SPORT   ORIGDEST</span></span><br><span class="line">DNAT            net             net:192.168.4.22        tcp     80,443  -       206.124.146.178</span><br></pre></td></tr></table></figure>
<p><strong>(FAQ 38) 哪里可以找到更多关于 DNAT 的信息？</strong></p>
<p>答：Ian Allen 写了一篇关于 DNAT 和 Linux 的论文(<a href="http://idallen.com/dnat.txt)。" target="_blank" rel="noopener">http://idallen.com/dnat.txt)。</a></p>
<p><strong>(FAQ 48) 如何使用 Shorewall 设置透明 HTTP 代理？</strong></p>
<p>答：请参见 Shorewall_Squid_Usage.html (<a href="https://shorewall.org/Shorewall_Squid_Usage.html)。" target="_blank" rel="noopener">https://shorewall.org/Shorewall_Squid_Usage.html)。</a></p>
<ul>
<li><a href="https://shorewall.org/FAQ.htm#DNS-DNAT" target="_blank" rel="noopener">DNS and Port Forwarding/NAT</a>——DNS 和端口转发/NAT</li>
<li><a href="https://shorewall.org/FAQ.htm#Blacklisting" target="_blank" rel="noopener">Blacklisting</a>——黑名单</li>
<li><a href="https://shorewall.org/FAQ.htm#MSN" target="_blank" rel="noopener">Netmeeting/MSN</a>——Netmeeting/MSN</li>
<li><a href="https://shorewall.org/FAQ.htm#Openports" target="_blank" rel="noopener">Open Ports</a>——开放端口</li>
<li><a href="https://shorewall.org/FAQ.htm#Connections" target="_blank" rel="noopener">Connection Problems</a>——连接问题</li>
<li><a href="https://shorewall.org/FAQ.htm#Logging" target="_blank" rel="noopener">Logging</a>——日志记录</li>
<li><a href="https://shorewall.org/FAQ.htm#Routing" target="_blank" rel="noopener">Routing</a>——路由</li>
<li><a href="https://shorewall.org/FAQ.htm#Start-Stop" target="_blank" rel="noopener">Starting and Stopping</a>——启动和停止</li>
<li><a href="https://shorewall.org/FAQ.htm#MultiISP" target="_blank" rel="noopener">Multiple ISPs</a>——多 ISP</li>
<li><a href="https://shorewall.org/FAQ.htm#idm1224" target="_blank" rel="noopener">Using DNS Names</a>——使用 DNS 名称</li>
<li><a href="https://shorewall.org/FAQ.htm#TC" target="_blank" rel="noopener">Traffic Shaping</a>——流量整形</li>
<li><a href="https://shorewall.org/FAQ.htm#About" target="_blank" rel="noopener">About Shorewall</a>——关于 Shorewall</li>
<li><a href="https://shorewall.org/FAQ.htm#ALIASES" target="_blank" rel="noopener">Alias IP Addresses/Virtual Interfaces</a>——别名 IP 地址/虚拟接口</li>
<li><a href="https://shorewall.org/FAQ.htm#Lite" target="_blank" rel="noopener">Shorewall Lite</a>——Shorewall Lite</li>
<li><a href="https://shorewall.org/FAQ.htm#VOIP" target="_blank" rel="noopener">VOIP</a>——VOIP</li>
<li><a href="https://shorewall.org/FAQ.htm#faq40" target="_blank" rel="noopener">IPv6</a>——IPv6</li>
<li><a href="https://shorewall.org/FAQ.htm#idm1477" target="_blank" rel="noopener">Wifidog</a>——Wifidog</li>
<li><a href="https://shorewall.org/FAQ.htm#Misc" target="_blank" rel="noopener">Miscellaneous</a>——其他事项</li>
</ul>
<h2 id="谷歌机械翻译FAQs"><a href="#谷歌机械翻译FAQs" class="headerlink" title="谷歌机械翻译FAQs"></a>谷歌机械翻译FAQs</h2><blockquote>
<p><a href="https://shorewall.org/FAQ.htm" target="_blank" rel="noopener">https://shorewall.org/FAQ.htm</a></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br><span class="line">1467</span><br><span class="line">1468</span><br><span class="line">1469</span><br><span class="line">1470</span><br><span class="line">1471</span><br><span class="line">1472</span><br><span class="line">1473</span><br><span class="line">1474</span><br><span class="line">1475</span><br><span class="line">1476</span><br><span class="line">1477</span><br><span class="line">1478</span><br><span class="line">1479</span><br><span class="line">1480</span><br><span class="line">1481</span><br><span class="line">1482</span><br><span class="line">1483</span><br><span class="line">1484</span><br><span class="line">1485</span><br><span class="line">1486</span><br><span class="line">1487</span><br><span class="line">1488</span><br><span class="line">1489</span><br><span class="line">1490</span><br><span class="line">1491</span><br><span class="line">1492</span><br><span class="line">1493</span><br><span class="line">1494</span><br><span class="line">1495</span><br><span class="line">1496</span><br><span class="line">1497</span><br><span class="line">1498</span><br><span class="line">1499</span><br><span class="line">1500</span><br><span class="line">1501</span><br><span class="line">1502</span><br><span class="line">1503</span><br><span class="line">1504</span><br><span class="line">1505</span><br><span class="line">1506</span><br><span class="line">1507</span><br><span class="line">1508</span><br><span class="line">1509</span><br><span class="line">1510</span><br><span class="line">1511</span><br><span class="line">1512</span><br><span class="line">1513</span><br><span class="line">1514</span><br><span class="line">1515</span><br><span class="line">1516</span><br><span class="line">1517</span><br><span class="line">1518</span><br><span class="line">1519</span><br><span class="line">1520</span><br><span class="line">1521</span><br><span class="line">1522</span><br><span class="line">1523</span><br><span class="line">1524</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Shorewall</span> <span class="string">常见问题解答</span></span><br><span class="line"><span class="string">Shorewall</span> <span class="string">社区</span></span><br><span class="line"><span class="string">汤姆·</span> <span class="string">伊斯特普</span></span><br><span class="line"></span><br><span class="line"><span class="string">版权所有</span> <span class="string">©</span> <span class="number">2001</span><span class="number">-2016</span> <span class="string">Thomas</span> <span class="string">M.</span> <span class="string">Eastep</span></span><br><span class="line"></span><br><span class="line"><span class="string">根据自由软件基金会发布的</span> <span class="string">GNU</span> <span class="string">自由文档许可证</span> <span class="number">1.2</span> <span class="string">版或任何后续版本的条款，允许复制、分发和/或修改本文档；无固定章节、无封面、无封底文字。许可证副本包含在题为“</span> <span class="string">GNU</span> <span class="string">自由文档许可证”</span> <span class="string">的部分中。</span></span><br><span class="line"></span><br><span class="line"><span class="number">2020</span><span class="string">/07/25</span></span><br><span class="line"></span><br><span class="line"><span class="string">目录</span></span><br><span class="line"></span><br><span class="line"><span class="string">安装</span> <span class="string">Shorewall</span></span><br><span class="line"><span class="string">升级</span> <span class="string">Shorewall</span></span><br><span class="line"><span class="string">端口转发（端口重定向）</span></span><br><span class="line"><span class="string">DNS</span> <span class="string">和端口转发/NAT</span></span><br><span class="line"><span class="string">黑名单</span></span><br><span class="line"><span class="string">网络会议/MSN</span></span><br><span class="line"><span class="string">开放端口</span></span><br><span class="line"><span class="string">连接问题</span></span><br><span class="line"><span class="string">日志记录</span></span><br><span class="line"><span class="string">路由</span></span><br><span class="line"><span class="string">启动和停止</span></span><br><span class="line"><span class="string">多个</span> <span class="string">ISP</span></span><br><span class="line"><span class="string">使用</span> <span class="string">DNS</span> <span class="string">名称</span></span><br><span class="line"><span class="string">流量整形</span></span><br><span class="line"><span class="string">关于</span> <span class="string">Shorewall</span></span><br><span class="line"><span class="string">别名</span> <span class="string">IP</span> <span class="string">地址/虚拟接口</span></span><br><span class="line"><span class="string">Shorewall</span> <span class="string">Lite</span></span><br><span class="line"><span class="string">网络电话</span></span><br><span class="line"><span class="string">IPv6</span></span><br><span class="line"><span class="string">无线狗</span></span><br><span class="line"><span class="string">各种各样的</span></span><br><span class="line"></span><br><span class="line"><span class="string">警告</span></span><br><span class="line"></span><br><span class="line"><span class="string">本文适用于</span> <span class="string">Shorewall</span> <span class="number">4.4</span> <span class="string">及更高版本。如果您运行的是</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.0</span> <span class="string">之前的版本，请参阅该版本的文档。</span></span><br><span class="line"><span class="string">安装</span> <span class="string">Shorewall</span></span><br><span class="line"><span class="string">在哪里可以找到分步安装和配置说明？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：查看快速入门指南。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">92</span><span class="string">）</span> <span class="string">Shorewall</span> <span class="string">有很多软件包；我应该安装哪一个？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：首次安装</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.0</span> <span class="string">或更高版本时，必须安装shorewall软件包。如果要配置</span> <span class="string">IPv6</span> <span class="string">防火墙，还必须安装shorewall6。从</span> <span class="string">Shorewall</span> <span class="number">4.5</span> <span class="string">开始，必须先安装shorewall-core软件包。</span></span><br><span class="line"><span class="string">（常见问题解答</span> <span class="string">92a）有人曾告诉我安装</span> <span class="string">shorewall-perl；有什么用吗？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这是</span> <span class="string">Shorewall</span> <span class="number">4.2</span> <span class="string">及更早版本中的好建议。在那些版本中，有两个软件包提供基本的防火墙功能：</span> <span class="string">shorewall-shell和shorewall-perl。从</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.0</span> <span class="string">开始，</span> <span class="string">shorewall-shell已停用，</span> <span class="string">shorewall-perl已重命名为shorewall。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">37</span><span class="string">）我刚刚在</span> <span class="string">Debian</span> <span class="string">上安装了</span> <span class="string">Shorewall，/etc/shorewall</span> <span class="string">目录几乎是空的！！！</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：</span></span><br><span class="line"><span class="string">重要的</span></span><br><span class="line"></span><br><span class="line"><span class="string">安装</span> <span class="string">.deb</span> <span class="string">包后，在尝试配置</span> <span class="string">Shorewall</span> <span class="string">之前，请听取前</span> <span class="string">Shorewall</span> <span class="string">Debian</span> <span class="string">维护者</span> <span class="string">Lorenzo</span> <span class="string">Martignoni</span> <span class="string">的建议：</span></span><br><span class="line"></span><br><span class="line"><span class="string">“有关在</span> <span class="string">Debian</span> <span class="string">系统上使用</span> <span class="string">Shorewall</span> <span class="string">的更多信息，请查看</span> <span class="string">shorewall-common</span> <span class="string">Debian</span> <span class="string">软件包提供的</span> <span class="string">/usr/share/doc/shorewall-common/README.Debian。</span> <span class="string">”</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您使用</span> <span class="string">.deb</span> <span class="string">安装，您会发现您的/etc/shorewall目录几乎是空的。这是故意的。发布的配置文件骨架可以在您的系统的目录中找到/usr/share/doc/shorewall-common/default-config。只需将您需要的文件从该目录复制到/etc/shorewall并修改副本即可。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">37a）我刚刚在</span> <span class="string">Debian</span> <span class="string">上安装了</span> <span class="string">Shorewall，但找不到示例配置。</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：从</span> <span class="string">Shorewall</span> <span class="number">4.4</span> <span class="string">开始，示例位于</span> <span class="string">shorewall</span> <span class="string">包中，并安装在</span> <span class="string">中/usr/share/doc/shorewall/examples/。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">14</span><span class="string">）我找不到</span> <span class="string">Shorewall</span> <span class="number">4.4</span> <span class="string">shorewall-common、shorewall-shell</span> <span class="string">和</span> <span class="string">shorewall-perl</span> <span class="string">软件包？它们在哪儿？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在</span> <span class="string">Shorewall</span> <span class="number">4.4</span> <span class="string">中，</span> <span class="string">shorewall-shell软件包已停用。shorewall</span> <span class="string">-common和shorewall-perl软件包合并为一个shorewall软件包。在</span> <span class="string">Shorewall</span> <span class="number">4.5</span> <span class="string">中，添加了shorewall-core软件包，所有其他软件包都依赖于</span> <span class="string">shorewall-core。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">1.5</span><span class="string">）安装最新版本（&gt;</span> <span class="number">5.1</span><span class="number">.10</span><span class="number">.1</span><span class="string">）的</span> <span class="string">Shorewall</span> <span class="string">后，当我更改配置并执行“shorewall</span> <span class="string">reload”或“shorewall</span> <span class="string">restart”时，我的更改未出现在正在运行的规则集中。为什么会发生这种情况？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这种情况发生在：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您使用</span> <span class="string">INCLUDE</span> <span class="string">(?INCLUDE)。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">包含的文件位于</span> <span class="string">/etc/shorewall[6]</span> <span class="string">的子目录或单独的目录中。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在shorewall[6].conf(5)中已将</span> <span class="string">AUTOMAKE=Yes</span> <span class="string">设置成</span></span><br><span class="line"></span><br><span class="line"><span class="string">当</span> <span class="string">AUTOMAKE=Yes</span> <span class="string">时，编译器会在</span> <span class="string">CONFIG_PATH</span> <span class="string">中的每个目录中查找比上次生成的防火墙脚本更新的文件。如果没有找到，则按原样使用旧脚本。在</span> <span class="number">5.1</span><span class="number">.10</span><span class="number">.2</span> <span class="string">之前的版本中，该搜索是递归的，因此会自动搜索</span> <span class="string">/etc/shorewall[6]</span> <span class="string">子目录中的更改。如果</span> <span class="string">CONFIG_PATH</span> <span class="string">上的目录嵌套很深，这会影响性能。因此，从</span> <span class="number">5.1</span><span class="number">.10</span><span class="number">.2</span> <span class="string">版本开始，只搜索目录本身。您可以通过设置</span> <span class="string">AUTOMAKE=recursive</span> <span class="string">或</span> <span class="string">AUTOMAKE=</span> <span class="string">来恢复</span> <span class="number">5.1</span><span class="number">.10</span><span class="number">.2</span> <span class="string">之前的行为integer，其中</span> <span class="string">integer</span> <span class="string">指定搜索深度。如果您包含的文件位于单独的目录中，则必须将该目录添加到</span> <span class="string">CONFIG_PATH</span> <span class="string">才能使</span> <span class="string">AUTOMAKE</span> <span class="string">正常工作。</span></span><br><span class="line"><span class="string">升级</span> <span class="string">Shorewall</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">66</span><span class="string">）我正在尝试升级到</span> <span class="string">Shorewall</span> <span class="number">4.</span><span class="string">x</span> <span class="string">或更高版本；我需要安装以下哪些软件包？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：请参阅升级问题。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">34</span><span class="string">）我尝试升级到</span> <span class="string">Shorewall</span> <span class="number">4.4</span> <span class="string">或更高版本，但找不到</span> <span class="string">shorewall-common、shorewall-shell</span> <span class="string">和</span> <span class="string">shorewall-perl</span> <span class="string">软件包？它们在哪里？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在</span> <span class="string">Shorewall</span> <span class="number">4.4</span> <span class="string">中，</span> <span class="string">shorewall-shell软件包已停用。shorewall</span> <span class="string">-common和shorewall-perl软件包已合并为一个shorewall软件包。有关详细信息，请参阅升级问题。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">34a）我尝试升级到</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="string">，但在启动</span> <span class="string">Shorewall</span> <span class="string">时出现错误。我在哪里可以找到有关这些问题的信息？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：请参阅升级问题。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">34b）我尝试升级到</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="string">，但在尝试启动</span> <span class="string">Shorewall</span> <span class="string">时看到警告消息。我在哪里可以找到有关这些问题的信息？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：请参阅升级问题。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">76</span><span class="string">）我刚刚升级了系统，现在伪装不起作用了？发生了什么？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这种情况发生在那些忽略我们的建议并允许安装程序用具有默认设置的安装程序替换其工作的/etc/shorewall/shorewall.conf人身上。无法转发流量（例如在本地网络伪装网络访问期间）通常意味着/etc/shorewall/shorewall.conf包含默认设置</span> <span class="string">IP_FORWARDING=Keep；它应该是</span> <span class="string">IP_FORWARDING=On。</span></span><br><span class="line"></span><br><span class="line"><span class="string">更新：从</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.21</span> <span class="string">开始，有一个shorewall</span> <span class="string">更新命令，可以对现有的</span> <span class="string">shorewall.conf</span> <span class="string">和新的</span> <span class="string">shorewall.conf</span> <span class="string">进行智能合并。</span></span><br><span class="line"><span class="string">（常见问题解答</span> <span class="number">2.6</span><span class="string">）升级到</span> <span class="string">Shorewall</span> <span class="string">的最新版本（&gt;</span> <span class="number">5.1</span><span class="number">.10</span><span class="number">.1</span><span class="string">）后，当我更改配置并执行“shorewall</span> <span class="string">reload”或“shorewall</span> <span class="string">restart”时，我的更改未显示在正在运行的规则集中。为什么会发生这种情况？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：参见常见问题</span> <span class="number">1.5</span><span class="string">。</span></span><br><span class="line"><span class="string">端口转发（端口重定向）</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">1</span><span class="string">）我想将</span> <span class="string">UDP</span> <span class="string">端口</span> <span class="number">7777</span> <span class="string">转发到</span> <span class="string">IP</span> <span class="string">地址为</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span> <span class="string">的个人电脑。我找遍了所有地方，但找不到如何操作。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：从网络到本地系统的端口转发规则的格式如下：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"><span class="string">DNAT</span> <span class="string">net</span> <span class="string">loc:本地IP地址[:本地端口]</span>      <span class="string">协议</span>     <span class="string">端口号</span></span><br><span class="line"></span><br><span class="line"><span class="string">因此要将</span> <span class="string">UDP</span> <span class="string">端口</span> <span class="number">7777</span> <span class="string">转发到内部系统</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span><span class="string">，规则是：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"><span class="string">DNAT</span> <span class="string">网络地址：192.168.1.5</span> <span class="string">udp</span> <span class="number">7777</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您想将指向防火墙上特定地址（external-IP）的请求转发到内部系统：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span></span><br><span class="line"><span class="string">DNAT</span> <span class="string">net</span> <span class="string">loc:本地</span> <span class="string">IP</span> <span class="string">地址&gt;[:本地端口]</span>     <span class="string">协议</span>    <span class="string">端口号</span>   <span class="bullet">-</span>       <span class="string">外部</span> <span class="string">IP</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您想要转发来自特定</span> <span class="string">Internet</span> <span class="string">地址（地址）的请求：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span></span><br><span class="line"><span class="string">DNAT</span> <span class="string">net:地址</span>   <span class="string">loc:本地</span> <span class="string">IP</span> <span class="string">地址[:本地端口]</span>      <span class="string">协议</span>    <span class="string">端口号</span>   <span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="string">最后，如果您需要转发一系列端口，请在</span> <span class="string">DEST</span> <span class="string">PORT</span> <span class="string">列中将范围指定为low-port:high-port。</span></span><br><span class="line"><span class="string">重要的</span></span><br><span class="line"></span><br><span class="line"><span class="string">以上方法不适用于从本地网络转发。如果您想这样做，请参阅常见问题解答</span> <span class="number">2</span><span class="string">。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">1a）好的</span> <span class="bullet">-</span> <span class="string">我按照这些说明操作，但是没有用</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这通常是以下五种情况之一造成的结果：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您正在尝试重定向</span> <span class="string">UDP</span> <span class="string">端口，并且已经存在通过</span> <span class="string">ACCEPT</span> <span class="string">规则创建的流的</span> <span class="string">conntrack</span> <span class="string">表条目。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">例子：</span></span><br><span class="line"></span><br><span class="line">            <span class="string">DNAT</span> <span class="string">定位：192.168.0.2</span> <span class="string">dmz：192.168.1.3</span> <span class="string">udp</span> <span class="number">53</span></span><br><span class="line"></span><br><span class="line">    <span class="string">假设您已经安装了conntrack包，您可以使用以下命令删除所有此类</span> <span class="string">conntrack</span> <span class="string">表条目：</span></span><br><span class="line"></span><br><span class="line">            <span class="string">conntrack</span> <span class="string">-D</span> <span class="string">-s</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span> <span class="string">-p</span> <span class="string">udp</span> <span class="string">--dport</span> <span class="number">53</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您正在尝试从防火墙内部进行测试（不，那样不行</span> <span class="bullet">-</span> <span class="string">请参阅“（常见问题解答</span> <span class="number">2</span><span class="string">）我将</span> <span class="string">www</span> <span class="string">请求转发到</span> <span class="string">www.mydomain.com（IP</span> <span class="number">130.151</span><span class="number">.100</span><span class="number">.69</span><span class="string">）到我本地网络中的系统</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span><span class="string">。外部客户端可以浏览</span> <span class="string">http://www.mydomain.com，但内部客户端不能。”</span> <span class="string">一节）。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您的本地系统（您尝试转发到的系统）存在更基本的问题，例如默认网关不正确（必须将其设置为防火墙内部接口的</span> <span class="string">IP</span> <span class="string">地址；如果由于某种原因无法实现，请参阅常见问题解答</span> <span class="string">1f）。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您的</span> <span class="string">ISP</span> <span class="string">正在阻止该特定端口的入站，或者对于</span> <span class="string">TCP，您的</span> <span class="string">ISP</span> <span class="string">正在丢弃出站</span> <span class="string">SYN、ACK</span> <span class="string">响应。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您运行的是</span> <span class="string">Mandriva</span> <span class="string">Linux</span> <span class="number">10.0</span> <span class="string">最终版之前的版本，并且已配置</span> <span class="string">Internet</span> <span class="string">连接共享。在这种情况下，您的本地区域的名称是“masq”而不是“loc”（在规则中将“loc”的所有实例更改为“masq”）。您可能需要考虑以与</span> <span class="string">Shorewall</span> <span class="string">文档相匹配的配置重新安装</span> <span class="string">Shorewall。有关详细信息，请参阅双接口快速入门指南。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">1b）我仍然遇到端口转发问题</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：为了进一步诊断此问题：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">以</span> <span class="string">root</span> <span class="string">身份输入“</span> <span class="string">shorewall</span> <span class="string">reset</span> <span class="string">”</span> <span class="string">（如果您正在运行</span> <span class="string">Shorewall</span> <span class="string">Lite，则输入“</span> <span class="string">shorewall-lite</span> <span class="string">reset</span> <span class="string">”）。这将清除所有</span> <span class="string">Netfilter</span> <span class="string">计数器。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">尝试从外部主机连接到重定向端口。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">以</span> <span class="string">root</span> <span class="string">身份输入“</span> <span class="string">shorewall</span> <span class="string">show</span> <span class="string">nat</span> <span class="string">”</span> <span class="string">（如果您正在运行</span> <span class="string">Shorewall</span> <span class="string">Lite，则输入“</span> <span class="string">shorewall-lite</span> <span class="string">show</span> <span class="string">nat</span> <span class="string">”）。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">找到适当的</span> <span class="string">DNAT</span> <span class="string">规则。它将位于名为&lt;source</span> <span class="string">zone&gt;</span> <span class="string">_dnat</span> <span class="string">的链中（在上面的示例中为“</span> <span class="string">net_dnat</span> <span class="string">”</span> <span class="string">）。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">第一列中的数据包计数是否非零？如果是，则连接请求已到达防火墙并被重定向到服务器。在这种情况下，问题通常是本地系统上缺少默认网关设置或默认网关设置不正确（您尝试转发到的系统</span> <span class="bullet">-</span> <span class="string">其默认网关必须是防火墙与该系统的接口的</span> <span class="string">IP</span> <span class="string">地址，除非您使用FAQ</span> <span class="string">1f中描述的黑客技术）。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果数据包数为零：</span></span><br><span class="line"></span><br><span class="line">        <span class="string">连接请求未到达您的服务器（可能被您的</span> <span class="string">ISP</span> <span class="string">阻止）；或者</span></span><br><span class="line"></span><br><span class="line">        <span class="string">您正在尝试连接到防火墙上的辅助</span> <span class="string">IP</span> <span class="string">地址，并且您的规则仅重定向主</span> <span class="string">IP</span> <span class="string">地址（您需要在DNAT</span> <span class="string">规则中的“</span> <span class="string">ORIG.</span> <span class="string">DEST.</span> <span class="string">”列中指定辅助</span> <span class="string">IP</span> <span class="string">地址）；或者</span></span><br><span class="line"></span><br><span class="line">        <span class="string">您的</span> <span class="string">DNAT</span> <span class="string">规则在其他方面与连接请求不匹配。在这种情况下，您可能必须使用数据包嗅探器（例如</span> <span class="string">tcpdump</span> <span class="string">或</span> <span class="string">Wireshark）来进一步诊断问题。</span></span><br><span class="line"></span><br><span class="line">        <span class="string">流量正在通过不同的接口进入您的防火墙（接口反转/etc/shorewall/interfaces？）。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果数据包计数不为零，请检查日志以查看连接是否被丢弃或拒绝。如果是，则可能是区域定义问题，即服务器所在的区域与</span> <span class="string">DEST</span> <span class="string">列中指定的区域不同。在</span> <span class="string">root</span> <span class="string">提示符下，键入“</span> <span class="string">shorewall</span> <span class="string">show</span> <span class="string">zone</span> <span class="string">”（“</span> <span class="string">shorewall-lite</span> <span class="string">show</span> <span class="string">zone</span> <span class="string">”），然后确保在</span> <span class="string">DEST</span> <span class="string">列中指定了列表中与</span> <span class="string">REJECT/DROP</span> <span class="string">日志消息中的</span> <span class="string">OUT=&lt;dev&gt;</span> <span class="string">和</span> <span class="string">DEST=</span> <span class="string">&lt;ip&gt;</span> <span class="string">匹配的第一个区域。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果这些测试看起来一切正常，但连接却无法正常工作，则可能是您的</span> <span class="string">ISP</span> <span class="string">阻止了</span> <span class="string">SYN、ACK</span> <span class="string">响应。此技术可让您的</span> <span class="string">ISP</span> <span class="string">检测到您何时运行服务器（通常违反您的服务协议）并阻止与该服务器建立连接。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">1c）我想从</span> <span class="string">Internet</span> <span class="string">连接到防火墙上的端口</span> <span class="number">1022</span><span class="string">，并让防火墙将连接转发到本地系统</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span> <span class="string">上的端口</span> <span class="number">22</span><span class="string">。我该怎么做？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在/etc/shorewall/rules：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"><span class="string">DNAT</span> <span class="string">网络位置：192.168.1.3:22</span> <span class="string">tcp</span> <span class="number">1022</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">1d）我的</span> <span class="string">DMZ</span> <span class="string">中有一个</span> <span class="string">Web</span> <span class="string">服务器，我使用端口转发使该服务器可从</span> <span class="string">Internet</span> <span class="string">访问。这工作正常，但当我的本地用户尝试使用防火墙的外部</span> <span class="string">IP</span> <span class="string">地址连接到服务器时，它不起作用。</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：请参阅常见问题</span> <span class="string">2b。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">1e）为了阻止暴力攻击，我想将非标准端口</span> <span class="string">(4104)</span> <span class="string">上的所有连接重定向到路由器/防火墙上的端口</span> <span class="number">22</span><span class="string">。我注意到设置重定向规则会导致防火墙同时打开端口</span> <span class="number">4104</span> <span class="string">和</span> <span class="number">22</span> <span class="string">以允许来自网络的连接。是否可以仅将</span> <span class="number">4104</span> <span class="string">重定向到本地主机端口</span> <span class="number">22</span><span class="string">，并丢弃来自网络的端口</span> <span class="number">22</span> <span class="string">的连接尝试？</span></span><br><span class="line"><span class="string">重要的</span></span><br><span class="line"></span><br><span class="line"><span class="string">在具有“扩展连接跟踪匹配”（NEW_CONNTRACK_MATCH）功能的系统上（参见shorewall</span> <span class="string">show</span> <span class="string">capabilities的输出），端口</span> <span class="number">22</span> <span class="string">仅对原始目标端口为</span> <span class="number">4104</span> <span class="string">的连接开放，并且本常见问题解答不适用。</span></span><br><span class="line"></span><br><span class="line"><span class="string">Ryan</span> <span class="string">提供的答案：假设您本地防火墙接口的</span> <span class="string">IP</span> <span class="string">地址为</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span><span class="string">。如果您将</span> <span class="string">SSHD</span> <span class="string">配置为仅侦听该地址并添加以下规则，那么您将可以从网络访问端口</span> <span class="number">4104</span><span class="string">，并从</span> <span class="string">LAN</span> <span class="string">访问端口</span> <span class="number">22</span><span class="string">。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"><span class="string">DNAT</span> <span class="string">网络转发：192.168.1.1:22</span> <span class="string">tcp</span> <span class="number">4104</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">1f）为什么我转发端口的服务器必须将其默认网关设置为我的</span> <span class="string">Shorewall</span> <span class="string">系统的</span> <span class="string">IP</span> <span class="string">地址？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：我们举个例子。假设</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您的</span> <span class="string">Shorewall</span> <span class="string">防火墙的外部</span> <span class="string">IP</span> <span class="string">地址是</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span><span class="string">（eth0），其内部</span> <span class="string">IP</span> <span class="string">地址是</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span><span class="string">（eth1）。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您有另一个网关路由器，其外部</span> <span class="string">IP</span> <span class="string">地址为</span> <span class="number">130.252</span><span class="number">.100</span><span class="number">.109</span><span class="string">，内部</span> <span class="string">IP</span> <span class="string">地址为</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.254</span><span class="string">。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">两个路由器后面都有一个</span> <span class="string">FTP</span> <span class="string">服务器，IP</span> <span class="string">地址为</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.4</span></span><br><span class="line"></span><br><span class="line">    <span class="string">FTP</span> <span class="string">服务器的默认网关是通过第二个路由器</span> <span class="string">(192.168.1.254)。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您在</span> <span class="string">Shorewall</span> <span class="string">系统上有以下规则：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span></span><br><span class="line">    <span class="string">DNAT</span> <span class="string">网络位置：192.168.1.4</span> <span class="string">tcp</span> <span class="number">21</span> <span class="bullet">-</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span></span><br><span class="line"></span><br><span class="line">    <span class="string">Internet</span> <span class="string">主机</span> <span class="number">16.105</span><span class="number">.221</span><span class="number">.4</span> <span class="string">发出命令ftp</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span></span><br><span class="line"></span><br><span class="line"><span class="string">这会导致以下事件序列：</span></span><br><span class="line"></span><br><span class="line">    <span class="number">16.105</span><span class="number">.221</span><span class="number">.4</span> <span class="string">向</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span> <span class="string">发送一个</span> <span class="string">TCP</span> <span class="string">SYN</span> <span class="string">数据包，指定目标端口</span> <span class="number">21</span><span class="string">。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">Shorewall</span> <span class="string">盒将目标</span> <span class="string">IP</span> <span class="string">地址重写为</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.4</span> <span class="string">并转发数据包。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">FTP</span> <span class="string">服务器接收数据包并接受连接，生成一个</span> <span class="string">SYN、ACK</span> <span class="string">数据包返回给</span> <span class="number">16.105</span><span class="number">.221</span><span class="number">.4</span><span class="string">。由于服务器的默认网关通过第二个路由器，因此它将数据包发送到该路由器。</span></span><br><span class="line"></span><br><span class="line"><span class="string">此时，可能会发生以下两种情况之一。第二台路由器要么丢弃或拒绝数据包；要么将源</span> <span class="string">IP</span> <span class="string">地址重写为</span> <span class="number">130.252</span><span class="number">.100</span><span class="number">.109</span><span class="string">，并将数据包转发回</span> <span class="number">16.105</span><span class="number">.221</span><span class="number">.4</span><span class="string">。无论发生哪种情况，连接都注定会失败。显然，如果数据包被拒绝或丢弃，连接将不会成功。但即使数据包到达</span> <span class="number">16.105</span><span class="number">.221</span><span class="number">.4</span><span class="string">，该主机也会拒绝它，因为它的源</span> <span class="string">IP</span> <span class="string">地址</span> <span class="string">(130.252.100.109)</span> <span class="string">与原始</span> <span class="string">SYN</span> <span class="string">数据包的目标</span> <span class="string">IP</span> <span class="string">地址</span> <span class="string">(206.124.146.176)</span> <span class="string">不匹配。</span></span><br><span class="line"></span><br><span class="line"><span class="string">解决此问题的最佳方法是将</span> <span class="string">FTP</span> <span class="string">服务器上的默认网关更改为</span> <span class="string">Shorewall</span> <span class="string">系统的内部</span> <span class="string">IP</span> <span class="string">地址</span> <span class="string">(192.168.1.1)。但如果这不可行，您可以使用以下丑陋的黑客来解决这个问题/etc/shorewall/masq：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#接口源地址协议端口</span></span><br><span class="line"><span class="string">eth1：192.168.1.4</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span> <span class="string">tcp</span> <span class="number">21</span></span><br><span class="line"></span><br><span class="line"><span class="string">运行</span> <span class="string">Shorewall</span> <span class="number">5.0</span><span class="number">.14</span> <span class="string">或更高版本时，等效/etc/shorewall/snat文件是：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"><span class="string">SNAT(192.168.1.1)</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="string">eth1:192.168.1.4</span> <span class="string">tcp</span> <span class="number">21</span></span><br><span class="line"></span><br><span class="line"><span class="string">此规则有一个不良副作用，即使来自网络的所有</span> <span class="string">FTP</span> <span class="string">连接在</span> <span class="string">FTP</span> <span class="string">服务器上看起来好像它们源自</span> <span class="string">Shorewall</span> <span class="string">系统。但它将强制</span> <span class="string">FTP</span> <span class="string">服务器通过</span> <span class="string">Shorewall</span> <span class="string">系统进行回复，然后</span> <span class="string">Shorewall</span> <span class="string">系统可以正确地重写响应中的源</span> <span class="string">IP</span> <span class="string">地址。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">1g）我想将我的公共</span> <span class="string">IP</span> <span class="string">地址（206.124.146.176）上的端口</span> <span class="number">80</span> <span class="string">重定向到</span> <span class="string">Internet</span> <span class="string">主机</span> <span class="number">66.249</span><span class="number">.93</span><span class="number">.111</span> <span class="string">上的端口</span> <span class="number">993</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这需要类似于FAQ</span> <span class="number">2</span><span class="string">中的卑鄙黑客手段。假设您的</span> <span class="string">Internet</span> <span class="string">区域名为net并连接到接口eth0：</span></span><br><span class="line"></span><br><span class="line"><span class="string">在/etc/shorewall/rules：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span></span><br><span class="line"></span><br><span class="line"><span class="string">?全部部分</span></span><br><span class="line"><span class="string">?部分已建立</span></span><br><span class="line"><span class="string">?SECTION</span> <span class="string">相关</span></span><br><span class="line"><span class="string">?部分无效</span></span><br><span class="line"><span class="string">?部分未跟踪</span></span><br><span class="line"><span class="string">?新部分</span></span><br><span class="line"></span><br><span class="line"><span class="string">DNAT</span> <span class="string">网：66.249.93.111:993</span> <span class="string">tcp</span> <span class="number">80</span> <span class="bullet">-</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span></span><br><span class="line"></span><br><span class="line"><span class="string">在</span> <span class="string">中/etc/shorewall/interfaces，指定eth0</span> <span class="string">上的routeback选项：</span></span><br><span class="line"></span><br><span class="line"><span class="string">?格式</span> <span class="number">2</span></span><br><span class="line"><span class="comment">#区域界面选项</span></span><br><span class="line"><span class="string">net</span> <span class="string">eth0</span>                    <span class="string">路由返回</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/shorewall/masq；</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#接口源地址协议端口</span></span><br><span class="line"><span class="string">eth0:66.249.93.111</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span> <span class="string">tcp</span> <span class="number">993</span></span><br><span class="line"></span><br><span class="line"><span class="string">运行</span> <span class="string">Shorewall</span> <span class="number">5.0</span><span class="number">.14</span> <span class="string">或更高版本时，等效的</span> <span class="string">/etc/shorewall/snat</span> <span class="string">文件是：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"><span class="string">SNAT(206.124.146.176)</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="string">eth0:66.249.93.111</span> <span class="string">tcp</span> <span class="number">993</span></span><br><span class="line"></span><br><span class="line"><span class="string">以及/etc/shorewall/shorewall.conf：</span></span><br><span class="line"></span><br><span class="line"><span class="string">IP_FORWARDING=开启</span></span><br><span class="line"></span><br><span class="line"><span class="string">与常见问题解答</span> <span class="number">2</span> <span class="string">中的破解方法类似，此方法会导致所有转发的连接都查看服务器</span> <span class="string">(66.249.93.11)，就好像它们源自您的防火墙</span> <span class="string">(206.124.146.176)。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">1h）如何设置</span> <span class="string">shorewall</span> <span class="string">以允许从网络在端口</span> <span class="number">9022</span> <span class="string">上使用</span> <span class="string">ssh？SSHD</span> <span class="string">正在监听端口</span> <span class="number">22</span><span class="string">。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：使用此规则。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"><span class="string">重定向网络</span> <span class="number">22</span> <span class="string">tcp</span> <span class="number">9022</span></span><br><span class="line"></span><br><span class="line"><span class="string">请注意，上述规则还将允许来自</span> <span class="string">TCP</span> <span class="string">端口</span> <span class="number">22</span> <span class="string">的网络的连接。如果您不想要这样，请参阅常见问题解答</span> <span class="string">1e。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">1j）为什么此</span> <span class="string">DNAT</span> <span class="string">规则不起作用？</span></span><br><span class="line"></span><br><span class="line"><span class="string">我添加了此规则，但仍然看到下面的日志消息</span></span><br><span class="line"></span><br><span class="line"><span class="string">规则：</span></span><br><span class="line"><span class="string">DNAT</span> <span class="string">scnet:172.19.41.2</span> <span class="string">dmz0:10.199.198.145</span> <span class="string">udp</span> <span class="number">2055</span></span><br><span class="line"></span><br><span class="line"><span class="string">日志：</span></span><br><span class="line"><span class="number">9</span> <span class="string">月</span> <span class="number">21</span> <span class="string">日</span> <span class="number">12</span><span class="string">:55:37</span> <span class="string">fw001</span> <span class="string">内核：[10357687.114928]</span> <span class="string">Shorewall：scnet2fw：DROP：IN=eth2</span> <span class="string">OUT=</span></span><br><span class="line"><span class="string">MAC=00：26：33：dd：aa：05：00：24：f7：19：ce：44：08：00</span> <span class="string">SRC=172.19.41.2</span> <span class="string">DST=172.19.1.1</span> <span class="string">LEN=1492</span></span><br><span class="line"><span class="string">TOS=0x00</span> <span class="string">PREC=0x00</span> <span class="string">TTL=63</span> <span class="string">ID=23035</span> <span class="string">PROTO=UDP</span> <span class="string">SPT=6376</span> <span class="string">DPT=2055</span> <span class="string">LEN=1472</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在添加规则之前，失败的连接已经有一个</span> <span class="string">conntrack</span> <span class="string">条目。安装conntrack实用程序并使用它来删除该条目。</span></span><br><span class="line"></span><br><span class="line"><span class="string">conntrack</span> <span class="string">-D</span> <span class="string">-s</span> <span class="number">172.19</span><span class="number">.41</span><span class="number">.2</span> <span class="string">-d</span> <span class="number">172.19</span><span class="number">.1</span><span class="number">.1</span> <span class="string">-p</span> <span class="string">udp</span> <span class="string">-sport</span> <span class="number">6367</span> <span class="string">-dport</span> <span class="number">2055</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">30</span><span class="string">）我不清楚何时使用</span> <span class="string">DNAT</span> <span class="string">规则以及何时使用</span> <span class="string">ACCEPT</span> <span class="string">规则。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：最好查看适合您设置的快速入门指南；指南以教程的方式介绍了此主题。DNAT</span> <span class="string">规则应用于需要与</span> <span class="string">SNAT/MASQUERADE</span> <span class="string">相反方向的连接。因此，如果您从本地网络到</span> <span class="string">Internet</span> <span class="string">伪装或使用</span> <span class="string">SNAT，则需要使用</span> <span class="string">DNAT</span> <span class="string">规则来允许从</span> <span class="string">Internet</span> <span class="string">到本地网络的连接。</span></span><br><span class="line"><span class="string">笔记</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果同时使用</span> <span class="number">1</span><span class="string">:1</span> <span class="string">NAT</span> <span class="string">和</span> <span class="string">SNAT/MASQUERADE，则受</span> <span class="number">1</span><span class="string">:1</span> <span class="string">NAT</span> <span class="string">约束的连接应使用</span> <span class="string">ACCEPT</span> <span class="string">而不是</span> <span class="string">DNAT。但请注意，DNAT</span> <span class="string">可用于覆盖</span> <span class="number">1</span><span class="string">:1</span> <span class="string">NAT，以便将连接重定向到与使用</span> <span class="number">1</span><span class="string">:1</span> <span class="string">NAT</span> <span class="string">时不同的内部系统或端口。</span></span><br><span class="line"></span><br><span class="line"><span class="string">当您有意重写目标</span> <span class="string">IP</span> <span class="string">地址或端口号时，您也应该使用</span> <span class="string">DNAT</span> <span class="string">规则。在所有其他情况下，您都应使用</span> <span class="string">ACCEPT，除非您需要在连接通过防火墙时劫持这些连接并在防火墙本身上处理它们；在这种情况下，您应使用</span> <span class="string">REDIRECT</span> <span class="string">规则。</span></span><br><span class="line"><span class="string">笔记</span></span><br><span class="line"></span><br><span class="line"><span class="string">上述答案不应被理解为</span> <span class="string">DNAT</span> <span class="string">只能与</span> <span class="string">SNAT</span> <span class="string">结合使用。但在使用私有本地地址的常见配置中，这是最常见的用法。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">8</span><span class="string">）我有多个外部</span> <span class="string">IP</span> <span class="string">地址，并使用</span> <span class="string">/etc/shorewall/nat</span> <span class="string">将它们与我的</span> <span class="string">DMZ</span> <span class="string">中的系统关联。当我添加</span> <span class="string">DNAT</span> <span class="string">规则（例如针对端口</span> <span class="number">80</span> <span class="string">和</span> <span class="number">443</span><span class="string">）时，Shorewall</span> <span class="string">会将这些端口上的连接重定向到我的所有地址。我如何将</span> <span class="string">DNAT</span> <span class="string">限制为仅单个地址？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在ORIGDEST列中指定您想要重定向的外部地址。</span></span><br><span class="line"></span><br><span class="line"><span class="string">例子：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span></span><br><span class="line"><span class="string">DNAT</span> <span class="string">网：192.168.4.22</span> <span class="string">tcp</span> <span class="number">80</span><span class="string">,443</span> <span class="bullet">-</span>        <span class="number">206.124</span><span class="number">.146</span><span class="number">.178</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">38</span><span class="string">）在哪里可以找到有关</span> <span class="string">DNAT</span> <span class="string">的更多信息？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：</span> <span class="string">Ian</span> <span class="string">Allen</span> <span class="string">写了一篇关于</span> <span class="string">DNAT</span> <span class="string">和</span> <span class="string">Linux</span> <span class="string">的论文。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">48</span><span class="string">）如何使用</span> <span class="string">Shorewall</span> <span class="string">设置透明</span> <span class="string">HTTP</span> <span class="string">代理？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：请参阅Shorewall_Squid_Usage.html。</span></span><br><span class="line"><span class="string">DNS</span> <span class="string">和端口转发/NAT</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">2</span><span class="string">）我将</span> <span class="string">www</span> <span class="string">请求转发到本地网络中的系统</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span> <span class="string">上的</span> <span class="string">www.mydomain.com（IP</span> <span class="number">130.151</span><span class="number">.100</span><span class="number">.69</span><span class="string">）。外部客户端可以浏览</span> <span class="string">http://www.mydomain.com，但内部客户端则不能。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：我对这种设置有两点反对意见。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在本地网络中拥有可访问</span> <span class="string">Internet</span> <span class="string">的服务器就像在鸡舍的角落里养狐狸一样。如果服务器受到攻击，该服务器与您的其他内部系统之间将没有任何联系。只需花费另一块</span> <span class="string">NIC</span> <span class="string">和一条交叉电缆，您就可以将服务器置于</span> <span class="string">DMZ</span> <span class="string">中，使其与您的本地系统隔离</span> <span class="bullet">-</span> <span class="string">当然，前提是服务器可以位于防火墙附近</span> <span class="string">:-)</span></span><br><span class="line"></span><br><span class="line">    <span class="string">可访问性问题最好通过拆分</span> <span class="string">DNS来解决（要么为本地客户端使用单独的</span> <span class="string">DNS</span> <span class="string">服务器，要么在主名称服务器上使用Bind</span> <span class="string">Version</span> <span class="number">9</span> <span class="string">“</span> <span class="string">views</span> <span class="string">”），这样</span> <span class="string">www.mydomain.com</span> <span class="string">在外部解析为</span> <span class="number">130.141</span><span class="number">.100</span><span class="number">.69</span><span class="string">，在内部解析为</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.5</span><span class="string">。我在</span> <span class="string">shorewall.net</span> <span class="string">上使用单独的</span> <span class="string">DNS</span> <span class="string">服务器</span> <span class="string">(dnsmasq)。</span></span><br><span class="line"></span><br><span class="line"><span class="string">因此，解决此问题的最佳和最安全方法是将您可通过</span> <span class="string">Internet</span> <span class="string">访问的服务器移至单独的</span> <span class="string">LAN</span> <span class="string">段，并使其具有自己的防火墙接口，然后按照常见问题解答</span> <span class="string">2b</span> <span class="string">操作。这样，如果您的服务器遭到黑客攻击，您的本地系统仍然是安全的，并且您不必运行拆分</span> <span class="string">DNS</span> <span class="string">配置（单独的服务器或</span> <span class="string">Bind</span> <span class="number">9</span> <span class="string">视图）。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果物理限制使得将服务器隔离在单独的</span> <span class="string">LAN</span> <span class="string">上不切实际，那么下一个最佳解决方案就是使用拆分</span> <span class="string">DNS。在您抱怨“设置拆分</span> <span class="string">DNS</span> <span class="string">太难了！”之前，请先查看此处。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您确实想通过防火墙在两个内部系统之间路由流量，请按如下所述进行。</span></span><br><span class="line"><span class="string">警告</span></span><br><span class="line"></span><br><span class="line"><span class="string">通过使用这种技术重定向的所有流量在服务器看来都好像是来自防火墙而不是原始客户端！因此，服务器的访问日志对于确定哪些本地主机正在访问服务器毫无用处。</span></span><br><span class="line"></span><br><span class="line"><span class="string">假设您的外部接口是</span> <span class="string">eth0，内部接口是</span> <span class="string">eth1，且</span> <span class="string">eth1</span> <span class="string">的</span> <span class="string">IP</span> <span class="string">地址为</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.254</span><span class="string">，子网为</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24，那么：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在/etc/shorewall/interfaces：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">?格式</span> <span class="number">2</span></span><br><span class="line">    <span class="comment">#区域界面选项</span></span><br><span class="line">    <span class="string">loc</span> <span class="string">eth1</span>                    <span class="string">路由返回</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在/etc/shorewall/masq：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#接口源地址协议端口</span></span><br><span class="line">    <span class="string">eth1:192.168.1.5</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.254</span> <span class="string">tcp</span> <span class="string">www</span></span><br><span class="line"></span><br><span class="line">    <span class="string">当运行Shorewall</span> <span class="number">5.0</span><span class="number">.14</span><span class="string">或更高版本时，相应的/etc/shorewall/snat文件是：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#操作源目标协议端口</span></span><br><span class="line">    <span class="string">SNAT(192.168.1.254)</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span> <span class="string">eth1:192.168.1.5</span> <span class="string">tcp</span> <span class="string">www</span></span><br><span class="line"></span><br><span class="line">    <span class="string">注意：此处描述的技术称为发夹式</span> <span class="string">NAT</span> <span class="string">，在RFC</span> <span class="number">4787</span><span class="string">的第</span> <span class="number">6</span> <span class="string">节中有描述。在该</span> <span class="string">RFC</span> <span class="string">中，要求使用外部</span> <span class="string">IP</span> <span class="string">地址作为源：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#接口源地址协议端口</span></span><br><span class="line">    <span class="string">eth1:192.168.1.5</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span>   <span class="number">130.151</span><span class="number">.100</span><span class="number">.69</span>   <span class="string">tcp</span> <span class="string">www</span></span><br><span class="line"></span><br><span class="line">    <span class="string">相等的/etc/shorewall/snat：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#动作源目标原型端口</span></span><br><span class="line">    <span class="string">SNAT(</span> <span class="number">130.151</span><span class="number">.100</span><span class="number">.69</span> <span class="string">)</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span> <span class="string">eth1:192.168.1.5</span> <span class="string">tcp</span> <span class="string">www</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在/etc/shorewall/rules：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span></span><br><span class="line"></span><br><span class="line">    <span class="string">?全部部分</span></span><br><span class="line">    <span class="string">?部分已建立</span></span><br><span class="line">    <span class="string">?SECTION</span> <span class="string">相关</span></span><br><span class="line">    <span class="string">?部分无效</span></span><br><span class="line">    <span class="string">?部分未跟踪</span></span><br><span class="line">    <span class="string">?新部分</span></span><br><span class="line"></span><br><span class="line">    <span class="string">DNAT</span> <span class="string">位置</span> <span class="string">loc：192.168.1.5</span> <span class="string">tcp</span> <span class="string">www</span> <span class="bullet">-</span> <span class="number">130.151</span><span class="number">.100</span><span class="number">.69</span></span><br><span class="line"></span><br><span class="line">    <span class="string">当然，该规则（以及上一条中的第二条规则）仅在您拥有静态外部</span> <span class="string">IP</span> <span class="string">地址时才有效。如果您拥有动态</span> <span class="string">IP</span> <span class="string">地址，则制定</span> <span class="string">DNAT</span> <span class="string">规则：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span></span><br><span class="line"></span><br><span class="line">    <span class="string">?全部部分</span></span><br><span class="line">    <span class="string">?部分已建立</span></span><br><span class="line">    <span class="string">?SECTION</span> <span class="string">相关</span></span><br><span class="line">    <span class="string">?部分无效</span></span><br><span class="line">    <span class="string">?部分未跟踪</span></span><br><span class="line">    <span class="string">?新部分</span></span><br><span class="line"></span><br><span class="line">    <span class="string">DNAT</span> <span class="string">loc</span> <span class="string">loc:192.168.1.5</span> <span class="string">tcp</span> <span class="string">www</span> <span class="bullet">-</span>        <span class="string">ð0</span></span><br><span class="line"></span><br><span class="line">    <span class="string">使用此技术，您将需要配置您的</span> <span class="string">DHCP/PPPoE/PPTP/...</span> <span class="string">客户端以便每次获得新的</span> <span class="string">IP</span> <span class="string">地址时自动重新加载</span> <span class="string">Shorewall。</span></span><br><span class="line">    <span class="string">笔记</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果您的本地接口是桥接器，请参阅常见问题解答</span> <span class="string">2e了解更多配置步骤。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">2a）我有一个带有</span> <span class="string">RFC1918</span> <span class="string">子网的区域“</span> <span class="string">Z</span> <span class="string">”，并且我使用一对一</span> <span class="string">NAT</span> <span class="string">将非</span> <span class="string">RFC1918</span> <span class="string">地址分配给</span> <span class="string">Z</span> <span class="string">中的主机。Z</span> <span class="string">中的主机无法使用它们的外部（非</span> <span class="string">RFC1918</span> <span class="string">地址）相互通信，因此它们无法使用它们的</span> <span class="string">DNS</span> <span class="string">名称相互访问。</span></span><br><span class="line"><span class="string">笔记</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果</span> <span class="string">/etc/shorewall/nat</span> <span class="string">中的</span> <span class="string">ALL</span> <span class="string">INTERFACES</span> <span class="string">列为空或包含“</span> <span class="literal">Yes</span> <span class="string">”，则在尝试使用目标主机的公共地址从</span> <span class="string">Z</span> <span class="string">中的另一台主机访问</span> <span class="string">Z</span> <span class="string">中的主机时，您还将看到如下日志消息：</span></span><br><span class="line"></span><br><span class="line"><span class="number">10</span><span class="string">月4日</span> <span class="number">10</span><span class="string">:26:40</span> <span class="string">netgw</span> <span class="string">内核：</span></span><br><span class="line">          <span class="string">岸墙：转发：拒绝：输入=eth1</span> <span class="string">输出=eth1</span> <span class="string">SRC=192.168.118.200</span></span><br><span class="line">          <span class="string">DST=192.168.118.210</span> <span class="string">LEN=48</span> <span class="string">TOS=0x00</span> <span class="string">PREC=0x00</span> <span class="string">TTL=127</span> <span class="string">ID=1342</span> <span class="string">DF</span></span><br><span class="line">          <span class="string">协议</span> <span class="string">=</span> <span class="string">TCP</span> <span class="string">SPT</span> <span class="string">=</span> <span class="number">1494</span> <span class="string">DPT</span> <span class="string">=</span> <span class="number">1491</span> <span class="string">窗口</span> <span class="string">=</span> <span class="number">17472</span> <span class="string">RES</span> <span class="string">=</span> <span class="number">0x00</span> <span class="string">ACK</span> <span class="string">SYN</span> <span class="string">URGP</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这是另一个最好使用拆分</span> <span class="string">DNS</span> <span class="string">解决的问题。它允许外部和内部客户端使用主机的</span> <span class="string">DNS</span> <span class="string">名称访问</span> <span class="string">NAT</span> <span class="string">主机。</span></span><br><span class="line"></span><br><span class="line"><span class="string">解决此问题的另一个好方法是从一对一</span> <span class="string">NAT</span> <span class="string">切换到代理</span> <span class="string">ARP。这样，Z</span> <span class="string">中的主机就有非</span> <span class="string">RFC1918</span> <span class="string">地址，并且可以使用同一地址进行外部和内部访问。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您不喜欢这些解决方案并且希望将所有</span> <span class="string">Z-&gt;Z</span> <span class="string">流量路由通过防火墙，那么：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">将接口上的routeback选项设置为Z。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">将</span> <span class="string">nat</span> <span class="string">文件中的</span> <span class="string">ALL</span> <span class="string">INTERFACES</span> <span class="string">列设置为“</span> <span class="literal">Yes</span> <span class="string">”。</span></span><br><span class="line"></span><br><span class="line"><span class="string">例1.示例：</span></span><br><span class="line"></span><br><span class="line"><span class="string">区域：dmz，接口：eth2，子网：192.168.2.0/24，服务器地址</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.2</span></span><br><span class="line"></span><br><span class="line"><span class="string">在/etc/shorewall/interfaces：</span></span><br><span class="line"></span><br><span class="line"><span class="string">?格式</span> <span class="number">2</span></span><br><span class="line"><span class="comment">#区域界面选项</span></span><br><span class="line"><span class="string">dmz</span> <span class="string">eth2</span>                    <span class="string">路由返回</span> </span><br><span class="line"></span><br><span class="line"><span class="string">在/etc/shorewall/masq：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#界面来源</span></span><br><span class="line"><span class="string">eth2：192.168.1.2</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.0</span><span class="string">/24</span></span><br><span class="line"></span><br><span class="line"><span class="string">运行</span> <span class="string">Shorewall</span> <span class="number">5.0</span><span class="number">.14</span> <span class="string">或更高版本时，等效/etc/shorewall/snat于：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"><span class="string">伪装</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span> <span class="string">eth2:192.168.1.2</span> <span class="string">tcp</span> <span class="string">www</span></span><br><span class="line"></span><br><span class="line"><span class="string">在</span> <span class="string">中，确保所有接口列中的/etc/shorewall/nat值为“是”</span> <span class="string">。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">2b）我的</span> <span class="string">DMZ</span> <span class="string">中有一个</span> <span class="string">Web</span> <span class="string">服务器，我使用端口转发使该服务器可以通过</span> <span class="string">Internet</span> <span class="string">以</span> <span class="string">www.mydomain.com</span> <span class="string">的形式访问。这可以正常工作，但当我的本地用户尝试连接到</span> <span class="string">www.mydomain.com</span> <span class="string">时，它不起作用。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：我们假设以下情况：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">(www.mydomain.com)上的外部</span> <span class="string">IP</span> <span class="string">地址是</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span> <span class="string">eth0。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">服务器的</span> <span class="string">IP</span> <span class="string">地址是</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.4</span></span><br><span class="line"></span><br><span class="line"><span class="string">您可以通过添加此规则，使用防火墙的外部</span> <span class="string">IP</span> <span class="string">地址从本地网络访问服务器：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span></span><br><span class="line"></span><br><span class="line"><span class="string">?全部部分</span></span><br><span class="line"><span class="string">?部分已建立</span></span><br><span class="line"><span class="string">?SECTION</span> <span class="string">相关</span></span><br><span class="line"><span class="string">?部分无效</span></span><br><span class="line"><span class="string">?部分未跟踪</span></span><br><span class="line"><span class="string">?新部分</span></span><br><span class="line"></span><br><span class="line"><span class="string">DNAT</span> <span class="string">位置</span> <span class="string">dmz:192.168.2.4</span> <span class="string">tcp</span> <span class="number">80</span> <span class="bullet">-</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您的外部</span> <span class="string">IP</span> <span class="string">地址是动态的，那么您必须制定</span> <span class="string">DNAT</span> <span class="string">规则：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ACTION SOURCE DEST PROTO DPORT SPORT ORIGDEST</span></span><br><span class="line"></span><br><span class="line"><span class="string">?全部部分</span></span><br><span class="line"><span class="string">?部分已建立</span></span><br><span class="line"><span class="string">?SECTION</span> <span class="string">相关</span></span><br><span class="line"><span class="string">?部分无效</span></span><br><span class="line"><span class="string">?部分未跟踪</span></span><br><span class="line"><span class="string">?新部分</span></span><br><span class="line"></span><br><span class="line"><span class="string">DNAT</span> <span class="string">位置</span> <span class="string">dmz:192.168.2.4</span> <span class="string">tcp</span> <span class="number">80</span><span class="bullet">-</span>        <span class="string">ð0</span></span><br><span class="line"></span><br><span class="line"><span class="string">警告</span></span><br><span class="line"></span><br><span class="line"><span class="string">对于动态</span> <span class="string">IP</span> <span class="string">地址，您可能不想使用shorewall[-lite]</span> <span class="string">save和shorewall[-lite]</span> <span class="string">restore。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">2c）我尝试将常见问题</span> <span class="number">2</span> <span class="string">的答案应用到我的外部接口和网络区域，但没有成功。为什么？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：您是否在中设置了IP_FORWARDING=Onshorewall.conf？</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">2d）Shorewall</span> <span class="string">是否支持发夹式</span> <span class="string">NAT？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：是的。</span></span><br><span class="line"></span><br><span class="line"><span class="string">对于简单伪装/SNAT的情况，请参见常见问题2。</span></span><br><span class="line"></span><br><span class="line"><span class="string">对于一对一（静态）NAT，只需在/etc/shorewall/nat中每个条目的所有接口列中输入“是”即可。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">2e）我遇到了常见问题</span> <span class="number">2</span> <span class="string">中的情况，但我的本地接口是一个桥梁，常见问题</span> <span class="number">2</span> <span class="string">中的解决方案不起作用</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：假设网桥是br0，eth2是连接包含192.168.1.5的LAN的网桥端口</span></span><br><span class="line"></span><br><span class="line"><span class="string">除了常见问题</span> <span class="number">2</span> <span class="string">中的步骤（将</span> <span class="string">eth1</span> <span class="string">替换为</span> <span class="string">br0）之外，您还需要：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在</span> <span class="string">eth2</span> <span class="string">上设置发夹选项。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">brctl</span> <span class="string">hairpin</span> <span class="string">br0</span> <span class="string">eth2</span> <span class="string">开启</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在</span> <span class="string">Debian</span> <span class="string">及其衍生版本中，您可以将该命令放在</span> <span class="string">/etc/network/interfaces</span> <span class="string">中作为后续命令：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">自动</span> <span class="string">br0</span></span><br><span class="line">    <span class="string">iface</span> <span class="string">br0</span> <span class="string">inet</span> <span class="string">静态</span></span><br><span class="line">            <span class="string">bridge_ports</span> <span class="string">eth2</span></span><br><span class="line">            <span class="string">bridge_fd</span> <span class="number">0</span></span><br><span class="line">            <span class="string">bridge_maxwait</span> <span class="number">0</span></span><br><span class="line">            <span class="string">地址</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span></span><br><span class="line">            <span class="string">网络掩码</span> <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br><span class="line">            <span class="string">发布</span> <span class="string">/sbin/brctl</span> <span class="string">hairpin</span> <span class="string">br0</span> <span class="string">eth2</span> <span class="string">on</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果尚未安装，请安装</span> <span class="string">ebtables。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">确保从</span> <span class="string">eth2</span> <span class="string">发出的所有流量都有正确的</span> <span class="string">MAC</span> <span class="string">地址。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">ebtables</span> <span class="string">-t</span> <span class="string">nat</span> <span class="string">-A</span> <span class="string">POSTROUTING</span> <span class="string">-o</span> <span class="string">eth2</span> <span class="string">-j</span> <span class="string">snat</span> <span class="string">--源br0-MAC</span> <span class="string">地址</span> </span><br><span class="line"></span><br><span class="line">    <span class="string">其中</span> <span class="string">br0-MAC-address</span> <span class="string">是</span> <span class="string">br0</span> <span class="string">的</span> <span class="string">MAC</span> <span class="string">地址。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">这是执行上述命令的</span> <span class="string">/etc/shorewall/start</span> <span class="string">的工作示例。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果</span> <span class="string">[</span> <span class="string">$(ebtables</span> <span class="string">-t</span> <span class="string">nat</span> <span class="string">-L</span> <span class="string">POSTROUTING</span> <span class="string">|</span> <span class="string">wc</span> <span class="string">-l)</span> <span class="string">-lt</span> <span class="number">4</span> <span class="string">];</span> <span class="string">然后</span></span><br><span class="line">       <span class="string">ebtables</span> <span class="string">-t</span> <span class="string">nat</span> <span class="string">-A</span> <span class="string">POSTROUTING</span> <span class="string">-o</span> <span class="string">eth2</span> <span class="string">-j</span> <span class="string">snat</span> <span class="string">--to-source</span> <span class="number">0</span><span class="string">:19:21:d0:61:65</span> </span><br><span class="line">    <span class="string">fi</span></span><br><span class="line"></span><br><span class="line"><span class="string">黑名单</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">63</span><span class="string">）我刚刚将</span> <span class="string">IP</span> <span class="string">地址</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.176</span> <span class="string">列入黑名单，但我仍然可以</span> <span class="string">ping</span> <span class="string">通它。我做错了什么？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：没什么。</span></span><br><span class="line"></span><br><span class="line"><span class="string">将</span> <span class="string">IP</span> <span class="string">地址列入黑名单会阻止来自该</span> <span class="string">IP</span> <span class="string">地址的传入流量。如果您在</span> <span class="string">中设置了</span> <span class="string">BLACKLISTNEWONLY=Yes</span> <span class="string">，则仅禁止来自shorewall.conf该地址的新连接；允许来自该地址的属于已建立连接（例如</span> <span class="string">ping</span> <span class="string">回复）的流量。</span></span><br><span class="line"><span class="string">笔记</span></span><br><span class="line"></span><br><span class="line"><span class="string">从</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.13</span> <span class="string">开始，您可以使用blacklist中的选项/etc/shorewall/interfaces按目标</span> <span class="string">IP</span> <span class="string">地址实现黑名单。</span></span><br><span class="line"><span class="string">笔记</span></span><br><span class="line"></span><br><span class="line"><span class="string">从</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.26</span> <span class="string">开始，您可以使用/etc/shorewall/blrules来实现任意黑名单规则。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">84</span><span class="string">）我将一些</span> <span class="string">IP</span> <span class="string">放入</span> <span class="string">/etc/shorewall</span> <span class="string">中的黑名单文件中以阻止这些</span> <span class="string">IP，但我仍然收到来自这些</span> <span class="string">IP</span> <span class="string">的</span> <span class="string">PSAD</span> <span class="string">报告，称它们正在进行端口扫描。列入黑名单难道不应该丢弃来自这些</span> <span class="string">IP</span> <span class="string">的所有数据包吗？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：您可能忘记在中为外部接口指定黑名单/etc/shorewall/interfaces选项。</span></span><br><span class="line"><span class="string">网络会议/MSN</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">3</span><span class="string">）我想将</span> <span class="string">Netmeeting</span> <span class="string">或</span> <span class="string">MSN</span> <span class="string">Instant</span> <span class="string">Messenger</span> <span class="string">与</span> <span class="string">Shorewall</span> <span class="string">一起使用。我该怎么做？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：有一个H.323</span> <span class="string">连接跟踪/NAT</span> <span class="string">模块可以帮助</span> <span class="string">Netmeeting。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在此处查找MSN</span> <span class="string">IM</span> <span class="string">的解决方案，但请注意，此解决方案存在重大安全风险。另请查看http://www.netfilter.org上的</span> <span class="string">Netfilter</span> <span class="string">邮件列表档案。</span></span><br><span class="line"><span class="string">开放端口</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">100</span><span class="string">）启动</span> <span class="string">Shorewall</span> <span class="string">后，“iptables</span> <span class="string">-L”的输出看起来好像我的防火墙完全打开了！</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这里的问题是，裸露的iptables</span> <span class="string">-L命令会产生完全无用的输出。请改用shorewall</span> <span class="string">show。</span></span><br><span class="line"><span class="string">笔记</span></span><br><span class="line"></span><br><span class="line"><span class="string">shorewall</span> <span class="string">show命令是iptables</span> <span class="string">-L</span> <span class="string">-n</span> <span class="string">-v的包装器。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">51</span><span class="string">）如何在</span> <span class="string">Shorewall</span> <span class="string">中打开端口？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：任何使用快速入门指南安装了</span> <span class="string">Shorewall</span> <span class="string">的人都不会问这个问题。</span></span><br><span class="line"></span><br><span class="line"><span class="string">无论您使用哪个指南，默认情况下所有出站通信都是开放的。因此您无需“打开端口”进行输出。</span></span><br><span class="line"></span><br><span class="line"><span class="string">输入：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果您使用独立指南进行安装，请重新阅读本节。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果你使用双接口指南进行安装，请重新阅读以下章节：端口转发</span> <span class="string">(DNAT)和其他连接</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果你使用三接口指南进行安装，请重新阅读以下部分：端口转发</span> <span class="string">(DNAT)和其他连接</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果您使用Shorewall</span> <span class="string">安装指南进行安装，那么您最好再次阅读该指南——您显然错过了很多内容。</span></span><br><span class="line"></span><br><span class="line"><span class="string">另请参阅本常见问题解答的端口转发部分。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">4</span><span class="string">）我刚刚使用在线端口扫描器检查了我的防火墙，它显示一些端口为“关闭”而不是“阻止”。为什么？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：默认的</span> <span class="string">Shorewall</span> <span class="string">设置在强制执行</span> <span class="string">DROP</span> <span class="string">策略之前会调用Drop操作，而</span> <span class="string">Internet</span> <span class="string">上所有区域的默认策略都是</span> <span class="string">DROP。Drop</span> <span class="string">操作在</span> <span class="string">中定义，/usr/share/shorewall/action.Drop它反过来会调用Auth宏（在</span> <span class="string">中定义/usr/share/shorewall/macro.Auth）来指定REJECT操作（即Auth(REJECT)</span> <span class="string">）。这对于防止使用“</span> <span class="string">Auth</span> <span class="string">”机制识别请求用户的服务出现传出连接问题是必不可少的。这是默认设置拒绝的唯一服务。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您看到除</span> <span class="number">113</span><span class="string">（auth）之外的关闭的</span> <span class="string">TCP</span> <span class="string">端口，那么您已经添加了规则来拒绝这些端口，或者防火墙外的路由器正在响应这些端口上的连接请求。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您希望“隐藏”端口</span> <span class="number">113</span><span class="string">，那么：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果您运行的是</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.20</span> <span class="string">或更早版本，请复制</span> <span class="string">/usr/share/shorewall/action.Drop并/etc/shorewall/修改</span> <span class="string">Auth</span> <span class="string">的调用为Auth(DROP)。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果您运行的是</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.21</span> <span class="string">或更高版本，请在</span> <span class="string">shorewall.conf</span> <span class="string">中设置</span> <span class="string">DROP_DEFAULT="Drop(-,DROP)"。请参阅</span> <span class="string">Action</span> <span class="string">HOWTO了解该魔法的工作原理。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">4a）我刚刚对我的防火墙运行了</span> <span class="string">nmap</span> <span class="string">UDP</span> <span class="string">扫描，结果显示有数百个端口处于打开状态！！！！</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：深吸一口气，阅读</span> <span class="string">nmap</span> <span class="string">手册页中有关</span> <span class="string">UDP</span> <span class="string">扫描的部分。如果</span> <span class="string">nmap</span> <span class="string">没有从防火墙收到任何回复，则它会报告端口已打开。如果您想查看哪些</span> <span class="string">UDP</span> <span class="string">端口确实已打开，请暂时将您的</span> <span class="string">net-&gt;all</span> <span class="string">策略更改为</span> <span class="string">REJECT，重新启动</span> <span class="string">Shorewall</span> <span class="string">并再次运行</span> <span class="string">nmap</span> <span class="string">UDP</span> <span class="string">扫描。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">4b）无论我如何更改规则，我都有一个无法关闭的端口。</span></span><br><span class="line"></span><br><span class="line"><span class="string">我有一条规则允许从我的本地网络</span> <span class="string">telnet</span> <span class="string">到我的防火墙；我删除了该规则并重新启动了</span> <span class="string">Shorewall，但我的</span> <span class="string">telnet</span> <span class="string">会话仍然有效！！！</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：规则仅控制新连接的建立。一旦通过防火墙建立了连接，它将一直可用，直到断开连接（tcp）或超时（其他协议）。如果您停止</span> <span class="string">telnet</span> <span class="string">并尝试建立新会话，您的防火墙将阻止该尝试。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">4c）如何将</span> <span class="string">Shorewall</span> <span class="string">与</span> <span class="string">PortSentry</span> <span class="string">一起使用？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：这里有一篇描述</span> <span class="string">Shorewall</span> <span class="string">和</span> <span class="string">PortSentry</span> <span class="string">完美整合的文章。</span></span><br><span class="line"><span class="string">连接问题</span></span><br><span class="line"><span class="string">为什么这些数据包被丢弃/拒绝？如何解码</span> <span class="string">Shorewall</span> <span class="string">日志消息？</span></span><br><span class="line"></span><br><span class="line"><span class="string">请参阅常见问题解答</span> <span class="number">17</span><span class="string">。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">5</span><span class="string">）我已经安装了</span> <span class="string">Shorewall，但现在无法通过防火墙进行</span> <span class="string">ping</span> <span class="string">操作</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：有关</span> <span class="string">Shorewall</span> <span class="string">“</span> <span class="string">ping</span> <span class="string">”管理的完整描述，请参阅此页面。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">15</span><span class="string">）我的本地系统无法访问网络</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：每次我读到“系统无法看到网络”时，我都会想知道发帖者在哪里买了带眼睛的计算机，以及当一切正常运行时这些计算机会“看到”什么:-)。除此之外，导致此问题的最常见原因是：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">每个本地系统上的默认网关未设置为本地防火墙接口的</span> <span class="string">IP</span> <span class="string">地址。您可以通过以下方式测试：</span></span><br><span class="line"></span><br><span class="line">        <span class="string">在</span> <span class="string">root</span> <span class="string">shell</span> <span class="string">提示符下，输入“shorewall</span> <span class="string">clear”。</span></span><br><span class="line"></span><br><span class="line">        <span class="string">从本地系统尝试</span> <span class="string">ping</span> <span class="string">Shorewall</span> <span class="string">系统的互联网（外部）接口的</span> <span class="string">IP</span> <span class="string">地址。如果此操作无效，则表示您</span> <span class="string">ping</span> <span class="string">的系统上的默认网关设置不正确。</span></span><br><span class="line"></span><br><span class="line">        <span class="string">测试后务必“shorewall</span> <span class="string">start”。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">文件中本地网络的条目/etc/shorewall/masq错误或缺失。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">本地系统上的</span> <span class="string">DNS</span> <span class="string">设置错误，或者用户正在防火墙上运行</span> <span class="string">DNS</span> <span class="string">服务器，并且尚未启用从本地网络到防火墙或从防火墙到</span> <span class="string">Internet</span> <span class="string">的</span> <span class="string">UDP</span> <span class="string">和</span> <span class="string">TCP</span> <span class="string">端口</span> <span class="number">53</span><span class="string">。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">未启用转发（这通常是</span> <span class="string">Debian</span> <span class="string">用户的问题）。输入此命令：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">cat</span> <span class="string">/proc/sys/net/ipv4/ip_forward</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果显示的值为</span> <span class="number">0</span><span class="string">（零），则设置IP_FORWARDING=On并/etc/shorewall/shorewall.conf重新启动</span> <span class="string">Shorewall。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">29</span><span class="string">）FTP</span> <span class="string">无法工作</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：请参阅Shorewall</span> <span class="string">和</span> <span class="string">FTP</span> <span class="string">页面。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">33</span><span class="string">）从防火墙后面的客户端，到某些站点的连接失败。从防火墙本身到相同站点的连接则正常。出了什么问题？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：最有可能的是，您需要在中设置</span> <span class="string">CLAMPMSS=Yes/etc/shorewall/shorewall.conf。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">35</span><span class="string">）我有两个以太网接口连接到我的本地网络，并将它们桥接起来。启动</span> <span class="string">Shorewall</span> <span class="string">后，我无法通过桥接器传输流量。我已将桥接接口</span> <span class="string">(br0)</span> <span class="string">定义为</span> <span class="string">中的本地接口/etc/shorewall/interfaces；桥接以太网接口未定义到</span> <span class="string">Shorewall。我如何告诉</span> <span class="string">Shorewall</span> <span class="string">允许流量通过桥接器？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在中添加routeback选项。br0/etc/shorewall/interfaces</span></span><br><span class="line"></span><br><span class="line"><span class="string">有关此类配置的更多信息，请参阅Shorewall</span> <span class="string">Simple</span> <span class="string">Bridge</span> <span class="string">文档。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">64</span><span class="string">）我刚刚将内核升级到</span> <span class="number">2.6</span><span class="number">.20</span><span class="string">（或更高版本），我的网桥/防火墙停止工作。这是怎么回事？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在内核</span> <span class="number">2.6</span><span class="number">.20</span> <span class="string">中，Netfilter</span> <span class="string">physdev</span> <span class="string">匹配功能已发生更改，因此它不再能够匹配非桥接流量的输出设备。您将在日志中看到如下消息：</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span> <span class="string">月</span> <span class="number">20</span> <span class="string">日</span> <span class="number">15</span><span class="string">:03:50</span> <span class="string">wookie</span> <span class="string">内核：[14736.560947]</span> <span class="string">physdev</span> <span class="string">匹配：在</span> <span class="string">OUTPUT、FORWARD</span> <span class="string">和</span> <span class="string">POSTROUTING</span> <span class="string">链中使用</span> <span class="string">--physdev-out</span></span><br><span class="line">                                                             <span class="string">不再支持非桥接流量。</span></span><br><span class="line"></span><br><span class="line"><span class="string">虽然这一内核更改是必要的，但这意味着</span> <span class="string">Shorewall</span> <span class="string">区域可能不再以桥接端口的形式定义。有关如何配置桥接/防火墙的信息，请参阅Shorewall-perl</span> <span class="string">桥接文档。</span></span><br><span class="line"><span class="string">笔记</span></span><br><span class="line"></span><br><span class="line"><span class="string">按照新桥接文档中的说明进行操作不会阻止发出上述消息。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">85</span><span class="string">）Shorewall</span> <span class="string">拒绝来自我的本地局域网的连接，因为它认为这些连接来自“网络”区域。</span></span><br><span class="line"></span><br><span class="line"><span class="string">我在我的日志中看到这个：</span></span><br><span class="line"></span><br><span class="line"><span class="number">8</span> <span class="string">月</span> <span class="number">31</span> <span class="string">日</span> <span class="number">16</span><span class="string">:51:24</span> <span class="string">fw22</span> <span class="string">内核：Shorewall：net2fw：DROP：IN=eth5</span> <span class="string">OUT=MAC=00：0c：29：74：9c：0c：08：00：20：b2：5f：db：08：00</span></span><br><span class="line">                                       <span class="string">SRC=10.1.50.14</span> <span class="string">DST=10.1.50.7</span> <span class="string">LEN=57</span> <span class="string">TOS=0x00</span> <span class="string">PREC=0x00</span> <span class="string">TTL=255</span> <span class="string">ID=32302</span> <span class="string">DF</span></span><br><span class="line">                                       <span class="string">协议=UDP</span> <span class="string">SPT=53289</span> <span class="string">DPT=53</span> <span class="string">LEN=37</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：当外部接口和内部接口连接到同一个交换机或集线器时，就会发生这种情况。有关详细信息，请参阅本文。解决方案是永远不要将多个防火墙接口连接到同一个集线器或交换机（一个明显的例外是当您有一个支持</span> <span class="string">VLAN</span> <span class="string">标记的交换机并且接口与不同的</span> <span class="string">VLAN</span> <span class="string">相关联时）。</span></span><br><span class="line"><span class="string">日志记录</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">91</span><span class="string">）我更改了</span> <span class="string">/etc/shorewall/</span> <span class="string">中的</span> <span class="string">shorewall.conf</span> <span class="string">文件，将日志输出到</span> <span class="string">/var/log/shorewall.log，但在我重新启动</span> <span class="string">shorewall</span> <span class="string">后，这种情况并没有发生。LOGFILE=/var/log/shorewall.log</span> <span class="string">&lt;--</span> <span class="string">这应该是正确的行，对吗？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：不，这是不正确的。LOGFILE</span> <span class="string">设置告诉</span> <span class="string">Shorewall</span> <span class="string">在哪里找到日志；它不能确定消息写入的位置。请参阅下一个常见问题解答。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">6</span><span class="string">）日志消息写在哪里以及如何更改目的地？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">NetFilter</span> <span class="string">使用内核的</span> <span class="string">syslog</span> <span class="string">等效项（请参阅“</span> <span class="string">man</span> <span class="string">syslog</span> <span class="string">”）来记录消息。它始终使用</span> <span class="string">LOG_KERN</span> <span class="string">(kern)</span> <span class="string">工具（请参阅“</span> <span class="string">man</span> <span class="string">openlog</span> <span class="string">”），您可以和中选择日志级别（再次请参阅“</span> <span class="string">man</span> <span class="string">syslog</span> <span class="string">”）。syslog</span> <span class="string">记录的消息的目标由</span> <span class="string">控制（请参阅“</span> <span class="string">man</span> <span class="string">syslog.conf</span> <span class="string">”）。更改后，请务必重新启动</span> <span class="string">syslogd（在</span> <span class="string">RedHat</span> <span class="string">系统上为“</span> <span class="string">service</span> <span class="string">syslog</span> <span class="string">restart</span> <span class="string">”）。policiesrules/etc/syslog.conf/etc/syslog.conf</span></span><br><span class="line"></span><br><span class="line"><span class="string">还可以设置</span> <span class="string">Shorewall</span> <span class="string">将所有</span> <span class="string">Netfilter</span> <span class="string">的消息记录到单独的文件中。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">6a）是否有任何可与</span> <span class="string">Shorewall</span> <span class="string">配合使用的日志解析器？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：以下几个链接可能有帮助：</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          <span class="string">https://shorewall.org/pub/shorewall/parsefw/</span></span><br><span class="line">          <span class="string">http://aaron.marasco.com/linux.html</span></span><br><span class="line">          <span class="string">http://cert.uni-stuttgart.de/projects/fwlogwatch</span></span><br><span class="line">          <span class="string">http://www.logwatch。组织</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="string">我个人使用fwlogwatch。它每天从我的各个系统通过电子邮件向我发送一份报告，每份报告总结了相应系统上记录的活动；以下是示例：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">fwlogwatch</span> <span class="string">摘要</span></span><br><span class="line">    <span class="string">由</span> <span class="string">root</span> <span class="string">于</span> <span class="number">2010</span> <span class="string">年</span> <span class="number">3</span> <span class="string">月</span> <span class="number">2</span> <span class="string">日星期二</span> <span class="number">08</span><span class="string">:14:37</span> <span class="string">PST</span> <span class="string">生成。</span></span><br><span class="line">    <span class="string">文件“/var/log/ulog/syslogemu.log”中的</span> <span class="number">817</span> <span class="string">个条目中有</span> <span class="number">362</span> <span class="string">个（其中</span> <span class="number">455</span> <span class="string">个超过</span> <span class="number">86400</span> <span class="string">秒）是数据包日志，其中</span> <span class="number">138</span> <span class="string">个具有独特的特征。</span></span><br><span class="line">    <span class="string">第一个数据包日志条目：3</span> <span class="string">月</span> <span class="number">1</span> <span class="string">日</span> <span class="number">08</span><span class="string">:16:06，最后一个：3</span> <span class="string">月</span> <span class="number">2</span> <span class="string">日</span> <span class="number">08</span><span class="string">:06:21。</span></span><br><span class="line">    <span class="string">所有条目均由同一主机记录：“网关”。</span></span><br><span class="line">    <span class="string">所有条目都有相同的目标：“-”。</span></span><br><span class="line">    <span class="string">仅显示计数至少为</span> <span class="number">5</span> <span class="string">的条目。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">net-dmz</span> <span class="string">DROP</span> <span class="string">eth2</span> <span class="number">36</span> <span class="string">个数据包从</span> <span class="number">61.158</span><span class="number">.162</span><span class="number">.9</span> <span class="string">到</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.177</span></span><br><span class="line">    <span class="string">net-fw</span> <span class="string">DROP</span> <span class="string">eth0</span> <span class="number">21</span> <span class="string">个数据包从</span> <span class="number">89.163</span><span class="number">.162</span><span class="number">.13</span> <span class="string">到</span> <span class="number">76.104</span><span class="number">.233</span><span class="number">.98</span></span><br><span class="line">    <span class="string">net-fw</span> <span class="string">DROP</span> <span class="string">eth0</span> <span class="number">19</span> <span class="string">个数据包从</span> <span class="number">61.184</span><span class="number">.101</span><span class="number">.46</span> <span class="string">到</span> <span class="number">76.104</span><span class="number">.233</span><span class="number">.98</span></span><br><span class="line">    <span class="string">net-fw</span> <span class="string">DROP</span> <span class="string">eth0</span> <span class="number">12</span> <span class="string">个数据包从</span> <span class="number">81.157</span><span class="number">.214</span><span class="number">.103</span> <span class="string">到</span> <span class="number">76.104</span><span class="number">.233</span><span class="number">.98</span></span><br><span class="line">    <span class="string">net-fw</span> <span class="string">DROP</span> <span class="string">eth0</span> <span class="number">11</span> <span class="string">个数据包从</span> <span class="number">174.37</span><span class="number">.159</span><span class="number">.222</span> <span class="string">到</span> <span class="number">76.104</span><span class="number">.233</span><span class="number">.98</span></span><br><span class="line">    <span class="string">net-fw</span> <span class="string">DROP</span> <span class="string">eth0</span> <span class="number">10</span> <span class="string">个数据包从</span> <span class="number">221.195</span><span class="number">.73</span><span class="number">.86</span> <span class="string">到</span> <span class="number">76.104</span><span class="number">.233</span><span class="number">.98</span></span><br><span class="line">    <span class="string">net-dmz</span> <span class="string">DROP</span> <span class="string">eth2</span> <span class="number">9</span> <span class="string">个数据包从</span> <span class="number">202.199</span><span class="number">.158</span><span class="number">.6</span> <span class="string">到</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.177</span></span><br><span class="line">    <span class="string">net-fw</span> <span class="string">DROP</span> <span class="string">eth2</span> <span class="number">9</span><span class="string">个数据包从202.199.158.6到206.124.146.176</span></span><br><span class="line">    <span class="string">net-dmz</span> <span class="string">DROP</span> <span class="string">eth2</span> <span class="number">9</span> <span class="string">个数据包从</span> <span class="number">202.199</span><span class="number">.158</span><span class="number">.6</span> <span class="string">到</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.178</span></span><br><span class="line">    <span class="string">net-fw</span> <span class="string">DROP</span> <span class="string">eth0</span> <span class="number">6</span><span class="string">个数据包从221.192.199.35到76.104.233.98</span></span><br><span class="line">    <span class="string">net-fw</span> <span class="string">DROP</span> <span class="string">eth2</span> <span class="number">5</span> <span class="string">个数据包从</span> <span class="number">61.158</span><span class="number">.162</span><span class="number">.9</span> <span class="string">到</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.177</span></span><br><span class="line"></span><br><span class="line"><span class="string">Fwlogwatch</span> <span class="string">包含一个内置的网络服务器，允许以摘要的方式监控最近的活动。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">6b）端口</span> <span class="number">10619</span> <span class="string">上的</span> <span class="string">DROP</span> <span class="string">消息及其连接请求充斥着日志。我是否可以暂时将此端口的这些错误消息排除在</span> <span class="string">Shorewall</span> <span class="string">日志之外？</span></span><br><span class="line"></span><br><span class="line"><span class="string">解答：暂时增加如下规则：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"></span><br><span class="line"><span class="string">?全部部分</span></span><br><span class="line"><span class="string">?部分已建立</span></span><br><span class="line"><span class="string">?SECTION</span> <span class="string">相关</span></span><br><span class="line"><span class="string">?部分无效</span></span><br><span class="line"><span class="string">?部分未跟踪</span></span><br><span class="line"><span class="string">?新部分</span></span><br><span class="line"></span><br><span class="line"><span class="string">DROP</span> <span class="string">净</span> <span class="string">$FW</span> <span class="string">udp</span> <span class="number">10619</span></span><br><span class="line"></span><br><span class="line"><span class="string">或者，如果您未设置</span> <span class="string">BLACKLIST_LOGLEVEL，则可以将端口列入黑名单。在/etc/shorewall/blrules：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"></span><br><span class="line"><span class="string">DROP</span> <span class="string">净</span> <span class="string">$FW</span> <span class="string">udp</span> <span class="number">10619</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">6d）为什么</span> <span class="string">Shorewall</span> <span class="string">日志消息中的</span> <span class="string">MAC</span> <span class="string">地址这么长？我以为</span> <span class="string">MAC</span> <span class="string">地址只有</span> <span class="number">6</span> <span class="string">个字节长。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">Netfilter（Shorewall）日志消息中标记为</span> <span class="string">MAC</span> <span class="string">地址的实际上是以太网帧头。它包含：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">目标</span> <span class="string">MAC</span> <span class="string">地址（6</span> <span class="string">个字节）</span></span><br><span class="line"></span><br><span class="line">    <span class="string">源</span> <span class="string">MAC</span> <span class="string">地址（6</span> <span class="string">个字节）</span></span><br><span class="line"></span><br><span class="line">    <span class="string">以太网帧类型（2</span> <span class="string">个字节）</span></span><br><span class="line"></span><br><span class="line"><span class="string">示例</span> <span class="number">2</span><span class="string">.示例</span></span><br><span class="line"></span><br><span class="line"><span class="string">MAC=00：04：4c：dc：e2：28：00：b0：8e：cf：3c：4c：08：00</span></span><br><span class="line"></span><br><span class="line">    <span class="string">目标</span> <span class="string">MAC</span> <span class="string">地址</span> <span class="string">=</span> <span class="number">00</span><span class="string">:04:4c:dc:e2:28</span></span><br><span class="line"></span><br><span class="line">    <span class="string">源</span> <span class="string">MAC</span> <span class="string">地址</span> <span class="string">=</span> <span class="number">00</span><span class="string">:b0:8e:cf:3c:4c</span></span><br><span class="line"></span><br><span class="line">    <span class="string">以太网帧类型</span> <span class="string">=</span> <span class="number">08</span><span class="string">:00（IP</span> <span class="string">版本</span> <span class="number">4</span><span class="string">）</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">16</span><span class="string">）Shorewall</span> <span class="string">在我的整个控制台上写入日志消息，导致它无法使用！</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：</span></span><br><span class="line"></span><br><span class="line"><span class="string">需要说明的是，并不是</span> <span class="string">Shorewall</span> <span class="string">在您的控制台上写入了所有内容。Shorewall</span> <span class="string">在每个启动、重新启动、停止等操作期间都会发出一条日志消息。而是您的日志守护进程将消息写入了控制台。Shorewall</span> <span class="string">本身无法控制特定类别的消息写入何处。请参阅Shorewall</span> <span class="string">日志记录文档。</span></span><br><span class="line"></span><br><span class="line"><span class="string">发送到控制台的最大日志级别可在</span> <span class="string">/proc/sys/kernel/printk</span> <span class="string">中找到：</span></span><br><span class="line"></span><br><span class="line"><span class="string">teastep@ursa:~$</span> <span class="string">cat</span> <span class="string">/proc/sys/kernel/printk</span></span><br><span class="line"><span class="number">6</span> <span class="number">6</span> <span class="number">1</span> <span class="number">7</span></span><br><span class="line"><span class="string">teastep@ursa:~$</span></span><br><span class="line"></span><br><span class="line"><span class="string">第一个数字决定发送到控制台的最大日志级别（系统日志优先级）。优先级低于此数字的消息将发送到控制台。在上面示例中，优先级</span> <span class="number">0</span><span class="number">-5</span> <span class="string">将发送到控制台。由于</span> <span class="string">Shorewall</span> <span class="string">默认使用“info”（6），因此</span> <span class="string">Shorewall</span> <span class="string">生成的</span> <span class="string">Netfilter</span> <span class="string">规则集将生成不会显示在控制台上的日志消息。</span></span><br><span class="line"></span><br><span class="line"><span class="string">第二个数字是未指定日志级别的内核</span> <span class="string">printk()</span> <span class="string">调用的默认日志级别。</span></span><br><span class="line"></span><br><span class="line"><span class="string">第三个数字指定最低控制台日志级别，而第四个数字给出默认控制台日志级别。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您的系统上的第一个数字是</span> <span class="number">7</span> <span class="string">或更大，则默认的</span> <span class="string">Shorewall</span> <span class="string">配置将导致消息写入您的控制台。最简单的解决方案是将其添加到您的/etc/sysctl.conf文件中：</span></span><br><span class="line"></span><br><span class="line"><span class="string">内核.printk</span> <span class="string">=</span> <span class="number">4</span> <span class="number">4</span> <span class="number">1</span> <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="string">然后</span></span><br><span class="line"></span><br><span class="line"><span class="string">sysctl</span> <span class="string">-p</span> <span class="string">/etc/sysctl.conf</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">16a）cat</span> <span class="string">/proc/sys/kernel/prink</span> <span class="string">返回</span> <span class="string">'4 4 1 7'</span><span class="string">，并且</span> <span class="string">dmesg</span> <span class="string">仍然被填满</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：虽然我们认为“dmesg</span> <span class="string">已填满”不一定是个问题，但消除该问题的唯一方法是设置Shorewall</span> <span class="string">将所有</span> <span class="string">Netfilter</span> <span class="string">的消息记录到单独的文件中。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">16b）为什么我在</span> <span class="string">/var/log/messages</span> <span class="string">中看不到任何</span> <span class="string">Shorewall</span> <span class="string">消息？</span></span><br><span class="line"></span><br><span class="line"><span class="string">一些提出这个问题的人报告说，他们看到的唯一</span> <span class="string">Shorewall</span> <span class="string">消息/var/log/messages是“已启动”、“已重新启动”和“已停止”消息。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：首先，重要的是要了解</span> <span class="string">Shorewall</span> <span class="string">本身并不控制</span> <span class="string">Netfilter</span> <span class="string">日志消息的写入位置。中的</span> <span class="string">LOGFILE</span> <span class="string">设置shorewall.conf只是告诉/sbin/shorewall[-lite]程序在哪里查找日志。此外，重要的是要了解“debug”日志级别通常会导致</span> <span class="string">Netfilter</span> <span class="string">消息写入的文件/var/log比“info”日志级别少。日志级别不控制日志消息的数量或消息的内容。</span></span><br><span class="line"></span><br><span class="line"><span class="string">Netfilter</span> <span class="string">消息写入的实际日志文件并非标准化，并且会因发行版和发行版本而异。但是，只要您看不到日志记录，就该在</span> <span class="string">Shorewall</span> <span class="string">配置之外寻找原因了。例如，最近的SUSE</span> <span class="string">™</span> <span class="string">版本默认使用</span> <span class="string">syslog-ng，并将</span> <span class="string">Shorewall</span> <span class="string">消息写入/var/log/firewall。</span></span><br><span class="line"></span><br><span class="line"><span class="string">请参阅Shorewall</span> <span class="string">日志记录文档以获取更多信息。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">16c）</span> <span class="string">Shorewall</span> <span class="string">消息充斥着“dmesg”的输出；我该如何阻止这种情况？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：改用ulogd。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">16d）我设置了</span> <span class="string">LOGFILE=/var/log/shorewall，但日志消息仍然发送到</span> <span class="string">/var/log/messages。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：请参阅上文常见问题</span> <span class="string">16b的答案。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">17</span><span class="string">）为什么这些数据包被丢弃/拒绝？如何解码</span> <span class="string">Shorewall</span> <span class="string">日志消息？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">Shorewall</span> <span class="string">中的多个链（如日志消息中所示）会记录丢弃/拒绝的数据包：</span></span><br><span class="line"></span><br><span class="line"><span class="string">zone2all、zone-all、all2</span> <span class="string">zone、all-</span> <span class="string">zone、all2all</span> <span class="string">或</span> <span class="string">all-all</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您有一个policy指定日志级别的规则，并且该数据包正在根据该策略进行记录。如果您打算接受此流量，则需要一条规则来实现此目的。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">从这些链中注销的数据包可能具有不在任何已定义区域中的源和/或目标（请参阅shorewall[-lite]</span> <span class="string">show</span> <span class="string">zone的输出）。请记住，区域成员资格涉及防火墙接口和</span> <span class="string">IP</span> <span class="string">地址。</span></span><br><span class="line"><span class="string">zone12zone2或zone1-zone2</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您有一个针对区域</span> <span class="number">1</span><span class="string">到区域</span> <span class="number">2</span><span class="string">的策略，该策略指定了日志级别，并且该数据包正在该策略下记录，或者该数据包与包含日志级别的规则相匹配。</span></span><br><span class="line"><span class="string">@</span> <span class="string">zone12zone2或</span> <span class="string">@</span> <span class="string">zone1-zone2</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您有一个针对从</span> <span class="string">到zone1的流量的策略zone2，该策略指定了</span> <span class="string">TCP</span> <span class="string">连接速率限制（LIMIT</span> <span class="string">列中的值）。记录的数据包超出了该限制并被丢弃。请注意，这些日志消息本身的速率受到严格限制，因此</span> <span class="string">syn-flood</span> <span class="string">不会因为过多的日志消息而产生二次</span> <span class="string">DOS。这些日志消息是在</span> <span class="string">Shorewall</span> <span class="number">2.2</span><span class="number">.0</span> <span class="string">Beta</span> <span class="number">7</span> <span class="string">中添加的。</span></span><br><span class="line"><span class="string">zone12</span> <span class="string">zone2~、zone1-</span> <span class="string">zone2~</span> <span class="string">或</span> <span class="string">~blacklistnn</span></span><br><span class="line"></span><br><span class="line">    <span class="string">这些是/etc/shorewall/blrules文件中条目的结果。</span></span><br><span class="line"><span class="string">接口_mac</span> <span class="string">或接口_rec</span></span><br><span class="line"></span><br><span class="line">    <span class="string">该数据包正在maclist</span> <span class="string">接口选项下记录。</span></span><br><span class="line"><span class="string">黑名单</span></span><br><span class="line"></span><br><span class="line">    <span class="string">由于源</span> <span class="string">IP</span> <span class="string">在文件中被列入黑名单，因此该数据包已被记录。</span> <span class="string">/etc/shorewall/blacklist</span></span><br><span class="line"><span class="string">输入或转发</span></span><br><span class="line"></span><br><span class="line">    <span class="string">数据包的源</span> <span class="string">IP</span> <span class="string">地址不在您定义的任何区域中（“</span> <span class="string">shorewall[-lite]</span> <span class="string">show</span> <span class="string">zone</span> <span class="string">”并查看打印的区域定义）或链为</span> <span class="string">FORWARD，而目标</span> <span class="string">IP</span> <span class="string">不在您定义的任何区域中。如果链为</span> <span class="string">FORWARD，并且</span> <span class="string">IN</span> <span class="string">和</span> <span class="string">OUT</span> <span class="string">接口相同，或者它们与/etc/shorewall/interfaces中的相同通配符条目匹配，那么您可能需要在</span> <span class="string">中的该接口上使用routeback选项，您需要在</span> <span class="string">中的相关条目中使用routeback选项</span> <span class="string">/etc/shorewall/interfaces</span> <span class="string">/etc/shorewall/hosts</span> <span class="string">or</span> <span class="string">you've</span> <span class="string">done</span> <span class="string">something</span> <span class="string">silly</span> <span class="string">like</span> <span class="string">define</span> <span class="string">a</span> <span class="string">default</span> <span class="string">route</span> <span class="string">out</span> <span class="string">of</span> <span class="string">an</span> <span class="string">internal</span> <span class="string">interface.</span></span><br><span class="line"></span><br><span class="line">    <span class="string">当shorewall.conf中的</span> <span class="string">OPTIMIZE=1</span> <span class="string">时，此类数据包也可能会被从</span> <span class="string">&lt;zone&gt;2all</span> <span class="string">链或</span> <span class="string">all2all</span> <span class="string">链中注销。</span></span><br><span class="line"><span class="string">输出</span></span><br><span class="line"></span><br><span class="line">    <span class="string">数据包的目标</span> <span class="string">IP</span> <span class="string">地址不在您定义的任何区域中（shorewall[-lite]</span> <span class="string">显示区域并查看打印的区域定义）。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">当shorewall.conf中的</span> <span class="string">OPTIMIZE=1</span> <span class="string">时，此类数据包也可能会被从</span> <span class="string">fw2all</span> <span class="string">链或</span> <span class="string">all2all</span> <span class="string">链中注销。</span></span><br><span class="line"><span class="string">日志标志</span></span><br><span class="line"></span><br><span class="line">    <span class="string">该数据包被记录是因为它未能通过tcpflags</span> <span class="string">接口选项实施的检查。</span></span><br><span class="line"><span class="string">过滤器</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在运行</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.20</span> <span class="string">或更高版本的系统上，数据包与filter</span> <span class="string">接口选项匹配，或者它被路由到它到达的同一接口，并且接口没有routeback或routefilter</span> <span class="string">接口选项。</span></span><br><span class="line"></span><br><span class="line"><span class="string">例</span> <span class="number">3</span><span class="string">.</span> <span class="string">下面是一个例子：</span></span><br><span class="line"></span><br><span class="line"><span class="number">6</span><span class="string">月27日</span> <span class="number">15</span><span class="string">:37:56</span> <span class="string">网关内核：</span></span><br><span class="line">        <span class="string">岸墙：all2all：REJECT：IN=eth2</span> </span><br><span class="line">          <span class="string">OUT=eth1</span> </span><br><span class="line">          <span class="string">SRC=192.168.2.2</span> </span><br><span class="line">          <span class="string">DST=192.168.1.3</span> <span class="string">LEN=67</span> <span class="string">TOS=0x00</span> <span class="string">PREC=0x00</span> <span class="string">TTL=63</span> <span class="string">ID=5805</span> <span class="string">DF</span> <span class="string">PROTO=UDP</span> </span><br><span class="line">        <span class="string">SPT=1803</span> <span class="string">DPT=53</span> <span class="string">LEN=47</span></span><br><span class="line"></span><br><span class="line"><span class="string">让我们看一下此消息的重要部分：</span></span><br><span class="line"></span><br><span class="line"><span class="string">all2all:拒绝</span></span><br><span class="line"></span><br><span class="line">    <span class="string">这个数据包在all2all链中被拒绝</span> <span class="string">——</span> <span class="string">这个数据包是在“</span> <span class="string">all</span> <span class="string">”</span> <span class="string">-&gt;</span> <span class="string">“</span> <span class="string">all</span> <span class="string">”</span> <span class="string">REJECT</span> <span class="string">策略（上面的all2all）下被拒绝的。</span></span><br><span class="line"><span class="string">输入=eth2</span></span><br><span class="line"></span><br><span class="line">    <span class="string">数据包通过</span> <span class="string">eth2</span> <span class="string">进入防火墙。如果您看到“</span> <span class="string">IN=</span> <span class="string">”但没有接口名称，则数据包源自防火墙本身。</span></span><br><span class="line"><span class="string">输出=eth1</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果被接受，数据包将在</span> <span class="string">eth1</span> <span class="string">上发送。如果您看到“</span> <span class="string">OUT=</span> <span class="string">”但没有接口名称，则数据包将由防火墙本身处理。</span></span><br><span class="line">    <span class="string">笔记</span></span><br><span class="line"></span><br><span class="line">    <span class="string">当</span> <span class="string">DNAT</span> <span class="string">规则被记录时，永远不会显示</span> <span class="string">OUT=，因为数据包在路由之前被记录。此外，DNAT</span> <span class="string">日志记录将显示原始目标</span> <span class="string">IP</span> <span class="string">地址和目标端口号。当</span> <span class="string">REDIRECT</span> <span class="string">规则被记录时，消息还将显示原始目标</span> <span class="string">IP</span> <span class="string">地址和端口号。</span></span><br><span class="line"><span class="string">源地址=192.168.2.2</span></span><br><span class="line"></span><br><span class="line">    <span class="string">数据包由</span> <span class="number">192.168</span><span class="number">.2</span><span class="number">.2</span> <span class="string">发送</span></span><br><span class="line"><span class="string">夏令时=192.168.1.3</span></span><br><span class="line"></span><br><span class="line">    <span class="string">该数据包的目的地是</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span></span><br><span class="line"><span class="string">协议=UDP</span></span><br><span class="line"></span><br><span class="line">    <span class="string">UDP</span> <span class="string">协议</span></span><br><span class="line"><span class="string">DPT=53</span></span><br><span class="line"></span><br><span class="line">    <span class="string">目标端口为</span> <span class="number">53</span> <span class="string">(DNS)</span></span><br><span class="line"></span><br><span class="line"><span class="string">在这种情况下，192.168.2.2</span> <span class="string">位于“</span> <span class="string">dmz</span> <span class="string">”区域，而</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.3</span> <span class="string">位于“</span> <span class="string">loc</span> <span class="string">”区域。我遗漏了以下规则：</span></span><br><span class="line"></span><br><span class="line"><span class="string">接受</span> <span class="string">dmz</span> <span class="string">loc</span> <span class="string">udp</span> <span class="number">53</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">21</span><span class="string">）我偶尔会看到这些奇怪的日志条目；它们是什么？</span></span><br><span class="line"></span><br><span class="line"><span class="number">11</span><span class="string">月25日</span> <span class="number">18</span><span class="string">:58:52</span> <span class="string">Linux内核：</span></span><br><span class="line">      <span class="string">岸墙：net2all：DROP：IN=eth1</span> <span class="string">OUT=</span></span><br><span class="line">      <span class="string">MAC=00:60:1d:f0:a6:f9:00:60:1d:f6:35:50:08:00</span> <span class="string">SRC=206.124.146.179</span></span><br><span class="line">      <span class="string">DST=192.0.2.3</span> <span class="string">LEN=56</span> <span class="string">TOS=0x00</span> <span class="string">PREC=0x00</span> <span class="string">TTL=110</span> <span class="string">ID=18558</span> <span class="string">PROTO=ICMP</span> </span><br><span class="line">      <span class="string">TYPE=3</span> <span class="string">CODE=3</span> <span class="string">[SRC=192.0.2.3</span> <span class="string">DST=172.16.1.10</span> <span class="string">LEN=128</span> <span class="string">TOS=0x00</span> <span class="string">PREC=0x00</span></span><br><span class="line">      <span class="string">TTL=47</span> <span class="string">ID=0</span> <span class="string">DF</span> <span class="string">PROTO=UDP</span> <span class="string">SPT=53</span> <span class="string">DPT=2857</span> <span class="string">LEN=108</span> <span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="number">192.0</span><span class="number">.2</span><span class="number">.3</span> <span class="string">是我的防火墙的外部...172.16.0.0/24</span> <span class="string">是我的内部</span> <span class="string">LAN</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：首先，请注意，以上是处理</span> <span class="string">ICMP</span> <span class="string">端口不可达数据包</span> <span class="string">(PROTO=ICMP</span> <span class="string">TYPE=3</span> <span class="string">CODE=3)</span> <span class="string">的非常特殊的日志消息类型。不要阅读此答案并假设所有</span> <span class="string">Shorewall</span> <span class="string">日志消息都与</span> <span class="string">ICMP</span> <span class="string">有关（提示</span> <span class="bullet">-</span> <span class="string">请参阅常见问题解答</span> <span class="number">17</span><span class="string">）。</span></span><br><span class="line"></span><br><span class="line"><span class="string">虽然大多数人将互联网控制消息协议</span> <span class="string">(ICMP)</span> <span class="string">与“</span> <span class="string">ping</span> <span class="string">”联系起来，但</span> <span class="string">ICMP</span> <span class="string">是</span> <span class="string">IP</span> <span class="string">的一个关键部分。ICMP</span> <span class="string">用于向数据包发送者报告问题；这就是这里发生的事情。不幸的是，在涉及</span> <span class="string">NAT（包括</span> <span class="string">SNAT、DNAT</span> <span class="string">和</span> <span class="string">Masquerade）的地方，存在许多不完善的实现。这就是您在这些消息中看到的情况。当</span> <span class="string">Netfilter</span> <span class="string">显示这些消息时，“[”之前的部分描述了</span> <span class="string">ICMP</span> <span class="string">数据包，“[”和“]”之间的部分描述了</span> <span class="string">ICMP</span> <span class="string">所响应的数据包。</span></span><br><span class="line"></span><br><span class="line"><span class="string">这是我对正在发生的事情的解释——为了证实这个分析，必须在连接的两端放置数据包嗅探器。</span></span><br><span class="line"></span><br><span class="line"><span class="string">NAT</span> <span class="string">网关</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.179</span> <span class="string">后面的主机</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.10</span> <span class="string">向</span> <span class="number">192.0</span><span class="number">.2</span><span class="number">.3</span> <span class="string">发送了一个</span> <span class="string">UDP</span> <span class="string">DNS</span> <span class="string">查询，您的</span> <span class="string">DNS</span> <span class="string">服务器尝试发送响应（响应信息在括号中</span> <span class="bullet">-</span> <span class="string">注意源端口</span> <span class="number">53</span><span class="string">，它将此标记为</span> <span class="string">DNS</span> <span class="string">回复）。当响应返回到</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.179</span> <span class="string">时，它将目标</span> <span class="string">IP</span> <span class="string">重写为</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.10</span><span class="string">，并将数据包转发到</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.10</span><span class="string">，而</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.10</span> <span class="string">不再与</span> <span class="string">UDP</span> <span class="string">端口</span> <span class="number">2857</span> <span class="string">建立连接。这会导致在</span> <span class="number">192.0</span><span class="number">.2</span><span class="number">.3</span> <span class="string">上生成端口不可达（类型</span> <span class="number">3</span><span class="string">，代码</span> <span class="number">3</span><span class="string">）。当此数据包通过</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.179</span> <span class="string">发送回来时，该框正确地将数据包中的源地址更改为</span> <span class="number">206.124</span><span class="number">.146</span><span class="number">.179</span><span class="string">，但不会以类似的方式重置原始</span> <span class="string">DNS</span> <span class="string">响应中的</span> <span class="string">DST</span> <span class="string">IP。当</span> <span class="string">ICMP</span> <span class="string">到达您的防火墙</span> <span class="string">(192.0.2.3)</span> <span class="string">时，您的防火墙没有向</span> <span class="number">172.16</span><span class="number">.1</span><span class="number">.10</span> <span class="string">发送</span> <span class="string">DNS</span> <span class="string">回复的记录，因此此</span> <span class="string">ICMP</span> <span class="string">似乎与发送的任何内容无关。最终结果是数据包在</span> <span class="string">all2all</span> <span class="string">链中被记录并丢弃。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">52</span><span class="string">）当我使用“shorewall[-lite]</span> <span class="string">drop</span> <span class="string">www.xxx.yyy.zzz”将某个</span> <span class="string">IP</span> <span class="string">地址列入黑名单时，为什么我的日志仍然显示来自该地址的</span> <span class="string">REDIRECT</span> <span class="string">和</span> <span class="string">DNAT</span> <span class="string">条目？</span></span><br><span class="line"></span><br><span class="line"><span class="string">我使用shorewall</span> <span class="string">drop</span> <span class="number">130.252</span><span class="number">.100</span><span class="number">.59</span> <span class="string">将地址</span> <span class="number">130.252</span><span class="number">.100</span><span class="number">.59</span> <span class="string">列入黑名单，但我仍然看到以下日志消息：</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="string">月</span> <span class="number">30</span> <span class="string">日</span> <span class="number">15</span><span class="string">:38:34</span> <span class="string">服务器</span> <span class="string">Shorewall:net_dnat:REDIRECT:IN=eth1</span> <span class="string">OUT=</span> <span class="string">MAC=00:4f:4e:14:97:8e:00:01:5c:23:24:cc:08:00</span></span><br><span class="line">                       <span class="string">SRC=130.252.100.59</span> <span class="string">DST=206.124.146.176</span> <span class="string">LEN=64</span> <span class="string">TOS=0x00</span> <span class="string">PREC=0x00</span> <span class="string">TTL=43</span> <span class="string">ID=42444</span> <span class="string">DF</span></span><br><span class="line">                       <span class="string">协议</span> <span class="string">=</span> <span class="string">TCP</span> <span class="string">SPT</span> <span class="string">=</span> <span class="number">2215</span> <span class="string">DPT</span> <span class="string">=</span> <span class="number">139</span> <span class="string">窗口</span> <span class="string">=</span> <span class="number">53760</span> <span class="string">RES</span> <span class="string">=</span> <span class="number">0x00</span> <span class="string">SYN</span> <span class="string">URGP</span> <span class="string">=</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：请参阅Shorewall</span> <span class="string">Netfilter</span> <span class="string">文档。REDIRECT</span> <span class="string">和</span> <span class="string">DNAT</span> <span class="string">规则的记录发生在</span> <span class="string">nat</span> <span class="string">表的</span> <span class="string">PREROUTING</span> <span class="string">链中，其中原始目标</span> <span class="string">IP</span> <span class="string">地址仍然可用。黑名单发生在</span> <span class="string">filter</span> <span class="string">表的</span> <span class="string">INPUT</span> <span class="string">和</span> <span class="string">FORWARD</span> <span class="string">链之外，直到稍后才会遍历这些链。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">81</span><span class="string">）logdrop</span> <span class="string">和</span> <span class="string">logreject</span> <span class="string">不记录。</span></span><br><span class="line"></span><br><span class="line"><span class="string">我喜欢输入“shorewall</span> <span class="string">logdrop</span> <span class="string">ww.xx.yy.zz”并完全阻止特定</span> <span class="string">IP</span> <span class="string">地址的功能。但是，日志部分没有发生。当我查看</span> <span class="string">logdrop</span> <span class="string">链时，没有</span> <span class="string">LOG</span> <span class="string">前缀。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：您没有在shorewall.conf</span> <span class="string">(5)</span> <span class="string">中设置</span> <span class="string">BLACKLIST_LOGLEVEL</span> <span class="string">的值。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">36</span><span class="string">）我的日志里充满了这些</span> <span class="string">BANDWIDTH</span> <span class="string">消息！</span></span><br><span class="line"></span><br><span class="line"><span class="number">12</span> <span class="string">月</span> <span class="number">15</span> <span class="string">日</span> <span class="number">16</span><span class="string">:47:30</span> <span class="string">heath-desktop</span> <span class="string">内核：[17182740.184000]</span> <span class="string">BANDWIDTH_IN:IN=eth1</span> <span class="string">OUT=MAC=ff:ff:ff:ff:ff:ff:ff:00:01:5c:23:79:02:08:00</span></span><br><span class="line">                                                        <span class="string">SRC=10.119.248.1</span> <span class="string">DST=255.255.255.255</span> <span class="string">LEN=328</span> <span class="string">TOS=0x00</span> <span class="string">PREC=0x00</span> <span class="string">TTL=64</span></span><br><span class="line">                                                        <span class="string">ID=62081</span> <span class="string">协议=UDP</span> <span class="string">SPT=67</span> <span class="string">DPT=68</span> <span class="string">LEN=308</span></span><br><span class="line"><span class="number">12</span> <span class="string">月</span> <span class="number">15</span> <span class="string">日</span> <span class="number">16</span><span class="string">:47:30</span> <span class="string">heath-desktop</span> <span class="string">最后一条消息重复了</span> <span class="number">2</span> <span class="string">次</span></span><br><span class="line"><span class="number">12</span> <span class="string">月</span> <span class="number">15</span> <span class="string">日</span> <span class="number">16</span><span class="string">:47:30</span> <span class="string">heath-desktop</span> <span class="string">内核：[17182740.188000]</span> <span class="string">BANDWIDTH_IN:IN=eth1</span> <span class="string">OUT=MAC=ff:ff:ff:ff:ff:ff:ff:00:01:5c:23:79:02:08:00</span></span><br><span class="line">                                                        <span class="string">SRC=10.112.70.1</span> <span class="string">DST=255.255.255.255</span> <span class="string">LEN=328</span> <span class="string">TOS=0x00</span> <span class="string">PREC=0x00</span> <span class="string">TTL=64</span></span><br><span class="line">                                                        <span class="string">ID=62082</span> <span class="string">协议=UDP</span> <span class="string">SPT=67</span> <span class="string">DPT=68</span> <span class="string">LEN=308</span></span><br><span class="line"><span class="number">12</span> <span class="string">月</span> <span class="number">15</span> <span class="string">日</span> <span class="number">16</span><span class="string">:47:30</span> <span class="string">heath-desktop</span> <span class="string">最后一条消息重复了</span> <span class="number">2</span> <span class="string">次</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：Webmin</span> <span class="string">的“带宽”模块添加了命令，/etc/shorewall/start创建规则来记录每个进出防火墙的数据包。不要在</span> <span class="string">WEBMIN</span> <span class="string">中启动带宽服务！</span></span><br><span class="line"></span><br><span class="line"><span class="string">一旦发生这种情况，请编辑/etc/shorewall/start并在</span> <span class="string">BANDWIDTH</span> <span class="string">规则之前插入“return</span> <span class="number">0</span><span class="string">”。</span></span><br><span class="line"><span class="string">路由</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">32</span><span class="string">）我的防火墙有两个来自不同</span> <span class="string">ISP</span> <span class="string">的互联网连接。如何在</span> <span class="string">Shorewall</span> <span class="string">中设置？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：请参阅有关</span> <span class="string">Shorewall</span> <span class="string">和多个</span> <span class="string">ISP</span> <span class="string">的文章。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">49</span><span class="string">）当我启动</span> <span class="string">Shorewall</span> <span class="string">时，我的路由表被吹走了。Shorewall</span> <span class="string">为什么会这样？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这通常是一对一</span> <span class="string">nat</span> <span class="string">配置错误造成的结果：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">/etc/shorewall/nat尽管文档（以及文件中的注释）警告您不要这样做，但仍要在</span> <span class="string">EXTERNAL</span> <span class="string">列中指定接口的主</span> <span class="string">IP</span> <span class="string">地址。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在</span> <span class="string">/etc/shorewall/shorewall.conf</span> <span class="string">中指定</span> <span class="string">ADD_IP_ALIASES=Yes</span> <span class="string">和</span> <span class="string">RETAIN_ALIASES=No。</span></span><br><span class="line"></span><br><span class="line"><span class="string">此组合会导致</span> <span class="string">Shorewall</span> <span class="string">从</span> <span class="string">INTERFACE</span> <span class="string">列中指定的网络接口中删除主</span> <span class="string">IP</span> <span class="string">地址，这通常会导致删除该接口的所有路由。解决方案是在</span> <span class="string">EXTERNAL</span> <span class="string">列中不指定接口的主</span> <span class="string">IP</span> <span class="string">地址。</span></span><br><span class="line"><span class="string">启动和停止</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">94</span><span class="string">）启动</span> <span class="string">Shorewall</span> <span class="string">后，ps</span> <span class="string">没有显示任何正在运行的</span> <span class="string">shorewall</span> <span class="string">进程。Shorewall</span> <span class="string">守护进程叫什么？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">Shorewall</span> <span class="string">不是守护进程。它是一个配置工具，根据</span> <span class="string">的内容配置您的内核/etc/shorewall/。一旦启动命令完成，Shorewall</span> <span class="string">就完成了它的工作，系统中不再有</span> <span class="string">Shorewall</span> <span class="string">进程。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">7</span><span class="string">）当我使用“</span> <span class="string">shorewall[-lite]</span> <span class="string">stop</span> <span class="string">”停止</span> <span class="string">Shorewall</span> <span class="string">时，我无法连接到任何东西。为什么该命令不起作用？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：stop命令将防火墙置于安全状态；允许的连接由shorewall.conf</span> <span class="string">(5)</span> <span class="string">中的</span> <span class="string">ADMINISABSENTMINDED</span> <span class="string">设置和shorewall-stoppedrules</span> <span class="string">(5)的内容。要完全打开防火墙，请使用clear命令。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">9</span><span class="string">）为什么</span> <span class="string">Shorewall</span> <span class="string">在启动时无法正确检测到我的接口？</span></span><br><span class="line"></span><br><span class="line"><span class="string">我刚刚安装了</span> <span class="string">Shorewall，当我发出启动命令时，我看到以下内容：</span></span><br><span class="line"></span><br><span class="line"><span class="string">正在处理</span> <span class="string">/etc/shorewall/params</span> <span class="string">...</span></span><br><span class="line"><span class="string">正在处理</span> <span class="string">/etc/shorewall/shorewall.conf</span> <span class="string">...</span></span><br><span class="line"><span class="string">启动</span> <span class="string">Shorewall...</span></span><br><span class="line"><span class="string">正在加载模块...</span></span><br><span class="line"><span class="string">正在初始化...</span></span><br><span class="line"><span class="string">确定区域...</span></span><br><span class="line">   <span class="string">区域：net</span> <span class="string">loc</span></span><br><span class="line"><span class="string">验证接口文件...</span></span><br><span class="line"><span class="string">正在验证主机文件...</span></span><br><span class="line"><span class="string">确定区域中的主机...</span></span><br><span class="line">    <span class="string">网络区域：eth0：0.0.0.0/0</span></span><br><span class="line">    <span class="string">本地区域：eth1：0.0.0.0/0</span></span><br><span class="line"><span class="string">正在删除用户链...</span></span><br><span class="line"><span class="string">创建输入链...</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"></span><br><span class="line"><span class="string">为什么</span> <span class="string">Shorewall</span> <span class="string">无法正确检测我的接口？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：以上输出完全正常。Net</span> <span class="string">区域定义为通过</span> <span class="string">连接的所有主机eth0，而</span> <span class="string">local</span> <span class="string">区域定义为通过</span> <span class="string">连接的所有主机eth1。如果您希望防范“</span> <span class="string">Martians</span> <span class="string">”（Martian</span> <span class="string">是指源</span> <span class="string">IP</span> <span class="string">地址未从接收数据包的接口路由出去的数据包），则可以在内部接口上设置routefilter选项。如果您这样做，最好也设置</span> <span class="string">logmartians选项。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">22</span><span class="string">）我有一些</span> <span class="string">iptables</span> <span class="string">命令，希望在</span> <span class="string">Shorewall</span> <span class="string">启动时运行。我应该把它们放在哪个文件中？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：您可以将这些命令放在Shorewall</span> <span class="string">扩展脚本之一中。请务必查看您将使用命令修改的链的内容，以便命令能够执行预期的操作。HOWTO</span> <span class="string">和其他指导材料中发布的许多</span> <span class="string">iptables</span> <span class="string">命令都使用</span> <span class="string">-A</span> <span class="string">命令，该命令将规则添加到链的末尾。Shorewall</span> <span class="string">构建的大多数链都以无条件的</span> <span class="string">DROP、ACCEPT</span> <span class="string">或</span> <span class="string">REJECT</span> <span class="string">规则结尾，之后添加的任何规则都将被忽略。检查“</span> <span class="string">man</span> <span class="string">iptables</span> <span class="string">”并查看</span> <span class="string">-I（--insert）命令。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">43</span><span class="string">）我刚刚安装了</span> <span class="string">Shorewall</span> <span class="string">RPM，但</span> <span class="string">Shorewall</span> <span class="string">在启动时无法启动。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：使用“rpm</span> <span class="string">-U”命令安装时，Shorewall</span> <span class="string">不会运行您的发行版的用于配置</span> <span class="string">Shorewall</span> <span class="string">启动的工具。您需要运行该工具（insserv、chkconfig、运行级别编辑器等）来配置</span> <span class="string">Shorewall</span> <span class="string">以在防火墙系统的默认运行级别中启动。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">59</span><span class="string">）启动</span> <span class="string">Shorewall</span> <span class="string">后，会加载大量未使用的</span> <span class="string">Netfilter</span> <span class="string">模块。如何避免这种情况？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：复制/usr/share/shorewall[-lite]/modules修改/etc/shorewall/modules</span> <span class="string">副本以仅包含您需要的模块。另一种方法是在shorewall.conf</span> <span class="string">(5)</span> <span class="string">中设置</span> <span class="string">LOAD_HELPERS_ONLY=Yes。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">68</span><span class="string">）我在</span> <span class="string">OpenVZ</span> <span class="string">系统下有一台虚拟机。我无法摆脱以下消息：</span></span><br><span class="line"></span><br><span class="line"><span class="string">错误：命令“/sbin/iptables</span> <span class="string">-A</span> <span class="string">FORWARD</span> <span class="string">-m</span> <span class="string">state</span> <span class="string">--state</span> <span class="string">ESTABLISHED,RELATED</span> <span class="string">-j</span> <span class="string">ACCEPT”失败。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：请参阅Shorewall</span> <span class="string">OpenVZ</span> <span class="string">文章。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">73</span><span class="string">）当我停止</span> <span class="string">Shorewall</span> <span class="string">时，防火墙处于完全打开状态。这难道不是安全风险吗？</span></span><br><span class="line"></span><br><span class="line"><span class="string">重要的是要了解，</span> <span class="string">中的脚本/etc/init.d通常由您的发行版提供，而不是由</span> <span class="string">Shorewall</span> <span class="string">开发人员提供。这些脚本必须满足发行版打包系统的要求，这可能会与严密防火墙的要求相冲突。因此，当您说“…当我停止</span> <span class="string">Shorewall…”时，有必要区分命令/sbin/shorewall</span> <span class="string">stop和/etc/init.d/shorewall</span> <span class="string">stop。</span></span><br><span class="line"></span><br><span class="line"><span class="string">/sbin/shorewall</span> <span class="string">stop将防火墙置于安全状态，其细节取决于您的/etc/shorewall/stoppedrules文件</span> <span class="string">(</span> <span class="string">shorewall-stoppedrules/etc/shorewall/shorewall.conf</span> <span class="string">(5))</span> <span class="string">和(</span> <span class="string">shorewall.conf</span> <span class="string">(5)</span> <span class="string">)中</span> <span class="string">ADMINISABSENTMINDED</span> <span class="string">的设置</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/init.d/shorewall</span> <span class="string">stop可能会或可能不会执行相同的操作。例如，在Debian</span> <span class="string">™</span> <span class="string">系统中，该命令实际上执行/sbin/shorewall</span> <span class="string">clear，从而完全打开防火墙。换句话说，在</span> <span class="string">init</span> <span class="string">脚本中，</span> <span class="string">stop会反转start的效果。</span></span><br><span class="line"></span><br><span class="line"><span class="string">从</span> <span class="string">Shorewall</span> <span class="number">4.4</span> <span class="string">开始，当</span> <span class="string">Shorewall</span> <span class="string">tarball</span> <span class="string">安装在</span> <span class="string">Debian（或衍生）系统上时，该/etc/init.d/shorewall文件与</span> <span class="string">.deb</span> <span class="string">安装的文件相同。/etc/init.d/shorewall</span> <span class="string">stop的行为由</span> <span class="string">中的</span> <span class="string">SAFESTOP</span> <span class="string">设置控制/etc/default/shorewall。设置为</span> <span class="number">0</span><span class="string">（默认值）时，防火墙被清除；设置为</span> <span class="number">1</span> <span class="string">时，防火墙处于安全状态。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">78</span><span class="string">）重启并启动我的</span> <span class="string">Debian</span> <span class="string">防火墙后，防火墙后面的主机尝试连接到网络或通过</span> <span class="string">VPN</span> <span class="string">的所有流量都被阻止（尽管我可以访问内部防火墙接口并获取转储等）。一旦我发出“shorewall</span> <span class="string">clear”，然后发出“shorewall</span> <span class="string">start”，它就会正常工作，尽管配置没有改变</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在</span> <span class="string">中设置</span> <span class="string">IP_FORWARDING=On/etc/shorewall/shorewall.conf。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">86</span><span class="string">）我的发行版</span> <span class="string">(Ubuntu)</span> <span class="string">使用</span> <span class="string">NetworkManager</span> <span class="string">来管理我的接口。我想为我的接口指定</span> <span class="string">upnpclient</span> <span class="string">选项，这要求在</span> <span class="string">Shorewall</span> <span class="string">启动时启动并配置它们，但</span> <span class="string">Shorewall</span> <span class="string">在</span> <span class="string">NetworkManager</span> <span class="string">之前启动。</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：我遇到了类似的问题，解决方法如下：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">不要在启动时启动</span> <span class="string">Shorewall（Debian</span> <span class="string">和</span> <span class="string">Ubuntu</span> <span class="string">用户只需在</span> <span class="string">中设置</span> <span class="string">startup=0</span> <span class="string">/etc/default/shorewall）或使用systemctl</span> <span class="string">disable</span> <span class="string">shorewall.service在</span> <span class="string">systemd</span> <span class="string">中禁用它。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在中/etc/network/ip-up.d我添加了一个shorewall脚本，内容如下：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">/bin/sh</span> <span class="comment">#!/bin/sh 复制代码</span></span><br><span class="line"></span><br><span class="line">    <span class="string">shorewall</span> <span class="string">status</span> <span class="string">&gt;</span> <span class="string">/dev/null</span> <span class="number">2</span><span class="string">&gt;&amp;1</span> <span class="string">||</span> <span class="string">shorewall</span> <span class="string">start</span> <span class="comment"># 如果 Shorewall 尚未运行，则启动它</span></span><br><span class="line"></span><br><span class="line">    <span class="string">确保脚本的执行访问权限安全。</span></span><br><span class="line"></span><br><span class="line"><span class="string">更新：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">从</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.10</span> <span class="string">开始，有一个新的Shorewall</span> <span class="string">Init</span> <span class="string">包专门用于处理这种情况。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">90</span><span class="string">）</span> <span class="string">Shorewall</span> <span class="string">启动正常，但几分钟后就停止了。为什么会这样？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">Shorewall</span> <span class="string">使用名为shorewall的链的存在来指示是启动还是停止。该链是在成功执行start、</span> <span class="string">restart或restore命令期间创建的，并在stop和clear期间删除。如果shorewall</span> <span class="string">status指示</span> <span class="string">Shorewall</span> <span class="string">已停止，则表示有东西删除了该链。查看shorewall</span> <span class="string">status的输出；如果它看起来像这样：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">网关：〜#岸墙状态</span></span><br><span class="line">    <span class="string">Shorewall-4.4.11</span> <span class="string">网关状态</span> <span class="bullet">-</span> <span class="number">2010</span> <span class="string">年</span> <span class="number">7</span> <span class="string">月</span> <span class="number">21</span> <span class="string">日星期三</span> <span class="number">13</span><span class="string">:21:41</span> <span class="string">PDT</span></span><br><span class="line"></span><br><span class="line">    <span class="string">Shorewall</span> <span class="string">已停止</span></span><br><span class="line">    <span class="string">状态：已启动（2010</span> <span class="string">年</span> <span class="number">7</span> <span class="string">月</span> <span class="number">20</span> <span class="string">日星期二</span> <span class="number">16</span><span class="string">:01:49</span> <span class="string">PDT）</span></span><br><span class="line"></span><br><span class="line">    <span class="string">网关:~#</span></span><br><span class="line"></span><br><span class="line"><span class="string">那么这意味着</span> <span class="string">Shorewall</span> <span class="string">之外的某些东西删除了该链。这通常意味着您在安装</span> <span class="string">Shorewall</span> <span class="string">之前正在运行另一个防火墙包，并且该包已用自己的配置替换了</span> <span class="string">Shorewall</span> <span class="string">的</span> <span class="string">Netfilter</span> <span class="string">配置。您必须删除（或至少禁用）其他防火墙包并重新启动</span> <span class="string">Shorewall。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">网关：〜#岸墙状态</span></span><br><span class="line">    <span class="string">Shorewall-4.4.11</span> <span class="string">网关状态</span> <span class="bullet">-</span> <span class="number">2010</span> <span class="string">年</span> <span class="number">7</span> <span class="string">月</span> <span class="number">21</span> <span class="string">日星期三</span> <span class="number">13</span><span class="string">:26:29</span> <span class="string">PDT</span></span><br><span class="line"></span><br><span class="line">    <span class="string">Shorewall</span> <span class="string">已停止</span></span><br><span class="line">    <span class="string">状态：已停止（2010</span> <span class="string">年</span> <span class="number">7</span> <span class="string">月</span> <span class="number">21</span> <span class="string">日星期三</span> <span class="number">13</span><span class="string">:26:26</span> <span class="string">PDT）</span></span><br><span class="line"></span><br><span class="line">    <span class="string">网关:~#</span></span><br><span class="line"></span><br><span class="line"><span class="string">然后执行了shorewall</span> <span class="string">stop命令（如果输出中显示的</span> <span class="string">State</span> <span class="string">为Cleared，则执行了shorewall</span> <span class="string">clear命令）。最有可能的是，您已经安装并配置了shorewall-init包，并且所需的接口已关闭。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">99</span><span class="string">）我的</span> <span class="string">/var/lib/shorewall-init.log</span> <span class="string">显示</span> <span class="string">Shorewall</span> <span class="string">在启动时正在运行，但启动后“iptables</span> <span class="string">-L”显示空配置</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这是由于您在安装</span> <span class="string">Shorewall</span> <span class="string">时未能禁用发行版默认的</span> <span class="string">iptables</span> <span class="string">配置工具所致。查找在</span> <span class="string">Shorewall</span> <span class="string">之后启动的名为“iptables”的服务并将其禁用。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">101</span><span class="string">）如何在较慢的硬件上加快“shorewall</span> <span class="string">start”和“shorewall</span> <span class="string">restart”的速度？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：您可以采取以下几个步骤：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果您的内核支持模块自动加载（并且分发默认内核几乎总是支持），那么请在</span> <span class="string">shorewall.conf</span> <span class="string">中设置</span> <span class="string">LOAD_HELPERS_ONLY=Yes。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在</span> <span class="string">shorewall.conf</span> <span class="string">中设置</span> <span class="string">AUTOMAKE=Yes。这将避免在配置自上次编译后没有发生更改的情况下进行编译阶段。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">不要设置优化选项</span> <span class="number">8</span><span class="string">。例如，如果您当前设置了</span> <span class="string">OPTIMIZE=31，则将其更改为</span> <span class="string">OPTIMIZE=23。优化选项</span> <span class="number">8</span> <span class="string">会合并相同的链，从而生成较小的规则集，但会减慢大型规则集的编译速度。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">不要使用</span> <span class="string">restart，而要使用reload。使用默认设置</span> <span class="string">RESTART=restart</span> <span class="string">，restart会执行stop然后执行</span> <span class="string">start，而reload则避免执行stop部分。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">使用功能文件：</span></span><br><span class="line"></span><br><span class="line">        <span class="string">运行shorewall</span> <span class="string">show</span> <span class="string">-f</span> <span class="string">capabilties</span> <span class="string">&gt;</span> <span class="string">/etc/shorewall/capabilities</span></span><br><span class="line"></span><br><span class="line">        <span class="string">每次安装新内核或新版本的</span> <span class="string">shorewall</span> <span class="string">时，请重新运行该命令。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">103</span><span class="string">）</span> <span class="string">Shorewall</span> <span class="string">无法在启动时启动，但启动后会立即启动</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这通常与</span> <span class="string">SELinux</span> <span class="string">有关。这里是一个例子。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">104</span><span class="string">）我明白了（常见问题</span> <span class="number">104</span><span class="string">）当我启动或重新启动</span> <span class="string">Shorewall</span> <span class="string">或</span> <span class="string">Shorewall6</span> <span class="string">时，我在日志中内核消息</span></span><br><span class="line"></span><br><span class="line"><span class="string">例子：</span></span><br><span class="line"></span><br><span class="line"><span class="string">&gt;</span> <span class="number">10</span> <span class="string">月</span> <span class="number">1</span> <span class="string">日</span> <span class="number">13</span><span class="string">:04:39</span> <span class="string">deb</span> <span class="string">内核：[9570.619744]</span> <span class="string">xt_addrtype：ipv6</span> <span class="string">不支持</span> <span class="string">BROADCAST</span> <span class="string">匹配</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这些是无害的。Shorewall</span> <span class="string">尝试执行各种命令来确定系统的功能。如果您的系统不支持某个命令，它通常会发出内核日志消息。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">106</span><span class="string">）使用</span> <span class="string">systemd</span> <span class="string">的</span> <span class="string">Debian</span> <span class="string">启动时</span> <span class="string">Shorewall</span> <span class="string">不会启动</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：要启用开机自启动功能，请运行systemctl</span> <span class="string">enable</span> <span class="string">shorewall.service</span></span><br><span class="line"><span class="string">多个</span> <span class="string">ISP</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">57</span><span class="string">）我在</span> <span class="string">Shorewall</span> <span class="string">中配置了两个</span> <span class="string">ISP，但是当我尝试使用第二个</span> <span class="string">ISP</span> <span class="string">时，它不起作用。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：多</span> <span class="string">ISP</span> <span class="string">文档强烈建议您在所有提供商上使用平衡选项，即使您想手动指定要使用的</span> <span class="string">ISP。如果您不这样做，您的主路由表只有一个默认路由，那么您必须禁用路由过滤。不要在其他接口上指定路由过滤器/etc/shorewall/interfaces选项，并禁用您的发行版提供的任何IP</span> <span class="string">地址欺骗保护。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">58</span><span class="string">）但是如果我指定“balance”，那么</span> <span class="string">Shorewall</span> <span class="string">不会平衡接口之间的流量吗？我不想要那样！</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：假设您希望所有流量都通过</span> <span class="string">ISP1（标记为</span> <span class="number">1</span><span class="string">）出去，除非您另有指定。那么只需在您的/etc/shorewall/mangle（原为</span> <span class="string">tcrules）文件中添加以下两条规则作为第一条标记规则即可：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标</span></span><br><span class="line"><span class="string">标记(1):P</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"><span class="string">MARK(1)</span> <span class="string">$FW</span></span><br><span class="line"><span class="string">其他</span> <span class="string">MARK</span> <span class="string">规则</span></span><br><span class="line"></span><br><span class="line"><span class="string">现在，任何未被其他</span> <span class="string">MARK</span> <span class="string">规则标记的流量都将标记为</span> <span class="number">1</span><span class="string">，并通过</span> <span class="string">ISP1</span> <span class="string">发送。无论是否指定了余额，这都可以正常工作！</span></span><br><span class="line"><span class="string">使用</span> <span class="string">DNS</span> <span class="string">名称</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">79</span><span class="string">）我可以在</span> <span class="string">Shorewall</span> <span class="string">配置文件条目中使用</span> <span class="string">DNS</span> <span class="string">名称代替</span> <span class="string">IP</span> <span class="string">地址吗？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：可以，但是我们强烈建议不要这么做。</span></span><br><span class="line"><span class="string">流量整形</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">67</span><span class="string">）我刚刚配置了</span> <span class="string">Shorewall</span> <span class="string">的内置流量整形，但现在</span> <span class="string">Shorewall</span> <span class="string">无法启动。</span></span><br><span class="line"></span><br><span class="line"><span class="string">我收到的错误如下：</span></span><br><span class="line"></span><br><span class="line"><span class="string">RTNETLINK</span> <span class="string">回答：没有这样的文件或目录</span></span><br><span class="line"><span class="string">我们与内核通信时出错</span></span><br><span class="line">    <span class="string">错误：命令“tc</span> <span class="string">filter</span> <span class="string">add</span> <span class="string">dev</span> <span class="string">eth2</span> <span class="string">parent</span> <span class="string">ffff：协议</span> <span class="string">ip</span> <span class="string">prio</span></span><br><span class="line">                    <span class="number">50</span> <span class="string">u32</span> <span class="string">匹配</span> <span class="string">ip</span> <span class="string">src</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="string">策略速率</span> <span class="string">500kbit</span> <span class="string">突发</span> <span class="string">10k</span> <span class="string">丢弃</span> <span class="string">flowid</span></span><br><span class="line">                    <span class="string">:1”失败</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：此消息表明您的内核不支持“流量监管”。如果您的内核是模块化的，您可以通过加载act_police内核模块来解决问题。您需要的其他内核模块包括：</span></span><br><span class="line"><span class="string">cls_基本</span></span><br><span class="line"><span class="string">cls_fw</span></span><br><span class="line"><span class="string">cls_u32</span></span><br><span class="line"><span class="string">sch_htb</span></span><br><span class="line"><span class="string">sch_ingress</span></span><br><span class="line"><span class="string">sch_sfq</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">97</span><span class="string">）我启用了</span> <span class="string">Shorewall</span> <span class="string">流量整形，现在我的上传速率远低于我指定的值</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这可能是由于网络适配器中启用了</span> <span class="string">TCP</span> <span class="string">分段卸载</span> <span class="string">(TSO)</span> <span class="string">和/或通用分段卸载</span> <span class="string">(GSO)。要验证，请安装ethtool包并使用</span> <span class="string">-k</span> <span class="string">命令：</span></span><br><span class="line"></span><br><span class="line"><span class="string">root@gateway:~#</span> <span class="string">ethtool</span> <span class="string">-k</span> <span class="string">eth1</span></span><br><span class="line"><span class="string">eth1</span> <span class="string">的卸载参数：</span></span><br><span class="line"><span class="string">接收校验和：开启</span></span><br><span class="line"><span class="string">tx-校验和：开启</span></span><br><span class="line"><span class="string">分散-聚集：开启</span></span><br><span class="line"><span class="string">tcp</span> <span class="string">分段卸载：开启</span></span><br><span class="line"><span class="string">udp</span> <span class="string">碎片卸载：关闭</span></span><br><span class="line"><span class="string">通用分段卸载：开启</span></span><br><span class="line"><span class="string">通用接收卸载：关闭</span></span><br><span class="line"><span class="string">大型接收卸载：关闭</span></span><br><span class="line"><span class="attr">ntuple-filters:</span> <span class="string">关闭</span></span><br><span class="line"><span class="string">接收哈希：关闭</span></span><br><span class="line"><span class="string">root@gateway:~#</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果是这种情况，您可以通过调整minburst/etc/shorewall/tcinterfaces（简单流量整形）或</span> <span class="string">/etc/shorewall/tcdevices（复杂流量整形）中的设置来解决问题。我们建议从</span> <span class="number">10</span><span class="string">-12kb</span> <span class="string">开始，并根据需要进行调整。示例（简单流量整形）：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#接口类型 输入带宽 输出带宽</span></span><br><span class="line"><span class="string">eth0</span> <span class="string">外部</span> <span class="attr">50mbit:200kb 5.0mbit:100kb:200ms:100mbit:</span> <span class="string">10kb</span></span><br><span class="line"></span><br><span class="line"><span class="string">或者，您也可以使用此命令关闭</span> <span class="string">TSO</span> <span class="string">和</span> <span class="string">GSO</span> <span class="string">/etc/shorewall/init：</span></span><br><span class="line"></span><br><span class="line"><span class="string">ethtool</span> <span class="string">-K</span> <span class="string">eth</span> <span class="string">N</span> <span class="string">tso</span> <span class="string">关闭</span> <span class="string">gso</span> <span class="string">关闭</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">97a）我启用了</span> <span class="string">Shorewall</span> <span class="string">流量整形，现在我的下载速率远低于我指定的值</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这可能是由于网络适配器中启用了通用接收卸载</span> <span class="string">(GRO)。要验证，请安装ethtool包并使用</span> <span class="string">-k</span> <span class="string">命令：</span></span><br><span class="line"></span><br><span class="line"><span class="string">root@gateway:/etc/shorewall#</span> <span class="string">ethtool</span> <span class="string">-k</span> <span class="string">eth1</span></span><br><span class="line"><span class="string">eth1</span> <span class="string">的卸载参数：</span></span><br><span class="line"><span class="string">接收校验和：开启</span></span><br><span class="line"><span class="string">tx-校验和：开启</span></span><br><span class="line"><span class="string">分散-聚集：开启</span></span><br><span class="line"><span class="string">tcp</span> <span class="string">分段卸载：开启</span></span><br><span class="line"><span class="string">udp</span> <span class="string">碎片卸载：关闭</span></span><br><span class="line"><span class="string">通用分段卸载：开启</span></span><br><span class="line"><span class="string">通用接收卸载：开启</span></span><br><span class="line"><span class="string">大型接收卸载：关闭</span></span><br><span class="line"><span class="attr">ntuple-filters:</span> <span class="string">关闭</span></span><br><span class="line"><span class="string">接收哈希：关闭</span></span><br><span class="line"><span class="string">root@gateway:/etc/shorewall#</span></span><br><span class="line"></span><br><span class="line"><span class="string">要解决此问题，请使用以下命令：</span></span><br><span class="line"></span><br><span class="line"><span class="string">ethtool</span> <span class="string">-K</span> <span class="string">eth</span> <span class="string">N</span> <span class="string">gro</span> <span class="string">关闭</span></span><br><span class="line"></span><br><span class="line"><span class="string">从</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.25</span> <span class="string">开始，以速率估计监管过滤器的形式提供了另一种选项。</span></span><br><span class="line"></span><br><span class="line"><span class="string">来自</span> <span class="string">/etc/shorewall/tcdevices</span> <span class="string">的示例：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#接口输入带宽输出带宽选项</span></span><br><span class="line"><span class="number">1</span><span class="string">：COMB_IF</span>        <span class="string">~20mbit：250ms：4sec</span>       <span class="string">$&#123;UPLOAD&#125;kbit</span> <span class="string">hfsc，链路层=以太网，开销=0</span></span><br><span class="line"></span><br><span class="line"><span class="string">要创建速率估计滤波器，请在带宽前加上波浪符号（“~”）。可选的间隔和衰减间隔决定了估计速率的频率以及保留多少个样本进行估计。有关详细信息，请参阅http://ace-host.stuart.id.au/russell/files/tc/doc/estimators.txt。</span></span><br><span class="line"><span class="string">关于</span> <span class="string">Shorewall</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">10</span><span class="string">）Shorewall</span> <span class="string">与哪些发行版兼容？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">Shorewall</span> <span class="string">可与任何包含适当先决条件的GNU/Linux</span> <span class="string">发行版兼容。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">11</span><span class="string">）Shorewall</span> <span class="string">有哪些功能？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：请参阅Shorewall</span> <span class="string">功能列表。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">12</span><span class="string">）有</span> <span class="string">GUI</span> <span class="string">吗？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：是的！Webmin</span> <span class="string">中提供</span> <span class="string">Shorewall</span> <span class="string">支持。请参阅http://www.webmin.com</span> <span class="string">。但请注意常见问题解答</span> <span class="number">36</span><span class="string">中描述的问题。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">13</span><span class="string">）为什么称之为“</span> <span class="string">Shorewall</span> <span class="string">”？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：</span> <span class="string">Shorewall</span> <span class="string">是“海岸线”</span> <span class="string">（我居住的城市）和“防火墙</span> <span class="string">”的组合。该产品的全名实际上是“海岸线防火墙”，但“</span> <span class="string">Shorewall</span> <span class="string">”更常用。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">23</span><span class="string">）为什么你们的网站上使用这么丑的字体？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">Shorewall</span> <span class="string">网站几乎不使用任何字体（除了少数页面外，它没有明确指定字体），因此您看到的字体大部分都是浏览器中配置的默认字体。如果您不喜欢它们，请重新配置您的浏览器。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">25</span><span class="string">）如何知道我正在运行哪个版本的</span> <span class="string">Shorewall</span> <span class="string">或</span> <span class="string">Shorewall</span> <span class="string">Lite？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在</span> <span class="string">shell</span> <span class="string">提示符下，输入：</span></span><br><span class="line"></span><br><span class="line"><span class="string">/sbin/shorewall[-lite]</span> <span class="string">版本</span> <span class="string">-a</span>     </span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">25a）上面说</span> <span class="number">4.4</span><span class="number">.7</span><span class="number">.5</span><span class="string">；我怎么知道它是</span> <span class="string">Shorewall-shell</span> <span class="string">还是</span> <span class="string">Shorewall-perl？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：它是</span> <span class="string">Shorewall-perl。Shorewall-shell</span> <span class="string">在</span> <span class="string">Shorewall</span> <span class="number">4.4</span> <span class="string">中已停用。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">31</span><span class="string">）Shorewall</span> <span class="string">是否提供针对....的保护。</span></span><br><span class="line"></span><br><span class="line"><span class="string">IP</span> <span class="string">欺骗：使用内部</span> <span class="string">LAP</span> <span class="string">IP</span> <span class="string">地址作为源地址通过</span> <span class="string">WAN</span> <span class="string">接口发送数据包？</span></span><br><span class="line"></span><br><span class="line">    <span class="string">答：是的。</span></span><br><span class="line"><span class="string">泪滴：发送包含重叠片段的数据包？</span></span><br><span class="line"></span><br><span class="line">    <span class="string">答案：这是</span> <span class="string">IP</span> <span class="string">堆栈的责任，而不是基于</span> <span class="string">Netfilter</span> <span class="string">的防火墙的责任，因为片段重组发生在状态数据包过滤器接触每个数据包之前。</span></span><br><span class="line"><span class="string">Smurf</span> <span class="string">和</span> <span class="string">Fraggle：发送使用</span> <span class="string">WAN</span> <span class="string">或</span> <span class="string">LAN</span> <span class="string">广播地址作为源地址的数据包？</span></span><br><span class="line"></span><br><span class="line">    <span class="string">答案：</span> <span class="string">Shorwall</span> <span class="string">在/etc/shorewall/interfaces中的nosmurfs接口选项下过滤这些数据包。</span></span><br><span class="line"><span class="string">Land</span> <span class="string">攻击：发送使用相同地址作为源地址和目标地址的数据包？</span></span><br><span class="line"></span><br><span class="line">    <span class="string">答案：是的，如果选择了routefilter接口选项。</span></span><br><span class="line"><span class="string">DOS：</span> <span class="bullet">-</span> <span class="string">SYN</span> <span class="string">Dos</span> <span class="bullet">-</span> <span class="string">ICMP</span> <span class="string">Dos</span> <span class="bullet">-</span> <span class="string">每主机</span> <span class="string">Dos</span> <span class="string">保护</span></span><br><span class="line"></span><br><span class="line">    <span class="string">答：是的。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">65</span><span class="string">）如何使用</span> <span class="string">Shorewall</span> <span class="string">实现故障转移？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：</span> <span class="string">Paul</span> <span class="string">Gear</span> <span class="string">的这篇文章应该可以帮助您入门。</span></span><br><span class="line"><span class="string">别名</span> <span class="string">IP</span> <span class="string">地址/虚拟接口</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">18</span><span class="string">）有没有办法将别名</span> <span class="string">IP</span> <span class="string">地址与</span> <span class="string">Shorewall</span> <span class="string">一起使用，并为不同的</span> <span class="string">IP</span> <span class="string">维护单独的规则集？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：是的。请参阅Shorewall</span> <span class="string">和别名接口。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">83</span><span class="string">）没有办法嵌套防火墙区域或创建子区域吗？我有一个带有</span> <span class="string">Linux-VServers</span> <span class="string">的系统，它是一个具有多个</span> <span class="string">IP</span> <span class="string">的接口</span> <span class="string">(eth0)</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：从</span> <span class="string">Shorewall</span> <span class="number">4.4</span><span class="number">.11</span> <span class="string">Beta</span> <span class="number">2</span> <span class="string">开始，您可以嵌套在防火墙区域内的虚拟服务器区域。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在</span> <span class="number">4.4</span><span class="number">.11</span> <span class="string">Beta</span> <span class="number">2</span> <span class="string">之前，无法创建防火墙区域的子区域。但您可以使用</span> <span class="string">shell</span> <span class="string">变量使虚拟服务器更易于处理。</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/shorewall/params：</span></span><br><span class="line"></span><br><span class="line"><span class="string">VS1=转发:192.168.2.12</span></span><br><span class="line"><span class="string">VS2=转发:192.168.2.13</span></span><br><span class="line"><span class="string">VS3=转发:192.168.2.14</span></span><br><span class="line"></span><br><span class="line"><span class="string">/etc/shorewall/rules：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型端口</span></span><br><span class="line"></span><br><span class="line"><span class="string">?全部部分</span></span><br><span class="line"><span class="string">?部分已建立</span></span><br><span class="line"><span class="string">?SECTION</span> <span class="string">相关</span></span><br><span class="line"><span class="string">?部分无效</span></span><br><span class="line"><span class="string">?部分未跟踪</span></span><br><span class="line"><span class="string">?新部分</span></span><br><span class="line"></span><br><span class="line"><span class="string">接受</span> <span class="string">$VS1</span> <span class="string">net</span> <span class="string">tcp</span> <span class="number">25</span></span><br><span class="line"><span class="string">DNAT</span> <span class="string">净</span> <span class="string">$VS1</span> <span class="string">tcp</span> <span class="number">25</span></span><br><span class="line"><span class="string">ETC...</span></span><br><span class="line"></span><br><span class="line"><span class="string">Shorewall</span> <span class="string">Lite</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">53</span><span class="string">）什么是</span> <span class="string">Shorewall</span> <span class="string">Lite？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">Shorewall</span> <span class="string">Lite</span> <span class="string">是</span> <span class="string">Shorewall</span> <span class="string">的配套产品，旨在让您在网络内的单个系统上维护所有</span> <span class="string">Shorewall</span> <span class="string">配置信息。有关详细信息，请参阅编译的防火墙脚本文档。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">54</span><span class="string">）如果我想使用</span> <span class="string">Shorewall</span> <span class="string">Lite，我是否还需要在同一系统上安装</span> <span class="string">Shorewall？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：不。事实上，我们建议您不要在想要使用</span> <span class="string">Shorewall</span> <span class="string">Lite</span> <span class="string">的系统上安装</span> <span class="string">Shorewall。您必须在网络中的至少一个系统上安装</span> <span class="string">Shorewall</span> <span class="string">才能使用</span> <span class="string">Shorewall</span> <span class="string">Lite。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">55</span><span class="string">）我如何决定使用哪种产品</span> <span class="bullet">-</span> <span class="string">Shorewall</span> <span class="string">还是</span> <span class="string">Shorewall</span> <span class="string">Lite？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：如果您只打算使用一个防火墙系统，那么</span> <span class="string">Shorewall</span> <span class="string">是合乎逻辑的选择。我还认为</span> <span class="string">Shorewall</span> <span class="string">是笔记本电脑系统的合适选择，因为笔记本电脑系统可能需要在旅途中更改防火墙配置。在其余情况下，Shorewall</span> <span class="string">Lite</span> <span class="string">会工作得很好。在</span> <span class="string">shorewall.net</span> <span class="string">上，两个笔记本电脑系统都安装了完整的</span> <span class="string">Shorewall</span> <span class="string">产品，我的个人</span> <span class="string">Linux</span> <span class="string">桌面系统也是如此。运行防火墙的所有其他</span> <span class="string">Linux</span> <span class="string">系统都使用</span> <span class="string">Shorewall</span> <span class="string">Lite，并且它们的配置目录位于我的桌面系统上。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">60</span><span class="string">）Shorewall</span> <span class="string">和</span> <span class="string">Shorewall</span> <span class="string">Lite</span> <span class="string">之间的兼容性限制是什么</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：</span> <span class="string">Shorewall</span> <span class="string">和</span> <span class="string">Shorewall-lite</span> <span class="string">之间没有兼容性限制。</span></span><br><span class="line"><span class="string">网络电话</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">77</span><span class="string">）</span> <span class="string">Shorewall</span> <span class="string">正在吞噬我的</span> <span class="string">Asterisk</span> <span class="string">出口流量！</span></span><br><span class="line"></span><br><span class="line"><span class="string">不知何故，我的防火墙配置导致</span> <span class="string">Asterisk</span> <span class="string">出现单向音频问题。如果有人拨打</span> <span class="string">PBX，他们听不到我说话，但我能听到他们说话。如果我将</span> <span class="string">Asterisk</span> <span class="string">服务器直接插入路由器，绕过防火墙，问题就解决了。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：遇到</span> <span class="string">VOIP</span> <span class="string">问题时，有两种方法可以尝试。两种方法都是从执行两个rmmod命令开始。</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果你的内核版本是2.6.20或更早版本：</span></span><br><span class="line"></span><br><span class="line"><span class="string">rmmod</span> <span class="string">ip_nat_sip</span></span><br><span class="line"><span class="string">rmmod</span> <span class="string">ip_conntrack_sip</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果你的内核版本是2.6.21或更高版本：</span></span><br><span class="line"></span><br><span class="line"><span class="string">rmmod</span> <span class="string">nf_nat_sip</span></span><br><span class="line"><span class="string">rmmod</span> <span class="string">nf_conntrack_sip</span></span><br><span class="line"></span><br><span class="line"><span class="string">对于运行较新内核（2.6.26</span> <span class="string">或更高版本）的用户来说，第一个替代方案似乎有效：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">/usr/share/shorewall/module将s复制到/etc/shorewall（/usr/share/shorewall/helpers如果</span> <span class="string">shorewall.conf</span> <span class="string">中有</span> <span class="string">LOAD_HELPERS_ONLY）。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">编辑副本并更改此行：</span></span><br><span class="line"></span><br><span class="line">        <span class="string">加载模块</span> <span class="string">nf_conntrack_sip</span></span><br><span class="line"></span><br><span class="line">    <span class="string">到</span></span><br><span class="line"></span><br><span class="line">        <span class="string">加载模块</span> <span class="string">nf_conntrack_sip</span> <span class="string">sip_direct_media=0</span></span><br><span class="line"></span><br><span class="line">    <span class="string">重启shorewall</span></span><br><span class="line"></span><br><span class="line"><span class="string">第二种选择是不加载</span> <span class="string">SIP</span> <span class="string">助手：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果您运行的是内核</span> <span class="number">2.6</span><span class="number">.20</span> <span class="string">或更早版本，则将</span> <span class="string">shorewall.conf</span> <span class="string">中的</span> <span class="string">DONT_LOAD</span> <span class="string">规范更改为：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">DONT_LOAD=ip_nat_sip，ip_conntrack_sip</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果您运行的是内核</span> <span class="number">2.6</span><span class="number">.21</span> <span class="string">或更高版本，则将</span> <span class="string">shorewall.conf</span> <span class="string">中的</span> <span class="string">DONT_LOAD</span> <span class="string">规范更改为：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">DONT_LOAD=nf_nat_sip，nf_conntrack_sip</span></span><br><span class="line"></span><br><span class="line"><span class="string">IPv6</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">80</span><span class="string">）Shorewall</span> <span class="string">是否支持</span> <span class="string">IPV6？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：Shorewall</span> <span class="string">IPv6</span> <span class="string">支持目前在</span> <span class="string">Shorewall</span> <span class="number">4.2</span><span class="number">.4</span> <span class="string">及更高版本中可用。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="string">80a）为什么</span> <span class="string">Shorewall</span> <span class="string">lPv6</span> <span class="string">支持需要内核</span> <span class="number">2.6</span><span class="number">.24</span> <span class="string">或更高版本？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">Shorewall</span> <span class="string">实现了状态防火墙，要求在</span> <span class="string">ip6tables</span> <span class="string">和内核中存在连接跟踪。2.6.20</span> <span class="string">之前的</span> <span class="string">Linux</span> <span class="string">内核不支持</span> <span class="string">IPv6</span> <span class="string">的连接跟踪。因此，直到</span> <span class="number">2.6</span><span class="number">.20</span> <span class="string">版本，我们才开始开发</span> <span class="string">Shorewall</span> <span class="string">IPv6</span> <span class="string">支持，而且至少在内核</span> <span class="number">2.6</span><span class="number">.23</span> <span class="string">版本之前，该功能都存在严重问题。当发行版开始提供</span> <span class="string">IPv6</span> <span class="string">连接跟踪支持时，使用的是内核</span> <span class="number">2.6</span><span class="number">.25</span><span class="string">。因此，这就是我们开发</span> <span class="string">IPv6</span> <span class="string">支持的基础，也是我们最初测试的基础。随后，我们在内核为</span> <span class="number">2.6</span><span class="number">.24</span> <span class="string">的</span> <span class="string">Ubuntu</span> <span class="string">Hardy</span> <span class="string">上测试了</span> <span class="string">Shorewall6。如果您运行的是</span> <span class="number">2.6</span><span class="number">.20</span> <span class="string">或更高版本，您可以尝试通过修改内核版本测试来运行</span> <span class="string">Shorewall6</span> <span class="string">/usr/share/shorewall/prog.footer6，以检查您的内核版本，而不是</span> <span class="number">2.6</span><span class="number">.24</span> <span class="string">(20624)。但之后，您就得靠自己了。</span></span><br><span class="line"></span><br><span class="line"><span class="string">内核</span> <span class="string">=</span> <span class="string">$（printf“％2d％02d％02d</span> <span class="string">\</span> <span class="string">n”$（echo</span> <span class="string">$（uname</span> <span class="string">-r）2&gt;</span> <span class="string">/</span> <span class="string">dev</span> <span class="string">/</span> <span class="literal">null</span> <span class="string">|</span> <span class="string">sed's</span> <span class="string">/</span> <span class="string">-。*</span> <span class="string">/</span> <span class="string">/'|</span> <span class="string">tr'。'''）|</span> <span class="string">head</span> <span class="string">-n1）</span></span><br><span class="line"><span class="string">如果</span> <span class="string">[</span> <span class="string">$kernel</span> <span class="string">-lt</span> <span class="number">20624</span> <span class="string">];</span> <span class="string">那么</span></span><br><span class="line">    <span class="string">error_message“错误：$PRODUCT</span> <span class="string">需要</span> <span class="string">Linux</span> <span class="string">内核2.6.24或更高版本”</span></span><br><span class="line">    <span class="string">状态=2</span></span><br><span class="line"><span class="string">别的</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="string">更新：上述逻辑在/usr/share/shorewall/prog.footer后来的</span> <span class="string">Shorewall</span> <span class="string">版本中被发现。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">40</span><span class="string">）我有一个从</span> <span class="string">radvd</span> <span class="string">获取其</span> <span class="string">IPv6</span> <span class="string">配置的接口。当我启动</span> <span class="string">Shorewall6</span> <span class="string">时，我立即丢失了默认路由。为什么？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：您已在接口上配置了转发，这将禁用接口的自动配置。要在</span> <span class="string">Shorewall6</span> <span class="string">启动时保留接口上的自动配置，请在shorewall6-interfaces</span> <span class="string">(5)中接口条目的</span> <span class="string">OPTIONS</span> <span class="string">列中指定forwarding=0。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">96</span><span class="string">）我开始使用</span> <span class="string">ipv6，但在我的</span> <span class="string">ipv4</span> <span class="string">FW</span> <span class="string">上，重新启动</span> <span class="string">Shorewall</span> <span class="string">时，它会放入</span> <span class="string">ip6tables</span> <span class="string">规则。我该如何禁用它？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：这是一个两步过程。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在shorewall.conf</span> <span class="string">(5)中设置</span> <span class="string">DISABLE_IPV6=No并重新启动</span> <span class="string">Shorewall。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在</span> <span class="string">root</span> <span class="string">shell</span> <span class="string">提示符下执行以下命令：</span></span><br><span class="line"></span><br><span class="line">        <span class="string">ip6tables</span> <span class="string">-P</span> <span class="string">输入接受</span></span><br><span class="line"></span><br><span class="line">        <span class="string">ip6tables</span> <span class="string">-P</span> <span class="string">输出接受</span></span><br><span class="line"></span><br><span class="line">        <span class="string">ip6tables</span> <span class="string">-P</span> <span class="string">转发接受</span></span><br><span class="line"></span><br><span class="line"><span class="string">您可能希望尽快安装Shorewall6，以便拥有</span> <span class="string">IPv6</span> <span class="string">防火墙和</span> <span class="string">IPv4</span> <span class="string">防火墙。</span></span><br><span class="line"><span class="string">无线狗</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">105</span><span class="string">）Shorewall</span> <span class="string">可以与</span> <span class="string">Wifidog</span> <span class="string">配合使用吗？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：是的，但有一些限制：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">必须在</span> <span class="string">Shorewall</span> <span class="string">之后启动</span> <span class="string">Wifidog。如果</span> <span class="string">Shorewall</span> <span class="string">重新启动/重新加载，则必须重新启动</span> <span class="string">wifidog。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">必须在</span> <span class="string">shorewall.conf</span> <span class="string">中设置</span> <span class="string">FORWARD_CLEAR_MARK</span> <span class="literal">No</span><span class="string">。</span></span><br><span class="line"></span><br><span class="line"><span class="string">各种各样的</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">20</span><span class="string">）我刚刚设置了服务器。我是否必须更改</span> <span class="string">Shorewall</span> <span class="string">以允许从</span> <span class="string">Internet</span> <span class="string">访问我的服务器？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：是的。请参阅您在初始设置期间使用的快速入门指南，了解如何为服务器设置规则的信息。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">24</span><span class="string">）我如何才能允许仅从</span> <span class="string">Internet</span> <span class="string">上的特定</span> <span class="string">IP</span> <span class="string">地址连接</span> <span class="string">ssh</span> <span class="string">端口？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在规则的</span> <span class="string">SOURCE</span> <span class="string">列中，</span> <span class="string">“</span> <span class="string">net</span> <span class="string">”后面跟着一个冒号，以及以逗号分隔的主机/子网地址列表。</span></span><br><span class="line"></span><br><span class="line"><span class="string">网络：&lt;ip1&gt;，&lt;ip2&gt;，...</span></span><br><span class="line"></span><br><span class="line"><span class="string">例4.示例：</span></span><br><span class="line"></span><br><span class="line"><span class="string">接受网络：192.0.2.16/28,192.0.2.44</span> <span class="string">fw</span> <span class="string">tcp</span> <span class="number">22</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">26</span><span class="string">）当我尝试在防火墙上或防火墙后使用</span> <span class="string">nmap</span> <span class="string">中的任何</span> <span class="string">SYN</span> <span class="string">选项时，出现“操作不允许”信息。如何将</span> <span class="string">nmap</span> <span class="string">与</span> <span class="string">Shorewall</span> <span class="string">结合使用？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：暂时删除任何rejNotSyn、</span> <span class="string">dropNotSyn、</span> <span class="string">dropInvalid、</span> <span class="string">NotSyn</span> <span class="string">(...</span> <span class="string">)和Invalid</span> <span class="string">(...</span> <span class="string">)规则/etc/shorewall/rules，然后重新启动</span> <span class="string">Shorewall。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">27</span><span class="string">）我正在为防火墙编译新内核。我应该注意什么？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：首先查看Shorewall</span> <span class="string">内核配置页面。您可能还想确保已在</span> <span class="string">Netfilter</span> <span class="string">配置菜单上选择了“本地连接的</span> <span class="string">NAT（阅读帮助）</span> <span class="string">”</span> <span class="string">。否则，以防火墙为源区域的</span> <span class="string">DNAT</span> <span class="string">规则将无法与新内核配合使用。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">28</span><span class="string">）如何使用</span> <span class="string">Shorewall</span> <span class="string">作为桥接防火墙？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：</span> <span class="string">Shorewall</span> <span class="string">Bridging</span> <span class="string">防火墙支持可用</span> <span class="string">—点击此处查看详细信息。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">39</span><span class="string">）如何阻止与特定域名的连接？</span></span><br><span class="line"></span><br><span class="line"><span class="string">我尝试使用此规则来阻止</span> <span class="string">Google</span> <span class="string">的</span> <span class="string">Adsense，您会在每个网站上看到它。Adsense</span> <span class="string">是人们添加到其网页中的</span> <span class="string">Javascript。因此我输入了以下规则：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型</span></span><br><span class="line"><span class="string">拒绝</span> <span class="string">fw</span> <span class="string">net:pagead2.googlesyndication.com</span> <span class="string">全部</span></span><br><span class="line"></span><br><span class="line"><span class="string">但是，这有时也会限制对“google.com”的访问。这是为什么呢？使用</span> <span class="string">dig，我找到了域名</span> <span class="string">googlesyndication.com</span> <span class="string">的以下</span> <span class="string">IP：</span></span><br><span class="line"></span><br><span class="line"><span class="number">216.239</span><span class="number">.37</span><span class="number">.99</span></span><br><span class="line"><span class="number">216.239</span><span class="number">.39</span><span class="number">.99</span></span><br><span class="line"></span><br><span class="line"><span class="string">google.com</span> <span class="string">的情况如下：</span></span><br><span class="line"></span><br><span class="line"><span class="number">216.239</span><span class="number">.37</span><span class="number">.99</span></span><br><span class="line"><span class="number">216.239</span><span class="number">.39</span><span class="number">.99</span></span><br><span class="line"><span class="number">216.239</span><span class="number">.57</span><span class="number">.99</span></span><br><span class="line"></span><br><span class="line"><span class="string">所以我猜你实际上并没有阻止域名，而是阻止了被调用的</span> <span class="string">IP。那么你究竟是如何阻止实际域名的呢？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：像</span> <span class="string">Netfilter</span> <span class="string">这样的数据包过滤器根据每个数据包前面的各种协议报头的内容做出决定。状态数据包过滤器（Netfilter</span> <span class="string">就是一个例子）使用报头内容和数据包过滤器处理早期数据包时创建的状态的组合。Netfilter（以及</span> <span class="string">Shorewall</span> <span class="string">对</span> <span class="string">Netfilter</span> <span class="string">的使用）还考虑每个数据包进入的网络接口和/或数据包离开防火墙/路由器的位置。</span></span><br><span class="line"></span><br><span class="line"><span class="string">当您在</span> <span class="string">Shorewall</span> <span class="string">规则中指定域名时，iptables</span> <span class="string">程序会将该名称解析为一个或多个</span> <span class="string">IP</span> <span class="string">地址，并且实际创建的</span> <span class="string">Netfilter</span> <span class="string">规则将根据这些</span> <span class="string">IP</span> <span class="string">地址来表示。因此，您输入的规则相当于：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作源目标原型</span></span><br><span class="line"><span class="string">拒绝$FW</span> <span class="string">net:216.239.37.99</span> <span class="string">全部</span></span><br><span class="line"><span class="string">拒绝$FW</span> <span class="string">net:216.239.39.99</span> <span class="string">全部</span></span><br><span class="line"></span><br><span class="line"><span class="string">鉴于基于名称的多重托管是一种常见做法（另一个示例：lists.shorewall.net</span> <span class="string">和</span> <span class="string">www1.shorewall.net</span> <span class="string">都托管在具有单个</span> <span class="string">IP</span> <span class="string">地址的同一系统上），仅通过检查协议标头无法过滤到特定名称的连接。虽然某些协议（例如FTP）需要防火墙检查并可能修改数据包负载，但解析单个数据包的负载并不总是有效，因为应用程序级数据流可以以任意方式跨数据包拆分。这是更高版本的</span> <span class="string">Linux</span> <span class="string">内核中提供的“字符串匹配”Netfilter</span> <span class="string">扩展的弱点之一。过滤数据包内容的唯一可靠方法是代理相关连接</span> <span class="bullet">-</span> <span class="string">对于</span> <span class="string">HTTP，这意味着运行类似Squid</span> <span class="string">的程序。代理允许代理进程组装完整的应用程序级消息，然后可以准确解析这些消息并根据结果做出决策。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">42</span><span class="string">）如何知道我的内核和</span> <span class="string">iptables</span> <span class="string">支持哪些功能？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：在</span> <span class="string">root</span> <span class="string">提示符下使用shorewall[-lite]</span> <span class="string">show</span> <span class="string">capabilities命令。</span></span><br><span class="line"></span><br><span class="line"><span class="string">网关：〜#</span> <span class="string">shorewall</span> <span class="string">显示功能</span></span><br><span class="line"><span class="string">Shorewall</span> <span class="string">检测到以下</span> <span class="string">iptables/netfilter</span> <span class="string">功能：</span></span><br><span class="line">   <span class="string">NAT：可用</span></span><br><span class="line">   <span class="string">数据包处理：可用</span></span><br><span class="line">   <span class="string">多端口匹配：可用</span></span><br><span class="line">   <span class="string">扩展多端口匹配：可用</span></span><br><span class="line">   <span class="string">连接追踪匹配：可用</span></span><br><span class="line">   <span class="string">扩展连接跟踪匹配支持：可用</span></span><br><span class="line">   <span class="string">旧连接跟踪匹配语法：不可用</span></span><br><span class="line">   <span class="string">数据包类型匹配：可用</span></span><br><span class="line">   <span class="string">政策匹配：可用</span></span><br><span class="line">   <span class="string">Physdev</span> <span class="string">Match：可用</span></span><br><span class="line">   <span class="string">Physdev-is-bridged</span> <span class="string">支持：可用</span></span><br><span class="line">   <span class="string">数据包长度匹配：可用</span></span><br><span class="line">   <span class="string">IP</span> <span class="string">范围匹配：可用</span></span><br><span class="line">   <span class="string">近期比赛：可用</span></span><br><span class="line">   <span class="string">所有者匹配：可用</span></span><br><span class="line">   <span class="string">Ipset</span> <span class="string">匹配：可用</span></span><br><span class="line">   <span class="string">CONNMARK</span> <span class="string">目标：可用</span></span><br><span class="line">   <span class="string">扩展的</span> <span class="string">CONNMARK</span> <span class="string">目标：可用</span></span><br><span class="line">   <span class="string">Connmark</span> <span class="string">匹配：可用</span></span><br><span class="line">   <span class="string">扩展的</span> <span class="string">Connmark</span> <span class="string">匹配：可用</span></span><br><span class="line">   <span class="string">原始表：可用</span></span><br><span class="line">   <span class="string">IPP2P</span> <span class="string">匹配：可用</span></span><br><span class="line">   <span class="string">旧</span> <span class="string">IPP2P</span> <span class="string">匹配语法：不可用</span></span><br><span class="line">   <span class="string">分类目标：可用</span></span><br><span class="line">   <span class="string">扩展拒绝：可用</span></span><br><span class="line">   <span class="string">重复匹配：可用</span></span><br><span class="line">   <span class="string">MARK</span> <span class="string">目标：可用</span></span><br><span class="line">   <span class="string">扩展</span> <span class="string">MARK</span> <span class="string">目标：可用</span></span><br><span class="line">   <span class="string">Mangle</span> <span class="string">FORWARD</span> <span class="string">链:</span> <span class="string">可用</span></span><br><span class="line">   <span class="string">评论：可用</span></span><br><span class="line">   <span class="string">地址类型匹配：可用</span></span><br><span class="line">   <span class="string">TCPMSS</span> <span class="string">匹配：可用</span></span><br><span class="line">   <span class="string">哈希限制匹配：可用</span></span><br><span class="line">   <span class="string">旧哈希限制匹配：不可用</span></span><br><span class="line">   <span class="string">NFQUEUE</span> <span class="string">目标：可用</span></span><br><span class="line">   <span class="string">领域匹配：可用</span></span><br><span class="line">   <span class="string">帮手匹配：可用</span></span><br><span class="line">   <span class="string">Connlimit</span> <span class="string">匹配：可用</span></span><br><span class="line">   <span class="string">時間匹配：有</span></span><br><span class="line">   <span class="string">转到支持：可用</span></span><br><span class="line">   <span class="string">LOGMARK</span> <span class="string">目标：可用</span></span><br><span class="line">   <span class="string">IPMARK</span> <span class="string">目标：可用</span></span><br><span class="line">   <span class="string">日志目标：可用</span></span><br><span class="line">   <span class="string">持久性</span> <span class="string">SNAT：可用</span></span><br><span class="line"><span class="string">网关:~#</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">19</span><span class="string">）如何打开防火墙以阻止所有往返于</span> <span class="string">LAN</span> <span class="string">的流量？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：添加这两个策略：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#源目标策略日志级别限制 CONNLIMIT</span></span><br><span class="line"><span class="string">$FW</span> <span class="string">loc</span> <span class="string">接受</span></span><br><span class="line"><span class="string">loc</span> <span class="string">$FW</span> <span class="string">接受</span></span><br><span class="line"></span><br><span class="line"><span class="string">您还应该删除</span> <span class="string">$FW-&gt;loc</span> <span class="string">和</span> <span class="string">loc-&gt;$FW</span> <span class="string">中的任何</span> <span class="string">ACCEPT</span> <span class="string">规则，因为这些规则与上述策略是重复的。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">88</span><span class="string">）我可以使用</span> <span class="string">Shorewall</span> <span class="string">运行</span> <span class="string">Snort</span> <span class="string">吗？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：是的。在网络入侵检测系统</span> <span class="string">(NIDS)</span> <span class="string">模式下，Snort</span> <span class="string">基于</span> <span class="string">libpcap（如</span> <span class="string">tcpdump），因此不会干扰</span> <span class="string">Shorewall。我们收到报告称，用户也可以成功将</span> <span class="string">Snort与</span> <span class="string">Shorewall结合使用，但目前尚无</span> <span class="string">HOWTO。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">89</span><span class="string">）如何从我的本地</span> <span class="string">LAN</span> <span class="string">连接到</span> <span class="string">aDSL</span> <span class="string">调制解调器中的</span> <span class="string">Web</span> <span class="string">服务器？</span></span><br><span class="line"></span><br><span class="line"><span class="string">回答：以下是我所做的：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">我的本地网络是</span> <span class="number">172.20</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24，所以我将调制解调器中的</span> <span class="string">IP</span> <span class="string">地址设置为</span> <span class="number">172.20</span><span class="number">.1</span><span class="number">.2</span><span class="string">。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">我的防火墙到</span> <span class="string">LAN</span> <span class="string">的接口的</span> <span class="string">IP</span> <span class="string">地址是</span> <span class="number">172.20</span><span class="number">.1</span><span class="number">.254</span><span class="string">。DSL</span> <span class="string">接口的逻辑名称是</span> <span class="string">EXT_IF，我的</span> <span class="string">LAN</span> <span class="string">接口是</span> <span class="string">INT_IF。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">我添加了以下两个配置条目：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">/etc/shorewall/masq:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#接口源地址</span></span><br><span class="line"></span><br><span class="line">    <span class="string">?评论</span> <span class="string">DSL</span> <span class="string">调制解调器</span></span><br><span class="line"></span><br><span class="line">    <span class="string">EXT_IF:172.20.1.2</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="number">172.20</span><span class="number">.1</span><span class="number">.254</span></span><br><span class="line"></span><br><span class="line">    <span class="string">运行</span> <span class="string">Shorewall</span> <span class="number">5.0</span><span class="number">.14</span> <span class="string">或更高版本时，等效/etc/shorewall/snat于：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#动作源目标原型端口</span></span><br><span class="line">    <span class="string">SNAT(172.20.1.254)</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="string">EXT_IF:192.168.1.2</span> <span class="string">tcp</span> <span class="string">www</span></span><br><span class="line"></span><br><span class="line">    <span class="string">/etc/shorewall/proxyarp：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#地址接口外部 HAVEROUTE 持久性</span></span><br><span class="line">    <span class="number">172.20</span><span class="number">.1</span><span class="number">.2</span> <span class="string">EXT_IF</span> <span class="string">INT_IF</span> <span class="string">否</span> <span class="string">是</span></span><br><span class="line"></span><br><span class="line"><span class="string">如果您无法更改调制解调器的</span> <span class="string">IP</span> <span class="string">地址，并且其当前地址不在您的本地网络中，则需要稍微更改它；假设调制解调器的</span> <span class="string">IP</span> <span class="string">地址是</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.1</span><span class="string">：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">不包括</span> <span class="string">中的条目/etc/shorewall/proxyarp。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">使用配置的网络管理工具将</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.0</span><span class="string">/24</span> <span class="string">中的</span> <span class="string">IP</span> <span class="string">地址添加到外部接口。对于基于</span> <span class="string">Debian</span> <span class="string">的系统，这意味着将其添加到接口的节中/etc/network/interfaces：</span></span><br><span class="line"></span><br><span class="line">        <span class="string">发布</span> <span class="string">/sbin/ip</span> <span class="string">addr</span> <span class="string">add</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.254</span><span class="string">/24</span> <span class="string">devexternal-interface</span></span><br><span class="line"></span><br><span class="line">    <span class="string">您的输入/etc/shorewall/masq将是：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#接口源地址</span></span><br><span class="line"></span><br><span class="line">    <span class="string">评论</span> <span class="string">DSL</span> <span class="string">调制解调器</span></span><br><span class="line"></span><br><span class="line">    <span class="string">EXT_IF:192.168.1.1</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="number">192.168</span><span class="number">.1</span><span class="number">.254</span></span><br><span class="line"></span><br><span class="line">    <span class="string">运行</span> <span class="string">Shorewall</span> <span class="number">5.0</span><span class="number">.14</span> <span class="string">或更高版本时，等效/etc/shorewall/snat于：</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#动作源目标原型端口</span></span><br><span class="line">    <span class="string">SNAT(192.168.1.254)</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span> <span class="string">EXT_IF:192.168.1.1</span> <span class="string">tcp</span> <span class="string">www</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">93</span><span class="string">）我无法使用</span> <span class="string">Shorewall</span> <span class="string">管理网桥。我收到以下错误：错误：Shorewall</span> <span class="number">4.4</span><span class="number">.13</span><span class="number">.3</span> <span class="string">不支持</span> <span class="string">BRIDGING=Yes。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：如果您想要将防火墙规则应用于桥接端口之间传递的流量，请参阅https://shorewall.org/bridge-Shorewall-perl.html。如果您只是想允许端口之间的所有流量，请参阅https://shorewall.org/SimpleBridge.html。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">95</span><span class="string">）我在配置文件和文档中看到的</span> <span class="string">$FW</span> <span class="string">是什么？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：FW是一个shell</span> <span class="string">变量，它扩展为您在shorewall-zones</span> <span class="string">(5)中为防火墙区域指定的名称。防火墙区域的默认名称是fw：</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#区域类型选项</span></span><br><span class="line"></span><br><span class="line"><span class="string">防火墙</span>              <span class="string">​</span></span><br><span class="line"></span><br><span class="line"><span class="string">因此，使用默认或示例配置，编写$FW与编写fw相同。如果您为防火墙区域指定不同的名称（例如gate）</span> <span class="string">，则编写$FW与编写gate相同。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#区域类型选项</span></span><br><span class="line"></span><br><span class="line"><span class="string">门</span>            <span class="string">防火墙</span></span><br><span class="line"></span><br><span class="line"><span class="string">为什么要这么做？</span></span><br><span class="line"></span><br><span class="line"><span class="string">答：防火墙区域具有特殊的语义，因此以独立于配置的方式引用它可以使编写文档、示例、宏等变得更容易。</span></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">98</span><span class="string">）如何取消订阅邮件列表</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：有两种方法：</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在网上</span></span><br><span class="line"></span><br><span class="line">    <span class="string">转到https://lists.sourceforge.net/lists/listinfo/shorewall-users。表单底部有一个名为“</span> <span class="string">Shorewall-users</span> <span class="string">订阅者”的部分。在该部分底部找到：</span></span><br><span class="line"></span><br><span class="line">        <span class="string">“要取消订阅</span> <span class="string">Shorewall-users，获取密码提示符，或者更改你的订阅选项，请输入你的订阅电子邮件地址：”。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">在提供的框中输入您的电子邮件地址，然后单击“取消订阅或编辑选项”按钮。这将带您进入第二个表单。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">第二个表单的顶部是输入密码的框——在那里输入密码，然后单击表单中心的“取消订阅”按钮。您将被取消订阅。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">如果您不记得密码，请点击表格底部的“提醒”按钮，您的密码将通过电子邮件发送给您。</span></span><br><span class="line"></span><br><span class="line">    <span class="string">通过电子邮件使用此链接：mailto:shorewall-users-request@lists.sourceforge.net?subject=unsubscribe。您很快就会收到一封确认电子邮件；请按照该电子邮件中的说明进行操作。</span></span><br><span class="line"></span><br><span class="line"><span class="string">（常见问题</span> <span class="number">102</span><span class="string">）什么是“qt”？我在一些较旧的文档中看到过它。</span></span><br><span class="line"></span><br><span class="line"><span class="string">答案：'qt'</span> <span class="string">代表</span> <span class="string">'quiet'</span><span class="string">；qt()</span> <span class="string">是一个</span> <span class="string">shell</span> <span class="string">函数，它接受带有参数的命令作为参数。它将标准输出和标准错误重定向到</span> <span class="string">/dev/null。它在</span> <span class="string">Shorewall-core</span> <span class="string">shell</span> <span class="string">库</span> <span class="string">lib.common</span> <span class="string">中定义。</span></span><br></pre></td></tr></table></figure>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          
          <li class="next">
            <a href="/2024/OfficeNote/" data-toggle="tooltip" data-placement="top" title="Office Notes">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <div class="tip">
          <p>
            If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
          </p>
        </div>
        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=Shorewall Firewall&body=Hi,I found this website and thought you might like it https://rmshadows.gitee.io/2024/Shorewall-Firewall/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!--修改--artalk-->
<!-- 0.artalk安装代码 -->

<!-- CSS -->
<link href="https://civiccccc.ltd/artalk/dist/Artalk.css" rel="stylesheet" />
<link href="https://civiccccc.ltd/artalk/dist/Artalk.css" rel="stylesheet" />
<!-- JS -->
<script src="https://civiccccc.ltd/artalk/dist/Artalk.js"></script>
<!-- Artalk -->
<div id="Comments"></div>
<script>
  Artalk.init({
    el: '#Comments', // 绑定元素的 Selector
    pageKey: 'https://rmshadows.gitee.io/2024/Shorewall-Firewall/', // 固定链接
    pageTitle: '关于引入 Artalk 的这档子事', // 页面标题 (留空自动获取)
    server: 'https://civiccccc.ltd/artalk', // 后端地址
    site: 'CIVICCCCC的博客', // 你的站点名
  })
</script>
<!-- artalk安装代码已完成 -->



<!-- 1. gitalk comment -->



<!-- 2. gitment comment -->



<!-- 3. disqus comment -->


<!--修改--Livere-->


<!--修改--ISSO-->

        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <!--div id="toc" class="toc-article" -->
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          
            <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#Shorewall防火墙配置"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">Shorewall防火墙配置</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#安装"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">安装</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#包介绍"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">包介绍</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#须知"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">须知</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#基础配置"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">基础配置</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Universal"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">Universal</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#one-interface-TODO"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">one-interface(TODO)</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#two-interfaces-TODO"><span class="toc-nav-number">1.4.3.</span> <span class="toc-nav-text">two-interfaces(TODO)</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#three-interfaces-TODO"><span class="toc-nav-number">1.4.4.</span> <span class="toc-nav-text">three-interfaces(TODO)</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Manpages"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">Manpages</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#第5节-—-文件和概念"><span class="toc-nav-number">1.5.1.</span> <span class="toc-nav-text">第5节 — 文件和概念</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#第8节-—-管理命令"><span class="toc-nav-number">1.5.2.</span> <span class="toc-nav-text">第8节 — 管理命令</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#配置文件"><span class="toc-nav-number">1.6.</span> <span class="toc-nav-text">配置文件</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#etc-shorewall-zones"><span class="toc-nav-number">1.6.1.</span> <span class="toc-nav-text">&#x2F;etc&#x2F;shorewall&#x2F;zones</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#类型（TYPE）"><span class="toc-nav-number">1.6.1.1.</span> <span class="toc-nav-text">类型（TYPE）</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#选项-OPTIONS"><span class="toc-nav-number">1.6.1.2.</span> <span class="toc-nav-text">选项 (OPTIONS)</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#IN-OPTIONS-和-OUT-OPTIONS"><span class="toc-nav-number">1.6.1.3.</span> <span class="toc-nav-text">IN OPTIONS 和 OUT OPTIONS</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Universal示例"><span class="toc-nav-number">1.6.1.4.</span> <span class="toc-nav-text">Universal示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#etc-shorewall-interfaces"><span class="toc-nav-number">1.6.2.</span> <span class="toc-nav-text">&#x2F;etc&#x2F;shorewall&#x2F;interfaces</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#区域-Zone"><span class="toc-nav-number">1.6.2.1.</span> <span class="toc-nav-text">区域 (Zone)</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#接口（INTERFACE）"><span class="toc-nav-number">1.6.2.2.</span> <span class="toc-nav-text">接口（INTERFACE）</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#广播（BROADCAST）"><span class="toc-nav-number">1.6.2.3.</span> <span class="toc-nav-text">广播（BROADCAST）</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#选项（OPTIONS）"><span class="toc-nav-number">1.6.2.4.</span> <span class="toc-nav-text">选项（OPTIONS）</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Universal示例-1"><span class="toc-nav-number">1.6.2.5.</span> <span class="toc-nav-text">Universal示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#etc-shorewall-policy"><span class="toc-nav-number">1.6.3.</span> <span class="toc-nav-text">&#x2F;etc&#x2F;shorewall&#x2F;policy</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#SOURCE-zone-…-FW-all-ezone-…"><span class="toc-nav-number">1.6.3.1.</span> <span class="toc-nav-text">SOURCE - zone[,…[+]]|$FW|all[+][!ezone[,…]]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#DEST-zone-…-FW-all-ezone-…"><span class="toc-nav-number">1.6.3.2.</span> <span class="toc-nav-text">DEST - zone[,…[+]]|$FW|all[+][!ezone[,…]]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#政策-POLICY-ACCEPT-DROP-REJECT-BLACKLIST-CONTINUE-QUEUE-NFQUEUE-queuenumber1-queuenumber2-c-bypass-bypass-NONE-policy-action-level-None"><span class="toc-nav-number">1.6.3.3.</span> <span class="toc-nav-text">政策 (POLICY) - {ACCEPT|DROP|REJECT|BLACKLIST|CONTINUE|QUEUE|NFQUEUE[([queuenumber1[:queuenumber2[c]][,bypass]]|bypass)]|NONE}[:{[+]policy-action[:level][,...]|None}]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#日志级别-LOGLEVEL-log-level-ULOG-NFLOG"><span class="toc-nav-number">1.6.3.4.</span> <span class="toc-nav-text">日志级别 (LOGLEVEL) - [log-level|ULOG|NFLOG]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#速率-RATE-limit"><span class="toc-nav-number">1.6.3.5.</span> <span class="toc-nav-text">速率 (RATE) - [-|limit]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#连接限制-CONNLIMIT-limit-mask"><span class="toc-nav-number">1.6.3.6.</span> <span class="toc-nav-text">连接限制 (CONNLIMIT) - limit[:mask]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Universal示例-2"><span class="toc-nav-number">1.6.3.7.</span> <span class="toc-nav-text">Universal示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#etc-shorewall-rules"><span class="toc-nav-number">1.6.4.</span> <span class="toc-nav-text">&#x2F;etc&#x2F;shorewall&#x2F;rules</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#SECTION"><span class="toc-nav-number">1.6.4.1.</span> <span class="toc-nav-text">?SECTION</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#ACTION-target-log-level-none-tag"><span class="toc-nav-number">1.6.4.2.</span> <span class="toc-nav-text">ACTION - target[:{log-level|none}[!][:tag]]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#SOURCE-source-spec-…"><span class="toc-nav-number">1.6.4.3.</span> <span class="toc-nav-text">SOURCE - source-spec[,…]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#DEST-dest-spec-…"><span class="toc-nav-number">1.6.4.4.</span> <span class="toc-nav-text">DEST - dest-spec[,…]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#PROTO-tcp-syn-ipp2p-ipp2p-udp-ipp2p-all-protocol-number-protocol-name-all"><span class="toc-nav-number">1.6.4.5.</span> <span class="toc-nav-text">PROTO- {-|tcp:[!]syn|ipp2p|ipp2p:udp|ipp2p:all|protocol-number|protocol-name|all}</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#DPORT-port-name-number-or-range-port-name-number-or-range-…-ipset"><span class="toc-nav-number">1.6.4.6.</span> <span class="toc-nav-text">DPORT - {-|port-name-number-or-range[,port-name-number-or-range]…|+ipset}</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#SPORT-port-name-number-or-range-port-name-number-or-range-…-ipset"><span class="toc-nav-number">1.6.4.7.</span> <span class="toc-nav-text">SPORT - {-|port-name-number-or-range[,port-name-number-or-range]…|+ipset}</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#ORIGDEST-address-address-…-exclusion-exclusion"><span class="toc-nav-number">1.6.4.8.</span> <span class="toc-nav-text">ORIGDEST - [-|address[,address]…[exclusion]|exclusion]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#RATE-limit"><span class="toc-nav-number">1.6.4.9.</span> <span class="toc-nav-text">RATE - limit</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#USER-user-name-or-number-group-name-or-number-…"><span class="toc-nav-number">1.6.4.10.</span> <span class="toc-nav-text">USER - [!][user-name-or-number][:group-name-or-number][,…]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#MARK-value-mask-C"><span class="toc-nav-number">1.6.4.11.</span> <span class="toc-nav-text">MARK - [!]value[&#x2F;mask][:C]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#CONNLIMIT-d-limit-mask"><span class="toc-nav-number">1.6.4.12.</span> <span class="toc-nav-text">CONNLIMIT - [d:][!]limit[:mask]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#TIME-timeelement-amp-timeelement…"><span class="toc-nav-number">1.6.4.13.</span> <span class="toc-nav-text">TIME - timeelement[&amp;timeelement…]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#HEADERS-any-exactly-header-list-Optional-Added-in-Shorewall-4-4-15"><span class="toc-nav-number">1.6.4.14.</span> <span class="toc-nav-text">HEADERS - [!][any:|exactly:]header-list (Optional - Added in Shorewall 4.4.15)</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#SWITCH-switch-name-0-1"><span class="toc-nav-number">1.6.4.15.</span> <span class="toc-nav-text">SWITCH - [!]switch-name[&#x3D;{0|1}]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#HELPER-helper"><span class="toc-nav-number">1.6.4.16.</span> <span class="toc-nav-text">HELPER - [helper]</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#示例"><span class="toc-nav-number">1.6.4.17.</span> <span class="toc-nav-text">示例</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Universal示例-3"><span class="toc-nav-number">1.6.4.18.</span> <span class="toc-nav-text">Universal示例</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#etc-shorewall-routes"><span class="toc-nav-number">1.6.5.</span> <span class="toc-nav-text">&#x2F;etc&#x2F;shorewall&#x2F;routes</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#etc-shorewall-hosts"><span class="toc-nav-number">1.6.6.</span> <span class="toc-nav-text">&#x2F;etc&#x2F;shorewall&#x2F;hosts</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#Debian：已知问题"><span class="toc-nav-number">1.7.</span> <span class="toc-nav-text">Debian：已知问题</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#FAQs"><span class="toc-nav-number">1.8.</span> <span class="toc-nav-text">FAQs</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Installing-Shorewall——安装-Shorewall"><span class="toc-nav-number">1.8.1.</span> <span class="toc-nav-text">Installing Shorewall——安装 Shorewall</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Upgrading-Shorewall——升级-Shorewall"><span class="toc-nav-number">1.8.2.</span> <span class="toc-nav-text">Upgrading Shorewall——升级 Shorewall</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Port-Forwarding-Port-Redirection-——端口转发（端口重定向）"><span class="toc-nav-number">1.8.3.</span> <span class="toc-nav-text">Port Forwarding (Port Redirection)——端口转发（端口重定向）</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#谷歌机械翻译FAQs"><span class="toc-nav-number">1.9.</span> <span class="toc-nav-text">谷歌机械翻译FAQs</span></a></li></ol></li></ol>
          
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Firewall" title="Firewall">Firewall</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://civiccccc.ltd" target="_blank">主站</a>
          </li>
          
          <li>
            <a href="https://github.com/xjx0106" target="_blank">国庆电播小弟</a>
          </li>
          
          <li>
            <a href="https://github.com/itcast-ying" target="_blank">itcast-ying</a>
          </li>
          
          <li>
            <a href="https://github.com/cjj19970505" target="_blank">Xeon-J</a>
          </li>
          
          <li>
            <a href="https://github.com/XeonKHJ" target="_blank">Xeon-H</a>
          </li>
          
          <li>
            <a href="https://gitee.com/rmshadows" target="_blank">Gitee - Ryan Yim</a>
          </li>
          
          <li>
            <a href="https://rmshadows.gitee.io/404" target="_blank">404 No Found Page</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



    <!-- Footer (contains ThemeColor、viewer) -->
    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          
            <li>
              <a href="/feed.xml">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://github.com/rmshadows">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          
            <li>
              <a target="_blank" href="https://www.instagram.com/just_aaaa_r">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          
            <li>
              <a target="_blank" href="https://www.zhihu.com/people/rmshadows">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse">知</i>
                </span>
              </a>
            </li>
          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Ryan Yim
          2025
          <br>
          Theme by
          <a href="http://beantech.org" target="_blank" rel="noopener">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a href="https://v-vincen.life/" target="_blank" rel="noopener">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>

<!-- jQuery -->
<script type="text/javascript" src="/js/jquery.min.js"></script>
<!-- <script type="text/javascript" src="/js/jquery.js"></script> -->
<!-- <script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->

<!-- Bootstrap Core JavaScript -->
<script type="text/javascript" src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--2022-03-28 添加了随机丝带特效-->

  <script type="text/javascript" src="/js/ribbonDynamic.js"></script>

<script type="text/javascript" src="/js/hux-blog.min.js"></script>

<!-- catalog -->
<script type="text/javascript" async="true" src="/js/catalog.js?v=1.0.0"></script>

<!-- totop(rocket) -->
<script type="text/javascript" async="true" src="/js/totop.js?v=1.0.0"></script>

<!-- Busuanzi JavaScript -->

  <!-- <script type="text/javascript" async="true" src="/js/busuanzi.pure.mini.js"></script> -->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



  <!-- Scroll start -->
  <script type="text/javascript" src="/js/scroll.js"></script>
  <!-- Scroll end -->



  <!-- ThemeColor start -->
  <script type="text/javascript" src="/js/themecolor.js"></script>
  <!-- ThemeColor end -->





  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  <script type="text/javascript" src="/js/viewer/viewer.min.js"></script>
  <script type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){ hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if($('#tag_cloud').length !== 0){ async("https://rmshadows.gitee.io/js/jquery.tagcloud.js",function(){ $.fn.tagcloud.defaults = { //size: {start: 1, end: 1, unit: 'em'}, color: {start:
'#bbbbee', end: '#0085a1'}, }; $('#tag_cloud a').tagcloud(); }) } </script> -->

    
    <!---自定义的代码 所有页面-->
    
        <script type="text/javascript" src="/js/on_mouse_clicked/emotions.js"></script>
    

    <!-- Search -->
    
    <div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/ziploader.js"></script>
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;

            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


    

    <!-- Image to hack wechat -->
    <!-- <img src="https://rmshadows.gitee.io/img/icon_wechat.png" width="0" height="0" /> -->
    <!-- Migrate from head to bottom, no longer block render and still work -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
