<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  

  <!-- Baidu Tongji -->
  

  <!-- Baidu Push -->
  

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc" />
  <meta name="baidu-site-verification" content="PpzM9WxOJU" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="This is CIVICCCCC&#39;s blog..." />
  <meta name="keyword" content="rmshadows,civiccccc,blog,Blog" />
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg" />

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>
  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/beantech.min.css" />

  <!-- Pygments Highlight CSS -->
  
<link rel="stylesheet" href="../../css/highlight.css">
<link rel="stylesheet" href="../../css/widget.css">
<link rel="stylesheet" href="../../css/rocket.css">
<link rel="stylesheet" href="../../css/signature.css">
<link rel="stylesheet" href="../../css/catalog.css">
<link rel="stylesheet" href="../../css/livemylife.css">


  
  <!-- wave start -->
  <link rel="stylesheet" href="/css/wave.css" />
  <!-- wave end -->
  

  
  <!-- top start (article top hot config) -->
  <link rel="stylesheet" href="/css/top.css" />
  <!-- top end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/scroll.css" />
  <!-- ThemeColor end -->
  

  
  <!-- viewer start (Picture preview) -->
  <link rel="stylesheet" href="/css/viewer.min.css" />
  <!-- viewer end -->
  

  
  <!-- Search start -->
  <link rel="stylesheet" href="/css/search.css" />
  <!-- Search end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/themecolor.css" />
  <!-- ThemeColor end -->
  

  

  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
    href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://rmshadows.gitee.io/2020/Debian-Server/">
  <title>
    
    Debian Server - RYAN | be yourself
    
  </title>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="atom.xml" title="Hello ~(○｀ 3′○)~ I'm Ryan Yim" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->

<body ontouchstart="" class="body--home">
    <!-- ThemeColor -->
    
    <!-- ThemeColor -->
<!-- <div class="toggle" onclick="document.body.classList.toggle('body--dark')">Switch Color</div> -->

<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons bright-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>

    

    <!-- Navigation (contains search)-->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Hello ~(○｀ 3′○)~ I&#39;m Ryan Yim</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">Home</a>
          </li>

          

          
          

          
          <li>
            <a href="/about/">About</a>
          </li>
          
          

          
          <li>
            <a href="/archive/">Archives</a>
          </li>
          
          

          
          <li>
            <a href="/tags/">Tags</a>
          </li>
          
          

          
          <li>
            <a href="/categories/">Categories</a>
          </li>
          
          

          
          <li><a class="popup-trigger" title="Search"><span class="search-icon"></span>Search</a></li>
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>


<script>
  // Drop Bootstarp low-performance Navbar
  // Use customize navbar with high-quality material design animation
  // in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


    <!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
    <!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    header.intro-header {
       /*post*/
        background-image: url('https://rmshadows.gitee.io//img/header_img/lml_bg.jpg');
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/rmshadows.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#Debian" title="Debian">Debian</a>
              
              <a class="tag" href="/tags/#Server" title="Server">Server</a>
              
            </div>
            <h1>Debian Server</h1>
            <h2 class="subheading">关于我如何搭建自己的服务器，实现自己想要的功能的一篇帖子。</h2>
            <span class="meta">
              Posted by Ryan Yim on
              2020-12-03
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">121</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">24.9k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



    <!-- Main Content (Post contains
    Pager、
    tip、
    socialshare、
    gitalk、gitment、disqus-comment、
    Catalog、
    Sidebar、
    Featured-Tags、
    Friends Blog、
    anchorjs、
    ) -->
    <!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h2 id="服务器"><a href="#服务器" class="headerlink" title="服务器"></a>服务器</h2><p>我的服务器是跟<a href="https://www.vultr.com/" target="_blank" rel="noopener">Vultr</a> 买的，服务器座标海外。为什么不买国内的呢？因为Github下载东西很慢，所以买了服务器，其中一个功能当然是帮我下载Github的大文件啦。另外还有一个原因是，便宜。</p>
<p>服务器怎么买呢？对我来说，便宜+老牌就行了。国外的主机可以快乐访问国内速度慢的资源，这很舒服，比如我都不用修改Debian官方源镜像，还有Github克隆仓库也快多了。但国外主机也有个问题：网络不稳定，高峰期SSH都能给我掉线……延时有点高。</p>
<h2 id="我的服务器快速部署脚本「仅限Debian」"><a href="#我的服务器快速部署脚本「仅限Debian」" class="headerlink" title="我的服务器快速部署脚本「仅限Debian」"></a>我的服务器快速部署脚本「仅限Debian」</h2><p>仓库：<a href="https://github.com/rmshadows/rm_scripts" target="_blank" rel="noopener">https://github.com/rmshadows/rm_scripts</a></p>
<p>脚本部署完成事项(截至2022-04)：</p>
<ul>
<li>检查点一：<ul>
<li>更改镜像（针对国内服务器）；</li>
<li>默认源安装apt-transport-https ca-certificates wget gnupg2 gnupg lsb-release(必选)；</li>
<li>配置unattended-upgrades</li>
</ul>
</li>
<li>检查点二：<ul>
<li>安装sudo openssh-server zsh(必选)；</li>
<li>设置所有用户使用zsh；</li>
<li>新建用户(包括配置sudo、是否使用zshrc、sudo免密码)</li>
</ul>
</li>
<li>检查点三：<ul>
<li>安装vim-full，卸载vim-tiny；</li>
<li>添加/usr/sbin到环境变量；<ul>
<li>添加添加HOME目录文件夹（Data for data;Applications for apps;Temp for file transport;Workplace for work;Services for service）(必选)；</li>
</ul>
</li>
<li>安装bash-completion；</li>
<li>安装zsh-autosuggestions</li>
</ul>
</li>
<li>检查点四：<ul>
<li>自定义自己的服务（运行一个shell脚本）；</li>
<li>设置主机名</li>
<li>配置语言</li>
<li>配置时区</li>
<li>配置tty1自动登录</li>
</ul>
</li>
<li>检查点五：<ul>
<li>从apt仓库拉取常用软件</li>
<li>安装Python3</li>
<li>安装Git</li>
<li>安装OpenSSH</li>
<li>安装nodejs</li>
<li>安装npm</li>
</ul>
</li>
<li>检查点六：<ul>
<li>安装、配置HTTP服务</li>
</ul>
</li>
<li>检查点七：<ul>
<li>安装docker-ce</li>
</ul>
</li>
<li>检查点八：<ul>
<li>安装ufw防火墙(默认开放22、80 、443)</li>
</ul>
</li>
</ul>
<h2 id="服务器域名、SSL证书购买"><a href="#服务器域名、SSL证书购买" class="headerlink" title="服务器域名、SSL证书购买"></a>服务器域名、SSL证书购买</h2><p>域名呢，当然有免费的，比如<a href="https://www.freenom.com" target="_blank" rel="noopener">Freenom</a>。我个人呢是跟<a href="https://www.aliyun.com/" target="_blank" rel="noopener">阿里巴巴</a>买的，我买的最便宜的，花了我一块钱，续费价格是13元/年。只要你选的域名越冷门，价格就越低，记得关注续费价格。</p>
<p>SSL证书有很多，<a href="https://www.comodo.com/" target="_blank" rel="noopener">COMODO</a>、<a href="https://letsencrypt.org/" target="_blank" rel="noopener">Let‘s Encrypt</a>，有免费的也有付费的。我买的当然是免费的，不过我是通过阿里中介买的，一年有效期。</p>
<h2 id="服务器应用"><a href="#服务器应用" class="headerlink" title="服务器应用"></a>服务器应用</h2><h3 id="Apache2"><a href="#Apache2" class="headerlink" title="Apache2"></a>Apache2</h3><blockquote>
<p>Debian的Apache2配置和其他发行版有所不同。这个在Apache2文档中有说明，这里我随意翻译了下：</p>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br></pre></td><td class="code"><pre><span class="line">Contents - 目录</span><br><span class="line">========</span><br><span class="line">	Apache2 Configuration under Debian GNU/Linux - Apache2在Debian下的配置</span><br><span class="line">		Files and Directories in '/etc/apache2' - 在/etc/apache2目录中的配置文件</span><br><span class="line">		Tools - 工具</span><br><span class="line">	Using mod_cache_disk - 使用mod_cache_disk</span><br><span class="line">	SSL - SSL</span><br><span class="line">		Enabling SSL - 开启SSL</span><br><span class="line">		Creating self-signed certificates - 生成自签名的证书</span><br><span class="line">		SSL workaround for MSIE - SSL &amp; MSIE</span><br><span class="line">	Suexec - 关于suEXEC</span><br><span class="line">	Documentation - 文档</span><br><span class="line">	Upgrades - 升级</span><br><span class="line">	Common Problems - 常见问题</span><br><span class="line">	For Developers - 开发者指南</span><br><span class="line"></span><br><span class="line">Apache2 Configuration under Debian GNU/Linux - Apache2在Debian下的配置</span><br><span class="line">============================================</span><br><span class="line"></span><br><span class="line">Debian's default Apache2 installation attempts to make adding and</span><br><span class="line">removing modules, virtual hosts, and extra configuration directives as</span><br><span class="line">flexible as possible, in order to make automating the changes and</span><br><span class="line">administering the server as easy as possible.</span><br><span class="line"></span><br><span class="line">Debian中的Apache2默认部署方式将尽可能地让添减模块、虚拟主机和配置指令更加灵活，让管理员能够以更简洁明了、自动化的方式来管理服务器。</span><br><span class="line"></span><br><span class="line">Please be aware that this layout is quite different from the standard</span><br><span class="line">Apache configuration. Due to the use of environment variables, apache2</span><br><span class="line">needs to be started/stopped with '/etc/init.d/apache2', apachectl, or</span><br><span class="line">apache2ctl. Calling '/usr/bin/apache2' directly will not work with the</span><br><span class="line">default configuration. To call apache2 with specific command line</span><br><span class="line">arguments, just call apache2ctl with the same arguments.</span><br><span class="line"></span><br><span class="line">请注意，Debian上的Apache2配置文件布局与标准配置完全不同。由于使用了环境变量，apache2需要使用“/etc/init.d/apache2”、apachectl或apache2ctl启动/停止。直接调用'/usr/bin/apache2'将无法使用默认配置。如果要调用apache2，只需使用调用apache2ctl时所用的参数。</span><br><span class="line"></span><br><span class="line">Files and Directories in '/etc/apache2':</span><br><span class="line">在/etc/apache2中的文件：</span><br><span class="line">---------------------------------------</span><br><span class="line"></span><br><span class="line">apache2.conf</span><br><span class="line"></span><br><span class="line">	This is the main configuration file. It does not include any</span><br><span class="line">	actual configuration we expect to be adapted on your site, so</span><br><span class="line">	where possible please do not touch it. This file is the</span><br><span class="line">	foundation stone of the Apache configuration in Debian and should</span><br><span class="line">	be up to date after upgrades to make sure all configuration pieces</span><br><span class="line">	are properly included.</span><br><span class="line"></span><br><span class="line">	这是主配置文件。它不包括任何我们希望在您的站点上调整实际配置，所以如果可能，请不要碰它。这个文件是</span><br><span class="line">Debian中Apache配置的基石。更新软件后请手动检查这个文件，以确保所有配置件包括在内。</span><br><span class="line"></span><br><span class="line">	If you want to extend the global configuration, you can customize</span><br><span class="line">	the Apache web server by including configuration files through the</span><br><span class="line">	conf-available mechanism. To change listening ports and socket</span><br><span class="line">	configuration use ports.conf (see below).</span><br><span class="line"></span><br><span class="line">	如果要扩展全局配置，可以自定义通过配置可用机制。更改侦听端口和套接字配置使用ports.conf（见下文）。</span><br><span class="line"></span><br><span class="line">ports.conf</span><br><span class="line"></span><br><span class="line">	Configuration directives for which ports and IP addresses to</span><br><span class="line">	listen to.</span><br><span class="line"></span><br><span class="line">	端口和IP地址的监听配置指令。</span><br><span class="line"></span><br><span class="line">magic</span><br><span class="line"></span><br><span class="line">	Patterns for mod_mime_magic. This is not compatible with the format</span><br><span class="line">	used by current versions of the file/libmagic packages.</span><br><span class="line"></span><br><span class="line">	mod_mime_magic的样式。这与当前版本的file/libmagic包使用的格式不兼容。</span><br><span class="line"></span><br><span class="line">envvars</span><br><span class="line"></span><br><span class="line">	This contains environment variables that may be used in the</span><br><span class="line">	configuration. Some settings, like user and pid file, need to</span><br><span class="line">	go in here so that other scripts can use them. It can also</span><br><span class="line">	be used to change some default settings used by apache2ctl,</span><br><span class="line">	including the ulimit value for the maximum number of open files.</span><br><span class="line">	The default LANG=C setting is also here, and can be changed to a</span><br><span class="line">	different language.</span><br><span class="line"></span><br><span class="line">	这里包含可以在中使用的环境变量配置。一些设置，如用户和pid文件，需要进入这里以便其他脚本可以使用它们。它也可以用于更改apache2ctl使用的某些默认设置，包括最大打开文件数的ulimit值。默认的LANG=C设置也在这里，可以更改为不同的语言。</span><br><span class="line"></span><br><span class="line">conf-available/</span><br><span class="line"></span><br><span class="line">	Files in this directory are included in the global server scope by</span><br><span class="line">	this line in apache2.conf:</span><br><span class="line"></span><br><span class="line">	此目录中的文件包含在全局服务器作用域中，被定义在apache2.conf配置文件中的这一行：</span><br><span class="line"></span><br><span class="line">	# Include generic snippets of statements</span><br><span class="line">        IncludeOptional conf-enabled/*.conf</span><br><span class="line"></span><br><span class="line">	This is a good place to add additional configuration</span><br><span class="line">	directives. All configuration snippets need a '.conf' suffix to be</span><br><span class="line">	included as actual configuration. The local administrator should</span><br><span class="line">	use file names starting with 'local-' to avoid name clashes with</span><br><span class="line">	files installed by packages.</span><br><span class="line"></span><br><span class="line">	这是添加附加配置的好地方指令。所有配置片段都需要“.conf”后缀包括在实际配置中。本地管理员应该</span><br><span class="line">使用以“local-”开头的文件名以避免与由程序包安装的文件。</span><br><span class="line"></span><br><span class="line">	Configuration snippets can be enabled and disabled by using the</span><br><span class="line">	a2enconf and a2disconf executables. This works similarly to the</span><br><span class="line">	approach used for modules and sites below.</span><br><span class="line"></span><br><span class="line">	可以使用a2enconf和a2discof可执行文件。这与用于以下模块和站点的方法。</span><br><span class="line"></span><br><span class="line">	Configuration snippets can of course also be included in individual</span><br><span class="line">	virtual hosts.</span><br><span class="line"></span><br><span class="line">	配置片段当然也可以包含在虚拟主机。</span><br><span class="line"></span><br><span class="line">conf-enabled/</span><br><span class="line"></span><br><span class="line">	Like mods-enabled/ and sites-enabled/, a piece of configuration is</span><br><span class="line">	enabled by symlinking a file from conf-available/ into this</span><br><span class="line">	directory. The a2enconf helper is provided to assist this task.</span><br><span class="line"></span><br><span class="line">	与mods enabled/和sites enabled/一样，一个配置是通过将文件从conf available/符号链接到</span><br><span class="line">目录。提供a2enconf帮助程序来协助此任务。</span><br><span class="line"></span><br><span class="line">mods-available/</span><br><span class="line"></span><br><span class="line">	This directory contains a series of .load and .conf files.</span><br><span class="line">	The .load files contain the Apache configuration directive</span><br><span class="line">	necessary to load the module in question.  The corresponding</span><br><span class="line">	.conf files contain configuration directives necessary to</span><br><span class="line">	utilize the module in question.</span><br><span class="line"></span><br><span class="line">	这个目录包含一系列.load和.conf文件。.load文件包含Apache配置指令需要加载有问题的模块。相应的.conf文件包含使用相关模块所需的配置指令。</span><br><span class="line"></span><br><span class="line">mods-enabled/</span><br><span class="line"></span><br><span class="line">	To actually enable a module for Apache2, it is necessary to</span><br><span class="line">	create a symlink in this directory to the .load (and .conf, if</span><br><span class="line">	it exists) files associated with the module in</span><br><span class="line">	mods-available/.  For example:</span><br><span class="line"></span><br><span class="line">	要真正启用Apache2的模块，必须在这个目录中创建一个指向.load（和.conf，如果它存在）与中的模块关联的文件可用mods/。例如：</span><br><span class="line"></span><br><span class="line">	cgi.load -&gt; /etc/apache2/mods-available/cgi.load</span><br><span class="line"></span><br><span class="line">	The a2enmod helper can be used to enable a module.</span><br><span class="line"></span><br><span class="line">	a2enmod可用于启用模块。</span><br><span class="line"></span><br><span class="line">sites-available/</span><br><span class="line"></span><br><span class="line">	Like mods-available/, except that it contains configuration</span><br><span class="line">	directives for different virtual hosts that might be used with</span><br><span class="line">	apache2.  Note that the hostname doesn't have to correspond</span><br><span class="line">	exactly with the filename.  '000-default.conf' is the default</span><br><span class="line">	host which is provided by Debian.</span><br><span class="line"></span><br><span class="line">	就像mods available/，它只包含可能一起使用的不同虚拟主机的指令Apache2配置。请注意，主机名不必对应和文件名一模一样。000-default.conf是由Debian提供的默认主机。</span><br><span class="line"></span><br><span class="line">sites-enabled/</span><br><span class="line"></span><br><span class="line">	Similar in functionality to mods-enabled/, sites-enabled</span><br><span class="line">	contains symlinks to sites in sites-available/ that the</span><br><span class="line">	administrator wishes to enable.</span><br><span class="line"></span><br><span class="line">	功能类似于mods enabled/，sites enabled包含指向管理员希望启用的可用站点中站点的符号链接。</span><br><span class="line"></span><br><span class="line">	Apache uses the first VirtualHost that matches the IP/Port</span><br><span class="line">	as default for named virtual hosts. Therefore the 'default'</span><br><span class="line">	site should be called '000-default' to make sure it sorts before</span><br><span class="line">	other sites.</span><br><span class="line"></span><br><span class="line">	Apache使用第一个与IP/端口匹配的虚拟主机作为命名虚拟主机的默认值。因此“default”站点应该被称为'000-default'，以确保它排在在其他网站之前。</span><br><span class="line"></span><br><span class="line">	Example:</span><br><span class="line">	dedasys.conf -&gt; /etc/apache2/sites-available/dedasys.conf</span><br><span class="line"></span><br><span class="line">	The a2ensite helper can be used to enable a site.</span><br><span class="line"></span><br><span class="line">	a2ensite可用于启用站点。</span><br><span class="line"></span><br><span class="line">The Include directives ignore files with names that do not end with a</span><br><span class="line">.conf suffix. This behavior has changed from previous releases!</span><br><span class="line"></span><br><span class="line">Include指令将忽略不以.conf后缀的文件。此行为与以前的版本不同！</span><br><span class="line"></span><br><span class="line">In some cases you may want to enable a specific piece of configuration</span><br><span class="line">(think of files shipped in conf-available/) for a particular virtual</span><br><span class="line">host only and not globally as is our default. In such cases you can</span><br><span class="line">disable the configuration at a global scope for example by doing</span><br><span class="line"></span><br><span class="line">	在某些情况下，您可能希望启用特定的配置（想想conf available/中提供的文件）对于特定仅主机的虚拟机</span><br><span class="line">，而不是我们默认的全局主机。在这种情况下，你可以在全局范围禁用配置，例如通过</span><br><span class="line"></span><br><span class="line">	a2disconf some-configuration</span><br><span class="line"></span><br><span class="line">Then it can be included in a particular virtual host within a file in</span><br><span class="line">sites-enabled/. You may want to add</span><br><span class="line"></span><br><span class="line">	然后它可以包含在文件中的特定虚拟主机中站点已启用/。您可能需要添加</span><br><span class="line"></span><br><span class="line">	Include conf-available/some-configuration.conf</span><br><span class="line"></span><br><span class="line">in that site configuration. However, be careful, as this may not work for</span><br><span class="line">some configurations, depending on the context and implications of some</span><br><span class="line">directives.</span><br><span class="line"></span><br><span class="line">到那个站点配置中。但是，请小心，因为这可能不适用于一些配置，取决于某些配置的上下文和含义</span><br><span class="line">指令。</span><br><span class="line"></span><br><span class="line">Tools - 工具</span><br><span class="line">-----</span><br><span class="line"></span><br><span class="line">a2enmod and a2dismod are available for enabling and disabling modules utilizing</span><br><span class="line">the above configuration system.</span><br><span class="line"></span><br><span class="line">a2enmod和a2dismod可用于启用和禁用模块配置系统。</span><br><span class="line"></span><br><span class="line">a2ensite and a2dissite do essentially the same thing as the above tools, but</span><br><span class="line">for sites rather than modules. Finally a2enconf and a2disconf are the</span><br><span class="line">corresponding tools for configuration snippets.</span><br><span class="line"></span><br><span class="line">a2ensite和a2disite所做的基本上与上个工具相同，但是对于站点而不是模块。最后，a2enconf和a2discof是</span><br><span class="line">配置片段的相应工具。</span><br><span class="line"></span><br><span class="line">a2query is a helper script providing runtime information about the running</span><br><span class="line">server instance. For example it can be used to query enabled modules, the</span><br><span class="line">selected MPM, and other information. This tool is primarily meant for package</span><br><span class="line">maintainers who need to interact with the Apache packages to activate</span><br><span class="line">their configurations upon package installation, but it can be used by users</span><br><span class="line">as well.</span><br><span class="line"></span><br><span class="line">a2query是一个助手脚本，提供有关服务器实例。例如，它可以用于查询启用的模块选择MPM和其他信息。此工具主要用于打包需要与Apache包交互才能激活的维护人员它们的配置在包安装时，但用户也可以使用它。</span><br><span class="line"></span><br><span class="line">apxs2 -a/-A is modified to use a2enmod to activate newly installed modules.</span><br><span class="line"></span><br><span class="line">apxs2-a/-A 被修改为使用a2enmod来激活新安装的模块。</span><br><span class="line"></span><br><span class="line">Using mod_cache_disk - 磁盘缓存</span><br><span class="line">====================</span><br><span class="line"></span><br><span class="line">To ensure that the disk cache does not grow indefinitely, htcacheclean is</span><br><span class="line">started when mod_cache_disk is enabled. Both daemon and cron (daily) mode</span><br><span class="line">are supported. The configuration (run mode, cache size, etc.) is in</span><br><span class="line">'/etc/default/apache2'.</span><br><span class="line"></span><br><span class="line">为了确保磁盘缓存不会无限期增长，htcacheclean将在启用mod_cache_disk时同时启动。守护程序和cron（每日）模式支持。在“/etc/default/apache2”可以配置（运行模式、缓存大小等）。</span><br><span class="line"></span><br><span class="line">Normally, htcacheclean is automatically started and stopped by</span><br><span class="line">'/etc/init.d/apache2'. However, if you change the state of mod_cache_disk or</span><br><span class="line">the configuration of htcacheclean while apache2 is running, you may need to</span><br><span class="line">manually start/stop htcacheclean with "/etc/init.d/apache2 start-htcacheclean"</span><br><span class="line">or "/etc/init.d/apache2 stop-htcacheclean".</span><br><span class="line"></span><br><span class="line">通常，htcacheclean和'/etc/init.d/apache2'一起自动启动和停止。但是，如果您更改mod_cache_磁盘的状态或在apache2运行时htcacheclean的配置，您可能需要使用“/etc/init.d/apache2 start htcacheclean”或“/etc/init.d/apache2 stop htcacheclean”手动启动/停止htcacheclean。</span><br><span class="line"></span><br><span class="line">Note that mod_cache_disk was named mod_disk_cache in versions 2.2 and earlier.</span><br><span class="line"></span><br><span class="line">请注意，在2.2及更早版本中，mod_cache_disk被命名为mod_disk_cache。</span><br><span class="line"></span><br><span class="line">SSL - SSL</span><br><span class="line">===</span><br><span class="line"></span><br><span class="line">Enabling SSL - 启用SSL</span><br><span class="line">------------</span><br><span class="line"></span><br><span class="line">To enable SSL, type (as user root):</span><br><span class="line"></span><br><span class="line">	a2ensite default-ssl</span><br><span class="line">	a2enmod ssl</span><br><span class="line"></span><br><span class="line">使用a2ensite default-ssl 和 a2enmod ssl启用ssl，两个都要运行。</span><br><span class="line"></span><br><span class="line">If you want to use self-signed certificates, you should install the ssl-cert</span><br><span class="line">package (see below). Otherwise, just adjust the SSLCertificateKeyFile and</span><br><span class="line">SSLCertificateFile directives in '/etc/apache2/sites-available/default-ssl.conf'</span><br><span class="line">to point to your SSL certificate. Then restart apache:</span><br><span class="line"></span><br><span class="line">如果要使用自签名证书，则应安装ssl-sert包（见下文）。否则，只需调整'/etc/apache2/sites available/default-ssl.conf中的sslcertificateKey和SSLCertificateFile参数指向SSL证书。然后重新启动apache：</span><br><span class="line"></span><br><span class="line">	service apache2 restart</span><br><span class="line"></span><br><span class="line">The SSL key file should only be readable by root; the certificate file may be</span><br><span class="line">globally readable. These files are read by the Apache parent process which runs</span><br><span class="line">as root, and it is therefore not necessary to make the files readable by the</span><br><span class="line">www-data user.</span><br><span class="line"></span><br><span class="line">SSL密钥文件应该只能由root用户读取；证书文件可以是全局可读。这些文件由以root用户运行的Apache父进程读取</span><br><span class="line">因此，不必让www-data用户可读。</span><br><span class="line"></span><br><span class="line">Creating self-signed certificates - 创建自签名证书</span><br><span class="line">---------------------------------</span><br><span class="line"></span><br><span class="line">If you install the ssl-cert package, a self-signed certificate will be</span><br><span class="line">automatically created using the hostname currently configured on your computer.</span><br><span class="line">You can recreate that certificate (e.g. after you have changed '/etc/hosts' or</span><br><span class="line">DNS to give the correct hostname) as user root with:</span><br><span class="line"></span><br><span class="line">如果安装ssl-cert包，则自签名证书将使用计算机上当前配置的主机名自动创建。您可以以root用户重新创建该证书（例如，在更改“/etc/hosts”或DNS提供正确的主机名）：</span><br><span class="line"></span><br><span class="line">	make-ssl-cert generate-default-snakeoil --force-overwrite</span><br><span class="line"></span><br><span class="line">To create more certificates with different host names, you can use</span><br><span class="line"></span><br><span class="line">要使用不同的主机名创建更多证书，可以使用</span><br><span class="line"></span><br><span class="line">	make-ssl-cert /usr/share/ssl-cert/ssleay.cnf /path/to/cert-file.crt</span><br><span class="line"></span><br><span class="line">This will ask you for the hostname and place both SSL key and certificate in</span><br><span class="line">the file '/path/to/cert-file.crt'. Use this file with the SSLCertificateFile</span><br><span class="line">directive in the Apache config (you don't need the SSLCertificateKeyFile in</span><br><span class="line">this case as it also contains the key). The file '/path/to/cert-file.crt'</span><br><span class="line">should only be readable by root. A good directory to use for the additional</span><br><span class="line">certificates/keys is '/etc/ssl/private'.</span><br><span class="line"></span><br><span class="line">这将要求您输入主机名、SSL密钥和证书存放路径。将此文件与SSLCertificateFile参数配合使用时就不需要在ssekficate中指定密钥路径了）。证书文件'/path/to/cert-文件.crt'应该只能由根用户读取。'/etc/ssl/private'会时一个存储新增的证书/密钥好地方。</span><br><span class="line"></span><br><span class="line">SSL workaround for MSIE - MSIE下的SSL</span><br><span class="line">-----------------------</span><br><span class="line"></span><br><span class="line">The SSL workaround for MS Internet Explorer needs to be added to your SSL</span><br><span class="line">VirtualHost section (it was previously in ssl.conf but caused keepalive to be</span><br><span class="line">disabled even for non-SSL connections):</span><br><span class="line"></span><br><span class="line">MS Internet Explorer(IE浏览器)的SSL解决方案需要添加到SSL中虚拟主机部分（在以前的ssl.conf中，会引起keepalive在非SSL连接下被禁用）：</span><br><span class="line"></span><br><span class="line">	BrowserMatch "MSIE [2-6]" \</span><br><span class="line">		nokeepalive ssl-unclean-shutdown \</span><br><span class="line">		downgrade-1.0 force-response-1.0</span><br><span class="line">	BrowserMatch "MSIE [17-9]" ssl-unclean-shutdown</span><br><span class="line"></span><br><span class="line">The default SSL virtual host in '/etc/apache2/sites-available/default-ssl.conf'</span><br><span class="line">already contains this workaround.</span><br><span class="line"></span><br><span class="line">现在/etc/apache2/sites_available/default-ssl.conf中的默认SSL虚拟主机已包含此解决方法。</span><br><span class="line"></span><br><span class="line">Suexec</span><br><span class="line">======</span><br><span class="line"></span><br><span class="line">Debian ships two version of the suexec helper program required by</span><br><span class="line">mod_suexec. It is not installed by default, to avoid possible security</span><br><span class="line">issues. The package apache2-suexec-pristine contains the standard version</span><br><span class="line">that works only with document root /var/www, userdir suffix public_html,</span><br><span class="line">and Apache run user www-data. The package apache2-suexec-custom contains a</span><br><span class="line">customizable version that can be configured with a config file to use</span><br><span class="line">different settings (like /srv/www as document root). For more information</span><br><span class="line">see the suexec(8) man page in the apache2-suexec-custom package.</span><br><span class="line"></span><br><span class="line">Debian提供了mod_suexec所需的两个版本suexec。默认情况下不安装，以避免可能的安全性问题。apache2 suexec pristine包包含标准版本它只适用于文档root/var/www，userdir后缀public_html，Apache运行用户www数据。apache2 suexec定制包包含可自定义版本，可配置为使用配置文件不同的设置（如/srv/www作为文档根目录）。了解更多信息请参阅apache2suexec定制包中的suexec（8）手册页。</span><br><span class="line"></span><br><span class="line">Since apache2-suexec-custom has received less testing and might be slightly</span><br><span class="line">slower, apache2-suexec is the recommended version unless you need the features</span><br><span class="line">from apache2-suexec-custom.</span><br><span class="line"></span><br><span class="line">由于Apache2-suexec-custom测试得不多，所以Apache2-suexec才是推荐的版本，除非您需要这些来自apache2 suexec_custom特性。</span><br><span class="line"></span><br><span class="line">Starting with Apache 2.4 both alternatives can be installed at the same</span><br><span class="line">time and the default suexec mechanism can be picked by using the</span><br><span class="line">update-alternatives(8) system.</span><br><span class="line"></span><br><span class="line">从Apache2.4开始，同时安装两个备选方案可以同时安装，然后在从偏好方案update-alternatives（8）系统中选择。</span><br><span class="line"></span><br><span class="line">Unicode File Name Normalization - Unicode文件名规范化</span><br><span class="line">===============================</span><br><span class="line"></span><br><span class="line">Using Apache with the document root on a file system that does unicode</span><br><span class="line">normalization on the filenames can cause security issues. In Debian,</span><br><span class="line">this affects ZFS with the non-default option to enable filename normalization,</span><br><span class="line">and HFS+. It is strongly recommended not to use Apache with such file systems.</span><br><span class="line">More information about this issue can be found by searching the web for</span><br><span class="line">CVE-2013-0966.</span><br><span class="line"></span><br><span class="line">在执行unicode的文件系统上使用带有文档根目录的Apache文件名的规范化可能会导致安全问题。在Debian，这会通过启用文件名规范化的非默认选项影响ZFS，和HFS+。强烈建议不要在此类文件系统中使用Apache。有关此问题的详细信息，请在web上搜索CVE-2013-0966。</span><br><span class="line"></span><br><span class="line">Documentation - 文档</span><br><span class="line">=============</span><br><span class="line"></span><br><span class="line">The full Apache 2 documentation can be found on the web at</span><br><span class="line"></span><br><span class="line">完整的文档在：</span><br><span class="line"></span><br><span class="line">http://httpd.apache.org/docs/2.4/</span><br><span class="line"></span><br><span class="line">or, if you have installed the apache2-doc package, in</span><br><span class="line"></span><br><span class="line">或者本地文档：</span><br><span class="line"></span><br><span class="line">/usr/share/doc/apache2-doc/manual/</span><br><span class="line"></span><br><span class="line">or at	</span><br><span class="line"></span><br><span class="line">http://localhost/manual/</span><br><span class="line"></span><br><span class="line">There is also a wiki that contains useful information:</span><br><span class="line"></span><br><span class="line">这里还有更多信息：</span><br><span class="line"></span><br><span class="line">http://wiki.apache.org/httpd/</span><br><span class="line"></span><br><span class="line">Some hints about securing Apache 2 on Debian are available at</span><br><span class="line"></span><br><span class="line">有关在Debian上保护Apache2的一些提示，请访问：</span><br><span class="line"></span><br><span class="line">http://wiki.debian.org/Apache/Hardening</span><br><span class="line"></span><br><span class="line">Upgrades - 升级</span><br><span class="line">========</span><br><span class="line"></span><br><span class="line">Changes in the Apache packages that require manual configuration adjustments</span><br><span class="line">are announced in NEWS.Debian. Installing the apt-listchanges package is</span><br><span class="line">recommended. It will display the relevant NEWS.Debian sections before</span><br><span class="line">upgrades.</span><br><span class="line"></span><br><span class="line">Apache软件包中需要手动调整配置的更改发布于NEWS.Debian. 安装apt listchanges包是推荐。升级之前它将显示相关NEWS.Debian。</span><br><span class="line"></span><br><span class="line">Multiple instances - 多实例</span><br><span class="line">==================</span><br><span class="line"></span><br><span class="line">There is some support for running multiple instances of Apache2 on the same</span><br><span class="line">machine. See '/usr/share/doc/apache2/README.multiple-instances' for more</span><br><span class="line">information.</span><br><span class="line"></span><br><span class="line">有一些在同一个平台上运行多个Apache2实例机器的帮助。参见'/usr/share/doc/apache2/自述文件.multiple-实例了解更多信息。</span><br><span class="line"></span><br><span class="line">Common Problems - 常见问题</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">1) Error message "Could not reliably determine the server's fully qualified </span><br><span class="line">domain name, using 127.0.0.1 for ServerName" during start</span><br><span class="line"></span><br><span class="line">错误消息“无法可靠地确定服务器的完全限定域名，在启动期间对ServerName使用127.0.0.1</span><br><span class="line"></span><br><span class="line">This can usually be ignored but it means that Apache httpd was unable to obtain</span><br><span class="line">a fully-qualified hostname by doing a reverse lookup on your server's IP</span><br><span class="line">address. You may want to add the fully-qualified hostname to '/etc/hosts'.</span><br><span class="line">An alternative is to specify "ServerName 127.0.0.1" in the global server</span><br><span class="line">context of the configuration, e.g. in</span><br><span class="line">'/etc/apache2/conf-enabled/local-servername.conf'.</span><br><span class="line"></span><br><span class="line">这通常可以忽略，但这意味着apachehttpd无法获得通过对服务器的IP进行反向查找来获得完全限定的主机名</span><br><span class="line">地址。您可能希望将完全限定的主机名添加到“/etc/hosts”。另一种方法是在全局服务器中指定“ServerName 127.0.0.1”</span><br><span class="line">例如'/etc/apache2/conf-enabled/local-servername.conf'.</span><br><span class="line"></span><br><span class="line">2) Error message "mod_rewrite: could not create rewrite_log_lock"</span><br><span class="line"></span><br><span class="line">错误消息“mod_rewrite:无法创建重写日志锁”</span><br><span class="line"></span><br><span class="line">This probably means that there are some stale SYSV semaphores around. This</span><br><span class="line">usually happens after apache2 has been killed with kill -9 (SIGKILL). You can</span><br><span class="line">clean up the semaphores with:</span><br><span class="line"></span><br><span class="line">这可能意味着周围有一些过时的SYSV信号量。这个通常发生在apache2被kill-9（SIGKILL）杀死之后。你可以</span><br><span class="line">使用以下命令清除信号量：</span><br><span class="line"></span><br><span class="line">	ipcs -s | grep www-data | awk ' &#123; print $2 &#125; ' | xargs ipcrm sem</span><br><span class="line"></span><br><span class="line">3) Message "File does not exist: /etc/apache2/htdocs" in error log</span><br><span class="line"></span><br><span class="line">错误日志中的消息“文件不存在：/etc/apache2/htdocs”</span><br><span class="line"></span><br><span class="line">In most cases this means that no matching VirtualHost definition could be</span><br><span class="line">found for an incoming request. Check that the target IP address/port and the</span><br><span class="line">name in the Host: header of the request actually match one of the virtual</span><br><span class="line">hosts.</span><br><span class="line"></span><br><span class="line">在大多数情况下，这意味着没有匹配的VirtualHost定义为传入请求找到。检查目标IP地址/端口和主机中的名称：请求的头实际上与虚拟主人。</span><br><span class="line"></span><br><span class="line">4) Message "Couldn't create pollset in child; check user or system limits" in</span><br><span class="line">  error log</span><br><span class="line"></span><br><span class="line">错误日志中的消息“无法在子级中创建pollset；请检查用户或系统限制”</span><br><span class="line"></span><br><span class="line">On Linux kernels since 2.6.27.8, the value in</span><br><span class="line"></span><br><span class="line">在2.6.27.8以后的Linux内核上</span><br><span class="line"></span><br><span class="line">    /proc/sys/fs/epoll/max_user_instances</span><br><span class="line"></span><br><span class="line">needs to be larger than</span><br><span class="line"></span><br><span class="line">需要大于</span><br><span class="line"></span><br><span class="line">    for prefork/itk  MPM: 2 * MaxClients</span><br><span class="line">    for worker/event MPM: MaxClients + MaxClients/ThreadsPerChild</span><br><span class="line"></span><br><span class="line">It can be set on boot by adding a line like</span><br><span class="line"></span><br><span class="line">它可以通过添加一行:</span><br><span class="line"></span><br><span class="line">        fs.epoll.max_user_instances=1024</span><br><span class="line"></span><br><span class="line">to '/etc/sysctl.conf'.</span><br><span class="line"></span><br><span class="line">到'/etc/sysctl.conf'.</span><br><span class="line"></span><br><span class="line">There are several other error messages related to creating a pollset that can</span><br><span class="line">appear for the same reason.</span><br><span class="line"></span><br><span class="line">还有几个与创建pollset相关的错误消息可以因为同样的原因出现。</span><br><span class="line"></span><br><span class="line">On the other hand, errors about adding to a pollset are related to the setting</span><br><span class="line">fs.epoll.max_user_watches. On most systems, max_user_watches should be high</span><br><span class="line">enough by default.</span><br><span class="line"></span><br><span class="line">另一方面，关于添加到pollset的错误与设置有关fs.epoll.max_user_watches. 在大多数系统上，max_user_watches 默认情况应该足够高了。</span><br><span class="line"></span><br><span class="line">5) Message "Server should be SSL-aware but has no certificate configured" in</span><br><span class="line">   error log</span><br><span class="line"></span><br><span class="line">错误日志中的消息“服务器应支持SSL，但未配置证书”</span><br><span class="line"></span><br><span class="line">Since 2.2.12, Apache is stricter about certain misconfigurations concerning</span><br><span class="line">name based SSL virtual hosts. See NEWS.Debian.gz for more details.</span><br><span class="line"></span><br><span class="line">从2.2.12开始，Apache对基于名称的SSL虚拟主机以下错误配置的要求更严格，查看NEWS.Debian.gz了解更多细节。</span><br><span class="line"></span><br><span class="line">6) Apache does not pass Authorization header to CGI scripts</span><br><span class="line"></span><br><span class="line">Apache不向CGI脚本传递授权头。</span><br><span class="line"></span><br><span class="line">This is intentional to avoid security holes. If you really want to change it,</span><br><span class="line">you can use mod_rewrite:</span><br><span class="line"></span><br><span class="line">这是为了避免安全漏洞。如果你真的想改变它，您可以使用mod_rewrite：</span><br><span class="line"></span><br><span class="line">	RewriteCond %&#123;HTTP:Authorization&#125; (.*)</span><br><span class="line">	RewriteRule . - [env=HTTP_AUTHORIZATION:%1]</span><br><span class="line"></span><br><span class="line">7) mod_dav is behaving strangely</span><br><span class="line"></span><br><span class="line">mod_dav行为很奇怪</span><br><span class="line"></span><br><span class="line">In general, if you use mod_dav_fs, you need to disable multiviews and script</span><br><span class="line">execution for that directory. For example:</span><br><span class="line"></span><br><span class="line">通常，如果使用mod_dav_fs，则需要禁用该目录的多视图和脚本执行。例如：</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Directory</span> /<span class="attr">var</span>/<span class="attr">www</span>/<span class="attr">dav</span>&gt;</span></span><br><span class="line">        Dav on</span><br><span class="line">        Options -MultiViews -ExecCGI</span><br><span class="line">        SetHandler none</span><br><span class="line">        <span class="tag">&lt;<span class="name">IfModule</span> <span class="attr">mod_php5.c</span>&gt;</span></span><br><span class="line">            php_admin_value engine Off</span><br><span class="line">        <span class="tag">&lt;/<span class="name">IfModule</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">8) Message "apache2: bad user name $&#123;APACHE_RUN_USER&#125;" when starting apache2</span><br><span class="line">   directly</span><br><span class="line"></span><br><span class="line">当直接启动apache2时，消息“apache2:bad user name$&#123;APACHE_RUN_user&#125;”</span><br><span class="line"></span><br><span class="line">Use apache2ctl (it accepts all the same options as apache2).</span><br><span class="line"></span><br><span class="line">请改用apache2ctl</span><br><span class="line"></span><br><span class="line">9) A PUT with mod_dav_fs fails with "Unable to PUT new contents for /...</span><br><span class="line">[403, #0]" even if Apache has permission to write the file.</span><br><span class="line"></span><br><span class="line">带有mod_dav_fs的PUT失败，并显示“无法为/….放入新内容”[403，#0]“即使Apache有写入文件的权限。</span><br><span class="line"></span><br><span class="line">Apache also needs write permission to the directory containing the file, in</span><br><span class="line">order to replace it atomically.</span><br><span class="line"></span><br><span class="line">Apache还需要权限来替换包含它的目录。</span><br><span class="line"></span><br><span class="line">10) When starting/reloading Apache, there is the error message</span><br><span class="line">    "ulimit: open files: cannot modify limit: Operation not permitted"</span><br><span class="line"></span><br><span class="line">启动/重新加载Apache时，会出现错误消息“ulimit:open files:cannot modify limit:Operation not allowed”</span><br><span class="line"></span><br><span class="line">If you are running Apache in a vserver environment, the start script may not</span><br><span class="line">be allowed to set the maximum number of open files. You should adjust</span><br><span class="line">APACHE_ULIMIT_MAX_FILES in /etc/apache2/envvars to your setup. You can</span><br><span class="line">disable changing the limits by setting APACHE_ULIMIT_MAX_FILES=true .</span><br><span class="line"></span><br><span class="line">如果在vserver环境中运行Apache，则可能不允许start脚本设置打开文件的最大数量。您应该将/etc/apache2/envvars中的APACHE_ULIMIT_MAX_文件调整为您的设置。您可以通过设置APACHE_ULIMIT_MAX_FILES=true来禁用更改限制。</span><br><span class="line"></span><br><span class="line">For Developers - 开发者</span><br><span class="line">==============</span><br><span class="line"></span><br><span class="line">The Apache 2 web server package provides several helpers to assist</span><br><span class="line">packagers to interact with the web server for both, build and installation</span><br><span class="line">time. Please refer to the PACKAGING file in the apache2 package for</span><br><span class="line">detailed information.</span><br><span class="line"></span><br><span class="line">Apache2Web服务器包提供了几个帮助程序，以帮助打包程序在构建和安装期间与web服务器进行交互。有关详细信息，请参阅apache2包中的打包文件。</span><br></pre></td></tr></table></figure>
<h4 id="配置SSL"><a href="#配置SSL" class="headerlink" title="配置SSL"></a>配置SSL</h4><p>证书文件预备：</p>
<ul>
<li>证书文件：以<code>.crt</code>为后缀或文件类型。</li>
<li>证书链文件：以<code>.crt</code>为后缀或文件类型。</li>
<li>密钥文件：以<code>.key</code>为后缀或文件类型。</li>
</ul>
<blockquote>
<p>Debian 配置指南</p>
</blockquote>
<ol>
<li><p>打开终端执行<code>a2enmod ssl</code></p>
</li>
<li><p>在<code>/etc/apache2/sites-available</code>中会有一个配置文件：<code>default-ssl.conf</code></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">自行设置DocumentRoot参数</span></span><br><span class="line"><span class="attr">添加：</span></span><br><span class="line">		<span class="attr">SSLEngine</span> <span class="string">on</span></span><br><span class="line"><span class="comment">		# 添加SSL协议支持协议，去掉不安全的协议。</span></span><br><span class="line">		<span class="attr">SSLProtocol</span> <span class="string">all -SSLv2 -SSLv3</span></span><br><span class="line"><span class="comment">		# 修改加密套件。</span></span><br><span class="line">		<span class="attr">SSLCipherSuite</span> <span class="string">HIGH:!RC4:!MD5:!aNULL:!eNULL:!NULL:!DH:!EDH:!EXP:+MEDIUM</span></span><br><span class="line">		<span class="attr">SSLHonorCipherOrder</span> <span class="string">on</span></span><br><span class="line"><span class="comment">		# 将domain name1_public.crt替换成您证书文件名。</span></span><br><span class="line">		<span class="attr">SSLCertificateFile</span>	<span class="string">public.crt</span></span><br><span class="line"><span class="comment">		# 将domain name1.key替换成您证书的密钥文件名。</span></span><br><span class="line">		<span class="attr">SSLCertificateKeyFile</span> <span class="string">.key</span></span><br><span class="line"><span class="comment">		# 将domain name1_chain.crt替换成您证书的密钥文件名；证书链开头如果有#字符，请删除。</span></span><br><span class="line">		<span class="attr">SSLCertificateChainFile</span> <span class="string">chain.crt</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>然后<code>a2ensite default-ssl.conf</code></p>
</li>
<li><p>重启Apache2.</p>
</li>
<li><p>配置强制跳转HTTPS：<code>a2enmod rewrite</code>。然后在80的000-default的HTTP配置文件中添加</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute"><span class="nomarkup">RewriteEngine</span></span> <span class="literal">on</span></span><br><span class="line"><span class="attribute"><span class="nomarkup">RewriteCond</span></span> <span class="variable">%&#123;SERVER_PORT&#125;</span> !^443$</span><br><span class="line"><span class="attribute"><span class="nomarkup">RewriteRule</span></span> ^(.*)$ https://<span class="variable">%&#123;SERVER_NAME&#125;</span><span class="number">$1</span><span class="meta"> [L,R]</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>其他常规发行版指南</p>
</blockquote>
<ol>
<li><p>在Apache安装目录中新建cert目录，并将解压的Apache证书、证书链文件和密钥文件拷贝到cert目录中。如果需要安装多个证书，需在Apache目录中新建对应数量的cert目录，用于存放不同的证书 。</p>
</li>
<li><p>修改httpd.conf - <code>Apache/conf/httpd.conf</code>配置文件。</p>
<figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#LoadModule ssl_module modules/mod_ssl.so  #删除行首的配置语句注释符号“#”加载mod_ssl.so模块启用SSL服务，Apache默认是不启用该模块的。</span><br><span class="line">#Include conf/extra/httpd-ssl.conf  #删除行首的配置语句注释符号“#”。</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong> ：如果您在httpd.conf文件中没有找到以上配置语句，请确认您的Apache服务器中是否已经安装mod_ssl.so模块。可执行<code>yum install -y mod_ssl</code>命令安装mod_ssl模块。</p>
</li>
<li><p>修改httpd-ssl.conf - <code>Apache/conf/extra/httpd-ssl.conf</code>配置文件。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost *:<span class="number">443</span>&gt;     </span><br><span class="line">    ServerName   <span class="comment">#修改为申请证书时绑定的域名www.YourDomainName1.com。                    </span></span><br><span class="line">    DocumentRoot  /data/www/hbappserver/public          </span><br><span class="line">    SSLEngine <span class="keyword">on</span>   </span><br><span class="line">    SSLProtocol all -SSLv2 -SSLv3 <span class="comment"># 添加SSL协议支持协议，去掉不安全的协议。</span></span><br><span class="line">    SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!<span class="literal">NULL</span>:!DH:!EDH:!EXP:+MEDIUM   <span class="comment"># 修改加密套件。</span></span><br><span class="line">    SSLHonorCipherOrder <span class="keyword">on</span></span><br><span class="line">    SSLCertificateFile cert/domain name1_public.crt   <span class="comment"># 将domain name1_public.crt替换成您证书文件名。</span></span><br><span class="line">    SSLCertificateKeyFile cert/domain name1.key   <span class="comment"># 将domain name1.key替换成您证书的密钥文件名。</span></span><br><span class="line">    SSLCertificateChainFile cert/domain name1_chain.crt  <span class="comment"># 将domain name1_chain.crt替换成您证书的密钥文件名；证书链开头如果有#字符，请删除。</span></span><br><span class="line">&lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#如果证书包含多个域名，复制以上参数，并将ServerName替换成第二个域名。 </span></span><br><span class="line">&lt;VirtualHost *:<span class="number">443</span>&gt;     </span><br><span class="line">    ServerName   <span class="comment">#修改为申请证书时绑定的第二个域名www.YourDomainName2.com。                    </span></span><br><span class="line">    DocumentRoot  /data/www/hbappserver/public          </span><br><span class="line">    SSLEngine <span class="keyword">on</span>   </span><br><span class="line">    SSLProtocol all -SSLv2 -SSLv3 <span class="comment"># 添加SSL协议支持协议，去掉不安全的协议。</span></span><br><span class="line">    SSLCipherSuite HIGH:!RC4:!MD5:!aNULL:!eNULL:!<span class="literal">NULL</span>:!DH:!EDH:!EXP:+MEDIUM   <span class="comment"># 修改加密套件。</span></span><br><span class="line">    SSLHonorCipherOrder <span class="keyword">on</span></span><br><span class="line">    SSLCertificateFile cert/domain name2_public.crt   <span class="comment"># 将domain name2替换成您申请证书时的第二个域名。</span></span><br><span class="line">    SSLCertificateKeyFile cert/domain name2.key   <span class="comment"># 将domain name2替换成您申请证书时的第二个域名。</span></span><br><span class="line">    SSLCertificateChainFile cert/domain name2_chain.crt  <span class="comment"># 将domain name2替换成您申请证书时的第二个域名；证书链开头如果有#字符，请删除。</span></span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure>
<p><strong>说明</strong> 根据操作系统的不同，http-ssl.conf文件也可能存放在conf.d/ssl.conf目录中。需注意您的浏览器版本是否支持SNI功能。如果不支持，多域名证书配置将无法生效。</p>
</li>
<li><p>重启Apache服务器使SSL配置生效。</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apachectl -k <span class="literal">stop</span></span><br><span class="line">apachectl -k <span class="literal">start</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>可选：</strong>修改httpd.conf文件，设置HTTP请求自动跳转HTTPS。</p>
<p>在httpd.conf文件中的<code>&lt;VirtualHost *:80&gt; &lt;/VirtualHost&gt;</code>中间，添加以下重定向代码。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute"><span class="nomarkup">RewriteEngine</span></span> <span class="literal">on</span></span><br><span class="line"><span class="attribute"><span class="nomarkup">RewriteCond</span></span> <span class="variable">%&#123;SERVER_PORT&#125;</span> !^443$</span><br><span class="line"><span class="attribute"><span class="nomarkup">RewriteRule</span></span> ^(.*)$ https://<span class="variable">%&#123;SERVER_NAME&#125;</span><span class="number">$1</span><span class="meta"> [L,R]</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>火狐有个SSL配置<a href="https://ssl-config.mozilla.org/" target="_blank" rel="noopener">生成器</a> </p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里演示的时仅支持TSLv1.3版本。</span></span><br><span class="line"><span class="comment"># generated 2020-12-10, Mozilla Guideline v5.6, Apache 2.4.38, OpenSSL 1.1.1d, modern configuration</span></span><br><span class="line"><span class="comment"># https://ssl-config.mozilla.org/#server=apache&amp;version=2.4.38&amp;config=modern&amp;openssl=1.1.1d&amp;guideline=5.6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># this configuration requires mod_ssl, mod_socache_shmcb, mod_rewrite, and mod_headers</span></span><br><span class="line"><span class="section">&lt;VirtualHost *:80&gt;</span></span><br><span class="line"><span class="attribute"><span class="nomarkup">RewriteEngine</span></span> <span class="literal">On</span></span><br><span class="line"><span class="attribute"><span class="nomarkup">RewriteRule</span></span> ^(.*)$ https://<span class="variable">%&#123;HTTP_HOST&#125;</span><span class="number">$1</span><span class="meta"> [R=301,L]</span></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">&lt;VirtualHost *:443&gt;</span>	</span><br><span class="line"><span class="attribute">ServerAdmin</span> 【】</span><br><span class="line"><span class="attribute"><span class="nomarkup">DocumentRoot</span></span> 【】</span><br><span class="line"><span class="attribute">ErrorLog</span> <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/error.log</span><br><span class="line"><span class="attribute">CustomLog</span> <span class="variable">$&#123;APACHE_LOG_DIR&#125;</span>/access.log combined</span><br><span class="line"><span class="section">&lt;FilesMatch "\.(cgi|shtml|phtml|php)$"&gt;</span></span><br><span class="line">   <span class="attribute">SSLOptions</span> +StdEnvVars</span><br><span class="line"><span class="section">&lt;/FilesMatch&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">SSLEngine</span> <span class="literal">on</span></span><br><span class="line"><span class="attribute">SSLCertificateFile</span>      【】</span><br><span class="line"><span class="attribute">SSLCertificateKeyFile</span>   【】</span><br><span class="line"><span class="attribute">SSLCertificateChainFile</span> 【】</span><br><span class="line"></span><br><span class="line"><span class="comment"># enable HTTP/2, if available</span></span><br><span class="line"><span class="attribute">Protocols</span> h2 http/1.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP Strict Transport Security (mod_headers is required) (63072000 seconds)</span></span><br><span class="line"><span class="attribute"><span class="nomarkup">Header</span></span> always set Strict-Transport-Security <span class="string">"max-age=63072000"</span></span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># modern configuration</span></span><br><span class="line"><span class="attribute">SSLProtocol</span>             <span class="literal">all</span> -SSLv3 -TLSv1 -TLSv1.1 -TLSv1.2</span><br><span class="line"><span class="attribute">SSLHonorCipherOrder</span>     <span class="literal">off</span></span><br><span class="line"><span class="attribute">SSLSessionTickets</span>       <span class="literal">off</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">SSLUseStapling</span> <span class="literal">On</span></span><br><span class="line"><span class="attribute">SSLStaplingCache</span> <span class="string">"shmcb:logs/ssl_stapling(32768)"</span></span><br></pre></td></tr></table></figure>
<h4 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h4><h5 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h5><p>首先加载<code>proxy</code>和<code>proxy_http</code>模块。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo a2enmod<span class="built_in"> proxy </span>proxy_http</span><br></pre></td></tr></table></figure>
<p>配置<code>sites-available</code>中的站点配置</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;VirtualHost *:80&gt;</span></span><br><span class="line"> <span class="attribute"><span class="nomarkup">ServerName</span></span> example.com</span><br><span class="line"> <span class="attribute">ProxyRequests</span> <span class="literal">Off</span></span><br><span class="line"> <span class="comment"># 末尾记得加斜杠</span></span><br><span class="line"> <span class="attribute">ProxyPass</span> / http://localhost:3000/</span><br><span class="line"> <span class="attribute">ProxyPassReverse</span> / http://localhost:3000/</span><br><span class="line"><span class="section">&lt;/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="其他配置"><a href="#其他配置" class="headerlink" title="其他配置"></a>其他配置</h4><p>最后记得测试配置文件：<code>apachectl configtest</code></p>
<blockquote>
<p><code>/etc/apache2/apache2.conf</code></p>
</blockquote>
<p><code>ServerName 【你的域名】</code>：服务器域名</p>
<p>在不需要的目录上增加规则：<code>Require all denied</code></p>
<blockquote>
<p><code>/etc/apache2/sites-available/000-default.conf</code></p>
</blockquote>
<p><code>ServerAdmin 【you@example.com邮箱】</code>：错误页面将会显示这个邮箱</p>
<p><code>ServerSignature Off</code>：关闭服务器签名</p>
<p><code>ServerTokens Prod</code>：隐藏 Apache 和 PHP 版本等属性</p>
<h3 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h3><h4 id="配置systemctl服务控制docker容器运行"><a href="#配置systemctl服务控制docker容器运行" class="headerlink" title="配置systemctl服务控制docker容器运行"></a>配置<code>systemctl</code>服务控制<code>docker</code>容器运行</h4><blockquote>
<p>不是Docker容器内运行<code>systemctl</code> ！是使用<code>systemctl</code>控制docker容器的运行</p>
</blockquote>
<p>生成容器：<code>sudo docker create --name rsshub -p 1200:1200 diygod/rsshub</code></p>
<p>服务：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=<span class="variable">$SRV_NAME</span></span><br><span class="line"><span class="attr">After</span>=network.target </span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStart</span>=start.sh</span><br><span class="line"><span class="attr">ExecStop</span>=stop.sh</span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">True</span></span><br><span class="line"><span class="comment"># 下面的注释是指定用户运行</span></span><br><span class="line"><span class="comment"># User=xxx</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>start.sh</code>和<code>stop.sh</code>内容分别是启动和停止：</p>
<p>启动：<code>docker start -a rsshub&amp;</code></p>
<p>停止：<code>docker stop rsshub</code></p>
<p>将服务移动到：<code>/lib/systemd/system/</code></p>
<h3 id="FFmpeg推流"><a href="#FFmpeg推流" class="headerlink" title="FFmpeg推流"></a>FFmpeg推流</h3><blockquote>
<p>还可使用kplayer推流(对服务器配置要求高些)，具体可以使用<a href="https://gitee.com/rmshadows/rm_scripts里面的脚本协助搭建成服务" target="_blank" rel="noopener">https://gitee.com/rmshadows/rm_scripts里面的脚本协助搭建成服务</a></p>
</blockquote>
<p>参考：<a href="https://www.bilibili.com/read/cv9687198/" target="_blank" rel="noopener">https://www.bilibili.com/read/cv9687198/</a></p>
<p><strong>简单推流</strong></p>
<p><code>ffmpeg -re -i &quot;1.mp4&quot; -vcodec copy -acodec copy -f flv &quot;你的rtmp地址/你的直播码&quot;</code></p>
<p><strong>控制输出(低带宽)</strong></p>
<p><code>-r</code>: 帧率</p>
<p><code>-b</code>: 比特率</p>
<p><code>ffmpeg -re -stream_loop -1 -i &quot;$MP4_FILE&quot; -r 10 -b 10k -f flv -flvflags no_duration_filesize &quot;$RTMP&quot;&amp;</code></p>
<p><strong>播放列表</strong></p>
<p><code>ffmpeg -re -f concat -safe 0 -i playlist.txt -vcodec copy -acodec copy -f flv &quot;rtmp://rtmp地址/你的直播码&quot;</code></p>
<p>播放列表格式：</p>
<figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">file</span> <span class="string">'input1.mp4'</span></span><br><span class="line"><span class="keyword">file</span> <span class="string">'input2.mp4'</span></span><br><span class="line"><span class="keyword">file</span> <span class="string">'input3.mp4'</span></span><br></pre></td></tr></table></figure>
<p><strong>单文件循环推流</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># RTMP地址</span></span><br><span class="line">RTMP_ADDR=<span class="string">"rtmp://"</span></span><br><span class="line">MP4_FILE=<span class="string">"1.mp4"</span></span><br><span class="line"><span class="comment"># 循环 -stream_loop -1</span></span><br><span class="line">ffmpeg -re -stream_loop -1 -i <span class="string">"<span class="variable">$MP4_FILE</span>"</span> -vcodec copy -acodec copy -f flv -flvflags no_duration_filesize <span class="string">"<span class="variable">$RTMP_ADDR</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#while true</span></span><br><span class="line"><span class="comment">#do</span></span><br><span class="line"><span class="comment">#    ffmpeg -re -i "1.mp4" -stream_loop -1 -vcodec copy -acodec copy -f flv "$RTMP_ADDR"</span></span><br><span class="line"><span class="comment">#done</span></span><br></pre></td></tr></table></figure>
<p><strong>尝试无缝推流</strong></p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">管道可以作为一个媒介，管道一端用于接收需要推送的媒体流，另一端则输出给ffmpeg推流到rtmp服务器，那只要管道输出端一直有数据给到ffmpeg推流，那ffmpeg就能一直运行。</span><br><span class="line"> 管道又分为匿名管道和命名管道，我一开始尝试使用匿名管道发现无法解决问题，匿名管道具有一定的局限性：首先，这个管道只能是具有血缘关系的进程之间通信；第二，它只能实现一个进程写另一个进程读，而如果需要两者同时进行时，就得重新打开一个管道。于是我尝试使用命名管道，关于命名管道：</span><br><span class="line"> <span class="number">1</span>、与管道的区别：提供了一个路径名与之关联，以FIFO文件的形式存储于文件系统中，能够实现任何两个进程之间通信。而匿名管道对于文件系统是不可见的，它仅限于在父子进程之间的通信。</span><br><span class="line"> <span class="number">2</span>、FIFO是一个设备文件，在文件系统中以文件名的形式存在，因此即使进程与创建FIFO的进程不存在血缘关系也依然可以通信，前提是可以访问该路径。</span><br><span class="line"> <span class="number">3</span>、FIFO(first input first output)总是遵循先进先出的原则，即第一个进来的数据会第一个被读走。</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、所有指向管道写端的文件描述符都关闭了（管道写端的引用计数等于<span class="number">0</span>），而仍然有进程从管道的读端读数据时，那么管道中剩余的数据都被读取后，再次read会返回<span class="number">0</span>，就像读到文件末尾一样。</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、指向管道写端的文件描述符没关闭（管道写端的引用计数大于<span class="number">0</span>），而持有管道写端的进程也没有向管道中写数据，这时有进程从管道读端读数据时，管道中剩余的数据都被读取后，再次read会阻塞，直到管道中有数据可读了才读取数据并返回。</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、所有指向管道读端的文件描述符都关闭了（管道读端的引用计数等于<span class="number">0</span>），这时有进程向管道的写端write，那么该进程会收到信号SIGPIPE，通常会导致进程异常终止。</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、指向管道读端的文件描述符没关闭（管道的引用计数大于<span class="number">0</span>），而持有管道读端的进程也没有从管道中读数据，这时有进程向管道写端写数据，那么在管道被写满时再次write会阻塞，直到管道中有空位置了才写入数据并返回。</span><br><span class="line"></span><br><span class="line">        当管道的写和读都已经打开后，管道读端的引用计数等于<span class="number">0</span>或者写端的引用计数等于<span class="number">0</span>，管道就会关闭，需要重新操作。简单来说，当上面整个操作流程开始后，中断其中一个进程，最后都会导致管道关闭，那么想要维持管道的开启，需要管道读端的引用计数和写端的引用计数都大于<span class="number">0</span>。</span><br><span class="line"></span><br><span class="line">        于是我想了个办法，利用管道的阻塞特点，通过新建两个新的管道文件keep1、keep2，一个指向push的写端，另一个指向push的读端，使push读端和写端的引用计数都不为<span class="number">0</span>,具体如下： </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkfifo keep1</span><br><span class="line"></span><br><span class="line">mkfifo keep2</span><br><span class="line"></span><br><span class="line">cat keep1 &gt; push</span><br><span class="line"></span><br><span class="line">cat keep2 &lt; push </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">经过测试：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、推流进程关闭时，输入进程进入阻塞状态，重新开启推流进程，输入进程恢复运行，输入没有重置</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、输入进程关闭时，推流进程进入阻塞状态，重新开启输入进程，推流进程恢复运行，无需重新打开</span><br><span class="line"></span><br><span class="line">六、总结</span><br><span class="line"></span><br><span class="line">        基于Linux系统下通过ffmpeg推流到本站，只需要几个简单的步骤：</span><br><span class="line"></span><br><span class="line"><span class="number">1</span>、新建<span class="number">3</span>个命名管道，名字随意</span><br><span class="line"></span><br><span class="line">mkfifo keep1</span><br><span class="line"></span><br><span class="line">mkfifo keep2</span><br><span class="line"></span><br><span class="line">mkfifo push</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、创建输入脚本push.sh，填入</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"></span><br><span class="line">ffmpeg -re -f concat -safe <span class="number">0</span> -i playlist.txt -vcodec copy -acodec aac -f flv pipe:<span class="number">1.f</span>lv | cat - &gt;&gt; push</span><br><span class="line"></span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、创建推流脚本send.sh，填入</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">ffmpeg -re -i push -c:v copy -c:a aac -f flv <span class="string">"rtmp://rtmp地址/你的直播码"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、打开四个终端窗口，分别输入：</span><br><span class="line"></span><br><span class="line">sh push.sh</span><br><span class="line"></span><br><span class="line">sh send.sh</span><br><span class="line"></span><br><span class="line">cat keep1 &gt; push</span><br><span class="line"></span><br><span class="line">cat keep2 &lt; push</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">上面几个命令的执行顺序应该不影响最终结果，不想开这么多终端窗口，那就后台运行吧，不过push和send在后台运行的话应该就看不到ffmpeg的打印信息了。</span><br></pre></td></tr></table></figure>
<p>推流地址：</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#### Twitch TV: </span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//help.twitch.tv/s/twitch-ingest-recommendation?language=zh_CN</span></span><br><span class="line">参考:https:<span class="comment">//www.bilibili.com/read/cv22157300?from=search</span></span><br><span class="line">Recommended Ingest Endpoints For You</span><br><span class="line">These ingests endpoints are selected for you based on the optimal network paths detected from Twitch to your device</span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#1US West: Los Angeles, CA</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//lax.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#2US West: San Jose, California (6)</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//sjc06.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#3US West: San Francisco, CA</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//sfo.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#4US West: Phoenix, AZ</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//phx.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#5US West: Salt Lake City, UT</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//slc.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#6US West: Portland, OR</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//pdx.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#7US Central: Denver, CO (52)</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//den52.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#8US West: Seattle, WA</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//sea.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#9US West: Seattle, WA (2)</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//sea02.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line">ingest</span><br><span class="line"><span class="meta">#10US Central: Dallas, TX</span></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//dfw.contribute.live-video.net/app/&#123;stream_key&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#### 花椒直播</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//activity.huajiao.com/web/share/banner/room/obsLive/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//ps2.live.huajiao.com/live_huajiao_open/2039960881684**********</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#### 映客直播</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//www.inke.cn/livemanager/index.html#/stream</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//istream.inke.cn/live/16840716964*****?sign=969d85aa******c9MjAwLWlzdHJlYW0uaW5rZS******3N*****c2NDI%3D&amp;ver=2&amp;uid=752******&amp;ikBeauty=2&amp;ikKnDebug=0&amp;ikEnableDRC=0&amp;ikExposure=0&amp;ikFilter=1&amp;dd_type=0&amp;ikDisableFaceSei=1&amp;ikKnIncr=0&amp;ikLiveType=normal&amp;ikFaceMorph=0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#### 哔哩哔哩</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//link.bilibili.com/p/center/index#/my-room/start-live</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">rtmp:</span><span class="comment">//live-push.bilivideo.com/live-bvc/?streamname=live_47*******_45******&amp;key=25a*******52d****e*******bc*****&amp;schedule=rtmp&amp;pflag=1</span></span><br><span class="line"></span><br><span class="line"><span class="symbol">srt:</span><span class="comment">//live-push.bilivideo.com:1937?streamid=#!::h=live-push.bilivideo.com,r=live-bvc/?streamname=live_47*******_45*****,key=25a576c7**********2de**********7,schedule=srtts,pflag=1?streamname=live_47*******_45*****&amp;key=25*****************de**********7&amp;schedule=rtmp&amp;pflag=1</span></span><br></pre></td></tr></table></figure>
<h3 id="FRP内网穿透"><a href="#FRP内网穿透" class="headerlink" title="FRP内网穿透"></a>FRP内网穿透</h3><p>首先，下载<a href="https://github.com/fatedier/frp" target="_blank" rel="noopener">FRP</a>  |  <a href="https://gofrp.org/docs/" target="_blank" rel="noopener">文档</a></p>
<h4 id="0-54-0版"><a href="#0-54-0版" class="headerlink" title="0.54.0版"></a>0.54.0版</h4><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https:<span class="comment">//github.com/fatedier/frp/releases/download/v0.54.0/frp_0.54.0_linux_amd64.tar.gz</span></span><br><span class="line">tar -xzvf ./frp_0<span class="number">.54</span><span class="number">.0</span>_linux_amd64.tar.gz</span><br><span class="line">rm frp_0<span class="number">.54</span><span class="number">.0</span>_linux_amd64.tar.gz</span><br><span class="line">mv frp_0<span class="number">.54</span><span class="number">.0</span>_linux_amd64 frp</span><br></pre></td></tr></table></figure>
<h5 id="安装服务"><a href="#安装服务" class="headerlink" title="安装服务"></a>安装服务</h5><p><code>frps.service</code></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"><span class="comment"># 服务名称，可自定义</span></span><br><span class="line">Description = frp server</span><br><span class="line">After = network.target syslog.target</span><br><span class="line">Wants = network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type = simple</span><br><span class="line"><span class="comment"># 启动frps的命令，需修改为您的frps的安装路径</span></span><br><span class="line">ExecStart = /path/frps -c /path/frps.toml</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy = multi-user.target</span><br></pre></td></tr></table></figure>
<p><code>sudo cp ./frps.service /lib/systemd/system/</code></p>
<h5 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h5><p><code>frps.toml</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bindPort</span> = <span class="number">7000</span></span><br><span class="line"><span class="attr">auth.method</span> = <span class="string">"token"</span></span><br><span class="line"><span class="attr">auth.token</span> = <span class="string">"aaa"</span></span><br><span class="line"><span class="attr">webServer.port</span> = <span class="number">7500</span></span><br><span class="line"><span class="comment"># dashboard 用户名密码，可选，默认为空</span></span><br><span class="line"><span class="attr">webServer.user</span> = <span class="string">"a1"</span></span><br><span class="line"><span class="attr">webServer.password</span> = <span class="string">"aaa1"</span></span><br><span class="line"><span class="attr">Log.to</span> = <span class="string">"/home/frp/frps.log"</span></span><br><span class="line"><span class="attr">Log.maxDays</span>=<span class="number">30</span></span><br><span class="line"><span class="comment"># 是否返回详细报错</span></span><br><span class="line"><span class="attr">detailedErrorsToClient</span> = <span class="literal">false</span></span><br><span class="line"><span class="comment"># 允许的端口</span></span><br><span class="line"><span class="attr">Server.allowPorts</span> = <span class="string">"3000-5000"</span></span><br></pre></td></tr></table></figure>
<h5 id="XTCP-P2P"><a href="#XTCP-P2P" class="headerlink" title="XTCP-P2P"></a>XTCP-P2P</h5><blockquote>
<p>首先需要服务器</p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 配置需要暴露到外网的机器上的 frpc.toml 文件</span></span><br><span class="line"></span><br><span class="line">serverAddr = <span class="string">"x.x.x.x"</span></span><br><span class="line">serverPort = 7000</span><br><span class="line"><span class="comment"># 如果默认的 STUN 服务器不可用，可以配置一个新的 STUN 服务器</span></span><br><span class="line"><span class="comment"># natHoleStunServer = "xxx"</span></span><br><span class="line"></span><br><span class="line">[[proxies]]</span><br><span class="line">name = <span class="string">"p2p_ssh"</span></span><br><span class="line">type = <span class="string">"xtcp"</span></span><br><span class="line"><span class="comment"># 只有共享密钥 (secretKey) 与服务器端一致的用户才能访问该服务</span></span><br><span class="line">secretKey = <span class="string">"abcdefg"</span></span><br><span class="line">localIP = <span class="string">"127.0.0.1"</span></span><br><span class="line">localPort = 22</span><br><span class="line"></span><br><span class="line"><span class="comment">### 在想要访问内网服务的机器上部署 frpc</span></span><br><span class="line"></span><br><span class="line">serverAddr = <span class="string">"x.x.x.x"</span></span><br><span class="line">serverPort = 7000</span><br><span class="line"><span class="comment"># 如果默认的 STUN 服务器不可用，可以配置一个新的 STUN 服务器</span></span><br><span class="line"><span class="comment"># natHoleStunServer = "xxx"</span></span><br><span class="line"></span><br><span class="line">[[visitors]]</span><br><span class="line">name = <span class="string">"p2p_ssh_visitor"</span></span><br><span class="line">type = <span class="string">"xtcp"</span></span><br><span class="line"><span class="comment"># 要访问的 P2P 代理的名称</span></span><br><span class="line">serverName = <span class="string">"p2p_ssh"</span></span><br><span class="line">secretKey = <span class="string">"abcdefg"</span></span><br><span class="line"><span class="comment"># 绑定本地端口以访问 SSH 服务</span></span><br><span class="line">bindAddr = <span class="string">"127.0.0.1"</span></span><br><span class="line">bindPort = 6000</span><br><span class="line"><span class="comment"># 如果需要自动保持隧道打开，将其设置为 true</span></span><br><span class="line">keepTunnelOpen = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 通过 SSH 访问内网机器</span></span><br><span class="line">ssh <span class="attribute">-oPort</span>=6000 test@127.0.0.1</span><br></pre></td></tr></table></figure>
<h4 id="0-37-0版本"><a href="#0-37-0版本" class="headerlink" title="0.37.0版本"></a>0.37.0版本</h4><p>配置FRP服务端：</p>
<p><code>frps.ini</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="comment"># 端口</span></span><br><span class="line"><span class="attr">bind_port</span> = <span class="number">7000</span></span><br><span class="line"><span class="comment"># 访问令牌</span></span><br><span class="line"><span class="attr">token</span> = xxxx</span><br><span class="line"><span class="comment"># 这个是Web监控页面端口</span></span><br><span class="line"><span class="attr">dashboard_port</span> = <span class="number">100</span></span><br><span class="line"><span class="comment"># dashboard 用户名密码，可选，默认为空</span></span><br><span class="line"><span class="attr">dashboard_user</span> = user</span><br><span class="line"><span class="attr">dashboard_pwd</span> = passwd</span><br><span class="line"><span class="attr">log_file</span> = /Logs/frp/frps.log</span><br><span class="line"><span class="attr">log_max_days</span>=<span class="number">30</span></span><br><span class="line"><span class="comment"># 是否返回详细报错到客户端</span></span><br><span class="line"><span class="attr">detailed_errors_to_client</span> = <span class="literal">false</span></span><br><span class="line"><span class="comment"># 允许的端口</span></span><br><span class="line"><span class="attr">allow_ports</span> = <span class="number">10086</span>-<span class="number">10090</span></span><br></pre></td></tr></table></figure>
<p>搭建服务：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line"><span class="attribute">Description</span>=Frp<span class="built_in"> Server </span>Service</span><br><span class="line"><span class="attribute">After</span>=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line"><span class="attribute">Type</span>=simple</span><br><span class="line"><span class="attribute">User</span>=nobody</span><br><span class="line"><span class="attribute">Restart</span>=on-failure</span><br><span class="line"><span class="attribute">RestartSec</span>=5s</span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/bin/frps -c /etc/frp/frps.ini</span><br><span class="line"><span class="attribute">LimitNOFILE</span>=1048576</span><br></pre></td></tr></table></figure>
<p>对应的客户端：</p>
<p><code>frpc.ini</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[common]</span></span><br><span class="line"><span class="attr">server_addr</span> = vip.frp.wlphp.com</span><br><span class="line"><span class="attr">server_port</span> = <span class="number">7000</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Name]</span></span><br><span class="line"><span class="attr">type</span> = tcp</span><br><span class="line"><span class="attr">local_ip</span> = <span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line"><span class="attr">local_port</span> = <span class="number">22</span></span><br><span class="line"><span class="attr">remote_port</span> = <span class="number">6000</span></span><br><span class="line"><span class="attr">token</span> = xxxx</span><br><span class="line"><span class="comment"># frp 会为本地服务的 22 端口，在 frps 所在的服务端监听 6000 端口，将 6000 端口接收到的连接和本地服务22 端口关联，透传流量，从而实现让用户在外部访问到内部服务。</span></span><br></pre></td></tr></table></figure>
<h3 id="Hackchat"><a href="#Hackchat" class="headerlink" title="Hackchat"></a>Hackchat</h3><p>首先从Github拉取仓库<code>git clone https://github.com/hack-chat/main.git</code></p>
<p>进入仓库执行<code>npm install</code></p>
<p>启动<code>npm start</code>  停止<code>npm stop</code></p>
<h4 id="内置命令"><a href="#内置命令" class="headerlink" title="内置命令"></a>内置命令</h4><ol>
<li><p>登录管理员：随便进入某个房间，在弹出的昵称对话框中输入<code>【管理员用户名】#【管理员密码】</code></p>
</li>
<li><p>登录管理员后，可以使用命令：</p>
<ol>
<li><p>直接键入：<code>/help</code></p>
</li>
<li><p>打开浏览器开发者工具，控制台输入：</p>
<p><code>send({ cmd: &#39;listusers&#39; });</code></p>
<p><code>send({ cmd: &#39;addmod&#39;, trip: &#39;thetrip&#39; });</code></p>
<p><code>send({ cmd: &#39;ban&#39;, nick: &#39;targetNick&#39; });</code></p>
</li>
</ol>
</li>
</ol>
<blockquote>
<p>自定义配置</p>
</blockquote>
<h4 id="修改监听端口号"><a href="#修改监听端口号" class="headerlink" title="修改监听端口号"></a>修改监听端口号</h4><p><code>nano ./pm2.config.js</code>，将<code>args: &#39;./client -p 3000 -o&#39;,</code>中的3000修改为你要的端口号。</p>
<h4 id="修改首页信息、Websocket地址和nginx反向代理配置"><a href="#修改首页信息、Websocket地址和nginx反向代理配置" class="headerlink" title="修改首页信息、Websocket地址和nginx反向代理配置"></a>修改首页信息、Websocket地址和nginx反向代理配置</h4><p><code>nano client/client.js</code>，找到<code>function join(channel)</code>里面的<code>var wsPath = &#39;6060&#39;;</code>设置为你要代理的路径即可。</p>
<p>我的首页配置：</p>
<figure class="highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">var frontpage = [</span><br><span class="line">	<span class="string">"                            _           _         _       _   "</span>,</span><br><span class="line">	<span class="string">"                           | |_ ___ ___| |_   ___| |_ ___| |_ "</span>,</span><br><span class="line">	<span class="string">"                           |   |_ ||  _| '_| |  _|   |_ ||  _|"</span>,</span><br><span class="line">	<span class="string">"                           |_|_|__/|___|_,_|.|___|_|_|__/|_|  "</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"欢迎使用hack.chat，这是一个迷你的、无干扰的加密聊天应用程序。"</span>,</span><br><span class="line">	<span class="string">"频道是通过url创建、加入和共享的，通过更改问号后的文本来创建自己的频道(请使用英文字母)。"</span>,</span><br><span class="line">	<span class="string">"如果您希望频道名称(房间名)为：‘ hello ’,请在浏览器地址栏输入： https://civiccccc.ltd/hc/?hello"</span>,</span><br><span class="line">	<span class="string">"这里没有公开频道列表，因此你可以使用秘密的频道名称(也就是别人都猜不到的房间名)进行私人讨论。在这里，聊天记录不会被记录，聊天信息传输也是加密的(除非你不是用的https访问本站，或者你的电脑遭到攻击)。"</span>,</span><br><span class="line">	<span class="string">"下面是预设的房间：休息室、元数据、数学、物理、化学、科技、编程、游戏、香蕉"</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"?lounge ?meta"</span>,</span><br><span class="line">	<span class="string">"?math ?physics ?chemistry"</span>,</span><br><span class="line">	<span class="string">"?technology ?programming"</span>,</span><br><span class="line">	<span class="string">"?games ?banana"</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"# 这里为你随机生成了一个聊天室（请点击链接进入房间）: ?"</span> + Math.random().toString(<span class="number">36</span>).substr(<span class="number">2</span>, <span class="number">8</span>),</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"语法支持(支持部分Markdown语法)："</span>,</span><br><span class="line">	<span class="string">"空格缩进(两个或四个空格)、Tab键是保留字符，因此可以逐字粘贴源代码(回车请用Shift+Enter)。比如："</span>,</span><br><span class="line">	<span class="string">"``<span class="subst">`	# 这是代码</span>```"</span>,</span><br><span class="line">	<span class="string">"``<span class="subst">`	#!/bin/bash</span>```"</span>,</span><br><span class="line">	<span class="string">"``<span class="subst">`	echo hello</span>```"</span>,</span><br><span class="line">	<span class="string">"支持LaTeX语法(数学公式)，单行显示请用一个美元符号包围数学公式，多行显示(展示公式)请用两个美元符号包围。"</span>,</span><br><span class="line">	<span class="string">"单行：``<span class="subst">`$\\zeta(<span class="number">2</span>) = \\pi^<span class="number">2</span>/<span class="number">6</span>$</span>```  $\\zeta(2) = \\pi^2/6$"</span>,</span><br><span class="line">	<span class="string">"多行：``<span class="subst">`$$\\int<span class="number">_0</span>^<span class="number">1</span> \\int<span class="number">_0</span>^<span class="number">1</span> \\frac&#123;<span class="number">1</span>&#125;&#123;<span class="number">1</span>-xy&#125; dx dy = \\frac&#123;\\pi^<span class="number">2</span>&#125;&#123;<span class="number">6</span>&#125;$$</span>```  $$\\int_0^1 \\int_0^1 \\frac&#123;1&#125;&#123;1-xy&#125; dx dy = \\frac&#123;\\pi^2&#125;&#123;6&#125;$$"</span>,</span><br><span class="line">	<span class="string">"对于语法突出显示，将代码包装为：``<span class="subst">`&lt;language&gt; &lt;the code&gt;</span>```其中&lt;language&gt;是任何已知的编程语言。"</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"当前的Github代码仓库: https://github.com/hack-chat"</span>,</span><br><span class="line">	<span class="string">"旧版GitHub代码仓库: https://github.com/AndrewBelt/hack.chat"</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line"></span><br><span class="line">	<span class="string">"机器人，Android客户端，桌面客户端，浏览器扩展，Docker映像，编程库，服务器模块等:"</span>,</span><br><span class="line">	<span class="string">"https://github.com/hack-chat/3rd-party-software-list"</span>,</span><br><span class="line">	<span class="string">"根据WTFPL和MIT开源许可证发布的服务器和Web客户端。"</span>,</span><br><span class="line">	<span class="string">"hack.chat服务器不会保留任何聊天记录。"</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"Welcome to hack.chat, a minimal, distraction-free chat application."</span>,</span><br><span class="line">	<span class="string">"Channels are created, joined and shared with the url, create your own channel by changing the text after the question mark."</span>,</span><br><span class="line">	<span class="string">"If you wanted your channel name to be 'your-channel': https://hack.chat/?your-channel"</span>,</span><br><span class="line">	<span class="string">"There are no channel lists, so a secret channel name can be used for private discussions."</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"Here are some pre-made channels you can join:"</span>,</span><br><span class="line">	<span class="string">"?lounge ?meta"</span>,</span><br><span class="line">	<span class="string">"?math ?physics ?chemistry"</span>,</span><br><span class="line">	<span class="string">"?technology ?programming"</span>,</span><br><span class="line">	<span class="string">"?games ?banana"</span>,</span><br><span class="line">	<span class="string">"And here's a random one generated just for you: ?"</span> + Math.random().toString(<span class="number">36</span>).substr(<span class="number">2</span>, <span class="number">8</span>),</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"Formatting:"</span>,</span><br><span class="line">	<span class="string">"Whitespace is preserved, so source code can be pasted verbatim."</span>,</span><br><span class="line">	<span class="string">"Surround LaTeX with a dollar sign for inline style $\\zeta(2) = \\pi^2/6$, and two dollars for display. $$\\int_0^1 \\int_0^1 \\frac&#123;1&#125;&#123;1-xy&#125; dx dy = \\frac&#123;\\pi^2&#125;&#123;6&#125;$$"</span>,</span><br><span class="line">	<span class="string">"For syntax highlight, wrap the code like: ``<span class="subst">`&lt;language&gt; &lt;the code&gt;</span>``` where &lt;language&gt; is any known programming language."</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"Current Github: https://github.com/hack-chat"</span>,</span><br><span class="line">	<span class="string">"Legacy GitHub: https://github.com/AndrewBelt/hack.chat"</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"Bots, Android clients, desktop clients, browser extensions, docker images, programming libraries, server modules and more:"</span>,</span><br><span class="line">	<span class="string">"https://github.com/hack-chat/3rd-party-software-list"</span>,</span><br><span class="line">	<span class="string">""</span>,</span><br><span class="line">	<span class="string">"Server and web client released under the WTFPL and MIT open source license."</span>,</span><br><span class="line">	<span class="string">"No message history is retained on the hack.chat server."</span></span><br><span class="line">].join(<span class="string">"\n"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="Nginx反向代理配置"><a href="#Nginx反向代理配置" class="headerlink" title="Nginx反向代理配置"></a>Nginx反向代理配置</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hack chat</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">/hc</span>/ &#123;</span><br><span class="line">  <span class="comment">#rewrite /$1 ^/hackchat(.*);</span></span><br><span class="line">  proxy_pass http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3000</span>/;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">location</span> <span class="title">/hc-wss</span> &#123;</span><br><span class="line">  proxy_pass http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">6060</span>;</span><br><span class="line">  <span class="comment"># proxy_http_version 1.1;</span></span><br><span class="line">  <span class="comment"># proxy_set_header Upgrade $http_upgrade;</span></span><br><span class="line">  <span class="comment"># proxy_set_header Connection "Upgrade";</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/hack-chat/main.git</span><br><span class="line">mv main hackchat-main</span><br><span class="line"><span class="built_in">cd</span> hackchat-main</span><br><span class="line">npm install</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"#!/bin/bash</span></span><br><span class="line"><span class="string">cd [Path to hackchat] &amp;&amp; npm start"</span> &gt; hc_start.sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"#!/bin/bash</span></span><br><span class="line"><span class="string">cd [Path to hackchat] &amp;&amp; npm stop"</span> &gt; hc_stop.sh</span><br><span class="line">sudo <span class="built_in">echo</span> <span class="string">"[Unit]</span></span><br><span class="line"><span class="string">Description=Hackchat</span></span><br><span class="line"><span class="string">After=network.target </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=Path to /hackchat_srv/hc_start.sh</span></span><br><span class="line"><span class="string">ExecStop=Path to /hakchat_srv/hc_stop.sh</span></span><br><span class="line"><span class="string">Type=forking</span></span><br><span class="line"><span class="string">PrivateTmp=True</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">"</span> &gt; /lib/systemd/system/hackchat.service</span><br><span class="line">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure>
<h3 id="ISSO"><a href="#ISSO" class="headerlink" title="ISSO"></a>ISSO</h3><p><a href="https://isso-comments.de/" target="_blank" rel="noopener">官网</a> | <a href="https://posativ.org/isso/" target="_blank" rel="noopener">官网-OLD</a> | <a href="https://isso-cn.rtfd.vip/zh_CN/latest/docs/configuration/client/" target="_blank" rel="noopener">中文文档</a> | <a href="https://sb.sb/blog/debian-ubuntu-install-isso/" target="_blank" rel="noopener">参考自烧饼博客</a></p>
<blockquote>
<p>安装</p>
</blockquote>
<p>安装先决条件：<code>apt-get install python-dev build-essential python3-pip -y</code></p>
<p>装ISSO：<code>pip3 install --upgrade pip &amp;&amp; pip3 install isso</code></p>
<p>安装SQL Lite3：<code>apt-get install sqlite3</code></p>
<h4 id="新建ISSO配置"><a href="#新建ISSO配置" class="headerlink" title="新建ISSO配置"></a>新建ISSO配置</h4><p>新建配置文件<code>sudo nano /etc/isso.conf</code></p>
<figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[general]</span><br><span class="line">dbpath = /isso/comments.db</span><br><span class="line">name = <span class="keyword">default</span></span><br><span class="line">host = https:<span class="comment">//</span></span><br><span class="line">       https:<span class="comment">//</span></span><br><span class="line"><span class="meta">#notify = smtp</span></span><br><span class="line">log-file = /isso/isso.log</span><br><span class="line"></span><br><span class="line">[server]</span><br><span class="line">listen = http:<span class="comment">//localhost:20/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[moderation]</span></span><br><span class="line"><span class="meta">#enabled = true</span></span><br><span class="line"><span class="meta">#purge-after = 30d</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#[smtp]</span></span><br><span class="line"><span class="meta">#username = .com</span></span><br><span class="line"><span class="meta">#password = m</span></span><br><span class="line"><span class="meta">#host = 127.0.0.1</span></span><br><span class="line"><span class="meta">#port = 587</span></span><br><span class="line"><span class="meta">#security = starttls</span></span><br><span class="line"><span class="meta">#to = @.com</span></span><br><span class="line"><span class="meta">#from = "Isso Comment"&lt;username@example.com&gt;</span></span><br><span class="line"><span class="meta">#timeout = 10</span></span><br><span class="line"></span><br><span class="line">[markup]</span><br><span class="line">options = strikethrough, superscript, autolink</span><br><span class="line"></span><br><span class="line">[guard]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">ratelimit = <span class="number">5</span></span><br><span class="line">direct-reply = <span class="number">30</span></span><br><span class="line">reply-to-self = <span class="literal">true</span></span><br><span class="line">require-author = <span class="literal">true</span></span><br><span class="line">require-email = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">[hash]</span><br><span class="line">salt = Eech7co8Ohloopo9Ol6baimi</span><br><span class="line">algorithm = pbkdf2</span><br></pre></td></tr></table></figure>
<p><code>[general]</code> 是基本配置，必须填写</p>
<p><code>dbpath</code> 就是数据库文件，刚才我们已经建立了 <code>/var/lib/isso/</code> 目录，所以他会自动生成 *必填</p>
<p><code>name</code> 是这一个配置文件的名字，如果本地只搭建一个 Isso 的话可以忽略，搭建多个 Isso 的话需要设置 *可选</p>
<p><code>host</code> 是你引用 Isso 的 JS 的网站地址，需要写全，如果有多个的话就多加几行，只有一个域名的话留下一个即可 *必填</p>
<p><code>notify</code> 评论审核通知方式，如果不开启审核可以不设置，设置了 SMTP 就需要在下面的 <code>[smtp]</code> 设置邮件发送方式 *可选</p>
<p><code>log-file</code> 记录日志，后续我们会提到，一般不需要开启</p>
<p><code>[server]</code> 本地服务端设置</p>
<p><code>listen</code> 需要监听的端口，可以自定义，这里我们用 8090 为例</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[moderation]` 是否开启评论审核，不需要的话可以写 `enabled = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p><code>purge-after</code> 指定多少时间后删除还在审核队列里的评论</p>
<p><code>[markup]</code> 是 <a href="http://misaka.61924.nl/" target="_blank" rel="noopener">Misaka</a> Markdown 插件</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options` 可选 `strikethrough`, `superscript`, `autolink` 比如不需要自动加入超链接可以去掉 `autolink</span><br></pre></td></tr></table></figure>
<p><code>allowed-elements</code> 评论开启 HTML 标签，默认允许的标签有 <code>a</code>, <code>blockquote</code>, <code>br</code>, <code>code</code>, <code>del</code>, <code>em</code>, <code>h1</code>, <code>h2</code>, <code>h3</code>, <code>h4</code>, <code>h5</code>, <code>h6</code>, <code>hr</code>, <code>ins</code>, <code>li</code>, <code>ol</code>, <code>p</code>, <code>pre</code>, <code>strong</code>, <code>table</code>, <code>tbody</code>, <code>td</code>, <code>th</code>, <code>thead</code> 和 <code>ul</code> 可以根据自己情况修改</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">allowed-attributes` 评论开启 HTML 标签的属性，默认只允许 `align` 和 `href</span><br></pre></td></tr></table></figure>
<p><code>[smtp]</code> 审核评论发送邮件通知的设置，具体可以咨询你使用的邮件服务，按服务商提供的配置填写即可，不再详细描述</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[guard]` 开启评论防火墙，如不需要可以填写 `enabled = <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p><code>ratelimit</code> 每个访客一分钟最多可以评论的次数</p>
<p><code>direct-reply</code> 评论回复次数</p>
<p><code>reply-to-self</code> 是否可以回复自己的评论，需要配合 JS 引用，下面会说</p>
<p><code>require-author</code> 是否要求写名字，需要配合 JS 引用，下面会说</p>
<p><code>require-email</code> 是否要求写 Email 地址，需要配合 JS 引用，下面会说</p>
<p><code>[hash]</code> 加密评论的身份方式，如 Email 地址，没有特殊需求可以忽略</p>
<h4 id="Nginx代理"><a href="#Nginx代理" class="headerlink" title="Nginx代理"></a>Nginx代理</h4><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># isso 评论系统</span></span><br><span class="line">  location /<span class="function"><span class="keyword">sub</span> </span>&#123;</span><br><span class="line">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    proxy_set_header X-Script-Name /<span class="function"><span class="keyword">sub</span></span>;</span><br><span class="line">    proxy_set_header Host $host;</span><br><span class="line">    proxy_set_header X-Forwarded-Proto $scheme;</span><br><span class="line">    proxy_pass http:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0</span>.<span class="number">1</span>:port;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="引入代码"><a href="#引入代码" class="headerlink" title="引入代码"></a>引入代码</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;script <span class="attribute">data-isso</span>=<span class="string">"http://example.com/isso/"</span></span><br><span class="line">        <span class="attribute">data-isso-css</span>=<span class="string">"true"</span></span><br><span class="line">        <span class="attribute">data-isso-lang</span>=<span class="string">"en"</span></span><br><span class="line">        <span class="attribute">data-isso-reply-to-self</span>=<span class="string">"false"</span></span><br><span class="line">        <span class="attribute">data-isso-require-author</span>=<span class="string">"false"</span></span><br><span class="line">        <span class="attribute">data-isso-require-email</span>=<span class="string">"false"</span></span><br><span class="line">        <span class="attribute">data-isso-max-comments-top</span>=<span class="string">"10"</span></span><br><span class="line">        <span class="attribute">data-isso-max-comments-nested</span>=<span class="string">"5"</span></span><br><span class="line">        <span class="attribute">data-isso-reveal-on-click</span>=<span class="string">"5"</span></span><br><span class="line">        <span class="attribute">data-isso-avatar</span>=<span class="string">"true"</span></span><br><span class="line">        <span class="attribute">data-isso-avatar-bg</span>=<span class="string">"#f0f0f0"</span></span><br><span class="line">        <span class="attribute">data-isso-avatar-fg</span>=<span class="string">"#9abf88 #5698c4 #e279a3 #9163b6 ..."</span></span><br><span class="line">        <span class="attribute">data-isso-vote</span>=<span class="string">"true"</span></span><br><span class="line">        <span class="attribute">data-vote-levels</span>=<span class="string">""</span></span><br><span class="line">        <span class="attribute">src</span>=<span class="string">"http://example.com/isso/js/embed.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;section <span class="attribute">id</span>=<span class="string">"isso-thread"</span>&gt;&lt;/section&gt;</span><br></pre></td></tr></table></figure>
<p><code>data-isso</code> Isso 安装的 URI</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">data</span><span class="params">-isso</span><span class="params">-css</span><span class="string">` 使用默认的 CSS 如果需要自己改 CSS 则设置成 `</span><span class="literal">false</span></span><br></pre></td></tr></table></figure>
<p><code>data-isso-lang</code> 默认语言，参考 <a href="https://zh.wikipedia.org/wiki/ISO_639-1" target="_blank" rel="noopener">ISO 639-1</a> 编码，可选语言列表在<a href="https://github.com/posativ/isso/tree/master/isso/js/app/i18n" target="_blank" rel="noopener">这儿</a></p>
<p><code>data-isso-reply-to-self</code>，<code>data-isso-require-author</code>，<code>data-isso-require-email</code> 需按照 Isso 配置文件来，请保持一致</p>
<p><code>data-isso-max-comments-top</code> 一页显示的评论数</p>
<p><code>data-isso-max-comments-nested</code> 最多嵌套评论数</p>
<p><code>data-isso-reveal-on-click</code> 超出评论数后点击显示的评论数</p>
<p><code>data-isso-avatar</code> 显示头像</p>
<p><code>data-isso-avatar-bg</code> 头像背景</p>
<p><code>data-isso-avatar-fg</code> 头像颜色</p>
<p><code>data-isso-vote</code> 开启评论的支持和反对</p>
<p><code>data-vote-levels</code> 评论支持和反对的等级算法，具体请参考官方的文档</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update &amp;&amp; sudo apt upgrade</span><br><span class="line">sudo apt-<span class="builtin-name">get</span> install python-dev build-essential python3-pip -y</span><br><span class="line">pip3 install --upgrade pip &amp;&amp; pip3 install isso</span><br><span class="line">sudo apt-<span class="builtin-name">get</span> install sqlite3</span><br></pre></td></tr></table></figure>
<h3 id="JAMS——Jami-Server"><a href="#JAMS——Jami-Server" class="headerlink" title="JAMS——Jami Server"></a>JAMS——Jami Server</h3><blockquote>
<p>Jami是一款跨平台聊天软件</p>
</blockquote>
<p>官网：<a href="https://jami.net/" target="_blank" rel="noopener">https://jami.net/</a>  JAMS：<a href="https://jami.biz/" target="_blank" rel="noopener">https://jami.biz/</a>  JAMS下载：<a href="https://dl.jami.net/jams/jams.tar" target="_blank" rel="noopener">https://dl.jami.net/jams/jams.tar</a></p>
<p>下载：<code>wget https://dl.jami.net/jams/jams.tar</code></p>
<p>解压：<code>tar -xvf jams.tar</code></p>
<p>生成SSL证书(非必选)：<code>openssl req -newkey rsa:2048 -new -nodes -x509 -days 3650 -keyout server.key -out server.pem</code></p>
<p>运行：<code>java -jar jams-launcher.jar PORT_NUMBER (eg. 8443 or 443) server.pem server.key</code></p>
<p>设置服务：<code>sudo nano /lib/systemd/system/jams.service</code></p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Service] </span><br><span class="line"><span class="attribute">Type</span>=simple </span><br><span class="line">WorkingDirectory=[DIRECTORY WHERE JAMS WAS UNZIPPED] </span><br><span class="line"><span class="attribute">ExecStart</span>=/usr/bin/java -jar [DIRECTORY WHERE JAMS WAS UNZIPPED]/jams-launcher.jar<span class="built_in"> PORT </span>SSL_CERTIFICATE SSL_CERTIFICATE_KEY</span><br><span class="line"></span><br><span class="line">[Install] </span><br><span class="line"><span class="attribute">WantedBy</span>=multi-user.target </span><br><span class="line"><span class="comment"># The parameters PORT, SSL_CERTIFICATE and SSL_CERTIFICATE_KEY are optional (however, </span></span><br><span class="line"><span class="comment"># PORT can be used alone whereas the SSL_CERTIFICATE comes in pair with </span></span><br><span class="line"><span class="comment"># SSL_CERTIFICATE_KEY)</span></span><br></pre></td></tr></table></figure>
<p>配置Nginx代理：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123; </span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">  <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl; </span><br><span class="line">  <span class="attribute">ssl</span> <span class="literal">on</span>; </span><br><span class="line">  <span class="attribute">ssl_certificate</span> /etc/certificates/mycertificate.pem </span><br><span class="line">  ssl_certificate_key /etc/certificates/mycertificatekey.pem </span><br><span class="line">  client_max_body_size <span class="number">100M</span>; <span class="attribute">server_name</span> jams.mycompany.com; </span><br><span class="line">  <span class="attribute">location</span> / &#123; </span><br><span class="line">    <span class="attribute">proxy_pass</span> http://10.10.0.1:8080/; </span><br><span class="line">    <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>; </span><br><span class="line">    <span class="attribute">proxy_set_header</span> Host <span class="variable">$http_host</span>; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Jitsi-Meet"><a href="#Jitsi-Meet" class="headerlink" title="Jitsi-Meet"></a>Jitsi-Meet</h3><blockquote>
<p>Jitsi-Meet是开源在线会议</p>
<p><a href="https://jitsi.org/" target="_blank" rel="noopener">官网</a>  <a href="https://jitsi.github.io/handbook/docs/intro" target="_blank" rel="noopener">手册</a>  <a href="https://meet.jit.si/" target="_blank" rel="noopener">在线会议</a></p>
</blockquote>
<h4 id="配置需求"><a href="#配置需求" class="headerlink" title="配置需求"></a>配置需求</h4><ul>
<li><strong>网络环境</strong>：基本的速度和可靠性是必不可少的。  使用任何下载工具（或 ftp）检查提供商声称的速度，以及 使用 <code>iperf3</code> 等工具验证延迟。 精确的计算非常复杂，并且依赖于许多优化和技巧，但您至少应该记住这些关于分辨率的数字： <code>180 = 200 比特/秒</code>、 <code>360 = 500 比特/秒</code>、 <code>720（高清）= 2500 kbits/s</code> 、<code>4k = 10 兆比特/秒</code>。 所以不要指望有 20 个用户在 <code>100Mbits/s</code> 上传和下载的服务器上使用 4K。 对于小型组织服务器，<code>1 Gbits/s</code> 通常就足够了，但对于大型服务器 <code>10 Gbits/s</code> 是可取的。  大型部署使用几个（或许多…）网桥，每个网桥都有一个 <code>10 Gbits/s</code> 的链路。 </li>
<li><p><strong>RAM：</strong> 通常建议获得 <code>8 GB</code>。   对于小型会议，您可以使用 <code>4 GB</code>，对于测试服务器或非常小的会议，您可以尝试使用 <code>2 GB</code>。   对于大型会议，建议采用可扩展的方式来获取大量内存。 </p>
</li>
<li><p><strong>CPU：</strong> 非常低的处理器性能会严重损害实时系统，尤其是在使用共享服务器时（您的 CPU 性能可能会被主机的其他客户窃取，如果您获得的是 VPS，请检查“专用 CPU”，而不是物理服务器）。   但是，需要考虑的是  Jitsi Meet 组件 Prosody 只能使用一 (1) 个核心。   所以获得很多核心，比方说超过 32 个，并不总是有用。    对于基本服务器，4 个专用内核就足够了。 </p>
</li>
<li><strong>磁盘：</strong> 除非您正在进行大量日志记录或有非常特殊的需求，否则您可以使用 20 GB 的标准硬盘。   SSD 与其说是必需品，不如说是锦上添花。 </li>
</ul>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>推荐使用Docker安装，手动构建可能出现依赖冲突问题</p>
<h5 id="Docker-1"><a href="#Docker-1" class="headerlink" title="Docker"></a>Docker</h5><p>注意：<strong>DO NOT</strong> clone the git repository. <strong>不要克隆仓库</strong>！</p>
<p>直接去<a href="https://github.com/jitsi/docker-jitsi-meet/releases" target="_blank" rel="noopener">Release</a>下载发布，解压。</p>
<ol>
<li><p>生成配置文件<code>cp env.example .env</code>，并自行修改配置文件(<code>TZ</code>，<code>HTTP_PORT</code>，<code>HTTPS_PORT</code>，<code>DOCKER_HOST_ADDRESS</code>，<code>PUBLIC_URL</code>)。</p>
</li>
<li><p>生成随机密码<code>./gen-passwords.sh</code></p>
</li>
<li><p>创建文件夹<code>mkdir -p ~/.jitsi-meet-cfg/{web,transcripts,prosody/config,prosody/prosody-plugins-custom,jicofo,jvb,jigasi,jibri}</code></p>
</li>
<li><p>运行、启动：<code>docker-compose up -d</code></p>
</li>
<li><p>开放防火墙端口：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">80</span>/tcp <span class="keyword">for</span> Web UI HTTP (really just to redirect, after uncommenting ENABLE_HTTP_REDIRECT=<span class="number">1</span> <span class="keyword">in</span> .env)</span><br><span class="line"><span class="number">443</span>/tcp <span class="keyword">for</span> Web UI HTTPS</span><br><span class="line"><span class="number">4443</span>/tcp <span class="keyword">for</span> RTP media over TCP</span><br><span class="line"><span class="number">10000</span>/udp <span class="keyword">for</span> RTP media over UDP</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置nginx：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /xmpp-websocket &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> https://localhost:8443;</span><br><span class="line">    <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> /colibri-ws &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> https://localhost:8443;</span><br><span class="line">    <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者Apache2</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">&lt;IfModule mod_proxy.c&gt;</span></span><br><span class="line">    <span class="section">&lt;IfModule mod_proxy_wstunnel.c&gt;</span></span><br><span class="line">        <span class="attribute">ProxyTimeout</span> 900</span><br><span class="line">        <span class="section">&lt;Location "/xmpp-websocket"&gt;</span></span><br><span class="line">            <span class="attribute">ProxyPass</span> <span class="string">"wss://localhost:8443/xmpp-websocket"</span></span><br><span class="line">        <span class="section">&lt;/Location&gt;</span></span><br><span class="line">        <span class="section">&lt;Location "/colibri-ws/"&gt;</span></span><br><span class="line">            <span class="attribute">ProxyPass</span> <span class="string">"wss://localhost:8443/colibri-ws/"</span></span><br><span class="line">        <span class="section">&lt;/Location&gt;</span></span><br><span class="line">    <span class="section">&lt;/IfModule&gt;</span></span><br><span class="line"><span class="section">&lt;/IfModule&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="Debian"><a href="#Debian" class="headerlink" title="Debian"></a>Debian</h5><blockquote>
<p>安装前建议只保留一个HTTP服务器，nginx、apache2只留一个。</p>
</blockquote>
<ol>
<li><p>更新apt</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Retrieve the latest package versions across all repositories</span></span><br><span class="line">sudo apt update</span><br><span class="line"></span><br><span class="line"><span class="comment"># Ensure support for apt repositories served via HTTPS</span></span><br><span class="line">sudo apt install apt-transport-https</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置主机名<code>sudo hostnamectl set-hostname meet.example.org</code></p>
</li>
<li><p>设置<code>/etc/hosts</code></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span> <span class="selector-tag">localhost</span></span><br><span class="line"><span class="selector-tag">x</span><span class="selector-class">.x</span><span class="selector-class">.x</span><span class="selector-class">.x</span> <span class="selector-tag">meet</span><span class="selector-class">.example</span><span class="selector-class">.org</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加Jitsi-meet仓库</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 安装<span class="keyword">lua</span>(可选)</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">deb</span> http://packages.prosody.<span class="keyword">im</span>/debian $(lsb_release -sc) main | sudo tee -<span class="keyword">a</span> /etc/apt/sources.<span class="keyword">list</span></span><br><span class="line">wget http<span class="variable">s:</span>//prosody.<span class="keyword">im</span>/<span class="keyword">files</span>/prosody-debian-packages.key -O- | sudo apt-key <span class="built_in">add</span> -</span><br><span class="line">apt install lua5.<span class="number">2</span></span><br><span class="line"></span><br><span class="line"># 添加Jitsi仓库</span><br><span class="line">curl http<span class="variable">s:</span>//download.jitsi.org/jitsi-key.gpg.key | sudo <span class="keyword">sh</span> -<span class="keyword">c</span> <span class="string">'gpg --dearmor &gt; /usr/share/keyrings/jitsi-keyring.gpg'</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'deb [signed-by=/usr/share/keyrings/jitsi-keyring.gpg] https://download.jitsi.org stable/'</span> | sudo tee /etc/apt/sources.<span class="keyword">list</span>.d/jitsi-stable.<span class="keyword">list</span> &gt; /dev/null</span><br></pre></td></tr></table></figure>
</li>
<li><p>打开防火墙</p>
<ul>
<li><code>80 TCP</code> =&gt; For SSL certificate verification / renewal with Let’s Encrypt. <strong>Required</strong></li>
<li><code>443 TCP</code> =&gt; For general access to Jitsi Meet. <strong>Required</strong></li>
<li><code>10000 UDP</code> =&gt; For General Network Audio/Video Meetings. <strong>Required</strong></li>
<li><code>22 TCP</code> =&gt; For Accessing your Server using SSH (change the port accordingly if it’s not 22). <strong>Required</strong></li>
<li><code>3478 UDP</code> =&gt; For querying the stun server (coturn, optional, needs <code>config.js</code> change to enable it).</li>
<li><code>5349 TCP</code> =&gt; For fallback network video/audio communications over TCP (when UDP is blocked for example), served by coturn. <strong>Required</strong></li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">sudo</span> <span class="string">ufw allow 80/tcp</span></span><br><span class="line"><span class="attr">sudo</span> <span class="string">ufw allow 443/tcp</span></span><br><span class="line"><span class="attr">sudo</span> <span class="string">ufw allow 10000/udp</span></span><br><span class="line"><span class="attr">sudo</span> <span class="string">ufw allow 22/tcp</span></span><br><span class="line"><span class="attr">sudo</span> <span class="string">ufw allow 3478/udp</span></span><br><span class="line"><span class="attr">sudo</span> <span class="string">ufw allow 5349/tcp</span></span><br><span class="line"><span class="attr">sudo</span> <span class="string">ufw enable</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装Jitsi-Meet，会询问问题，需要回答问题才能继续安装：<code>sudo apt update &amp;&amp; sudo apt install jitsi-meet</code></p>
</li>
<li><p>(可选)<strong>Systemd/Limits</strong>:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Default deployments on systems using systemd will have low<span class="built_in"> default </span>values <span class="keyword">for</span> maximum processes <span class="keyword">and</span> open files. <span class="keyword">If</span> the used<span class="built_in"> bridge </span>will expect higher number of participants the<span class="built_in"> default </span>values need <span class="keyword">to</span> be adjusted (the<span class="built_in"> default </span>values are good <span class="keyword">for</span> less than 100 participants).</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span> update the values <span class="builtin-name">edit</span> /etc/systemd/system.conf <span class="keyword">and</span> make sure you have the following values <span class="keyword">if</span> values are smaller, <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">do</span> <span class="keyword">not</span> update.</span><br><span class="line"></span><br><span class="line"><span class="attribute">DefaultLimitNOFILE</span>=65000</span><br><span class="line"><span class="attribute">DefaultLimitNPROC</span>=65000</span><br><span class="line"><span class="attribute">DefaultTasksMax</span>=65000</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span> check values just run:</span><br><span class="line"></span><br><span class="line">systemctl show --property DefaultLimitNPROC</span><br><span class="line">systemctl show --property DefaultLimitNOFILE</span><br><span class="line">systemctl show --property DefaultTasksMax</span><br></pre></td></tr></table></figure>
</li>
<li><p>同理，nginx配置文件需要检查一下(按道理安装的时候就自动配置好了)</p>
</li>
<li><p>(卸载)如果你不想要Jitsi-meet了，卸载请用：<code>sudo apt purge jigasi jitsi-meet jitsi-meet-web-config jitsi-meet-prosody jitsi-meet-turnserver jitsi-meet-web jicofo jitsi-videobridge2</code></p>
</li>
</ol>
<p>完整的<code>jitsi-meet nginx</code>配置文件看起来可能是：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># generated 2021-03-20, Mozilla Guideline v5.6, nginx 1.14.2, OpenSSL 1.1.1d, modern configuration</span></span><br><span class="line"><span class="comment"># https://ssl-config.mozilla.org/#server=nginx&amp;version=1.14.2&amp;config=modern&amp;openssl=1.1.1d&amp;guideline=5.6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rewrite module from firefox ssl config generator</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span> default_server;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">80</span> default_server;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">301</span> https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">  <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl http2;</span><br><span class="line">  <span class="comment">#域名</span></span><br><span class="line">  <span class="attribute">server_name</span> jitsi.name;</span><br><span class="line">  <span class="comment"># index index.html index.htm index.php;</span></span><br><span class="line">  <span class="comment">#站点目录</span></span><br><span class="line">  <span class="comment"># root /home/nginx/; </span></span><br><span class="line">  <span class="comment">#错误页</span></span><br><span class="line">  <span class="comment"># error_page 301 302 403 404 502 /404.html; #错误</span></span><br><span class="line">  <span class="attribute">access_log</span> /Logs/nginx/<span class="number">443</span>-access.log; </span><br><span class="line">  <span class="attribute">error_log</span> /Logs/nginx/<span class="number">443</span>-<span class="literal">error</span>.log;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> https://127.0.0.1:8443;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">location</span> /xmpp-websocket &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> https://localhost:8443;</span><br><span class="line">    <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">location</span> /colibri-ws &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> https://localhost:8443;</span><br><span class="line">    <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Upgrade <span class="variable">$http_upgrade</span>;</span><br><span class="line">    <span class="attribute">proxy_set_header</span> Connection <span class="string">"upgrade"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">ssl_certificate</span> /etc/ssl/jitsi.pem;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /etc/ssl/jitsi.key;</span><br><span class="line">  <span class="attribute">ssl_session_timeout</span> <span class="number">180m</span>;</span><br><span class="line">  <span class="attribute">ssl_session_cache</span> shared:MozSSL:<span class="number">10m</span>;  <span class="comment"># about 40000 sessions</span></span><br><span class="line">  <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># modern configuration</span></span><br><span class="line">  <span class="comment">#ssl_protocols TLSv1.3;</span></span><br><span class="line">  <span class="comment">#ssl_prefer_server_ciphers off;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ali_cloud_config</span></span><br><span class="line">  <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>; <span class="comment">#表示使用的TLS协议的类型。</span></span><br><span class="line">  <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4; <span class="comment">#表示使用的加密套件的类型。</span></span><br><span class="line">  <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># HSTS (ngx_http_headers_module is required) (63072000 seconds)</span></span><br><span class="line">  <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">"max-age=63072000"</span> always;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># OCSP stapling</span></span><br><span class="line">  <span class="comment"># ssl_stapling on; # 启用OCSP响应验证，OCSP信息响应适用的证书</span></span><br><span class="line">  <span class="comment"># ssl_stapling_verify on;</span></span><br><span class="line">  <span class="comment"># verify chain of trust of OCSP response using Root CA and Intermediate certs</span></span><br><span class="line">  <span class="comment"># ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;</span></span><br><span class="line">  <span class="comment"># replace with the IP address of your resolver</span></span><br><span class="line">  <span class="comment"># resolver 127.0.0.1;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 其他目录</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">  <span class="attribute">listen</span> <span class="number">200</span> ssl http2;</span><br><span class="line">  <span class="attribute">listen</span> [::]:<span class="number">200</span> ssl http2;</span><br><span class="line">  <span class="attribute">server_name</span> jitsi.name;<span class="comment">#域名</span></span><br><span class="line">  <span class="attribute">index</span> index.html index.htm index.php;</span><br><span class="line">  <span class="attribute">root</span> /home/nginx/;<span class="comment">#站点目录</span></span><br><span class="line"></span><br><span class="line">  <span class="attribute">access_log</span>  /Logs/nginx/<span class="number">200</span>-access.log;</span><br><span class="line">  <span class="attribute">error_log</span>   /Logs/nginx/<span class="number">200</span>-<span class="literal">error</span>.log;  </span><br><span class="line">  </span><br><span class="line">  <span class="comment"># 用户分享的文件</span></span><br><span class="line">  <span class="attribute">location</span>  / &#123;</span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">autoindex_exact_size</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">autoindex_localtime</span> <span class="literal">off</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">ssl_certificate</span> /etc/ssl/jitsi.pem;</span><br><span class="line">  <span class="attribute">ssl_certificate_key</span> /etc/ssl/jitsi.key;</span><br><span class="line">  <span class="attribute">ssl_session_timeout</span> <span class="number">180m</span>;</span><br><span class="line">  <span class="attribute">ssl_session_cache</span> shared:MozSSL:<span class="number">10m</span>;  <span class="comment"># about 40000 sessions</span></span><br><span class="line">  <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># modern configuration</span></span><br><span class="line">  <span class="comment">#ssl_protocols TLSv1.3;</span></span><br><span class="line">  <span class="comment">#ssl_prefer_server_ciphers off;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># ali_cloud_config</span></span><br><span class="line">  <span class="attribute">ssl_protocols</span> TLSv1 TLSv1.<span class="number">1</span> TLSv1.<span class="number">2</span>; <span class="comment">#表示使用的TLS协议的类型。</span></span><br><span class="line">  <span class="attribute">ssl_ciphers</span> ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4; <span class="comment">#表示使用的加密套件的类型。</span></span><br><span class="line">  <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Linx-server"><a href="#Linx-server" class="headerlink" title="Linx-server"></a>Linx-server</h3><blockquote>
<p>文件共享服务器，使用Go语言编写，需要自行编译。</p>
<p>此 文件共享服务器是限时分享，超时文件将被销毁。</p>
</blockquote>
<p><strong>功能：</strong></p>
<ol>
<li>文件共享</li>
<li>命令行上传（API）</li>
<li>多平台客户端（Windows、Linux、Android），客户端链接见文末</li>
<li>临时文件共享(无需登录)</li>
<li>限时文件共享(可设置文件共享时长，超时文件销毁)</li>
<li>支持鉴权，API Key登录</li>
<li>文件大小限制</li>
<li>支持文件预览</li>
<li>代码共享</li>
<li>支持配置访问密码</li>
<li>支持生成种子下载</li>
</ol>
<p><strong>客户端：</strong></p>
<ul>
<li>CLI: <strong>linx-client</strong> - <a href="https://github.com/andreimarcu/linx-client" target="_blank" rel="noopener">Source</a></li>
<li>Android: <strong>LinxShare</strong> - <a href="https://github.com/iksteen/LinxShare/" target="_blank" rel="noopener">Source</a> | <a href="https://play.google.com/store/apps/details?id=org.thegraveyard.linxshare" target="_blank" rel="noopener">Google Play</a></li>
<li>CLI: <strong>golinx</strong> - <a href="https://github.com/mutantmonkey/golinx" target="_blank" rel="noopener">Source</a></li>
</ul>
<h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><p>首先安装<code>golang</code>、<code>acl</code>、<code>git</code></p>
<p>克隆仓库：<code>git clone https://github.com/ZizzyDizzyMC/linx-server.git</code></p>
<p><code>cd linx-server</code></p>
<p>编译三个文件：</p>
<p>主文件：<code>go build</code></p>
<p>其他文件：分别进入<code>linx-genkey</code>和<code>linx-cleanup</code>文件夹中执行<code>go build</code></p>
<p>配置文件<code>linx-server.conf</code>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">bind</span> = <span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span></span><br><span class="line"><span class="attr">sitename</span> = File Sharing</span><br><span class="line"><span class="attr">siteurl</span> = https://yourdomain/</span><br><span class="line"><span class="attr">selifpath</span> = s</span><br><span class="line"><span class="attr">maxsize</span> = <span class="number">4294967296</span></span><br><span class="line"><span class="attr">maxexpiry</span> = <span class="number">86400</span></span><br><span class="line"><span class="attr">allowhotlink</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">remoteuploads</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">nologs</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">force-random-filename</span> = <span class="literal">false</span></span><br><span class="line"><span class="attr">cleanup-every-minutes</span> = <span class="number">5</span></span><br><span class="line"><span class="attr">realip</span> = <span class="literal">true</span></span><br><span class="line"><span class="attr">fastcgi</span> = <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<p>nginx配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl http2;   </span><br><span class="line">    <span class="attribute">root</span> /file-sharing;</span><br><span class="line">    <span class="attribute">index</span> index.html index.htm index.nginx-debian.html;</span><br><span class="line">    <span class="attribute">server_name</span> yours;</span><br><span class="line">    <span class="attribute">client_max_body_size</span> <span class="number">4096M</span>;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">fastcgi_pass</span> <span class="number">127.0.0.1:8000</span>;</span><br><span class="line">        <span class="attribute">include</span> fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/ssl/xxx.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/ssl/xxx.key;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:MozSSL:<span class="number">10m</span>;  <span class="comment"># about 40000 sessions</span></span><br><span class="line">    <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">"max-age=63072000"</span> always;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行：<code>./linx-server -config linx-server.conf</code></p>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><ul>
<li>files——上传的文件</li>
<li>linx-cleanup——清理过期文件</li>
<li>linx-genkey——API Key</li>
<li>linx-server——主文件</li>
<li>linx-server.conf——配置文件</li>
<li>meta——过期的文件</li>
</ul>
<h4 id="自定义主页"><a href="#自定义主页" class="headerlink" title="自定义主页"></a>自定义主页</h4><p>修改<code>templates</code>文件夹中的文件后运行<code>go build</code>，然后替换主文件即可。</p>
<h4 id="关于写入权限"><a href="#关于写入权限" class="headerlink" title="关于写入权限"></a>关于写入权限</h4><p>注意运行的时候用的<code>www-data</code>用户，所以如果目录<code>www-data</code>用户访问不了，无法写入的，自然上传失败</p>
<h3 id="Matterbridge"><a href="#Matterbridge" class="headerlink" title="Matterbridge"></a>Matterbridge</h3><blockquote>
<p>桥接Telegram 和 IRC</p>
<p>Telegram机器人要自己申请，然后<strong>关闭机器人隐私模式</strong>(privacy mode)</p>
<p>截至2022年12月支持<code>mattermost, IRC, gitter, xmpp, slack, discord, telegram, rocketchat,  twitch, ssh-chat, zulip, whatsapp, keybase, matrix, microsoft teams,  nextcloud, mumble, vk</code>等。</p>
<p><a href="https://github.com/42wim/matterbridge/" target="_blank" rel="noopener">仓库</a></p>
</blockquote>
<h4 id="下载和安装"><a href="#下载和安装" class="headerlink" title="下载和安装"></a>下载和安装</h4><p>直接<a href="https://github.com/42wim/matterbridge/releases" target="_blank" rel="noopener">下载</a>可执行文件</p>
<p>如：<code>wget -O matterbridge-linux https://github.com/42wim/matterbridge/releases/download/v1.25.2/matterbridge-1.25.2-linux-64bit</code></p>
<h4 id="配置文件matterbridge-toml"><a href="#配置文件matterbridge-toml" class="headerlink" title="配置文件matterbridge.toml"></a>配置文件<code>matterbridge.toml</code></h4><blockquote>
<p>所有配置参见<a href="https://github.com/42wim/matterbridge/wiki" target="_blank" rel="noopener">Wiki</a></p>
</blockquote>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[general]</span></span><br><span class="line"><span class="comment"># 如果你有配置媒体服务器的话 https://github.com/42wim/matterbridge/wiki/Mediaserver-setup-%28advanced%29</span></span><br><span class="line"><span class="attr">MediaDownloadPath</span>=<span class="string">"/nginx/matterbridge"</span></span><br><span class="line"><span class="attr">MediaServerDownload</span>=<span class="string">"https://media/matterbridge"</span></span><br><span class="line"><span class="comment"># 日志文件</span></span><br><span class="line"><span class="attr">LogFile</span>=<span class="string">"/Logs/matterbridge/matterbridge.log"</span></span><br><span class="line"><span class="comment"># ShowJoinPart=true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[telegram.mytelegram]</span></span><br><span class="line"><span class="comment">#See https://core.telegram.org/bots#6-botfather </span></span><br><span class="line"><span class="comment">#and https://www.linkedin.com/pulse/telegram-bots-beginners-marco-frau</span></span><br><span class="line"><span class="comment"># 你的机器人Token</span></span><br><span class="line"><span class="attr">Token</span>=<span class="string">""</span></span><br><span class="line"><span class="attr">RemoteNickFormat</span>=<span class="string">"(&#123;PROTOCOL&#125;) &#123;NICK&#125; "</span></span><br><span class="line"><span class="attr">MessageFormat</span>=<span class="string">"HTMLNick"</span></span><br><span class="line"><span class="comment"># QuoteLengthLimit=5000</span></span><br><span class="line"><span class="comment"># Don't bridge bot commands (as the responses will not be bridged)</span></span><br><span class="line"><span class="comment"># IgnoreMessages="^/"</span></span><br><span class="line"></span><br><span class="line"><span class="section">[irc.myirc]</span></span><br><span class="line"><span class="comment"># 如果你是Libera IRC的话</span></span><br><span class="line"><span class="attr">Server</span>=<span class="string">"irc.libera.chat:6697"</span></span><br><span class="line"><span class="comment"># 你的昵称</span></span><br><span class="line"><span class="attr">Nick</span>=<span class="string">"nickname"</span></span><br><span class="line"><span class="attr">UseTLS</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">RemoteNickFormat</span>=<span class="string">"[&#123;PROTOCOL&#125;] &lt;&#123;NICK&#125;&gt; "</span></span><br><span class="line"><span class="attr">RejoinDelay</span>=<span class="number">4</span></span><br><span class="line"><span class="attr">ColorNicks</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment"># Flood control. Delay in milliseconds between each message send to the IRC server.</span></span><br><span class="line"><span class="attr">MessageDelay</span>=<span class="number">1500</span></span><br><span class="line"><span class="comment"># 长消息分段</span></span><br><span class="line"><span class="attr">MessageSplit</span>=<span class="literal">true</span></span><br><span class="line"><span class="comment"># MessageClipped="&lt;Next Msg&gt;"</span></span><br><span class="line"><span class="attr">MessageClipped</span>=<span class="string">"          "</span></span><br><span class="line"><span class="comment"># 消息队列(长消息支持)</span></span><br><span class="line"><span class="attr">MessageQueue</span>=<span class="number">1000</span></span><br><span class="line"><span class="comment"># NickServNick="nickserv"</span></span><br><span class="line"><span class="comment"># NickServPassword="secret"</span></span><br><span class="line"><span class="comment"># NickServUsername="username"</span></span><br><span class="line"><span class="comment"># UseSASL=true</span></span><br><span class="line"><span class="comment"># VerboseJoinPart=true</span></span><br><span class="line"><span class="attr">Charset</span>=<span class="string">"utf-8"</span></span><br><span class="line"><span class="comment"># IgnoreMessages="^~~ badword"</span></span><br><span class="line"><span class="comment"># NoSendJoinPart=false</span></span><br><span class="line"><span class="comment"># IgnoreNicks="ircspammer1 ircspammer2"</span></span><br><span class="line"><span class="comment"># JoinDelay=1000</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">[[gateway]]</span></span><br><span class="line"><span class="attr">name</span>=<span class="string">"gateway-irc-tg"</span></span><br><span class="line"><span class="attr">enable</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># IRC Gateway</span></span><br><span class="line"><span class="section">[[gateway.inout]]</span></span><br><span class="line"><span class="attr">account</span>=<span class="string">"irc.myirc"</span></span><br><span class="line"><span class="comment"># 要加入的频道名称</span></span><br><span class="line"><span class="attr">channel</span>=<span class="string">"#channel"</span></span><br><span class="line"><span class="comment"># options = &#123; key="password" &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Telegram Gateway</span></span><br><span class="line"><span class="section">[[gateway.inout]]</span></span><br><span class="line"><span class="attr">account</span>=<span class="string">"telegram.mytelegram"</span></span><br><span class="line"><span class="comment"># Telegram群组ID，一个负数</span></span><br><span class="line"><span class="attr">channel</span>=<span class="string">"-189174892374"</span></span><br></pre></td></tr></table></figure>
<h4 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h4><p>可以作为服务运行</p>
<p><code>start_matterbridge.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">cd</span> /path/to/Applications/matterbridge/</span><br><span class="line">./matterbridge-1.25.2-linux-64bit&amp;</span><br></pre></td></tr></table></figure>
<p><code>matterbridge.service</code></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Matterbridge服务</span><br><span class="line"><span class="attr">After</span>=network.target </span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStart</span>=/path/to/Applications/matterbridge/start_matterbridge.sh</span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">True</span></span><br><span class="line"><span class="attr">User</span>=User</span><br><span class="line">	</span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<h3 id="NGINX"><a href="#NGINX" class="headerlink" title="NGINX"></a>NGINX</h3><p>主配置<code>/etc/nginx/nginx.conf</code></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#### nginx配置</span></span><br><span class="line"><span class="comment"># nginx用户</span></span><br><span class="line"><span class="attribute">user</span> www-data;</span><br><span class="line"><span class="comment"># 工作核心数量</span></span><br><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="comment"># 指定nginx进程运行文件存放地址</span></span><br><span class="line"><span class="attribute">pid</span> /run/nginx.pid;</span><br><span class="line"><span class="comment"># 包含启用的模块</span></span><br><span class="line"><span class="attribute">include</span> /etc/nginx/modules-enabled/<span class="regexp">*.conf</span>;<span class="comment"># </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#制定日志路径，级别。这个设置可以放入全局块，http块，server块，级别以此为：debug|info|notice|warn|error|crit|alert|emerg</span></span><br><span class="line"><span class="attribute">error_log</span> /Logs/nginx/nginx_error.log <span class="literal">crit</span>; </span><br><span class="line"><span class="comment"># Specifies the value for maximum file descriptors that can be opened by this process.# nginx worker进程最大打开文件数</span></span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">4028</span>;</span><br><span class="line"></span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment"># 在linux下，nginx使用epoll的IO多路复用模型</span></span><br><span class="line">  <span class="attribute">use</span> <span class="literal">epoll</span>; </span><br><span class="line">  <span class="comment"># nginx worker单个进程允许的客户端最大连接数</span></span><br><span class="line">  <span class="attribute">worker_connections</span> <span class="number">1024</span>; </span><br><span class="line">  <span class="comment"># 设置网路连接序列化，防止惊群现象发生，默认为on.惊群现象：一个网路连接到来，多个睡眠的进程被同时叫醒，但只有一个进程能获得链接，这样会影响系统性能。</span></span><br><span class="line">  <span class="attribute">accept_mutex</span> <span class="literal">on</span>; </span><br><span class="line">  <span class="comment"># 设置一个进程是否同时接受多个网络连接，默认为off。如果web服务器面对的是一个持续的请求流，那么启用multi_accept可能会造成worker进程一次接受的请求大于worker_connections指定可以接受的请求数。这就是overflow，这个overflow会造成性能损失，overflow这部分的请求不会受到处理。</span></span><br><span class="line">  <span class="comment"># multi_accept on; </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">include</span> /etc/nginx/mime.types;</span><br><span class="line">  <span class="attribute">default_type</span> application/octet-stream;</span><br><span class="line">  <span class="attribute">log_format</span> main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">               <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">               <span class="string">'"<span class="variable">$http_user_agent</span>" <span class="variable">$http_x_forwarded_for</span>'</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># charset gb2312;</span></span><br><span class="line">  <span class="attribute">charset</span> utf-<span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">  <span class="attribute">limit_req_zone</span> <span class="variable">$binary_remote_addr</span> zone=one:<span class="number">10m</span> rate=1r/s;</span><br><span class="line">  </span><br><span class="line">  <span class="attribute">server_names_hash_bucket_size</span> <span class="number">128</span>;</span><br><span class="line">  <span class="comment"># server_name_in_redirect off;</span></span><br><span class="line">  <span class="attribute">client_header_buffer_size</span> <span class="number">32k</span>;</span><br><span class="line">  <span class="attribute">large_client_header_buffers</span> <span class="number">4</span> <span class="number">32k</span>;</span><br><span class="line">  <span class="comment"># 允许客户端请求的最大单文件字节数。如果有上传较大文件，请设置它的限制值</span></span><br><span class="line">  <span class="attribute">client_max_body_size</span> <span class="number">25m</span>; </span><br><span class="line">  </span><br><span class="line">  <span class="attribute">types_hash_max_size</span> <span class="number">2048</span>;</span><br><span class="line">  <span class="comment"># 禁用服务器版本显示</span></span><br><span class="line">  <span class="attribute">server_tokens</span> <span class="literal">off</span>;</span><br><span class="line">  <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="comment"># 只有sendfile开启模式下有效</span></span><br><span class="line">  <span class="attribute">tcp_nopush</span> <span class="literal">on</span>; </span><br><span class="line">  <span class="comment"># 长连接超时时间，单位是秒，这个参数很敏感，涉及浏览器的种类、后端服务器的超时设置、操作系统的设置，可以另外起一片文章了。长连接请求大量小文件的时候，可以减少重建连接的开销，但假如有大文件上传，65s内没上传完成会导致失败。如果设置时间过长，用户又多，长时间保持连接会占用大量资源。</span></span><br><span class="line">  <span class="attribute">keepalive_timeout</span> <span class="number">60</span>; </span><br><span class="line">  <span class="comment"># 设置客户端连接保持会话的超时时间，超过这个时间，服务器会关闭该连接。</span></span><br><span class="line">  <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>; </span><br><span class="line">  <span class="attribute">fastcgi_connect_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="attribute">fastcgi_send_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="attribute">fastcgi_read_timeout</span> <span class="number">300</span>;</span><br><span class="line">  <span class="attribute">fastcgi_buffer_size</span> <span class="number">64k</span>;</span><br><span class="line">  <span class="attribute">fastcgi_buffers</span> <span class="number">4</span> <span class="number">64k</span>;</span><br><span class="line">  <span class="attribute">fastcgi_busy_buffers_size</span> <span class="number">128k</span>;</span><br><span class="line">  <span class="attribute">fastcgi_temp_file_write_size</span> <span class="number">128k</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">#limit_zone crawler $binary_remote_addr 10m;</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment"># SSL Settings</span></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment"># ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE</span></span><br><span class="line">  <span class="comment"># ssl_prefer_server_ciphers on;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment"># Logging Settings</span></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="attribute">access_log</span> /var/log/nginx/access.log;</span><br><span class="line">  <span class="attribute">error_log</span> /var/log/nginx/error.log;</span><br><span class="line"></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment"># Gzip Settings</span></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">gzip_min_length</span> <span class="number">1k</span>;</span><br><span class="line">  <span class="attribute">gzip_buffers</span> <span class="number">4</span> <span class="number">16k</span>;</span><br><span class="line">  <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">0</span>;</span><br><span class="line">  <span class="attribute">gzip_comp_level</span> <span class="number">2</span>;</span><br><span class="line">  <span class="attribute">gzip_types</span> text/plain application/x-javascript text/css application/xml;</span><br><span class="line">  <span class="attribute">gzip_vary</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="comment"># Nginx作为反向代理的时候启用，决定开启或者关闭后端服务器返回的结果是否压缩，匹配的前提是后端服务器必须要返回包含"Via"的 header头。</span></span><br><span class="line">  <span class="comment"># gzip_proxied any; </span></span><br><span class="line"></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment"># Virtual Host Configs</span></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="attribute">include</span> /etc/nginx/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line">  <span class="attribute">include</span> /etc/nginx/sites-enabled/*;</span><br><span class="line"></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment"># http_proxy 设置</span></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment">#支持客户端的请求方法。post/get；</span></span><br><span class="line">  <span class="comment"># proxy_method post;</span></span><br><span class="line">  <span class="comment"># client_max_body_size   10m;</span></span><br><span class="line">  <span class="attribute">client_body_buffer_size</span>   <span class="number">128k</span>;</span><br><span class="line">  <span class="comment"># nginx跟后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line">  <span class="attribute">proxy_connect_timeout</span>   <span class="number">75</span>; </span><br><span class="line">  <span class="attribute">proxy_send_timeout</span>   <span class="number">75</span>;</span><br><span class="line">  <span class="comment"># 连接成功后，与后端服务器两个成功的响应操作之间超时时间(代理接收超时)</span></span><br><span class="line">  <span class="attribute">proxy_read_timeout</span>   <span class="number">75</span>;</span><br><span class="line">  <span class="comment"># 设置代理服务器（nginx）从后端realserver读取并保存用户头信息的缓冲区大小，默认与proxy_buffers大小相同，其实可以将这个指令值设的小一点</span></span><br><span class="line">  <span class="attribute">proxy_buffer_size</span>   <span class="number">4k</span>; </span><br><span class="line">  <span class="comment"># proxy_buffers缓冲区，nginx针对单个连接缓存来自后端realserver的响应，网页平均在32k以下的话，这样设置</span></span><br><span class="line">  <span class="attribute">proxy_buffers</span>   <span class="number">4</span> <span class="number">32k</span>; </span><br><span class="line">  <span class="comment"># 高负荷下缓冲大小（proxy_buffers*2）</span></span><br><span class="line">  <span class="attribute">proxy_busy_buffers_size</span> <span class="number">64k</span>;</span><br><span class="line">  <span class="comment"># 当缓存被代理的服务器响应到临时文件时，这个选项限制每次写临时文件的大小。proxy_temp_path（可以在编译的时候）指定写到哪那个目录。</span></span><br><span class="line">  <span class="comment"># proxy_temp_file_write_size  64k; </span></span><br><span class="line">  <span class="comment"># proxy_temp_path   /usr/local/nginx/proxy_temp 1 2;</span></span><br><span class="line">  <span class="attribute">proxy_hide_header</span> X-Powered-By; </span><br><span class="line">  <span class="attribute">proxy_hide_header</span> Server;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment"># 设定负载均衡后台服务器列表 </span></span><br><span class="line">  <span class="comment">##</span></span><br><span class="line">  <span class="comment">## down，表示当前的server暂时不参与负载均衡。</span></span><br><span class="line">  <span class="comment">## backup，预留的备份机器。当其他所有的非backup机器出现故障或者忙的时候，才会请求backup机器，因此这台机器的压力最轻。</span></span><br><span class="line">  <span class="comment"># upstream mysvr &#123; </span></span><br><span class="line">  <span class="comment">#  #ip_hash; </span></span><br><span class="line">  <span class="comment">#  server   192.168.10.100:8080 max_fails=2 fail_timeout=30s ;  </span></span><br><span class="line">  <span class="comment">#  server   192.168.10.101:8080 max_fails=2 fail_timeout=30s ;  </span></span><br><span class="line">  <span class="comment"># &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#mail &#123;</span></span><br><span class="line"><span class="comment">#	# See sample authentication script at:</span></span><br><span class="line"><span class="comment">#	# http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#	# auth_http localhost/auth.php;</span></span><br><span class="line"><span class="comment">#	# pop3_capabilities "TOP" "USER";</span></span><br><span class="line"><span class="comment">#	# imap_capabilities "IMAP4rev1" "UIDPLUS";</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#	server &#123;</span></span><br><span class="line"><span class="comment">#		listen     localhost:110;</span></span><br><span class="line"><span class="comment">#		protocol   pop3;</span></span><br><span class="line"><span class="comment">#		proxy      on;</span></span><br><span class="line"><span class="comment">#	&#125;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#	server &#123;</span></span><br><span class="line"><span class="comment">#		listen     localhost:143;</span></span><br><span class="line"><span class="comment">#		protocol   imap;</span></span><br><span class="line"><span class="comment">#		proxy      on;</span></span><br><span class="line"><span class="comment">#	&#125;</span></span><br><span class="line"><span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>
<p>注意事项</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Debian的nginx结构</span><br><span class="line"><span class="symbol">https:</span>/<span class="regexp">/wiki.debian.org/</span>Nginx/DirectoryStructure</span><br><span class="line"></span><br><span class="line">注意事项</span><br><span class="line"><span class="symbol">https:</span>/<span class="regexp">/www.nginx.com/resources</span><span class="regexp">/wiki/start</span><span class="regexp">/topics/tutorials</span><span class="regexp">/config_pitfalls/</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># SSL configuration</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># listen 443 ssl default_server;</span></span><br><span class="line">	<span class="comment"># listen [::]:443 ssl default_server;</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># Note: You should disable gzip for SSL traffic.</span></span><br><span class="line">	<span class="comment"># See: https://bugs.debian.org/773332</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># Read up on ssl_ciphers to ensure a secure configuration.</span></span><br><span class="line">	<span class="comment"># See: https://bugs.debian.org/765782</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># Self signed certs generated by the ssl-cert package</span></span><br><span class="line">	<span class="comment"># Don't use them in a production server!</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment"># include snippets/snakeoil.conf;</span></span><br><span class="line">		<span class="comment"># pass PHP scripts to FastCGI server</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment">#location ~ \.php$ &#123;</span></span><br><span class="line">	<span class="comment">#	include snippets/fastcgi-php.conf;</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment">#	# With php-fpm (or other unix sockets):</span></span><br><span class="line">	<span class="comment">#	fastcgi_pass unix:/run/php/php7.3-fpm.sock;</span></span><br><span class="line">	<span class="comment">#	# With php-cgi (or other tcp sockets):</span></span><br><span class="line">	<span class="comment">#	fastcgi_pass 127.0.0.1:9000;</span></span><br><span class="line">	<span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># deny access to .htaccess files, if Apache's document root</span></span><br><span class="line">	<span class="comment"># concurs with nginx's one</span></span><br><span class="line">	<span class="comment">#</span></span><br><span class="line">	<span class="comment">#location ~ /\.ht &#123;</span></span><br><span class="line">	<span class="comment">#	deny all;</span></span><br><span class="line">	<span class="comment">#&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="Nginx显示网站目录文件列表"><a href="#Nginx显示网站目录文件列表" class="headerlink" title="Nginx显示网站目录文件列表"></a>Nginx显示网站目录文件列表</h4><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> 【path】 &#123;</span><br><span class="line">  <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">  <span class="attribute">autoindex_exact_size</span> <span class="literal">off</span>;</span><br><span class="line">  <span class="attribute">autoindex_localtime</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="加密的目录"><a href="#加密的目录" class="headerlink" title="加密的目录"></a>加密的目录</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主文件添加：limit_req_zone $binary_remote_addr zone=one:10m rate=1r/s;</span></span><br><span class="line">location /crypt &#123;</span><br><span class="line">    autoindex <span class="keyword">on</span>;</span><br><span class="line">    <span class="comment"># 突发请求不超过10个</span></span><br><span class="line">    limit_req zone=one burst=<span class="number">10</span>; </span><br><span class="line">    auth_basic <span class="string">"Passwd required"</span>;       <span class="comment">#提示信息(自定义)</span></span><br><span class="line">    auth_basic_user_file /home/jessie/Logs/nginx_login;   <span class="comment">#生成的密码文件</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成密码文件：</span></span><br><span class="line">apt-<span class="keyword">get</span> install apache2-utils</span><br><span class="line">htpasswd -c 【配置文件路径】 【用户名】</span><br><span class="line"></span><br><span class="line">-c：创建一个加密文件</span><br><span class="line">-n：不更新加密文件，只将加密后的用户名密码显示在屏幕上</span><br><span class="line">-m：默认采用MD5算法对密码进行加密</span><br><span class="line">-d：采用CRYPT算法对密码进行加密</span><br><span class="line">-p：不对密码进行进行加密，即明文密码</span><br><span class="line">-s：采用SHA算法对密码进行加密</span><br><span class="line">-b：在命令行中一并输入用户名和密码而不是根据提示输入密码</span><br><span class="line">-D：删除指定的用户</span><br></pre></td></tr></table></figure>
<h4 id="禁止访问某些后缀的文件"><a href="#禁止访问某些后缀的文件" class="headerlink" title="禁止访问某些后缀的文件"></a>禁止访问某些后缀的文件</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">location</span> <span class="title">~* ^/xxx</span>.html &#123;</span><br><span class="line">  return <span class="number">301</span> /<span class="number">404</span>.html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">location</span> <span class="title">~* \.(ini</span>|php|cfg|sh|py|conf)$ &#123;</span><br><span class="line">  return <span class="number">301</span> /<span class="number">404</span>.html;</span><br><span class="line">  <span class="comment"># deny all;</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 根目录下的部分文件夹全为404</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">~* ^/(.xxx</span>) &#123;</span><br><span class="line">  return <span class="number">301</span> /<span class="number">404</span>.html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="解决Nginx无法访问js等文件"><a href="#解决Nginx无法访问js等文件" class="headerlink" title="解决Nginx无法访问js等文件"></a>解决Nginx无法访问js等文件</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 很久之前的了，不知道还行不行</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">~ \.css</span> &#123;</span><br><span class="line">  add_header  Content-<span class="keyword">Type</span>    text/css;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">location</span> <span class="title">~ \.js</span> &#123;</span><br><span class="line">  add_header  Content-<span class="keyword">Type</span>    application/x-javascript;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果是404问题，请使用rewrite</span></span><br><span class="line"><span class="comment"># 比如，把img开头的链接重写为/s/img/</span></span><br><span class="line"><span class="comment"># $1是括号里的东西的代称</span></span><br><span class="line"><span class="keyword">location</span> <span class="title">/img</span>/ &#123;</span><br><span class="line">    rewrite ^/img/(.*)$ /s/img/$<span class="number">1</span>;</span><br><span class="line">    <span class="comment"># rewrite_log on;</span></span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">location</span> <span class="title">/js</span>/ &#123;</span><br><span class="line">    rewrite ^/js/(.*)$ /s/js/$<span class="number">1</span>;</span><br><span class="line">    <span class="comment"># rewrite_log on;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h4 id="限制IP"><a href="#限制IP" class="headerlink" title="限制IP"></a>限制IP</h4><p>查看IP访问次数：</p>
<p><code>sudo awk &#39;{print $1}&#39; /var/log/nginx/access.log |sort |uniq -c|sort -n</code></p>
<p>新建文件：<code>sudo nano deny.ip.conf</code></p>
<p>添加IP：<code>deny 165.91.122.67;</code></p>
<p>在nginx配置文件中引入:<code>include deny.ip.conf;</code></p>
<h4 id="Nginx反向代理-Reverse-Proxy"><a href="#Nginx反向代理-Reverse-Proxy" class="headerlink" title="Nginx反向代理 - Reverse Proxy"></a>Nginx反向代理 - Reverse Proxy</h4><p><a href="https://www.nginx.com/resources/wiki/start/topics/examples/likeapache/#nginx" target="_blank" rel="noopener">https://www.nginx.com/resources/wiki/start/topics/examples/likeapache/#nginx</a></p>
<blockquote>
<p>Apache</p>
</blockquote>
<p>Let’s say we want to establish simple proxy between myhost:80 and myapp:8080. The Apache rule is simple:</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;VirtualHost myhost:<span class="number">80</span>&gt;</span><br><span class="line">    ServerName myhost</span><br><span class="line">    DocumentRoot <span class="regexp">/path/</span>to<span class="regexp">/myapp/</span><span class="keyword">public</span></span><br><span class="line">    ProxyPass <span class="regexp">/ http:/</span><span class="regexp">/myapp:8080/</span></span><br><span class="line">    ProxyPassReverse <span class="regexp">/ http:/</span><span class="regexp">/myapp:8080/</span></span><br><span class="line">&lt;<span class="regexp">/VirtualHost&gt;</span></span><br></pre></td></tr></table></figure>
<p>But NGINX does not have ProxyPassReverse… The solution is adding a few missing HTTP headers.</p>
<p>See also</p>
<p><a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect" target="_blank" rel="noopener">proxy_redirect</a>. This wiki is partly incorrect. If you need to do location header rewriting, then you will need to use <a href="https://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_redirect" target="_blank" rel="noopener">proxy_redirect</a> as well.</p>
<blockquote>
<p>NGINX</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> myhost:<span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  myhost;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> /path/to/myapp/public;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-Server <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://myapp:8080;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="末尾加不加斜杠的区别"><a href="#末尾加不加斜杠的区别" class="headerlink" title="末尾加不加斜杠的区别"></a>末尾加不加斜杠的区别</h5><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">From：https:<span class="comment">//www.jianshu.com/p/c751250a5112</span></span><br><span class="line"><span class="meta"># http:<span class="comment">//localhost/api1/xxx -&gt; http://localhost:8080/api1/xxx</span></span></span><br><span class="line">location <span class="meta-keyword">/api1/</span> &#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># http:<span class="comment">//localhost/api2/xxx -&gt; http://localhost:8080/xxx</span></span></span><br><span class="line">location <span class="meta-keyword">/api2/</span> &#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080/;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># http:<span class="comment">//localhost/api3/xxx -&gt; http://localhost:8080/api3/xxx</span></span></span><br><span class="line">location /<span class="class">api3 </span>&#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># http:<span class="comment">//localhost/api4/xxx -&gt; http://localhost:8080//xxx，请注意这里的双斜线，好好分析一下。</span></span></span><br><span class="line">location /<span class="class">api4 </span>&#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080/;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># http:<span class="comment">//localhost/api5/xxx -&gt; http://localhost:8080/hahaxxx，请注意这里的haha和xxx之间没有斜杠，分析一下原因。</span></span></span><br><span class="line">location <span class="meta-keyword">/api5/</span> &#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080/haha;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># http:<span class="comment">//localhost/api6/xxx -&gt; http://localhost:8080/haha/xxx</span></span></span><br><span class="line">location <span class="meta-keyword">/api6/</span> &#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080/haha/;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># http:<span class="comment">//localhost/api7/xxx -&gt; http://localhost:8080/haha/xxx</span></span></span><br><span class="line">location /<span class="class">api7 </span>&#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080/haha;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta"># http:<span class="comment">//localhost/api8/xxx -&gt; http://localhost:8080/haha//xxx，请注意这里的双斜杠。</span></span></span><br><span class="line">location /<span class="class">api8 </span>&#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080/haha/;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># 对于不带URI方式，nginx将会保留location中路径部分，在访问http:<span class="comment">//localhost/api1/xxx时，会代理到http://localhost:8080/api1/xxx</span></span></span><br><span class="line">location <span class="meta-keyword">/api1/</span> &#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># 对于带URI方式，nginx将使用诸如alias的替换方式对URL进行替换，并且这种替换只是字面上的替换。当访问http:<span class="comment">//localhost/api2/xxx时，http://localhost/api2/（注意最后的/）被替换成了http://localhost:8080/，然后再加上剩下的xxx，于是变成了http://localhost:8080/xxx</span></span></span><br><span class="line">location <span class="meta-keyword">/api2/</span> &#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080/;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta"># 当访问http:<span class="comment">//localhost/api5/xxx时，http://localhost/api5/被替换成了http://localhost:8080/haha，请注意这里haha后面没有/，然后再加上剩下的xxx，即http://localhost:8080/haha+xxx=http://localhost:8080/hahaxxx</span></span></span><br><span class="line">location <span class="meta-keyword">/api5/</span> &#123;</span><br><span class="line">  proxy_pass http:<span class="comment">//localhost:8080/haha;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<a href="http://sawers.com/blog/reverse-proxying-with-nginx/" target="_blank" rel="noopener">http://sawers.com/blog/reverse-proxying-with-nginx/</a> —— <a href="http://sawers.com/blog/author/mark/" target="_blank" rel="noopener">Mark Sawers</a></p>
<h5 id="Option-1-Subdomain"><a href="#Option-1-Subdomain" class="headerlink" title="Option 1: Subdomain"></a>Option 1: Subdomain</h5><p><img src="nginx/Subdomain.png" alt="Subdomain.png"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">events</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">worker_connections</span> <span class="string">1024;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">http</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="attr">...</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">server</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="attr">server_name</span> <span class="string">app-a.example.com;</span></span><br><span class="line">      </span><br><span class="line">        <span class="attr">listen</span> <span class="string">443 ssl; </span></span><br><span class="line">        <span class="attr">ssl_certificate</span> <span class="string">/etc/nginx/cert/certificate.pem;</span></span><br><span class="line">        <span class="attr">ssl_certificate_key</span> <span class="string">/etc/nginx/cert/key.pem;</span></span><br><span class="line">    </span><br><span class="line">        <span class="attr">proxy_pass</span> <span class="string">http://10.0.4.14:8080;</span></span><br><span class="line">   <span class="attr">&#125;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这里的app-a托管在10.0.4.14上，并在端口8080上提供服务。在本示例中，我们使用静态IP，但是您可以使用子域，例如app-a.private.example.com，也可以使用内部（VPC-facing）负载均衡器。</p>
<p>该路径未设置，并且隐式传递而无需转换。因此，例如，对<code>https://app-a.example.com/report/cust/67?mode=monthly</code>的请求将作为<code>http://10.0.4.14:8080/report/cust/67?mode=monthly</code>传递。</p>
<p>进入app-a的请求看起来就像是从代理启动的。因此最好添加一些标头以表明已被代理：</p>
<figure class="highlight tp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_set_header <span class="keyword">X</span>-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    proxy_set_header <span class="keyword">X</span>-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">    proxy_set_header <span class="keyword">X</span>-Forwarded-Host <span class="variable">$host</span>:<span class="variable">$server_port</span>;</span><br><span class="line">    proxy_set_header <span class="keyword">X</span>-Forwarded-Proto <span class="variable">$scheme</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h5 id="Option-2-Port"><a href="#Option-2-Port" class="headerlink" title="Option 2: Port"></a>Option 2: Port</h5><p><img src="nginx/Port.png" alt="Port.png"></p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="class">http </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="class">server </span>&#123;</span><br><span class="line">        listen <span class="number">8443</span> ssl; </span><br><span class="line">        ssl_certificate <span class="meta-keyword">/etc/</span>nginx<span class="meta-keyword">/cert/</span>certificate.pem;</span><br><span class="line">        ssl_certificate_key <span class="meta-keyword">/etc/</span>nginx<span class="meta-keyword">/cert/</span>key.pem;</span><br><span class="line">    </span><br><span class="line">        proxy_pass http:<span class="comment">//10.0.4.15:8080;</span></span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里app-b托管在10.0.4.15上，并在端口8080上提供服务。</p>
<p>您必须打开8443才能在Nginx主机防火墙（和/或安全组，网络ACL等）上入站。</p>
<h5 id="Option-3-Symmetric-Path"><a href="#Option-3-Symmetric-Path" class="headerlink" title="Option 3: Symmetric Path"></a>Option 3: Symmetric Path</h5><p><img src="nginx/Symmetric.png" alt="Symmetric.png"></p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">...</span></span><br><span class="line">http &#123;</span><br><span class="line">    <span class="string">...</span></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 443 ssl; </span><br><span class="line">        <span class="string">...</span></span><br><span class="line">        </span><br><span class="line">        location <span class="string">/app-c</span> &#123;</span><br><span class="line">            proxy_pass http:<span class="string">//10.0.4.16</span><span class="function">:8080</span>/app-c;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里app-c托管在10.0.4.16上，并在端口8080上提供。</p>
<blockquote>
<p>The location expression is a prefix match without any modifiers. You can get fancy with exact and regex matches. (See <a href="https://www.digitalocean.com/community/tutorials/understanding-nginx-server-and-location-block-selection-algorithms" target="_blank" rel="noopener">here</a> for a great intro).</p>
</blockquote>
<p>位置表达式是没有任何修饰符的前缀匹配。您可以完全匹配和正则表达式匹配。（有关介绍，请参见<a href="https://www.digitalocean.com/community/tutorials/understanding-nginx-server-and-location-block-selection-algorithms" target="_blank" rel="noopener">此处</a>）。</p>
<p>如果应用将重定向发送到其主机/端口，则可以使用以下方法解决此问题：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /app-c &#123;</span><br><span class="line">    ...</span><br><span class="line">    proxy_redirect <span class="symbol">http:</span>/<span class="regexp">/$proxy_host/</span> <span class="variable">$scheme</span><span class="symbol">://</span><span class="variable">$host</span><span class="symbol">:</span><span class="variable">$server_port</span>/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>This will take the Location header in the response, and replace the string <code>http://10.0.4.16:8080</code> with nginx’s scheme, host and port. So let’s say app-c redirects  requests to /app-c to /app-c/landing.html. The 301 redirect is to <code>http://10.0.4.16:8080/app-c/landing.html</code>, the above directive will transform it to <code>https://www.example.com:443/app-c/landing.html</code>. The browser then makes a call back to that URL.</p>
</blockquote>
<p>Take note, the terminology and variable use is odd. The <code>$proxy_</code>  variables are the origin servers or target server, and do not refer to  the nginx proxy. The <code>$proxy_host</code> variable <em>includes</em> the host and port. The <code>$proxy_port</code> variable does exist and it contains only the  port. The <code>$host</code> only contains the nginx host, and the <code>$server_port</code> is  separate.</p>
<p>这将在响应中使用Location标头，并将字符串<code>http://10.0.4.16:8080</code>替换为nginx的方案，主机和端口。因此，假设app-c将请求重定向到<code>/app-c</code>到<code>/app-c/landing.html</code>。301重定向到<code>http://10.0.4.16:8080/app-c/landing.html</code>，上述指令会将其转换为<code>https://www.example.com:443/app-c/landing.html</code>。然后，浏览器将对该URL进行回叫。</p>
<p>请注意，术语和变量用法很奇怪。$ proxy_变量是原始服务器或目标服务器，并且不引用nginx代理。$ proxy_host变量<em>包括</em>主机和端口。$ proxy_port变量确实存在，并且仅包含端口。$ host仅包含nginx主机，而$ server_port是单独的。</p>
<h5 id="Option-4-Asymmetric-Path"><a href="#Option-4-Asymmetric-Path" class="headerlink" title="Option 4: Asymmetric Path"></a>Option 4: Asymmetric Path</h5><p><img src="nginx/Asymmetric.png" alt="Asymmetric.png"></p>
<p>使用100％相对URL的应用程序可能会让您很幸运，而且不需要进行任何内容转换。但应用程序经常使用绝对URI和/或绝对URL（协议://主机:端口/路径）引用其自身的内容，并使用多种机制，例如，anchor href，图像和链接src，css @import和JavaScript-建立动态路径。对于目标应用程序中的每个使用模式，您将需要一个转换指令。</p>
<p>它可能需要数天的反复试验。您肯定需要浏览器的开发人员工具视图。您将非常熟悉应用程序的内部，在整个应用程序中导航，检查它如何加载外部文件（HTML，JavaScript，CSS和媒体）。单页AJAX / Comet和现代框架（Angular，React和Vue）可能特别具有挑战性，因为可以通过编程方式构建URL。</p>
<p>这也是最脆弱的方法。经过所有最初的代理工作后，开发人员可以在将来的升级中更改内容访问方法，并且您需要修复反向代理规则。</p>
<p>我在此选项中使用的两个主要指令是：</p>
<ol>
<li><a href="http://nginx.org/en/docs/http/ngx_http_rewrite_module.html" target="_blank" rel="noopener">重写</a>请求URI更改</li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_sub_module.html" target="_blank" rel="noopener">sub_filter</a>用于响应内容的更改</li>
</ol>
<p>sub_filter使用固定的字符串替换，并涵盖了我遇到的所有情况。（我还没有使用过它，但是您可以使用<a href="https://www.nginx.com/resources/wiki/modules/substitutions/" target="_blank" rel="noopener">非标准的替换模块</a>进行重建以获得正则表达式的功能。）</p>
<p>假设目标应用在<a href="http://10.0.4.17:8080/origin-d上投放，而我们在https://www.example.com/app-d上发布。添加一个位置块，如下所示：" target="_blank" rel="noopener">http://10.0.4.17:8080/origin-d上投放，而我们在https://www.example.com/app-d上发布。添加一个位置块，如下所示：</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen 443 ssl; </span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">        location /app<span class="_">-d</span> &#123;</span><br><span class="line">            rewrite /origin<span class="_">-d</span><span class="variable">$1</span> /app<span class="_">-d</span>(.*);</span><br><span class="line">            proxy_pass http://10.0.4.16:8080/origin<span class="_">-d</span>;</span><br><span class="line">            proxy_redirect http://<span class="variable">$proxy_host</span>/origin<span class="_">-d</span>/ <span class="variable">$scheme</span>://<span class="variable">$host</span>:<span class="variable">$server_port</span>/app<span class="_">-d</span>/;</span><br><span class="line">            sub_filter <span class="string">'href="/origin-d'</span> <span class="string">'href="/app-d'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在重写中，proxy_redirect和sub_filter，第一个参数是要匹配的字符串，第二个参数是要替换的字符串。</p>
<ul>
<li>重写将<code>/app-d/product/list?category=blue</code>之类的URL更改为<code>/origin-d/product/list?category=blue</code>。</li>
<li>重定向更改了响应中的Location头，以便它与发布的路径一起使用。</li>
<li>最后，sub_filter在响应主体中创建超链接以使用发布的路径。</li>
</ul>
<p>您需要为应用程序中使用的其他模式添加其他sub_filter语句。</p>
<p>我通常添加的其他一些内容：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">location</span> <span class="string">/app-d &#123;</span></span><br><span class="line">    <span class="attr">...</span></span><br><span class="line">    <span class="attr">sub_filter_types</span> <span class="string">*;</span></span><br><span class="line">    <span class="attr">sub_filter_once</span> <span class="string">off;</span></span><br><span class="line">    <span class="attr">sub_filter_last_modified</span> <span class="string">on;</span></span><br><span class="line"><span class="attr">&#125;</span></span><br></pre></td></tr></table></figure>
<p>sub_filter_types将其应用于所有内容类型。默认情况下，它仅适用于text / html，但是通常您需要更改js和css。</p>
<p>sub_filter_once默认情况下处于启用状态，这意味着它匹配一次并停止。那有多有用？一点也不。您要替换每个实例。请记住，每个字符串都会被替换一次，因此您无法使用两个规则替换说  <code>http://10.0.4.16:8080/origin-d/blah/blah</code>的两个规则，一个规则用于<code>http://$proxy_host</code>，另一个规则用于<code>/origin-d</code>。您将需要一个带有完整URL的规则。</p>
<p>在未将sub_filter_last_modified设置为on的情况下，您将破坏所有客户端（以及可能的其他中间代理）缓存。启用此选项后，将在替换期间从原始响应中保留“最后修改的”标头字段，以启用上游响应缓存。</p>
<p>注意事项：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from https://www.cnblogs.com/kevingrace/p/7133806.html</span></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /wangshibo/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">proxy_cache</span> js_cache;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> Host js.test.com;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://js.test.com/;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 如上面的配置，如果请求的url是http://servername/wangshibo/test.html会被代理成http://js.test.com/test.html</span></span><br><span class="line"><span class="comment"># 而如果这么配置</span></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /wangshibo/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">proxy_cache</span> js_cache;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> Host js.test.com;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://js.test.com;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 则请求的url是http://servername/wangshibo/test.html会被代理到http://js.test.com/wangshibo/test.html</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#当然，可以用如下的rewrite来实现/的功能</span></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /wangshibo/</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attribute">proxy_cache</span> js_cache;</span><br><span class="line">  <span class="attribute">proxy_set_header</span> Host js.test.com;</span><br><span class="line">  <span class="attribute">rewrite</span> /wangshibo/(.+)$ /<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">  <span class="attribute">proxy_pass</span> http://js.test.com;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># from https://xuexb.github.io/learn-nginx/example/proxy_pass.html#url-%E5%8F%AA%E6%98%AF-host</span></span><br><span class="line"></span><br><span class="line">url 只是 host</span><br><span class="line"></span><br><span class="line">这里指不包含 $uri ，如：</span><br><span class="line"></span><br><span class="line">    http:<span class="string">//host</span> - √</span><br><span class="line">    https:<span class="string">//host</span> - √</span><br><span class="line">    http:<span class="string">//host</span><span class="function">:port</span> - √</span><br><span class="line">    https:<span class="string">//host</span><span class="function">:port</span> - √</span><br><span class="line">    http:<span class="string">//host/</span> - x</span><br><span class="line">    http:<span class="string">//host</span><span class="function">:port</span>/ - x</span><br><span class="line"></span><br><span class="line">这时候 location 匹配的完整路径将直接透传给 url ，如：</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 访问：   /                               后端：   /</span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>                         后端：   <span class="string">/api/xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>?aa                      后端：   <span class="string">/api/xx</span>?aa</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/</span>                           后端：   <span class="string">/api/</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>                         后端：   <span class="string">/api/xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>?aa                      后端：   <span class="string">/api/xx</span>?aa</span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api-xx</span>?aa                      后端：</span><br><span class="line">location <span class="string">/api/</span> &#123;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/</span>                           后端：   <span class="string">/api/</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>                         后端：   <span class="string">/api/xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>?aa                      后端：   <span class="string">/api/xx</span>?aa</span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api-xx</span>?aa                      后端：   <span class="string">/api-xx</span>?aa</span><br><span class="line">location <span class="string">/api</span> &#123;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">url 包含路径</span><br><span class="line"></span><br><span class="line">注意，这里的路径哪怕只是一个 / 也是存在的，如：</span><br><span class="line"></span><br><span class="line">    http:<span class="string">//host</span> - x</span><br><span class="line">    https/<span class="string">/host/</span> - √</span><br><span class="line">    http:<span class="string">//host</span><span class="function">:port</span> - x</span><br><span class="line">    https:<span class="string">//host</span><span class="function">:port</span>/ - √</span><br><span class="line">    http:<span class="string">//host/api</span> - √</span><br><span class="line">    http:<span class="string">//host/api/</span> - √</span><br><span class="line"></span><br><span class="line">当 proxy_pass url 的 url 包含路径时，匹配时会根据 location 的匹配后的链接透传给 url ，注意匹配后就是这样：</span><br><span class="line">location 规则 	访问的原始链接 	匹配之后的路径</span><br><span class="line">location / 	/ 	</span><br><span class="line">location / 	<span class="string">/a</span> 	a</span><br><span class="line">location / 	<span class="string">/a/b/c</span>?d 	a/b/c?d</span><br><span class="line">location <span class="string">/a/</span> 	<span class="string">/a/</span> 	</span><br><span class="line">location <span class="string">/a/</span> 	<span class="string">/a/b/c</span>?d 	b/c?d</span><br><span class="line"></span><br><span class="line">明白匹配之后的路径后，在 proxy_pass url 包含路径时，将会把匹配之后的路径透传给 url ，如：</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 访问：   /                               后端：   /</span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>                         后端：   <span class="string">/api/xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>?aa                      后端：   <span class="string">/api/xx</span>?aa</span><br><span class="line">location / &#123;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/</span>                           后端：   /</span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>                         后端：   <span class="string">/xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>?aa                      后端：   <span class="string">/xx</span>?aa</span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api-xx</span>?aa                      未匹配</span><br><span class="line">location <span class="string">/api/</span> &#123;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api</span>                            后端：   /</span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/</span>                           后端：   <span class="string">//</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>                         后端：   <span class="string">//xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>?aa                      后端：   <span class="string">//xx</span>?aa</span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api-xx</span>?aa                      后端：   <span class="string">/-xx</span>?aa</span><br><span class="line">location <span class="string">/api</span> &#123;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/</span>                           后端：   <span class="string">/v1</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>                         后端：   <span class="string">/v1xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>?aa                      后端：   <span class="string">/v1xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api-xx</span>?aa                      未匹配</span><br><span class="line">location <span class="string">/api/</span> &#123;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>/v1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/</span>                           后端：   <span class="string">/v1/</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>                         后端：   <span class="string">/v1/xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/xx</span>?aa                      后端：   <span class="string">/v1/xx</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api-xx</span>?aa                      未匹配</span><br><span class="line">location <span class="string">/api/</span> &#123;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>/v1/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">由以上规则可以看出，当 proxy_pass url 中包含路径时，结尾的 / 最好同 location 匹配规则一致。</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">当 proxy_pass 遇到正则</span><br><span class="line"></span><br><span class="line">当 location 以正则形式匹配时，proxy_pass 就不能以 / 结束了，也就是不能包含路径了，比如错误的：</span><br><span class="line"></span><br><span class="line">location ~* ^<span class="string">/api/</span> &#123;</span><br><span class="line">    proxy_pass http:<span class="string">//host/</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="params">($uri ~* ^/api/)</span> &#123;</span><br><span class="line">        proxy_pass http:<span class="string">//host/</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">解决办法就是把链接中的路径去掉。</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">重写代理链接 - url rewrite</span><br><span class="line"></span><br><span class="line">当原始链接（浏览器访问的链接）和代理服务器链接规则不一致时，可以使用 Nginx URL Rewrite 功能去动态的重写，如：</span><br><span class="line"></span><br><span class="line">location ~* ^<span class="string">/api/</span> &#123;</span><br><span class="line">    rewrite ^<span class="string">/api/</span><span class="params">(.*)</span> /?path=$1 break;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">以上请求会把匹配 <span class="string">/api/</span> 的链接重写为 /?path= 的链接透传给 node<span class="function">:8080</span> 服务，有意思的是当使用 rewrite 指令并且生效后，proxy_pass url 链接中的路径会被忽略，如：</span><br><span class="line"></span><br><span class="line"><span class="string">//</span> 访问：   /                               后端：   <span class="string">/node/</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api</span>                            后端：   <span class="string">/node/api</span></span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/</span>                           后端：   /?path=</span><br><span class="line"><span class="string">//</span> 访问：   <span class="string">/api/a/b/c</span>                      后端：   /?path=a/b/c</span><br><span class="line">location / &#123;</span><br><span class="line">    rewrite ^<span class="string">/api/</span><span class="params">(.*)</span> /?path=$1 break;</span><br><span class="line">    proxy_pass http:<span class="string">//node</span><span class="function">:8080</span>/node/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Kplayer"><a href="#Kplayer" class="headerlink" title="Kplayer"></a>Kplayer</h3><p>用于直播推流，<a href="https://kplayer.net/" target="_blank" rel="noopener">官网</a></p>
<p>安装：<code>curl -fsSL get.kplayer.net | bash</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line">curl --fail  http://download.bytelang.cn/kplayer-v0.5.4-$(uname -s | sed s/Linux/linux/)_$(uname -m | sed s/aarch64/arm64/ | sed s/x86_64/amd64/).tar.gz -o kplayer.tar.gz</span><br><span class="line">tar zxvf kplayer.tar.gz</span><br><span class="line">rm -rf kplayer.tar.gz</span><br></pre></td></tr></table></figure>
<p>低带宽配置文件</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"version"</span>: <span class="string">"2.0.0"</span>,</span><br><span class="line">    <span class="attr">"play"</span>: &#123;</span><br><span class="line">        <span class="attr">"play_model"</span>: <span class="string">"random"</span>,</span><br><span class="line">        <span class="attr">"encode_model"</span>: <span class="string">"rtmp"</span>,</span><br><span class="line">        <span class="attr">"rpc"</span>: &#123;</span><br><span class="line">            <span class="attr">"on"</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">"port"</span>: <span class="number">4156</span>,</span><br><span class="line">            <span class="attr">"address"</span>: <span class="string">"127.0.0.1"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"encode"</span>: &#123;</span><br><span class="line">            <span class="attr">"video_width"</span>: <span class="number">780</span>,</span><br><span class="line">            <span class="attr">"video_height"</span>: <span class="number">480</span>,</span><br><span class="line">            <span class="attr">"video_fps"</span>: <span class="number">10</span>,</span><br><span class="line">            <span class="attr">"audio_channel_layout"</span>: <span class="number">3</span>,</span><br><span class="line">            <span class="attr">"audio_channels"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="attr">"bit_rate"</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">"avg_quality"</span>: <span class="number">20</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"resource"</span>: &#123;</span><br><span class="line">        <span class="attr">"lists"</span>: [</span><br><span class="line">            <span class="string">"../videos/1.mp4"</span>,</span><br><span class="line">            <span class="string">"../videos/2.mp4"</span></span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"output"</span>: &#123;</span><br><span class="line">        <span class="attr">"reconnect_internal"</span>: <span class="number">-1</span>,</span><br><span class="line">        <span class="attr">"lists"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"path"</span>: <span class="string">"rtmp://127.0.0.1:1935/push"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>启动：<code>kplayer play start -d</code></p>
<p>测试：<code>kplayer play start</code></p>
<p>停止：<code>kplayer play stop</code></p>
<p>多平台只需要运行的<code>kplayer</code>文件不一样即可(<code>kplayer</code>的<code>home</code>不一样)</p>
<h3 id="TightVNC"><a href="#TightVNC" class="headerlink" title="TightVNC"></a>TightVNC</h3><blockquote>
<p>Install Gnome Desktop with TightVNC on Debian 7</p>
<p>来源：<a href="https://www.vultr.com/docs/install-gnome-desktop-with-tightvnc-on-debian-7" target="_blank" rel="noopener">Vultr Docs</a></p>
</blockquote>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="builtin-name">get</span> update</span><br><span class="line">apt-<span class="builtin-name">get</span> upgrade</span><br><span class="line"><span class="comment"># 安装GNOME</span></span><br><span class="line">apt-<span class="builtin-name">get</span> install gnome</span><br><span class="line">apt-<span class="builtin-name">get</span> install xfonts-100dpi xfonts-100dpi-transcoded xfonts-75dpi xfonts-75dpi-transcoded xfonts-base</span><br><span class="line"><span class="comment"># 安装VNC Server</span></span><br><span class="line">apt-<span class="builtin-name">get</span> install tightvncserver</span><br><span class="line"><span class="comment"># 运行VNC</span></span><br><span class="line">tightvncserver :1</span><br><span class="line"><span class="comment"># 结束VNC</span></span><br><span class="line">tightvncserver -kill :1</span><br><span class="line"><span class="comment"># 修改配置</span></span><br><span class="line">nano ~/.vnc/xstartup</span><br><span class="line">$$$$ 内容开始</span><br><span class="line"><span class="comment">#!/bin/shxrdb $HOME/.Xresources</span></span><br><span class="line">xsetroot -solid grey</span><br><span class="line">x-terminal-emulator -geometry 80x24+10+10 -ls -title <span class="string">"<span class="variable">$VNCDESKTOP</span> Desktop"</span> &amp;</span><br><span class="line"><span class="comment"># x-window-manager &amp;</span></span><br><span class="line">gnome-session &amp;</span><br><span class="line">$$$$ 内容结束</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行VNC</span></span><br><span class="line">tightvncserver -geometry 1024x720 :1</span><br></pre></td></tr></table></figure>
<h4 id="VNC运行灰屏解决方法"><a href="#VNC运行灰屏解决方法" class="headerlink" title="VNC运行灰屏解决方法"></a>VNC运行灰屏解决方法</h4><blockquote>
<p>不一定有效，仅供参考（好吧。。GNOME搞不定，Xfce4倒是可以用）</p>
<p>参考资料：</p>
<ol>
<li><a href="https://askubuntu.com/questions/800302/vncserver-grey-screen-ubuntu-16-04-lts" target="_blank" rel="noopener">https://askubuntu.com/questions/800302/vncserver-grey-screen-ubuntu-16-04-lts</a></li>
<li><a href="https://unix.stackexchange.com/questions/543864/vnc-gray-screen-on-debian-10-gnome-3" target="_blank" rel="noopener">https://unix.stackexchange.com/questions/543864/vnc-gray-screen-on-debian-10-gnome-3</a></li>
<li><a href="https://www.linode.com/community/questions/19315/ubuntu-1804-vnc-doesnt-work-grey-box-screen" target="_blank" rel="noopener">https://www.linode.com/community/questions/19315/ubuntu-1804-vnc-doesnt-work-grey-box-screen</a></li>
</ol>
</blockquote>
<p>修改<code>~/.vnc/xstartup</code></p>
<p>Xfce4：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">xrdb <span class="variable">$HOME</span>/.Xresources</span><br><span class="line">xsetroot -solid grey</span><br><span class="line"><span class="comment"># x-terminal-emulator -geometry 80x24+10+10 -ls -title "$VNCDESKTOP Desktop" &amp;</span></span><br><span class="line"><span class="comment"># x-window-manager &amp;</span></span><br><span class="line"><span class="comment"># Fix to make GNOME work</span></span><br><span class="line"><span class="comment"># export XKL_XMODMAP_DISABLE=1</span></span><br><span class="line"><span class="comment">#/etc/X11/Xsession</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fix to make xfce work:</span></span><br><span class="line">startxfce4 &amp;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">[ -r <span class="variable">$HOME</span>/.Xresources ] &amp;&amp; xrdb <span class="variable">$HOME</span>/.Xresources</span><br><span class="line">startxfce4 &amp;</span><br></pre></td></tr></table></figure>
<p>GNOME：</p>
<p><code>$ sudo apt-get install gnome-panel gnome-settings-daemon metacity nautilus gnome-terminal</code></p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gnome-panel <span class="meta">&amp;</span></span><br><span class="line">gnome-settings-daemon <span class="meta">&amp;</span></span><br><span class="line">metacity <span class="meta">&amp;</span></span><br><span class="line">nautilus <span class="meta">&amp;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">unset</span> SESSION_MANAGER</span><br><span class="line"><span class="built_in">unset</span> DBUS_SESSION_BUS_ADDRESS</span><br><span class="line">startxfce4 &amp;</span><br><span class="line">[ -x /etc/vnc/xstartup ] &amp;&amp; <span class="built_in">exec</span> /etc/vnc/xstartup</span><br><span class="line">[ -r <span class="variable">$HOME</span>/.Xresources ] &amp;&amp; xrdb <span class="variable">$HOME</span>/.Xresources</span><br><span class="line">xsetroot -solid grey &amp;</span><br><span class="line">vncconfig -iconic &amp;</span><br></pre></td></tr></table></figure>
<p>With <code>sudo apt install gnome-session-flashback</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">autocutsel -fork</span><br><span class="line">xrdb <span class="variable">$HOME</span>/.Xresources</span><br><span class="line">xsetroot -solid grey</span><br><span class="line"><span class="built_in">export</span> XKL_XMODMAP_DISABLE=1</span><br><span class="line"><span class="built_in">export</span> XDG_CURRENT_DESKTOP=<span class="string">"GNOME-Flashback:Unity"</span></span><br><span class="line"><span class="built_in">export</span> XDG_MENU_PREFIX=<span class="string">"gnome-flashback-"</span></span><br><span class="line"><span class="built_in">unset</span> DBUS_SESSION_BUS_ADDRESS</span><br><span class="line">gnome-session --session=gnome-flashback-metacity --<span class="built_in">disable</span>-acceleration-check --debug &amp;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Uncomment the following two lines for normal desktop:</span></span><br><span class="line"><span class="comment"># unset SESSION_MANAGER</span></span><br><span class="line"><span class="comment"># exec /etc/X11/xinit/xinitrc</span></span><br><span class="line"></span><br><span class="line">[ -x /etc/vnc/xstartup ] &amp;&amp; <span class="built_in">exec</span> /etc/vnc/xstartup</span><br><span class="line">[ -r <span class="variable">$HOME</span>/.Xresources ] &amp;&amp; xrdb <span class="variable">$HOME</span>/.Xresources</span><br><span class="line">xsetroot -solid grey</span><br><span class="line">vncconfig -iconic &amp;</span><br><span class="line">x-terminal-emulator -geometry 80x24+10+10 -ls -title <span class="string">"<span class="variable">$VNCDESKTOP</span> Desktop"</span> &amp;</span><br><span class="line">x-window-manager &amp;</span><br><span class="line"></span><br><span class="line">gnome-panel &amp;</span><br><span class="line">gnome-settings-daemon &amp;</span><br><span class="line">metacity &amp;</span><br><span class="line">nautilus &amp;</span><br></pre></td></tr></table></figure>
<h3 id="Tiny-file-manager-PHP"><a href="#Tiny-file-manager-PHP" class="headerlink" title="Tiny-file-manager(PHP)"></a>Tiny-file-manager(PHP)</h3><blockquote>
<p>PHP小型文件共享、浏览（支持上传的文件浏览器，需要登录！）</p>
<p>密码<a href="https://tinyfilemanager.github.io/docs/pwd.html" target="_blank" rel="noopener">生成</a></p>
</blockquote>
<p>功能：</p>
<ol>
<li>支持URL上传文件（本地上传当然是最基本的要求）</li>
<li>支持配置用户登录</li>
<li>支持配置只读用户</li>
<li>支持鼠标悬停图片文件预览</li>
<li>支持文件搜索</li>
<li>支持<code>zip</code>、<code>tar</code>打包下载</li>
<li>支持在线编辑、重命名、复制、删除文件</li>
<li>支持文件备份</li>
<li>支持扩展名限制</li>
</ol>
<p>需要：</p>
<ul>
<li>php</li>
<li>php-fpm</li>
<li>nginx</li>
</ul>
<ol>
<li>修改PHP-FPM监听端口到<code>9000</code></li>
<li>克隆仓库：<code>git clone https://github.com/prasathmani/tinyfilemanager.git</code></li>
<li>复制<code>tinyfilemanager.php</code>和<code>translation.json</code>到工作目录（要共享的目录）</li>
<li>修改<code>tinyfilemanager.php</code>为<code>index.php</code></li>
<li>新建配置文件<code>config.php</code></li>
<li>修改Nginx代理配置</li>
</ol>
<p>配置文件<code>config.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">#################################################################################################################</span></span><br><span class="line"><span class="comment">This is an OPTIONAL configuration file. rename this file into config.php to use this configuration </span></span><br><span class="line"><span class="comment">The role of this file is to make updating of "tinyfilemanager.php" easier.</span></span><br><span class="line"><span class="comment">So you can:</span></span><br><span class="line"><span class="comment">-Feel free to remove completely this file and configure "tinyfilemanager.php" as a single file application.</span></span><br><span class="line"><span class="comment">or</span></span><br><span class="line"><span class="comment">-Put inside this file all the static configuration you want and forgot to configure "tinyfilemanager.php".</span></span><br><span class="line"><span class="comment">#################################################################################################################</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Auth with login/password</span></span><br><span class="line"><span class="comment">// set true/false to enable/disable it</span></span><br><span class="line"><span class="comment">// Is independent from IP white- and blacklisting</span></span><br><span class="line">$use_auth = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Login user name and password</span></span><br><span class="line"><span class="comment">// Users: array('Username' =&gt; 'Password', 'Username2' =&gt; 'Password2', ...)</span></span><br><span class="line"><span class="comment">// Generate secure password hash - https://tinyfilemanager.github.io/docs/pwd.html</span></span><br><span class="line">$auth_users = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'admin'</span> =&gt; <span class="string">'$2y$10$33897pMU.fVQqckYQBBZK.QzEzs4TS2sYSltehquwVkjeIOid.EH.'</span>, <span class="comment">//12345</span></span><br><span class="line">    <span class="string">'user'</span> =&gt; <span class="string">'$2y$10$33897pMU.fVQqckYQBBZK.QzEzs4TS2sYSltehquwVkjeIOid.EH.'</span>, <span class="comment">//12345</span></span><br><span class="line">    <span class="string">'guest'</span> =&gt; <span class="string">'$2y$10$8U3V3LxTEuLKU9q4WXwpXubZa6CKgiA5hUH6VmCCHZkvvDdP.Ggty'</span>, <span class="comment">// guest</span></span><br><span class="line">    <span class="string">'upload'</span> =&gt; <span class="string">'$2y$10$Oa7Sc9M3bh0W34.hdSn/He0JoWqv52I9ZPaMQca.PV7DIU9M7W13W'</span> <span class="comment">// upload</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Readonly users</span></span><br><span class="line"><span class="comment">// e.g. array('users', 'guest', ...)</span></span><br><span class="line">$readonly_users = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'user'</span>,</span><br><span class="line">    <span class="string">'guest'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Enable highlight.js (https://highlightjs.org/) on view's page</span></span><br><span class="line">$use_highlightjs = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// highlight.js style</span></span><br><span class="line"><span class="comment">// for dark theme use 'ir-black'</span></span><br><span class="line">$highlightjs_style = <span class="string">'vs'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Enable ace.js (https://ace.c9.io/) on view's page</span></span><br><span class="line">$edit_files = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Default timezone for date() and time()</span></span><br><span class="line"><span class="comment">// Doc - http://php.net/manual/en/timezones.php</span></span><br><span class="line">$default_timezone = <span class="string">'Etc/UTC'</span>; <span class="comment">// UTC</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Root path for file manager</span></span><br><span class="line"><span class="comment">// use absolute path of directory i.e: '/var/www/folder' or $_SERVER['DOCUMENT_ROOT'].'/folder'</span></span><br><span class="line"><span class="comment">// $root_path = $_SERVER['DOCUMENT_ROOT']; 根目录 files</span></span><br><span class="line">$root_path = $_SERVER[<span class="string">'DOCUMENT_ROOT'</span>].<span class="string">'/files'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Root url for links in file manager.Relative to $http_host. Variants: '', 'path/to/subfolder'</span></span><br><span class="line"><span class="comment">// Will not working if $root_path will be outside of server document root</span></span><br><span class="line">$root_url = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Server hostname. Can set manually if wrong</span></span><br><span class="line"> $http_host = $_SERVER[<span class="string">'HTTP_HOST'</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// user specific directories</span></span><br><span class="line"><span class="comment">// array('Username' =&gt; 'Directory path', 'Username2' =&gt; 'Directory path', ...)</span></span><br><span class="line">$directories_users = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'upload'</span> =&gt; <span class="string">'files/temp'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// input encoding for iconv</span></span><br><span class="line">$iconv_input_encoding = <span class="string">'UTF-8'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// date() format for file modification date</span></span><br><span class="line"><span class="comment">// Doc - https://www.php.net/manual/en/datetime.format.php</span></span><br><span class="line"><span class="comment">// $datetime_format = 'd.m.y H:i:s';</span></span><br><span class="line">$datetime_format = <span class="string">'y-m-d H:i:s'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allowed file extensions for create and rename files</span></span><br><span class="line"><span class="comment">// e.g. 'txt,html,css,js'</span></span><br><span class="line">$allowed_file_extensions = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allowed file extensions for upload files</span></span><br><span class="line"><span class="comment">// e.g. 'gif,png,jpg,html,txt'</span></span><br><span class="line"><span class="comment">// $allowed_upload_extensions = 'jpg,jpeg,gif,txt,mp4,doc,xls,xlsx,docx,pdf';</span></span><br><span class="line">$allowed_upload_extensions = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Favicon path. This can be either a full url to an .PNG image, or a path based on the document root.</span></span><br><span class="line"><span class="comment">// full path, e.g http://example.com/favicon.png</span></span><br><span class="line"><span class="comment">// local path, e.g images/icons/favicon.png</span></span><br><span class="line">$favicon_path = <span class="string">'/favicon.ico'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Files and folders to excluded from listing</span></span><br><span class="line"><span class="comment">// e.g. array('myfile.html', 'personal-folder', '*.php', ...)</span></span><br><span class="line"><span class="comment">// Files and folders to excluded from listing</span></span><br><span class="line">$exclude_items = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'my-folder'</span>,</span><br><span class="line">    <span class="string">'secret-files'</span>,</span><br><span class="line">    <span class="string">'tinyfilemanger.php'</span>,</span><br><span class="line">    <span class="string">'*.php'</span>,</span><br><span class="line">    <span class="string">'*.js'</span>,</span><br><span class="line">    <span class="string">'file.lst'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Online office Docs Viewer</span></span><br><span class="line"><span class="comment">// Availabe rules are 'google', 'microsoft' or false</span></span><br><span class="line"><span class="comment">// google =&gt; View documents using Google Docs Viewer</span></span><br><span class="line"><span class="comment">// microsoft =&gt; View documents using Microsoft Web Apps Viewer</span></span><br><span class="line"><span class="comment">// false =&gt; disable online doc viewer</span></span><br><span class="line">$online_viewer = <span class="string">'google'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Sticky Nav bar</span></span><br><span class="line"><span class="comment">// true =&gt; enable sticky header</span></span><br><span class="line"><span class="comment">// false =&gt; disable sticky header</span></span><br><span class="line">$sticky_navbar = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// max upload file size MB</span></span><br><span class="line">$max_upload_size_bytes = <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Possible rules are 'OFF', 'AND' or 'OR'</span></span><br><span class="line"><span class="comment">// OFF =&gt; Don't check connection IP, defaults to OFF</span></span><br><span class="line"><span class="comment">// AND =&gt; Connection must be on the whitelist, and not on the blacklist</span></span><br><span class="line"><span class="comment">// OR =&gt; Connection must be on the whitelist, or not on the blacklist</span></span><br><span class="line">$ip_ruleset = <span class="string">'OR'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Should users be notified of their block?</span></span><br><span class="line">$ip_silent = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IP-addresses, both ipv4 and ipv6</span></span><br><span class="line">$ip_whitelist = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'127.0.0.1'</span>,    <span class="comment">// local ipv4</span></span><br><span class="line">    <span class="string">'::1'</span>           <span class="comment">// local ipv6</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// IP-addresses, both ipv4 and ipv6</span></span><br><span class="line">$ip_blacklist = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">'0.0.0.0'</span>,      <span class="comment">// non-routable meta ipv4</span></span><br><span class="line">    <span class="string">'::'</span>            <span class="comment">// non-routable meta ipv6</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>Nginx反向代理PHP:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl http2;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl http2;   </span><br><span class="line">    <span class="attribute">root</span> /file-manager;</span><br><span class="line">    <span class="attribute">index</span> index.html index.php index.htm index.nginx-debian.html;</span><br><span class="line">    <span class="attribute">server_name</span> yours;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">location</span> <span class="regexp">~ \.php?.*$</span> &#123; </span><br><span class="line">        <span class="attribute">fastcgi_pass</span>   <span class="number">127.0.0.1:9000</span>; </span><br><span class="line">        <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>; </span><br><span class="line">        <span class="attribute">include</span>        fastcgi_params; </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">ssl_certificate</span> /etc/ssl/xxx.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> /etc/ssl/xxx.key;</span><br><span class="line">    <span class="attribute">ssl_session_timeout</span> <span class="number">1d</span>;</span><br><span class="line">    <span class="attribute">ssl_session_cache</span> shared:MozSSL:<span class="number">10m</span>;  <span class="comment"># about 40000 sessions</span></span><br><span class="line">    <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">ssl_protocols</span> TLSv1.<span class="number">2</span> TLSv1.<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">ssl_ciphers</span> ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;</span><br><span class="line">    <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">add_header</span> Strict-Transport-Security <span class="string">"max-age=63072000"</span> always;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="修改根目录"><a href="#修改根目录" class="headerlink" title="修改根目录"></a>修改根目录</h4><p>配置文件中</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">//</span> Root path <span class="keyword">for</span> file manager</span><br><span class="line"><span class="regexp">//</span> use absolute path of directory </span><br><span class="line"><span class="regexp">//</span> i.e: <span class="string">'/var/www/folder'</span> or <span class="variable">$_SERVER</span>[<span class="string">'DOCUMENT_ROOT'</span>].<span class="string">'/folder'</span></span><br><span class="line"><span class="regexp">//</span> <span class="variable">$root_path</span> = <span class="variable">$_SERVER</span>[<span class="string">'DOCUMENT_ROOT'</span>]; 根目录 files</span><br><span class="line"><span class="regexp">//</span> 这里的files就是说根目录在tinyfmgr的目录中的files文件夹</span><br><span class="line"><span class="variable">$root_path</span> = <span class="variable">$_SERVER</span>[<span class="string">'DOCUMENT_ROOT'</span>].<span class="string">'/files'</span>;</span><br><span class="line"></span><br><span class="line"><span class="regexp">//</span> Root url <span class="keyword">for</span> links <span class="keyword">in</span> file manager.Relative to <span class="variable">$http_host</span>. Variants: <span class="string">''</span>, <span class="string">'path/to/subfolder'</span></span><br><span class="line"><span class="regexp">//</span> Will not working <span class="keyword">if</span> <span class="variable">$root_path</span> will be outside of server document root</span><br><span class="line"><span class="regexp">//</span> 这个看起来像是域名子路径（我不确定）</span><br><span class="line"><span class="variable">$root_url</span> = <span class="string">''</span>;</span><br></pre></td></tr></table></figure>
<h4 id="关于写入权限（如果你的PHP页面配置无法保存）"><a href="#关于写入权限（如果你的PHP页面配置无法保存）" class="headerlink" title="关于写入权限（如果你的PHP页面配置无法保存）"></a>关于写入权限（如果你的PHP页面配置无法保存）</h4><p>同<code>linx-server</code>它要求<code>www-data</code>用户可读写。<code>index.php</code>文件也要求可写，因为文件本身用于保存设置</p>
<h3 id="ZNC"><a href="#ZNC" class="headerlink" title="ZNC"></a>ZNC</h3><blockquote>
<p>ZNC是IRC的一种<em>IRC BNC</em> (Bouncer)</p>
<p>支持离线消息</p>
<p><a href="https://github.com/znc/znc" target="_blank" rel="noopener">仓库</a>  <a href="https://znc.in" target="_blank" rel="noopener">官网</a> </p>
</blockquote>
<h4 id="安装-2"><a href="#安装-2" class="headerlink" title="安装"></a>安装</h4><p>Debian仓库是自带<code>znc</code>的，可以使用<code>sudo apt install znc</code>进行安装。</p>
<p>安装完<code>znc</code>以后，运行<code>znc --makeconf</code>进行配置文件初始化(TLS可以后面加，没事儿)，初始化需要回答问题。</p>
<h4 id="运行-1"><a href="#运行-1" class="headerlink" title="运行"></a>运行</h4><p>直接终端输入<code>znc</code>即可运行。停止请使用<code>pkill znc</code></p>
<p>如果需修改<code>~/.znc</code>目录中的配置文件，请先停止znc，但更好的做法是从web端进行修改。</p>
<p>首次运行，请进入Web端修改配置，然后记得添加用户(你当前用户是管理员账户，你当然要添加一下普通用户)</p>
<h4 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h4><p>IRC客户端配置：</p>
<ul>
<li>服务器：<code>服务器域名</code></li>
<li>端    口：<code>你设置的服务端口号</code></li>
<li>服务器密码：<code>你设置的密码，一般来说和用户密码相同</code></li>
<li>用户认证方式：<code>SASL Plain</code></li>
<li>用户名：<code>username@clientid/network</code></li>
<li>用户密码：<code>你的密码</code></li>
</ul>
<p>注意事项：</p>
<ol>
<li>需要消息回放请在Web端设置频道：<code>Detach</code></li>
<li>如果开启了<code>Protect Web Sessions:Disallow IP changing during each web session</code>选项，则只允许一个IP登录关机界面(没注销的话，其他IP登录了会显示403)</li>
<li><code>“Message of the Day”, sent to all ZNC users on connect.</code>是每日消息，每次登录都会显示的。</li>
</ol>
<h2 id="服务器安全"><a href="#服务器安全" class="headerlink" title="服务器安全"></a>服务器安全</h2><h3 id="禁用不必要的模块"><a href="#禁用不必要的模块" class="headerlink" title="禁用不必要的模块"></a>禁用不必要的模块</h3><p>Disable Apache modules that you don’t need. Good candidates are: </p>
<ul>
<li>userdir </li>
<li>suexec </li>
<li>cgi/cgid </li>
<li>include </li>
<li>autoindex (if you don’t need directory indexes) </li>
</ul>
<h3 id="防火墙"><a href="#防火墙" class="headerlink" title="防火墙"></a>防火墙</h3><h4 id="UFW"><a href="#UFW" class="headerlink" title="UFW"></a>UFW</h4><blockquote>
<p>使用UFW前记得事先建立SSH端口的防火墙规则！</p>
</blockquote>
<h3 id="其他参考"><a href="#其他参考" class="headerlink" title="其他参考"></a>其他参考</h3><ul>
<li><a href="https://wiki.debian.org/Apache/Hardening" target="_blank" rel="noopener">Debian Apache2</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Apache_HTTP_Server_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87" target="_blank" rel="noopener">Arch Wiki</a>)</li>
<li><a href="https://www.ssllabs.com/projects/documentation/index.html" target="_blank" rel="noopener">SSL Lab Docs</a></li>
</ul>
<h2 id="通用问题"><a href="#通用问题" class="headerlink" title="通用问题"></a>通用问题</h2><h3 id="服务器终端复用"><a href="#服务器终端复用" class="headerlink" title="服务器终端复用"></a>服务器终端复用</h3><p><a href="https://www.gnu.org/software/screen/" target="_blank" rel="noopener">帮助</a></p>
<p>使用<code>screen</code>命令：</p>
<p>安装：<code>sudo apt install screen</code></p>
<p>创建一个名为name的会话并进入： <code>screen -S name</code></p>
<p>列出已创建的会话：<code>screen -ls</code></p>
<p>重新进入会话：</p>
<p><code>screen -r pid</code> 使用<code>pid</code>号重新进入；</p>
<p> <code>screen -r name</code> 使用会话名称重新进入；</p>
<p>关闭会话：<br>在<code>screen</code>创建的会话中可以依次按下键盘 <code>ctrl + a</code>  、<code>k</code> 关闭当前会话，也可以输入<code>exit</code>命令来关闭。</p>
<p>离开会话保留<code>screen</code>会话中的任务或程序（后台运行）：</p>
<p><code>Ctrl</code>+<code>a</code> 、<code>d</code>     (即按住<code>Ctrl</code>，依次再按<code>a</code>，<code>d</code>)</p>
<p>结束所有：<code>screen -ls|awk &#39;NR&gt;=2&amp;&amp;NR&lt;=5{print $1}&#39;|awk &#39;{print &quot;screen -S &quot;$1&quot; -X quit&quot;}&#39;|sh</code></p>
<p>和Bash脚本互通：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 会话名</span></span><br><span class="line"><span class="attribute">screen_name</span>=<span class="string">"s_name"</span></span><br><span class="line">screen -dmS <span class="variable">$screen_name</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 要运行的命令</span></span><br><span class="line"><span class="attribute">cmd</span>=<span class="string">"top"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 向指定的会话传输内容（注意最后的回车使命令生效）</span></span><br><span class="line">screen -x -S <span class="variable">$screen_name</span> -p 0 -X stuff <span class="string">"<span class="variable">$cmd</span>\n"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以使用下面方式关闭会话</span></span><br><span class="line">screen -x -S <span class="variable">$screen_name</span> -p 0 -X quit</span><br></pre></td></tr></table></figure>
<h3 id="PHP-FPM没有在9000端口监听"><a href="#PHP-FPM没有在9000端口监听" class="headerlink" title="PHP-FPM没有在9000端口监听"></a>PHP-FPM没有在9000端口监听</h3><p>刚安装好<code>php-fpm</code>需要修改配置文件，如：<code>/etc/php/7.4/fpm/pool.d/www.conf</code>配置文件中的<code>listen = /run/php/php7.4-fpm.sock</code>需要注释掉，改成<code>;listen = /run/php/php7.4-fpm.sock</code>，然后在下一行添加<code>listen = 127.0.0.1:9000</code>，重启<code>php-fpm服务即可</code></p>
<h3 id="找不到Font-Awesome字体"><a href="#找不到Font-Awesome字体" class="headerlink" title="找不到Font-Awesome字体"></a>找不到Font-Awesome字体</h3><p>仓库：<a href="https://github.com/FortAwesome/Font-Awesome" target="_blank" rel="noopener">https://github.com/FortAwesome/Font-Awesome</a></p>
<p>下载：<a href="https://fontawesome.dashgame.com/" target="_blank" rel="noopener">https://fontawesome.dashgame.com/</a></p>
<h3 id="GoAccess日志格式"><a href="#GoAccess日志格式" class="headerlink" title="GoAccess日志格式"></a>GoAccess日志格式</h3><blockquote>
<p>转载：<a href="https://www.cnblogs.com/yjf512/p/3640346.html" target="_blank" rel="noopener">https://www.cnblogs.com/yjf512/p/3640346.html</a></p>
</blockquote>
<p>goaccess支持的日志格式：</p>
<p><strong>Common Log Format （CLF）</strong></p>
<p>通用日志格式，例子：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0.0.1</span> - frank <span class="string">[10/Oct/2000:13:55:36 -0700]</span> <span class="string">"<span class="keyword">GET</span> /apache_pb.gif HTTP/1.0"</span> <span class="number">200</span> <span class="number">2326</span></span><br><span class="line"></span><br><span class="line">主机   用户身份 作者 <span class="string">[日期]</span> <span class="string">"请求方法  请求路径 请求协议"</span> 状态码 字节数</span><br></pre></td></tr></table></figure>
<p> <strong>NCSA Commbined Log Format</strong></p>
<p>这个是Common Log Format的扩展，例子：</p>
<figure class="highlight accesslog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">125.125.125.125</span> - dsmith <span class="string">[10/Oct/1999:21:15:05 +0500]</span> <span class="string">"<span class="keyword">GET</span> /index.html HTTP/1.0"</span> <span class="number">200</span> <span class="number">1043</span> <span class="string">"http://www.ibm.com/"</span> <span class="string">"Mozilla/4.05 [en] (WinNT; I)"</span> <span class="string">"USERID=CustomerA;IMPID=01234"</span></span><br><span class="line"></span><br><span class="line">主机 用户身份 作者 <span class="string">[日期]</span> <span class="string">"请求方法 请求路径 请求协议"</span> 状态码 字节数 referrer 客户端代理 cookie</span><br></pre></td></tr></table></figure>
<p> <strong>W3C</strong></p>
<p>IIS 4.0和5.0是使用这种格式的，例子如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#Software: Microsoft Internet Information Server <span class="number">4.0</span></span><br><span class="line"></span><br><span class="line">#Version: <span class="number">1.0</span></span><br><span class="line"></span><br><span class="line">#Date: <span class="number">1998</span><span class="number">-11</span><span class="number">-19</span> <span class="number">22</span>:<span class="number">48</span>:<span class="number">39</span></span><br><span class="line"></span><br><span class="line">#Fields: date time c-ip cs-username s-ip cs-method cs-uri-stem cs-uri-query sc-status sc-bytes cs-bytes time-taken cs-version cs(User-Agent) cs(Cookie) cs(Referrer)</span><br><span class="line"></span><br><span class="line"><span class="number">1998</span><span class="number">-11</span><span class="number">-19</span> <span class="number">22</span>:<span class="number">48</span>:<span class="number">39</span> <span class="number">206.175</span><span class="number">.82</span><span class="number">.5</span> - <span class="number">208.201</span><span class="number">.133</span><span class="number">.173</span> GET /global/images/navlineboards.gif - <span class="number">200</span> <span class="number">540</span> <span class="number">324</span> <span class="number">157</span> HTTP/<span class="number">1.0</span> Mozilla/<span class="number">4.0</span>+(compatible;+MSIE+<span class="number">4.01</span>;+Windows+<span class="number">95</span>) USERID=CustomerA;+IMPID=<span class="number">01234</span> http:<span class="comment">//yourturn.rollingstone.com/webx?98@@webx1.html</span></span><br></pre></td></tr></table></figure>
<p> <strong>CloudFront</strong></p>
<p>AWS上的日志格式</p>
<p><strong>自定义格式</strong></p>
<p>关于自定义格式所设置的参数说明在<a href="http://goaccess.prosoftcorp.com/man" target="_blank" rel="noopener">这里</a></p>
<h2 id="走进科学"><a href="#走进科学" class="headerlink" title="走进科学"></a>走进科学</h2><blockquote>
<p>由于科研或者学习需要，各大高校都有专门的线路与国际学者交流。但毕业后怎么办呢？外文文献无法下载吗？那就自己想个办法吧，学习的路上有困难，但办法总比问题多。</p>
<p>本文代名词（请自行去掉【】后食用）：</p>
<ol>
<li>V【我50】M【The】ES【】S协议——VM协议</li>
<li>【Desto】X【Intro】-U【Esppd】I——UI面板 <a href="https://github.com/vaxilu/x-ui.git" target="_blank" rel="noopener">Github</a></li>
<li>V【我50KFC】2【Feng疯狂】R【星期三】ay【With Any】——鼠鼠<a href="(https://www.v2fly.org/">社区</a>)</li>
</ol>
</blockquote>
<h3 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a>Server端</h3><p>使用root用户一键安装：</p>
<p><code>bash &lt;(curl -Ls https://raw.githubusercontent.com/vaxilu/x-ui/master/install.sh)</code></p>
<p>或者</p>
<p><code>bash &lt;(curl -Ls https://jitsi.civiccccc.ltd:2053/res/free/x-ui/install.sh)</code></p>
<p>或者鼠鼠的<code>bash &lt;(curl -L https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh)</code></p>
<h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><ul>
<li><a href="https://github.com/2dust/v2rayN" target="_blank" rel="noopener">Windows</a></li>
<li><a href="https://github.com/v2rayA/v2rayA" target="_blank" rel="noopener">Linux A</a> or <a href="https://github.com/jiangxufeng/v2rayL" target="_blank" rel="noopener">Linux L</a></li>
<li><a href="https://github.com/2dust/v2rayNG" target="_blank" rel="noopener">Android</a></li>
</ul>
<p>备份于<a href="https://jitsi.civiccccc.ltd:2053/res/free/" target="_blank" rel="noopener">Jitsi CIVICCCCC</a></p>
<p>安装鼠鼠V5版本：<code>curl -O https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/env bash</span></span><br><span class="line"><span class="comment"># shellcheck disable=SC2268</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The files installed by the script conform to the Filesystem Hierarchy Standard:</span></span><br><span class="line"><span class="comment"># https://wiki.linuxfoundation.org/lsb/fhs</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The URL of the script project is:</span></span><br><span class="line"><span class="comment"># https://github.com/v2fly/fhs-install-v2ray</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The URL of the script is:</span></span><br><span class="line"><span class="comment"># https://raw.githubusercontent.com/v2fly/fhs-install-v2ray/master/install-release.sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># If the script executes incorrectly, go to:</span></span><br><span class="line"><span class="comment"># https://github.com/v2fly/fhs-install-v2ray/issues</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You can set this variable whatever you want in shell session right before running this script by issuing:</span></span><br><span class="line"><span class="comment"># export DAT_PATH='/usr/local/share/v2ray'</span></span><br><span class="line">DAT_PATH=<span class="variable">$&#123;DAT_PATH:-/usr/local/share/v2ray&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># You can set this variable whatever you want in shell session right before running this script by issuing:</span></span><br><span class="line"><span class="comment"># export JSON_PATH='/usr/local/etc/v2ray'</span></span><br><span class="line">JSON_PATH=<span class="variable">$&#123;JSON_PATH:-/usr/local/etc/v2ray&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this variable only if you are starting v2ray with multiple configuration files:</span></span><br><span class="line"><span class="comment"># export JSONS_PATH='/usr/local/etc/v2ray'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set this variable only if you want this script to check all the systemd unit file:</span></span><br><span class="line"><span class="comment"># export check_all_service_files='yes'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">curl</span></span>() &#123;</span><br><span class="line">  $(<span class="built_in">type</span> -P curl) -L -q --retry 5 --retry-delay 10 --retry-max-time 60 <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">systemd_cat_config</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> systemd-analyze --<span class="built_in">help</span> | grep -qw <span class="string">'cat-config'</span>; <span class="keyword">then</span></span><br><span class="line">    systemd-analyze --no-pager cat-config <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;aoi&#125;</span>~~~~~~~~~~~~~~~~"</span></span><br><span class="line">    cat <span class="string">"<span class="variable">$@</span>"</span> <span class="string">"<span class="variable">$1</span>"</span>.d/*</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;aoi&#125;</span>~~~~~~~~~~~~~~~~"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;red&#125;</span>warning: <span class="variable">$&#123;green&#125;</span>The systemd version on the current operating system is too low."</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;red&#125;</span>warning: <span class="variable">$&#123;green&#125;</span>Please consider to upgrade the systemd or the operating system.<span class="variable">$&#123;reset&#125;</span>"</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_if_running_as_root</span></span>() &#123;</span><br><span class="line">  <span class="comment"># If you want to run as another user, please modify $UID to be owned by this user</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$UID</span>"</span> -ne <span class="string">'0'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"WARNING: The user currently executing this script is not root. You may encounter the insufficient privilege error."</span></span><br><span class="line">    <span class="built_in">read</span> -r -p <span class="string">"Are you sure you want to continue? [y/n] "</span> cont_without_been_root</span><br><span class="line">    <span class="keyword">if</span> [[ x<span class="string">"<span class="variable">$&#123;cont_without_been_root:0:1&#125;</span>"</span> = x<span class="string">'y'</span> ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"Continuing the installation with current user..."</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"Not running with root, exiting..."</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">identify_the_operating_system_and_architecture</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$(uname)</span>"</span> == <span class="string">'Linux'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$(uname -m)</span>"</span> <span class="keyword">in</span></span><br><span class="line">      <span class="string">'i386'</span> | <span class="string">'i686'</span>)</span><br><span class="line">        MACHINE=<span class="string">'32'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'amd64'</span> | <span class="string">'x86_64'</span>)</span><br><span class="line">        MACHINE=<span class="string">'64'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'armv5tel'</span>)</span><br><span class="line">        MACHINE=<span class="string">'arm32-v5'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'armv6l'</span>)</span><br><span class="line">        MACHINE=<span class="string">'arm32-v6'</span></span><br><span class="line">        grep Features /proc/cpuinfo | grep -qw <span class="string">'vfp'</span> || MACHINE=<span class="string">'arm32-v5'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'armv7'</span> | <span class="string">'armv7l'</span>)</span><br><span class="line">        MACHINE=<span class="string">'arm32-v7a'</span></span><br><span class="line">        grep Features /proc/cpuinfo | grep -qw <span class="string">'vfp'</span> || MACHINE=<span class="string">'arm32-v5'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'armv8'</span> | <span class="string">'aarch64'</span>)</span><br><span class="line">        MACHINE=<span class="string">'arm64-v8a'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'mips'</span>)</span><br><span class="line">        MACHINE=<span class="string">'mips32'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'mipsle'</span>)</span><br><span class="line">        MACHINE=<span class="string">'mips32le'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'mips64'</span>)</span><br><span class="line">        MACHINE=<span class="string">'mips64'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'mips64le'</span>)</span><br><span class="line">        MACHINE=<span class="string">'mips64le'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'ppc64'</span>)</span><br><span class="line">        MACHINE=<span class="string">'ppc64'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'ppc64le'</span>)</span><br><span class="line">        MACHINE=<span class="string">'ppc64le'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'riscv64'</span>)</span><br><span class="line">        MACHINE=<span class="string">'riscv64'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'s390x'</span>)</span><br><span class="line">        MACHINE=<span class="string">'s390x'</span></span><br><span class="line">        ;;</span><br><span class="line">      *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"error: The architecture is not supported."</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    <span class="keyword">if</span> [[ ! -f <span class="string">'/etc/os-release'</span> ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"error: Don't use outdated Linux distributions."</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="comment"># Do not combine this judgment condition with the following judgment condition.</span></span><br><span class="line">    <span class="comment">## Be aware of Linux distribution like Gentoo, which kernel supports switch between Systemd and OpenRC.</span></span><br><span class="line">    <span class="comment">### Refer: https://github.com/v2fly/fhs-install-v2ray/issues/84#issuecomment-688574989</span></span><br><span class="line">    <span class="keyword">if</span> [[ -f /.dockerenv ]] || grep -q <span class="string">'docker\|lxc'</span> /proc/1/cgroup &amp;&amp; [[ <span class="string">"<span class="variable">$(type -P systemctl)</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">    <span class="keyword">elif</span> [[ -d /run/systemd/system ]] || grep -q systemd &lt;(ls -l /sbin/init); <span class="keyword">then</span></span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"error: Only Linux distributions using systemd are supported."</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$(type -P apt)</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      PACKAGE_MANAGEMENT_INSTALL=<span class="string">'apt -y --no-install-recommends install'</span></span><br><span class="line">      PACKAGE_MANAGEMENT_REMOVE=<span class="string">'apt purge'</span></span><br><span class="line">      package_provide_tput=<span class="string">'ncurses-bin'</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$(type -P dnf)</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      PACKAGE_MANAGEMENT_INSTALL=<span class="string">'dnf -y install'</span></span><br><span class="line">      PACKAGE_MANAGEMENT_REMOVE=<span class="string">'dnf remove'</span></span><br><span class="line">      package_provide_tput=<span class="string">'ncurses'</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$(type -P yum)</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      PACKAGE_MANAGEMENT_INSTALL=<span class="string">'yum -y install'</span></span><br><span class="line">      PACKAGE_MANAGEMENT_REMOVE=<span class="string">'yum remove'</span></span><br><span class="line">      package_provide_tput=<span class="string">'ncurses'</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$(type -P zypper)</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      PACKAGE_MANAGEMENT_INSTALL=<span class="string">'zypper install -y --no-recommends'</span></span><br><span class="line">      PACKAGE_MANAGEMENT_REMOVE=<span class="string">'zypper remove'</span></span><br><span class="line">      package_provide_tput=<span class="string">'ncurses-utils'</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$(type -P pacman)</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      PACKAGE_MANAGEMENT_INSTALL=<span class="string">'pacman -Syu --noconfirm'</span></span><br><span class="line">      PACKAGE_MANAGEMENT_REMOVE=<span class="string">'pacman -Rsn'</span></span><br><span class="line">      package_provide_tput=<span class="string">'ncurses'</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"error: The script does not support the package manager in this operating system."</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"error: This operating system is not supported."</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Demo function for processing parameters</span></span><br><span class="line"><span class="function"><span class="title">judgment_parameters</span></span>() &#123;</span><br><span class="line">  <span class="keyword">while</span> [[ <span class="string">"<span class="variable">$#</span>"</span> -gt <span class="string">'0'</span> ]]; <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">      <span class="string">'--remove'</span>)</span><br><span class="line">        <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$#</span>"</span> -gt <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">'error: Please enter the correct parameters.'</span></span><br><span class="line">          <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        REMOVE=<span class="string">'1'</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'--version'</span>)</span><br><span class="line">        VERSION=<span class="string">"<span class="variable">$&#123;2:?error: Please specify the correct version.&#125;</span>"</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'-c'</span> | <span class="string">'--check'</span>)</span><br><span class="line">        CHECK=<span class="string">'1'</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'-f'</span> | <span class="string">'--force'</span>)</span><br><span class="line">        FORCE=<span class="string">'1'</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'-h'</span> | <span class="string">'--help'</span>)</span><br><span class="line">        HELP=<span class="string">'1'</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'-l'</span> | <span class="string">'--local'</span>)</span><br><span class="line">        LOCAL_INSTALL=<span class="string">'1'</span></span><br><span class="line">        LOCAL_FILE=<span class="string">"<span class="variable">$&#123;2:?error: Please specify the correct local file.&#125;</span>"</span></span><br><span class="line">        <span class="built_in">break</span></span><br><span class="line">        ;;</span><br><span class="line">      <span class="string">'-p'</span> | <span class="string">'--proxy'</span>)</span><br><span class="line">        <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$&#123;2:?error: Please specify the proxy server address.&#125;</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        PROXY=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">        <span class="built_in">shift</span></span><br><span class="line">        ;;</span><br><span class="line">      *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$0</span>: unknown option -- -"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line">    <span class="built_in">shift</span></span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_software</span></span>() &#123;</span><br><span class="line">  package_name=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">  file_to_detect=<span class="string">"<span class="variable">$2</span>"</span></span><br><span class="line">  <span class="built_in">type</span> -P <span class="string">"<span class="variable">$file_to_detect</span>"</span> &gt; /dev/null 2&gt;&amp;1 &amp;&amp; <span class="built_in">return</span></span><br><span class="line">  <span class="keyword">if</span> <span class="variable">$&#123;PACKAGE_MANAGEMENT_INSTALL&#125;</span> <span class="string">"<span class="variable">$package_name</span>"</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"info: <span class="variable">$package_name</span> is installed."</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"error: Installation of <span class="variable">$package_name</span> failed, please check your network."</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_current_version</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> /usr/<span class="built_in">local</span>/bin/v2ray -version &gt; /dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    VERSION=<span class="string">"<span class="variable">$(/usr/local/bin/v2ray -version | awk 'NR==1 &#123;print $2&#125;')</span>"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    VERSION=<span class="string">"<span class="variable">$(/usr/local/bin/v2ray version | awk 'NR==1 &#123;print $2&#125;')</span>"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  CURRENT_VERSION=<span class="string">"v<span class="variable">$&#123;VERSION#v&#125;</span>"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">get_version</span></span>() &#123;</span><br><span class="line">  <span class="comment"># 0: Install or update V2Ray.</span></span><br><span class="line">  <span class="comment"># 1: Installed or no new version of V2Ray.</span></span><br><span class="line">  <span class="comment"># 2: Install the specified version of V2Ray.</span></span><br><span class="line">  <span class="keyword">if</span> [[ -n <span class="string">"<span class="variable">$VERSION</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    RELEASE_VERSION=<span class="string">"v<span class="variable">$&#123;VERSION#v&#125;</span>"</span></span><br><span class="line">    <span class="built_in">return</span> 2</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="comment"># Determine the version number for V2Ray installed from a local file</span></span><br><span class="line">  <span class="keyword">if</span> [[ -f <span class="string">'/usr/local/bin/v2ray'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    get_current_version</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$LOCAL_INSTALL</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">      RELEASE_VERSION=<span class="string">"<span class="variable">$CURRENT_VERSION</span>"</span></span><br><span class="line">      <span class="built_in">return</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="comment"># Get V2Ray release version number</span></span><br><span class="line">  TMP_FILE=<span class="string">"<span class="variable">$(mktemp)</span>"</span></span><br><span class="line">  <span class="keyword">if</span> ! curl -x <span class="string">"<span class="variable">$&#123;PROXY&#125;</span>"</span> -sS -i -H <span class="string">"Accept: application/vnd.github.v3+json"</span> -o <span class="string">"<span class="variable">$TMP_FILE</span>"</span> <span class="string">'https://api.github.com/repos/v2fly/v2ray-core/releases/latest'</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="string">"rm"</span> <span class="string">"<span class="variable">$TMP_FILE</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'error: Failed to get release list, please check your network.'</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  HTTP_STATUS_CODE=$(awk <span class="string">'NR==1 &#123;print $2&#125;'</span> <span class="string">"<span class="variable">$TMP_FILE</span>"</span>)</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="variable">$HTTP_STATUS_CODE</span> -lt 200 ]] || [[ <span class="variable">$HTTP_STATUS_CODE</span> -gt 299 ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="string">"rm"</span> <span class="string">"<span class="variable">$TMP_FILE</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"error: Failed to get release list, GitHub API response code: <span class="variable">$HTTP_STATUS_CODE</span>"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  RELEASE_LATEST=<span class="string">"<span class="variable">$(sed 'y/,/\n/' "$TMP_FILE" | grep 'tag_name' | awk -F '"' '&#123;print $4&#125;')</span>"</span></span><br><span class="line">  <span class="string">"rm"</span> <span class="string">"<span class="variable">$TMP_FILE</span>"</span></span><br><span class="line">  RELEASE_VERSION=<span class="string">"v<span class="variable">$&#123;RELEASE_LATEST#v&#125;</span>"</span></span><br><span class="line">  <span class="comment"># Compare V2Ray version numbers</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$RELEASE_VERSION</span>"</span> != <span class="string">"<span class="variable">$CURRENT_VERSION</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    RELEASE_VERSIONSION_NUMBER=<span class="string">"<span class="variable">$&#123;RELEASE_VERSION#v&#125;</span>"</span></span><br><span class="line">    RELEASE_MAJOR_VERSION_NUMBER=<span class="string">"<span class="variable">$&#123;RELEASE_VERSIONSION_NUMBER%%.*&#125;</span>"</span></span><br><span class="line">    RELEASE_MINOR_VERSION_NUMBER=<span class="string">"<span class="variable">$(echo "$RELEASE_VERSIONSION_NUMBER" | awk -F '.' '&#123;print $2&#125;')</span>"</span></span><br><span class="line">    RELEASE_MINIMUM_VERSION_NUMBER=<span class="string">"<span class="variable">$&#123;RELEASE_VERSIONSION_NUMBER##*.&#125;</span>"</span></span><br><span class="line">    <span class="comment"># shellcheck disable=SC2001</span></span><br><span class="line">    CURRENT_VERSION_NUMBER=<span class="string">"<span class="variable">$(echo "$&#123;CURRENT_VERSION#v&#125;" | sed 's/-.*//')</span>"</span></span><br><span class="line">    CURRENT_MAJOR_VERSION_NUMBER=<span class="string">"<span class="variable">$&#123;CURRENT_VERSION_NUMBER%%.*&#125;</span>"</span></span><br><span class="line">    CURRENT_MINOR_VERSION_NUMBER=<span class="string">"<span class="variable">$(echo "$CURRENT_VERSION_NUMBER" | awk -F '.' '&#123;print $2&#125;')</span>"</span></span><br><span class="line">    CURRENT_MINIMUM_VERSION_NUMBER=<span class="string">"<span class="variable">$&#123;CURRENT_VERSION_NUMBER##*.&#125;</span>"</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$RELEASE_MAJOR_VERSION_NUMBER</span>"</span> -gt <span class="string">"<span class="variable">$CURRENT_MAJOR_VERSION_NUMBER</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">return</span> 0</span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$RELEASE_MAJOR_VERSION_NUMBER</span>"</span> -eq <span class="string">"<span class="variable">$CURRENT_MAJOR_VERSION_NUMBER</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$RELEASE_MINOR_VERSION_NUMBER</span>"</span> -gt <span class="string">"<span class="variable">$CURRENT_MINOR_VERSION_NUMBER</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> 0</span><br><span class="line">      <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$RELEASE_MINOR_VERSION_NUMBER</span>"</span> -eq <span class="string">"<span class="variable">$CURRENT_MINOR_VERSION_NUMBER</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$RELEASE_MINIMUM_VERSION_NUMBER</span>"</span> -gt <span class="string">"<span class="variable">$CURRENT_MINIMUM_VERSION_NUMBER</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">          <span class="built_in">return</span> 0</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="built_in">return</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">return</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">return</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$RELEASE_VERSION</span>"</span> == <span class="string">"<span class="variable">$CURRENT_VERSION</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">download_v2ray</span></span>() &#123;</span><br><span class="line">  DOWNLOAD_LINK=<span class="string">"https://github.com/v2fly/v2ray-core/releases/download/<span class="variable">$RELEASE_VERSION</span>/v2ray-linux-<span class="variable">$MACHINE</span>.zip"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Downloading V2Ray archive: <span class="variable">$DOWNLOAD_LINK</span>"</span></span><br><span class="line">  <span class="keyword">if</span> ! curl -x <span class="string">"<span class="variable">$&#123;PROXY&#125;</span>"</span> -R -H <span class="string">'Cache-Control: no-cache'</span> -o <span class="string">"<span class="variable">$ZIP_FILE</span>"</span> <span class="string">"<span class="variable">$DOWNLOAD_LINK</span>"</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'error: Download failed! Please check your network or try again.'</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Downloading verification file for V2Ray archive: <span class="variable">$DOWNLOAD_LINK</span>.dgst"</span></span><br><span class="line">  <span class="keyword">if</span> ! curl -x <span class="string">"<span class="variable">$&#123;PROXY&#125;</span>"</span> -sSR -H <span class="string">'Cache-Control: no-cache'</span> -o <span class="string">"<span class="variable">$ZIP_FILE</span>.dgst"</span> <span class="string">"<span class="variable">$DOWNLOAD_LINK</span>.dgst"</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'error: Download failed! Please check your network or try again.'</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$(cat "$ZIP_FILE".dgst)</span>"</span> == <span class="string">'Not Found'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'error: This version does not support verification. Please replace with another version.'</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Verification of V2Ray archive</span></span><br><span class="line">  CHECKSUM=$(awk -F <span class="string">'= '</span> <span class="string">'/256=/ &#123;print $2&#125;'</span> &lt; <span class="string">"<span class="variable">$&#123;ZIP_FILE&#125;</span>.dgst"</span>)</span><br><span class="line">  LOCALSUM=$(sha256sum <span class="string">"<span class="variable">$ZIP_FILE</span>"</span> | awk <span class="string">'&#123;printf $1&#125;'</span>)</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$CHECKSUM</span>"</span> != <span class="string">"<span class="variable">$LOCALSUM</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'error: SHA256 check failed! Please check your network or try again.'</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">decompression</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> ! unzip -q <span class="string">"<span class="variable">$1</span>"</span> -d <span class="string">"<span class="variable">$TMP_DIRECTORY</span>"</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'error: V2Ray decompression failed.'</span></span><br><span class="line">    <span class="string">"rm"</span> -r <span class="string">"<span class="variable">$TMP_DIRECTORY</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"removed: <span class="variable">$TMP_DIRECTORY</span>"</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"info: Extract the V2Ray package to <span class="variable">$TMP_DIRECTORY</span> and prepare it for installation."</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_file</span></span>() &#123;</span><br><span class="line">  NAME=<span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$NAME</span>"</span> == <span class="string">'v2ray'</span> ]] || [[ <span class="string">"<span class="variable">$NAME</span>"</span> == <span class="string">'v2ctl'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    install -m 755 <span class="string">"<span class="variable">$&#123;TMP_DIRECTORY&#125;</span>/<span class="variable">$NAME</span>"</span> <span class="string">"/usr/local/bin/<span class="variable">$NAME</span>"</span></span><br><span class="line">  <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$NAME</span>"</span> == <span class="string">'geoip.dat'</span> ]] || [[ <span class="string">"<span class="variable">$NAME</span>"</span> == <span class="string">'geosite.dat'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    install -m 644 <span class="string">"<span class="variable">$&#123;TMP_DIRECTORY&#125;</span>/<span class="variable">$NAME</span>"</span> <span class="string">"<span class="variable">$&#123;DAT_PATH&#125;</span>/<span class="variable">$NAME</span>"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_v2ray</span></span>() &#123;</span><br><span class="line">  <span class="comment"># Install V2Ray binary to /usr/local/bin/ and $DAT_PATH</span></span><br><span class="line">  install_file v2ray</span><br><span class="line">  <span class="keyword">if</span> [[ -f <span class="string">"<span class="variable">$&#123;TMP_DIRECTORY&#125;</span>/v2ctl"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    install_file v2ctl</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">if</span> [[ -f <span class="string">'/usr/local/bin/v2ctl'</span> ]]; <span class="keyword">then</span></span><br><span class="line">      rm <span class="string">'/usr/local/bin/v2ctl'</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  install -d <span class="string">"<span class="variable">$DAT_PATH</span>"</span></span><br><span class="line">  <span class="comment"># If the file exists, geoip.dat and geosite.dat will not be installed or updated</span></span><br><span class="line">  <span class="keyword">if</span> [[ ! -f <span class="string">"<span class="variable">$&#123;DAT_PATH&#125;</span>/.undat"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    install_file geoip.dat</span><br><span class="line">    install_file geosite.dat</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Install V2Ray configuration file to $JSON_PATH</span></span><br><span class="line">  <span class="comment"># shellcheck disable=SC2153</span></span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$JSONS_PATH</span>"</span> ]] &amp;&amp; [[ ! -d <span class="string">"<span class="variable">$JSON_PATH</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    install -d <span class="string">"<span class="variable">$JSON_PATH</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&#123;&#125;"</span> &gt; <span class="string">"<span class="variable">$&#123;JSON_PATH&#125;</span>/config.json"</span></span><br><span class="line">    CONFIG_NEW=<span class="string">'1'</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Install V2Ray configuration file to $JSONS_PATH</span></span><br><span class="line">  <span class="keyword">if</span> [[ -n <span class="string">"<span class="variable">$JSONS_PATH</span>"</span> ]] &amp;&amp; [[ ! -d <span class="string">"<span class="variable">$JSONS_PATH</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    install -d <span class="string">"<span class="variable">$JSONS_PATH</span>"</span></span><br><span class="line">    <span class="keyword">for</span> BASE <span class="keyword">in</span> 00_log 01_api 02_dns 03_routing 04_policy 05_inbounds 06_outbounds 07_transport 08_stats 09_reverse; <span class="keyword">do</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'&#123;&#125;'</span> &gt; <span class="string">"<span class="variable">$&#123;JSONS_PATH&#125;</span>/<span class="variable">$&#123;BASE&#125;</span>.json"</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    CONFDIR=<span class="string">'1'</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Used to store V2Ray log files</span></span><br><span class="line">  <span class="keyword">if</span> [[ ! -d <span class="string">'/var/log/v2ray/'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> id nobody | grep -qw <span class="string">'nogroup'</span>; <span class="keyword">then</span></span><br><span class="line">      install -d -m 700 -o nobody -g nogroup /var/<span class="built_in">log</span>/v2ray/</span><br><span class="line">      install -m 600 -o nobody -g nogroup /dev/null /var/<span class="built_in">log</span>/v2ray/access.log</span><br><span class="line">      install -m 600 -o nobody -g nogroup /dev/null /var/<span class="built_in">log</span>/v2ray/error.log</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      install -d -m 700 -o nobody -g nobody /var/<span class="built_in">log</span>/v2ray/</span><br><span class="line">      install -m 600 -o nobody -g nobody /dev/null /var/<span class="built_in">log</span>/v2ray/access.log</span><br><span class="line">      install -m 600 -o nobody -g nobody /dev/null /var/<span class="built_in">log</span>/v2ray/error.log</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    LOG=<span class="string">'1'</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">install_startup_service_file</span></span>() &#123;</span><br><span class="line">  get_current_version</span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$(echo "$&#123;CURRENT_VERSION#v&#125;" | sed 's/-.*//' | awk -F'.' '&#123;print $1&#125;')</span>"</span> -gt <span class="string">"4"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    START_COMMAND=<span class="string">"/usr/local/bin/v2ray run"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    START_COMMAND=<span class="string">"/usr/local/bin/v2ray"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  install -m 644 <span class="string">"<span class="variable">$&#123;TMP_DIRECTORY&#125;</span>/systemd/system/v2ray.service"</span> /etc/systemd/system/v2ray.service</span><br><span class="line">  install -m 644 <span class="string">"<span class="variable">$&#123;TMP_DIRECTORY&#125;</span>/systemd/system/v2ray@.service"</span> /etc/systemd/system/v2ray@.service</span><br><span class="line">  mkdir -p <span class="string">'/etc/systemd/system/v2ray.service.d'</span></span><br><span class="line">  mkdir -p <span class="string">'/etc/systemd/system/v2ray@.service.d/'</span></span><br><span class="line">  <span class="keyword">if</span> [[ -n <span class="string">"<span class="variable">$JSONS_PATH</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="string">"rm"</span> -f <span class="string">'/etc/systemd/system/v2ray.service.d/10-donot_touch_single_conf.conf'</span> \</span><br><span class="line">      <span class="string">'/etc/systemd/system/v2ray@.service.d/10-donot_touch_single_conf.conf'</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"# In case you have a good reason to do so, duplicate this file in the same directory and make your customizes there.</span></span><br><span class="line"><span class="string"># Or all changes you made will be lost!  # Refer: https://www.freedesktop.org/software/systemd/man/systemd.unit.html</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=</span></span><br><span class="line"><span class="string">ExecStart=<span class="variable">$&#123;START_COMMAND&#125;</span> -confdir <span class="variable">$JSONS_PATH</span>"</span> |</span><br><span class="line">      tee <span class="string">'/etc/systemd/system/v2ray.service.d/10-donot_touch_multi_conf.conf'</span> &gt; <span class="string">'/etc/systemd/system/v2ray@.service.d/10-donot_touch_multi_conf.conf'</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="string">"rm"</span> -f <span class="string">'/etc/systemd/system/v2ray.service.d/10-donot_touch_multi_conf.conf'</span> \</span><br><span class="line">      <span class="string">'/etc/systemd/system/v2ray@.service.d/10-donot_touch_multi_conf.conf'</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"# In case you have a good reason to do so, duplicate this file in the same directory and make your customizes there.</span></span><br><span class="line"><span class="string"># Or all changes you made will be lost!  # Refer: https://www.freedesktop.org/software/systemd/man/systemd.unit.html</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=</span></span><br><span class="line"><span class="string">ExecStart=<span class="variable">$&#123;START_COMMAND&#125;</span> -config <span class="variable">$&#123;JSON_PATH&#125;</span>/config.json"</span> &gt; <span class="string">'/etc/systemd/system/v2ray.service.d/10-donot_touch_single_conf.conf'</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"# In case you have a good reason to do so, duplicate this file in the same directory and make your customizes there.</span></span><br><span class="line"><span class="string"># Or all changes you made will be lost!  # Refer: https://www.freedesktop.org/software/systemd/man/systemd.unit.html</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string">ExecStart=</span></span><br><span class="line"><span class="string">ExecStart=<span class="variable">$&#123;START_COMMAND&#125;</span> -config <span class="variable">$&#123;JSON_PATH&#125;</span>/%i.json"</span> &gt; <span class="string">'/etc/systemd/system/v2ray@.service.d/10-donot_touch_single_conf.conf'</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"info: Systemd service files have been installed successfully!"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;red&#125;</span>warning: <span class="variable">$&#123;green&#125;</span>The following are the actual parameters for the v2ray service startup."</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;red&#125;</span>warning: <span class="variable">$&#123;green&#125;</span>Please make sure the configuration file path is correctly set.<span class="variable">$&#123;reset&#125;</span>"</span></span><br><span class="line">  systemd_cat_config /etc/systemd/system/v2ray.service</span><br><span class="line">  <span class="comment"># shellcheck disable=SC2154</span></span><br><span class="line">  <span class="keyword">if</span> [[ x<span class="string">"<span class="variable">$&#123;check_all_service_files:0:1&#125;</span>"</span> = x<span class="string">'y'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    <span class="built_in">echo</span></span><br><span class="line">    systemd_cat_config /etc/systemd/system/v2ray@.service</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  systemctl daemon-reload</span><br><span class="line">  SYSTEMD=<span class="string">'1'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">start_v2ray</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [[ -f <span class="string">'/etc/systemd/system/v2ray.service'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> systemctl start <span class="string">"<span class="variable">$&#123;V2RAY_CUSTOMIZE:-v2ray&#125;</span>"</span>; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'info: Start the V2Ray service.'</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'error: Failed to start V2Ray service.'</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">stop_v2ray</span></span>() &#123;</span><br><span class="line">  V2RAY_CUSTOMIZE=<span class="string">"<span class="variable">$(systemctl list-units | grep 'v2ray@' | awk -F ' ' '&#123;print $1&#125;')</span>"</span></span><br><span class="line">  <span class="keyword">if</span> [[ -z <span class="string">"<span class="variable">$V2RAY_CUSTOMIZE</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">local</span> v2ray_daemon_to_stop=<span class="string">'v2ray.service'</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">local</span> v2ray_daemon_to_stop=<span class="string">"<span class="variable">$V2RAY_CUSTOMIZE</span>"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> ! systemctl stop <span class="string">"<span class="variable">$v2ray_daemon_to_stop</span>"</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'error: Stopping the V2Ray service failed.'</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'info: Stop the V2Ray service.'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">check_update</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> [[ -f <span class="string">'/etc/systemd/system/v2ray.service'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    get_version</span><br><span class="line">    <span class="built_in">local</span> get_ver_exit_code=$?</span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$get_ver_exit_code</span>"</span> -eq <span class="string">'0'</span> ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"info: Found the latest release of V2Ray <span class="variable">$RELEASE_VERSION</span> . (Current release: <span class="variable">$CURRENT_VERSION</span>)"</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$get_ver_exit_code</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"info: No new version. The current version of V2Ray is <span class="variable">$CURRENT_VERSION</span> ."</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">exit</span> 0</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'error: V2Ray is not installed.'</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">remove_v2ray</span></span>() &#123;</span><br><span class="line">  <span class="keyword">if</span> systemctl list-unit-files | grep -qw <span class="string">'v2ray'</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">"<span class="variable">$(pidof v2ray)</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      stop_v2ray</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">if</span> ! (<span class="string">"rm"</span> -r <span class="string">'/usr/local/bin/v2ray'</span> \</span><br><span class="line">      <span class="string">"<span class="variable">$DAT_PATH</span>"</span> \</span><br><span class="line">      <span class="string">'/etc/systemd/system/v2ray.service'</span> \</span><br><span class="line">      <span class="string">'/etc/systemd/system/v2ray@.service'</span> \</span><br><span class="line">      <span class="string">'/etc/systemd/system/v2ray.service.d'</span> \</span><br><span class="line">      <span class="string">'/etc/systemd/system/v2ray@.service.d'</span>); <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'error: Failed to remove V2Ray.'</span></span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'removed: /usr/local/bin/v2ray'</span></span><br><span class="line">      <span class="keyword">if</span> [[ -f <span class="string">'/usr/local/bin/v2ctl'</span> ]]; <span class="keyword">then</span></span><br><span class="line">        rm <span class="string">'/usr/local/bin/v2ctl'</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">'removed: /usr/local/bin/v2ctl'</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"removed: <span class="variable">$DAT_PATH</span>"</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'removed: /etc/systemd/system/v2ray.service'</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'removed: /etc/systemd/system/v2ray@.service'</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'removed: /etc/systemd/system/v2ray.service.d'</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'removed: /etc/systemd/system/v2ray@.service.d'</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'Please execute the command: systemctl disable v2ray'</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"You may need to execute a command to remove dependent software: <span class="variable">$PACKAGE_MANAGEMENT_REMOVE</span> curl unzip"</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'info: V2Ray has been removed.'</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">'info: If necessary, manually delete the configuration and log files.'</span></span><br><span class="line">      <span class="keyword">if</span> [[ -n <span class="string">"<span class="variable">$JSONS_PATH</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"info: e.g., <span class="variable">$JSONS_PATH</span> and /var/log/v2ray/ ..."</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"info: e.g., <span class="variable">$JSON_PATH</span> and /var/log/v2ray/ ..."</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      <span class="built_in">exit</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'error: V2Ray is not installed.'</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Explanation of parameters in the script</span></span><br><span class="line"><span class="function"><span class="title">show_help</span></span>() &#123;</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$0</span> [--remove | --version number | -c | -f | -h | -l | -p]"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'  [-p address] [--version number | -c | -f]'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'  --remove        Remove V2Ray'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'  --version       Install the specified version of V2Ray, e.g., --version v4.18.0'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'  -c, --check     Check if V2Ray can be updated'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'  -f, --force     Force installation of the latest version of V2Ray'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'  -h, --help      Show help'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'  -l, --local     Install V2Ray from a local file'</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'  -p, --proxy     Download through a proxy server, e.g., -p http://127.0.0.1:8118 or -p socks5://127.0.0.1:1080'</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">  check_if_running_as_root</span><br><span class="line">  identify_the_operating_system_and_architecture</span><br><span class="line">  judgment_parameters <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"></span><br><span class="line">  install_software <span class="string">"<span class="variable">$package_provide_tput</span>"</span> <span class="string">'tput'</span></span><br><span class="line">  red=$(tput setaf 1)</span><br><span class="line">  green=$(tput setaf 2)</span><br><span class="line">  aoi=$(tput setaf 6)</span><br><span class="line">  reset=$(tput sgr0)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Parameter information</span></span><br><span class="line">  [[ <span class="string">"<span class="variable">$HELP</span>"</span> -eq <span class="string">'1'</span> ]] &amp;&amp; show_help</span><br><span class="line">  [[ <span class="string">"<span class="variable">$CHECK</span>"</span> -eq <span class="string">'1'</span> ]] &amp;&amp; check_update</span><br><span class="line">  [[ <span class="string">"<span class="variable">$REMOVE</span>"</span> -eq <span class="string">'1'</span> ]] &amp;&amp; remove_v2ray</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Two very important variables</span></span><br><span class="line">  TMP_DIRECTORY=<span class="string">"<span class="variable">$(mktemp -d)</span>"</span></span><br><span class="line">  ZIP_FILE=<span class="string">"<span class="variable">$&#123;TMP_DIRECTORY&#125;</span>/v2ray-linux-<span class="variable">$MACHINE</span>.zip"</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Install V2Ray from a local file, but still need to make sure the network is available</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$LOCAL_INSTALL</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'warn: Install V2Ray from a local file, but still need to make sure the network is available.'</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">'warn: Please make sure the file is valid because we cannot confirm it. (Press any key) ...'</span></span><br><span class="line">    <span class="built_in">read</span> -r</span><br><span class="line">    install_software <span class="string">'unzip'</span> <span class="string">'unzip'</span></span><br><span class="line">    decompression <span class="string">"<span class="variable">$LOCAL_FILE</span>"</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="comment"># Normal way</span></span><br><span class="line">    install_software <span class="string">'curl'</span> <span class="string">'curl'</span></span><br><span class="line">    get_version</span><br><span class="line">    NUMBER=<span class="string">"$?"</span></span><br><span class="line">    <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$NUMBER</span>"</span> -eq <span class="string">'0'</span> ]] || [[ <span class="string">"<span class="variable">$FORCE</span>"</span> -eq <span class="string">'1'</span> ]] || [[ <span class="string">"<span class="variable">$NUMBER</span>"</span> -eq 2 ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"info: Installing V2Ray <span class="variable">$RELEASE_VERSION</span> for <span class="variable">$(uname -m)</span>"</span></span><br><span class="line">      download_v2ray</span><br><span class="line">      <span class="keyword">if</span> [[ <span class="string">"$?"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">        <span class="string">"rm"</span> -r <span class="string">"<span class="variable">$TMP_DIRECTORY</span>"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"removed: <span class="variable">$TMP_DIRECTORY</span>"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">      install_software <span class="string">'unzip'</span> <span class="string">'unzip'</span></span><br><span class="line">      decompression <span class="string">"<span class="variable">$ZIP_FILE</span>"</span></span><br><span class="line">    <span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$NUMBER</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"info: No new version. The current version of V2Ray is <span class="variable">$CURRENT_VERSION</span> ."</span></span><br><span class="line">      <span class="built_in">exit</span> 0</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Determine if V2Ray is running</span></span><br><span class="line">  <span class="keyword">if</span> systemctl list-unit-files | grep -qw <span class="string">'v2ray'</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [[ -n <span class="string">"<span class="variable">$(pidof v2ray)</span>"</span> ]]; <span class="keyword">then</span></span><br><span class="line">      stop_v2ray</span><br><span class="line">      V2RAY_RUNNING=<span class="string">'1'</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  install_v2ray</span><br><span class="line">  install_startup_service_file</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">'installed: /usr/local/bin/v2ray'</span></span><br><span class="line">  <span class="keyword">if</span> [[ -f <span class="string">'/usr/local/bin/v2ctl'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'installed: /usr/local/bin/v2ctl'</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="comment"># If the file exists, the content output of installing or updating geoip.dat and geosite.dat will not be displayed</span></span><br><span class="line">  <span class="keyword">if</span> [[ ! -f <span class="string">"<span class="variable">$&#123;DAT_PATH&#125;</span>/.undat"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;DAT_PATH&#125;</span>/geoip.dat"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;DAT_PATH&#125;</span>/geosite.dat"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$CONFIG_NEW</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/config.json"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$CONFDIR</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/00_log.json"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/01_api.json"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/02_dns.json"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/03_routing.json"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/04_policy.json"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/05_inbounds.json"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/06_outbounds.json"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/07_transport.json"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/08_stats.json"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"installed: <span class="variable">$&#123;JSON_PATH&#125;</span>/09_reverse.json"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$LOG</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'installed: /var/log/v2ray/'</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'installed: /var/log/v2ray/access.log'</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'installed: /var/log/v2ray/error.log'</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$SYSTEMD</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'installed: /etc/systemd/system/v2ray.service'</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'installed: /etc/systemd/system/v2ray@.service'</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="string">"rm"</span> -r <span class="string">"<span class="variable">$TMP_DIRECTORY</span>"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"removed: <span class="variable">$TMP_DIRECTORY</span>"</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$LOCAL_INSTALL</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    get_version</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"info: V2Ray <span class="variable">$RELEASE_VERSION</span> is installed."</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"You may need to execute a command to remove dependent software: <span class="variable">$PACKAGE_MANAGEMENT_REMOVE</span> curl unzip"</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">"<span class="variable">$V2RAY_RUNNING</span>"</span> -eq <span class="string">'1'</span> ]]; <span class="keyword">then</span></span><br><span class="line">    start_v2ray</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">'Please execute the command: systemctl enable v2ray; systemctl start v2ray'</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">main <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure>
<h3 id="临时"><a href="#临时" class="headerlink" title="临时"></a>临时</h3><ul>
<li><a href="https://9.234456.xyz/abc.html?t=567" target="_blank" rel="noopener">XYZ</a></li>
</ul>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/2020/Bilibili-navigation/" data-toggle="tooltip" data-placement="top" title="My Bilibili navigation">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/2020/Build-a-blog-with-Hexo-framework/" data-toggle="tooltip" data-placement="top" title="Build a blog with Hexo framework">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <div class="tip">
          <p>
            If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
          </p>
        </div>
        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=Debian Server&body=Hi,I found this website and thought you might like it https://rmshadows.gitee.io/2020/Debian-Server/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!--修改--artalk-->
<!-- 0.artalk安装代码 -->

<!-- CSS -->
<link href="https://civiccccc.ltd/artalk/dist/Artalk.css" rel="stylesheet" />
<link href="https://civiccccc.ltd/artalk/dist/Artalk.css" rel="stylesheet" />
<!-- JS -->
<script src="https://civiccccc.ltd/artalk/dist/Artalk.js"></script>
<!-- Artalk -->
<div id="Comments"></div>
<script>
  Artalk.init({
    el: '#Comments', // 绑定元素的 Selector
    pageKey: 'https://rmshadows.gitee.io/2020/Debian-Server/', // 固定链接
    pageTitle: '', // 页面标题 (留空自动获取)
    server: 'https://civiccccc.ltd/artalk', // 后端地址
    site: 'CIVICCCCC的博客', // 你的站点名
  })
</script>
<!-- artalk安装代码已完成 -->



<!-- 1. gitalk comment -->



<!-- 2. gitment comment -->



<!-- 3. disqus comment -->


<!--修改--Livere-->


<!--修改--ISSO-->

        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <!--div id="toc" class="toc-article" -->
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          
            <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#服务器"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">服务器</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#我的服务器快速部署脚本「仅限Debian」"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">我的服务器快速部署脚本「仅限Debian」</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#服务器域名、SSL证书购买"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">服务器域名、SSL证书购买</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#服务器应用"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">服务器应用</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Apache2"><span class="toc-nav-number">4.1.</span> <span class="toc-nav-text">Apache2</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#配置SSL"><span class="toc-nav-number">4.1.1.</span> <span class="toc-nav-text">配置SSL</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#代理"><span class="toc-nav-number">4.1.2.</span> <span class="toc-nav-text">代理</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#反向代理"><span class="toc-nav-number">4.1.2.1.</span> <span class="toc-nav-text">反向代理</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#其他配置"><span class="toc-nav-number">4.1.3.</span> <span class="toc-nav-text">其他配置</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Docker"><span class="toc-nav-number">4.2.</span> <span class="toc-nav-text">Docker</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#配置systemctl服务控制docker容器运行"><span class="toc-nav-number">4.2.1.</span> <span class="toc-nav-text">配置systemctl服务控制docker容器运行</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#FFmpeg推流"><span class="toc-nav-number">4.3.</span> <span class="toc-nav-text">FFmpeg推流</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#FRP内网穿透"><span class="toc-nav-number">4.4.</span> <span class="toc-nav-text">FRP内网穿透</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#0-54-0版"><span class="toc-nav-number">4.4.1.</span> <span class="toc-nav-text">0.54.0版</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#安装服务"><span class="toc-nav-number">4.4.1.1.</span> <span class="toc-nav-text">安装服务</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#服务端"><span class="toc-nav-number">4.4.1.2.</span> <span class="toc-nav-text">服务端</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#XTCP-P2P"><span class="toc-nav-number">4.4.1.3.</span> <span class="toc-nav-text">XTCP-P2P</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#0-37-0版本"><span class="toc-nav-number">4.4.2.</span> <span class="toc-nav-text">0.37.0版本</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Hackchat"><span class="toc-nav-number">4.5.</span> <span class="toc-nav-text">Hackchat</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#内置命令"><span class="toc-nav-number">4.5.1.</span> <span class="toc-nav-text">内置命令</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#修改监听端口号"><span class="toc-nav-number">4.5.2.</span> <span class="toc-nav-text">修改监听端口号</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#修改首页信息、Websocket地址和nginx反向代理配置"><span class="toc-nav-number">4.5.3.</span> <span class="toc-nav-text">修改首页信息、Websocket地址和nginx反向代理配置</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Nginx反向代理配置"><span class="toc-nav-number">4.5.4.</span> <span class="toc-nav-text">Nginx反向代理配置</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ISSO"><span class="toc-nav-number">4.6.</span> <span class="toc-nav-text">ISSO</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#新建ISSO配置"><span class="toc-nav-number">4.6.1.</span> <span class="toc-nav-text">新建ISSO配置</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Nginx代理"><span class="toc-nav-number">4.6.2.</span> <span class="toc-nav-text">Nginx代理</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#引入代码"><span class="toc-nav-number">4.6.3.</span> <span class="toc-nav-text">引入代码</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#JAMS——Jami-Server"><span class="toc-nav-number">4.7.</span> <span class="toc-nav-text">JAMS——Jami Server</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Jitsi-Meet"><span class="toc-nav-number">4.8.</span> <span class="toc-nav-text">Jitsi-Meet</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#配置需求"><span class="toc-nav-number">4.8.1.</span> <span class="toc-nav-text">配置需求</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#安装"><span class="toc-nav-number">4.8.2.</span> <span class="toc-nav-text">安装</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Docker-1"><span class="toc-nav-number">4.8.2.1.</span> <span class="toc-nav-text">Docker</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Debian"><span class="toc-nav-number">4.8.2.2.</span> <span class="toc-nav-text">Debian</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Linx-server"><span class="toc-nav-number">4.9.</span> <span class="toc-nav-text">Linx-server</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#安装-1"><span class="toc-nav-number">4.9.1.</span> <span class="toc-nav-text">安装</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#目录结构"><span class="toc-nav-number">4.9.2.</span> <span class="toc-nav-text">目录结构</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#自定义主页"><span class="toc-nav-number">4.9.3.</span> <span class="toc-nav-text">自定义主页</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#关于写入权限"><span class="toc-nav-number">4.9.4.</span> <span class="toc-nav-text">关于写入权限</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Matterbridge"><span class="toc-nav-number">4.10.</span> <span class="toc-nav-text">Matterbridge</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#下载和安装"><span class="toc-nav-number">4.10.1.</span> <span class="toc-nav-text">下载和安装</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#配置文件matterbridge-toml"><span class="toc-nav-number">4.10.2.</span> <span class="toc-nav-text">配置文件matterbridge.toml</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#运行"><span class="toc-nav-number">4.10.3.</span> <span class="toc-nav-text">运行</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#NGINX"><span class="toc-nav-number">4.11.</span> <span class="toc-nav-text">NGINX</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Nginx显示网站目录文件列表"><span class="toc-nav-number">4.11.1.</span> <span class="toc-nav-text">Nginx显示网站目录文件列表</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#加密的目录"><span class="toc-nav-number">4.11.2.</span> <span class="toc-nav-text">加密的目录</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#禁止访问某些后缀的文件"><span class="toc-nav-number">4.11.3.</span> <span class="toc-nav-text">禁止访问某些后缀的文件</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#解决Nginx无法访问js等文件"><span class="toc-nav-number">4.11.4.</span> <span class="toc-nav-text">解决Nginx无法访问js等文件</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#限制IP"><span class="toc-nav-number">4.11.5.</span> <span class="toc-nav-text">限制IP</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#Nginx反向代理-Reverse-Proxy"><span class="toc-nav-number">4.11.6.</span> <span class="toc-nav-text">Nginx反向代理 - Reverse Proxy</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#末尾加不加斜杠的区别"><span class="toc-nav-number">4.11.6.1.</span> <span class="toc-nav-text">末尾加不加斜杠的区别</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Option-1-Subdomain"><span class="toc-nav-number">4.11.6.2.</span> <span class="toc-nav-text">Option 1: Subdomain</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Option-2-Port"><span class="toc-nav-number">4.11.6.3.</span> <span class="toc-nav-text">Option 2: Port</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Option-3-Symmetric-Path"><span class="toc-nav-number">4.11.6.4.</span> <span class="toc-nav-text">Option 3: Symmetric Path</span></a></li><li class="toc-nav-item toc-nav-level-5"><a class="toc-nav-link" href="#Option-4-Asymmetric-Path"><span class="toc-nav-number">4.11.6.5.</span> <span class="toc-nav-text">Option 4: Asymmetric Path</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Kplayer"><span class="toc-nav-number">4.12.</span> <span class="toc-nav-text">Kplayer</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#TightVNC"><span class="toc-nav-number">4.13.</span> <span class="toc-nav-text">TightVNC</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#VNC运行灰屏解决方法"><span class="toc-nav-number">4.13.1.</span> <span class="toc-nav-text">VNC运行灰屏解决方法</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Tiny-file-manager-PHP"><span class="toc-nav-number">4.14.</span> <span class="toc-nav-text">Tiny-file-manager(PHP)</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#修改根目录"><span class="toc-nav-number">4.14.1.</span> <span class="toc-nav-text">修改根目录</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#关于写入权限（如果你的PHP页面配置无法保存）"><span class="toc-nav-number">4.14.2.</span> <span class="toc-nav-text">关于写入权限（如果你的PHP页面配置无法保存）</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#ZNC"><span class="toc-nav-number">4.15.</span> <span class="toc-nav-text">ZNC</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#安装-2"><span class="toc-nav-number">4.15.1.</span> <span class="toc-nav-text">安装</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#运行-1"><span class="toc-nav-number">4.15.2.</span> <span class="toc-nav-text">运行</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#连接"><span class="toc-nav-number">4.15.3.</span> <span class="toc-nav-text">连接</span></a></li></ol></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#服务器安全"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">服务器安全</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#禁用不必要的模块"><span class="toc-nav-number">5.1.</span> <span class="toc-nav-text">禁用不必要的模块</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#防火墙"><span class="toc-nav-number">5.2.</span> <span class="toc-nav-text">防火墙</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#UFW"><span class="toc-nav-number">5.2.1.</span> <span class="toc-nav-text">UFW</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#其他参考"><span class="toc-nav-number">5.3.</span> <span class="toc-nav-text">其他参考</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#通用问题"><span class="toc-nav-number">6.</span> <span class="toc-nav-text">通用问题</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#服务器终端复用"><span class="toc-nav-number">6.1.</span> <span class="toc-nav-text">服务器终端复用</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#PHP-FPM没有在9000端口监听"><span class="toc-nav-number">6.2.</span> <span class="toc-nav-text">PHP-FPM没有在9000端口监听</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#找不到Font-Awesome字体"><span class="toc-nav-number">6.3.</span> <span class="toc-nav-text">找不到Font-Awesome字体</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#GoAccess日志格式"><span class="toc-nav-number">6.4.</span> <span class="toc-nav-text">GoAccess日志格式</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#走进科学"><span class="toc-nav-number">7.</span> <span class="toc-nav-text">走进科学</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#Server端"><span class="toc-nav-number">7.1.</span> <span class="toc-nav-text">Server端</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#客户端"><span class="toc-nav-number">7.2.</span> <span class="toc-nav-text">客户端</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#临时"><span class="toc-nav-number">7.3.</span> <span class="toc-nav-text">临时</span></a></li></ol></li></ol>
          
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Debian" title="Debian">Debian</a>
            
            <a class="tag" href="/tags/#Server" title="Server">Server</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://civiccccc.ltd" target="_blank">主站</a>
          </li>
          
          <li>
            <a href="https://github.com/xjx0106" target="_blank">国庆电播小弟</a>
          </li>
          
          <li>
            <a href="https://github.com/itcast-ying" target="_blank">itcast-ying</a>
          </li>
          
          <li>
            <a href="https://github.com/cjj19970505" target="_blank">Xeon-J</a>
          </li>
          
          <li>
            <a href="https://github.com/XeonKHJ" target="_blank">Xeon-H</a>
          </li>
          
          <li>
            <a href="https://gitee.com/rmshadows" target="_blank">Gitee - Ryan Yim</a>
          </li>
          
          <li>
            <a href="https://rmshadows.gitee.io/404" target="_blank">404 No Found Page</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



    <!-- Footer (contains ThemeColor、viewer) -->
    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          
            <li>
              <a href="/feed.xml">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://github.com/rmshadows">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          
            <li>
              <a target="_blank" href="https://www.instagram.com/just_aaaa_r">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          
            <li>
              <a target="_blank" href="https://www.zhihu.com/people/rmshadows">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse">知</i>
                </span>
              </a>
            </li>
          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Ryan Yim
          2025
          <br>
          Theme by
          <a href="http://beantech.org" target="_blank" rel="noopener">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a href="https://v-vincen.life/" target="_blank" rel="noopener">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>

<!-- jQuery -->
<script type="text/javascript" src="/js/jquery.min.js"></script>
<!-- <script type="text/javascript" src="/js/jquery.js"></script> -->
<!-- <script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->

<!-- Bootstrap Core JavaScript -->
<script type="text/javascript" src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--2022-03-28 添加了随机丝带特效-->

  <script type="text/javascript" src="/js/ribbonDynamic.js"></script>

<script type="text/javascript" src="/js/hux-blog.min.js"></script>

<!-- catalog -->
<script type="text/javascript" async="true" src="/js/catalog.js?v=1.0.0"></script>

<!-- totop(rocket) -->
<script type="text/javascript" async="true" src="/js/totop.js?v=1.0.0"></script>

<!-- Busuanzi JavaScript -->

  <!-- <script type="text/javascript" async="true" src="/js/busuanzi.pure.mini.js"></script> -->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



  <!-- Scroll start -->
  <script type="text/javascript" src="/js/scroll.js"></script>
  <!-- Scroll end -->



  <!-- ThemeColor start -->
  <script type="text/javascript" src="/js/themecolor.js"></script>
  <!-- ThemeColor end -->





  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  <script type="text/javascript" src="/js/viewer/viewer.min.js"></script>
  <script type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){ hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if($('#tag_cloud').length !== 0){ async("https://rmshadows.gitee.io/js/jquery.tagcloud.js",function(){ $.fn.tagcloud.defaults = { //size: {start: 1, end: 1, unit: 'em'}, color: {start:
'#bbbbee', end: '#0085a1'}, }; $('#tag_cloud a').tagcloud(); }) } </script> -->

    
    <!---自定义的代码 所有页面-->
    
        <script type="text/javascript" src="/js/on_mouse_clicked/emotions.js"></script>
    

    <!-- Search -->
    
    <div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/ziploader.js"></script>
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;

            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


    

    <!-- Image to hack wechat -->
    <!-- <img src="https://rmshadows.gitee.io/img/icon_wechat.png" width="0" height="0" /> -->
    <!-- Migrate from head to bottom, no longer block render and still work -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
