<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  

  <!-- Baidu Tongji -->
  

  <!-- Baidu Push -->
  

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc" />
  <meta name="baidu-site-verification" content="PpzM9WxOJU" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="This is CIVICCCCC&#39;s blog..." />
  <meta name="keyword" content="rmshadows,civiccccc,blog,Blog" />
  <link rel="shortcut icon" href="/img/avatar/roguerabbit.jpg" />

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>
  <!-- Bootstrap Core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css" />

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/beantech.min.css" />

  <!-- Pygments Highlight CSS -->
  
<link rel="stylesheet" href="../../css/highlight.css">
<link rel="stylesheet" href="../../css/widget.css">
<link rel="stylesheet" href="../../css/rocket.css">
<link rel="stylesheet" href="../../css/signature.css">
<link rel="stylesheet" href="../../css/catalog.css">
<link rel="stylesheet" href="../../css/livemylife.css">


  
  <!-- wave start -->
  <link rel="stylesheet" href="/css/wave.css" />
  <!-- wave end -->
  

  
  <!-- top start (article top hot config) -->
  <link rel="stylesheet" href="/css/top.css" />
  <!-- top end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/scroll.css" />
  <!-- ThemeColor end -->
  

  
  <!-- viewer start (Picture preview) -->
  <link rel="stylesheet" href="/css/viewer.min.css" />
  <!-- viewer end -->
  

  
  <!-- Search start -->
  <link rel="stylesheet" href="/css/search.css" />
  <!-- Search end -->
  

  
  <!-- ThemeColor start -->
  <link rel="stylesheet" href="/css/themecolor.css" />
  <!-- ThemeColor end -->
  

  

  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
    href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="https://rmshadows.gitee.io/2022/C-Notes/">
  <title>
    
    C Notes - RYAN | be yourself
    
  </title>
<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="atom.xml" title="Hello ~(○｀ 3′○)~ I'm Ryan Yim" type="application/atom+xml">
</head>


<!-- hack iOS CSS :active style -->

<body ontouchstart="" class="body--home">
    <!-- ThemeColor -->
    
    <!-- ThemeColor -->
<!-- <div class="toggle" onclick="document.body.classList.toggle('body--dark')">Switch Color</div> -->

<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons bright-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>

    

    <!-- Navigation (contains search)-->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Hello ~(○｀ 3′○)~ I&#39;m Ryan Yim</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">Home</a>
          </li>

          

          
          

          
          <li>
            <a href="/about/">About</a>
          </li>
          
          

          
          <li>
            <a href="/archive/">Archives</a>
          </li>
          
          

          
          <li>
            <a href="/categories/">Categories</a>
          </li>
          
          

          
          <li>
            <a href="/tags/">Tags</a>
          </li>
          
          

          
          <li><a class="popup-trigger" title="Search"><span class="search-icon"></span>Search</a></li>
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>


<script>
  // Drop Bootstarp low-performance Navbar
  // Use customize navbar with high-quality material design animation
  // in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


    <!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
    <!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    header.intro-header {
       /*post*/
        background-image: url('https://rmshadows.gitee.io//img/header_img/lml_bg.jpg');
      
    }

    
      #signature {/*signature*/
        background-image: url('/img/signature/rmshadows.png');
      }
    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#C" title="C">C</a>
              
              <a class="tag" href="/tags/#C++" title="C++">C++</a>
              
            </div>
            <h1>C Notes</h1>
            <h2 class="subheading">我的C语言、C++语言、C#语言笔记</h2>
            <span class="meta">
              Posted by Ryan Yim on
              2022-03-27
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">9</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">2.5k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            
            <!-- 不蒜子统计 start -->
            <span class="meta" id="busuanzi_container_page_pv">
              Viewed <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span> Times
            </span>
            <!-- 不蒜子统计 end -->
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



    <!-- Main Content (Post contains
    Pager、
    tip、
    socialshare、
    gitalk、gitment、disqus-comment、
    Catalog、
    Sidebar、
    Featured-Tags、
    Friends Blog、
    anchorjs、
    ) -->
    <!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <h1 id="C-amp-C-Notes"><a href="#C-amp-C-Notes" class="headerlink" title="C &amp; C++ Notes"></a>C &amp; C++ Notes</h1><h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><ol>
<li>Windows：下载<a href="http://www.cygwin.com/" target="_blank" rel="noopener">cygwin</a>，安装时勾选gcc(包括gcc-core等一系列，都勾了)、cmake、make、binutils、MinGW、vim、nano等一些你觉得需要用到的。蓝后这里面可以导出exe，但此exe在cygwin外运行报缺少dll，缺少的dll在cygwin的bin目录下，复制过去导出程序的文件夹就行。</li>
<li>Linux：安装有gcc、cmake等就行了。</li>
</ol>
<h2 id="头文件"><a href="#头文件" class="headerlink" title="头文件"></a>头文件</h2><p>C 函数声明和宏定义。</p>
<p>引用系统头文件：<code>#include &lt;file&gt;</code>；引用用户头文件：<code>#include &quot;file&quot;</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEADER_FILE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEADER_FILE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h2 id="共享库生成与调用-Share-Lib"><a href="#共享库生成与调用-Share-Lib" class="headerlink" title="共享库生成与调用 - Share Lib"></a>共享库生成与调用 - Share Lib</h2><p>静态库：Linux：<code>.a</code>；Windows： <code>.lib</code></p>
<p>动态库：Linux：<code>.so</code>；Windows：<code>.dll</code></p>
<p>举例子：From <a href="https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html" target="_blank" rel="noopener">https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html</a></p>
<blockquote>
<p>在我们开始之前，它可能有助于快速了解从源代码到运行程序发生的所有事情： </p>
<ol>
<li>C 预处理器：此阶段处理所有 <a href="https://www.cprogramming.com/tutorial/cpreprocessor.html" target="_blank" rel="noopener">预处理器指令 </a>。 基本上，任何以# 开头的行，例如#define 和#include。 </li>
<li>编译正确：一旦源文件被预处理，结果就会被编译。 由于许多人将 <a href="https://www.cprogramming.com/compilingandlinking.html" target="_blank" rel="noopener">整个构建过程 </a>称为编译，因此此阶段通常称为编译正确。 此阶段将 .c 文件转换为 .o（对象）文件。 </li>
<li>链接：这里是所有目标文件和任何库链接在一起以制作最终程序的地方。  请注意，对于静态库，实际库放置在您的最终程序中，而对于共享库，则只放置对库的引用。  现在您有一个可以运行的完整程序。  你从 shell 启动它，程序被交给加载器。 </li>
<li>加载：这个阶段发生在你的程序启动时。  扫描您的程序以查找对共享库的引用。  找到的任何引用都会被解析，并将库映射到您的程序中。 </li>
</ol>
<p>第 3 步和第 4 步是共享库的神奇之处（和混淆）。 </p>
</blockquote>
<p>foo.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Hello, I am a shared library"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>foo.h:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> foo_h__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> foo_h__</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  <span class="comment">// foo_h__</span></span></span><br></pre></td></tr></table></figure>
<p>main.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"foo.h"</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(voigcc -c testlib.cd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"This is a shared library test..."</span>);</span><br><span class="line">    foo();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>静态库生成：</p>
<p>生成对象：<code>gcc -c foo.c</code></p>
<p>打包：<code>ar crv libfoo.a foo.o</code></p>
<p>生成内容表：<code>ranlib libfoo.a</code></p>
<p>动态库生成：</p>
<p>步骤 1：使用位置无关代码进行编译 </p>
<p>我们需要将我们的库源代码编译成位置无关代码（PIC）： <a href="https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html#fn:pic" target="_blank" rel="noopener">1 </a></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -<span class="keyword">c</span> -Wall -Werror -fpic foo.<span class="keyword">c</span></span><br></pre></td></tr></table></figure>
<p>步骤 2：从目标文件创建共享库 </p>
<p>现在我们需要实际将这个目标文件转换成一个共享库。  我们将其称为 libfoo.so： </p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">gcc</span> <span class="selector-tag">-shared</span> <span class="selector-tag">-o</span> <span class="selector-tag">libfoo</span><span class="selector-class">.so</span> <span class="selector-tag">foo</span><span class="selector-class">.o</span></span><br></pre></td></tr></table></figure>
<p>第 3 步：链接共享库 </p>
<p>如您所见，这实际上非常简单。  我们有一个共享库。  让我们编译 main.c 并将其与 libfoo 链接。   我们将调用我们的最终程序测试。  请注意，-lfoo 选项不是在寻找 foo.o，而是 libfoo.so。  GCC 假定所有库都以 lib  开头并以 .so 或 .a 结尾（.so 用于共享对象或共享库，而 .a 用于存档或静态链接库）。 </p>
<figure class="highlight avrasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ gcc -Wall -o test main.c -lfoo</span><br><span class="line">/usr/bin/<span class="keyword">ld</span>: cannot find -lfoo</span><br><span class="line"><span class="symbol">collect2:</span> <span class="keyword">ld</span> returned <span class="number">1</span> exit status</span><br></pre></td></tr></table></figure>
<p>告诉 GCC 在哪里可以找到共享库 </p>
<p>哦哦！ 链接器不知道在哪里可以找到 libfoo。 默认情况下，GCC 有一个它查找的位置列表，但我们的目录不在该列表中。 <a href="https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html#fn:gcclist" target="_blank" rel="noopener">2 </a>我们需要告诉 GCC 在哪里可以找到 libfoo.so。 我们将使用 -L 选项来做到这一点。 在这个例子中，我们将使用当前目录，/home/username/foo： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gcc -L/home/username/foo -Wall -o <span class="built_in">test</span> main.c -lfoo</span></span><br></pre></td></tr></table></figure>
<p>第 4 步：使库在运行时可用 </p>
<p>很好，没有错误。  现在让我们运行我们的程序： </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./<span class="keyword">test</span></span><br><span class="line">./<span class="keyword">test</span>: <span class="keyword">error</span> <span class="keyword">while</span> loading shared libraries: libfoo.<span class="keyword">so</span>: cannot <span class="keyword">open</span> shared object <span class="keyword">file</span>: <span class="keyword">No</span> such <span class="keyword">file</span> or directory</span><br></pre></td></tr></table></figure>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./测试</span><br><span class="line"> ./<span class="string">test:</span> 加载共享库时出错: libfoo.<span class="string">so:</span> 无法打开共享对象文件: 没有这样的文件或目录</span><br></pre></td></tr></table></figure>
<p>不好了！ 加载程序找不到共享库。 <a href="https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html#fn:loadorder" target="_blank" rel="noopener">3 </a>我们没有安装在标准位置，所以需要给loader一点帮助。 我们有几个选择：我们可以为此使用环境变量 LD_LIBRARY_PATH 或 rpath。 我们先来看看 LD_LIBRARY_PATH： </p>
<p>使用 LD_LIBRARY_PATH </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> <span class="variable">$LD_LIBRARY_PATH</span></span></span><br></pre></td></tr></table></figure>
<p>里面什么都没有。  让我们通过将我们的工作目录添加到现有的 LD_LIBRARY_PATH 来解决这个问题： </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ LD_LIBRARY_PATH=/home/username/foo:<span class="variable">$LD_LIBRARY_PATH</span></span><br><span class="line">$ ./<span class="keyword">test</span></span><br><span class="line">./<span class="keyword">test</span>: <span class="keyword">error</span> <span class="keyword">while</span> loading shared libraries: libfoo.<span class="keyword">so</span>: cannot <span class="keyword">open</span> shared object <span class="keyword">file</span>: <span class="keyword">No</span> such <span class="keyword">file</span> or directory</span><br></pre></td></tr></table></figure>
<p>发生了什么？  我们的目录在 LD_LIBRARY_PATH 中，但我们没有导出它。  在 Linux 中，如果您不将更改导出到环境变量，它们将不会被子进程继承。  加载器和我们的测试程序没有继承我们所做的更改。  幸运的是，修复很简单： </p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">$</span> export LD_LIBRARY_PATH=/home/username/foo:<span class="symbol">$</span>LD_LIBRARY_PATH</span><br><span class="line"><span class="symbol">$</span> ./test</span><br><span class="line"><span class="function"><span class="title">This</span></span> is a shared library test...</span><br><span class="line">Hello, I am a shared library</span><br></pre></td></tr></table></figure>
<p>很好，成功了！  LD_LIBRARY_PATH 非常适合快速测试和您没有管理员权限的系统。  然而，作为一个缺点，导出  LD_LIBRARY_PATH 变量意味着它可能会导致您运行的其他程序出现问题，这些程序也依赖于  LD_LIBRARY_PATH，如果您在完成后没有将其重置为以前的状态。 </p>
<p>使用 rpath </p>
<p>现在让我们尝试 rpath（首先我们将清除 LD_LIBRARY_PATH 以确保找到我们的库的是 rpath）。  Rpath  或运行路径是一种将共享库的位置嵌入到可执行文件本身中的方法，而不是依赖于默认位置或环境变量。  我们在链接阶段这样做。   注意冗长的“-Wl,-rpath=/home/username/foo”??  选项。  -Wl  部分将逗号分隔的选项发送到链接器，因此我们告诉它使用我们的工作目录将 -rpath 选项发送到链接器。 </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">unset</span> LD_LIBRARY_PATH</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> gcc -L/home/username/foo -Wl,-rpath=/home/username/foo -Wall -o <span class="built_in">test</span> main.c -lfoo</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./<span class="built_in">test</span></span></span><br><span class="line">This is a shared library test...</span><br><span class="line">Hello, I am a shared library</span><br></pre></td></tr></table></figure>
<p>太好了，它奏效了。  rpath 方法很棒，因为每个程序都可以独立地列出其共享库位置，因此不同的程序不会像 LD_LIBRARY_PATH 那样在错误的路径中查找问题。 </p>
<p>rpath 与 LD_LIBRARY_PATH </p>
<p>然而，rpath 有一些缺点。  首先，它要求将共享库安装在固定位置，以便程序的所有用户都可以访问这些位置中的那些库。   这意味着系统配置的灵活性较低。  其次，如果该库引用 NFS 挂载或其他网络驱动器，您可能会在程序启动时遇到不希望的延迟 - 或者更糟 - 。 </p>
<p>使用ldconfig修改ld.so </p>
<p>如果我们想安装我们的库以便系统上的每个人都可以使用它怎么办？  为此，您将需要管理员权限。   您需要这样做有两个原因：首先，将库放在标准位置，可能是 /usr/lib 或 /usr/local/lib，普通用户没有写入权限。   其次，您需要修改 ld.so 配置文件和缓存。  以 root 身份执行以下操作： </p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cp /home/username/foo/libfoo.so /usr/<span class="class"><span class="keyword">lib</span></span></span><br><span class="line">$ chmod <span class="number">0</span>755 /usr/<span class="class"><span class="keyword">lib</span>/<span class="title">libfoo</span>.<span class="title">so</span></span></span><br></pre></td></tr></table></figure>
<p>现在该文件位于标准位置，具有正确的权限，每个人都可以读取。  我们需要告诉加载器它可以使用，所以让我们更新缓存： </p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>ldconfig</span><br></pre></td></tr></table></figure>
<p>这应该创建一个指向我们共享库的链接并更新缓存，以便它可以立即使用。  让我们仔细检查一下： </p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ldconfig -<span class="keyword">p</span> | <span class="keyword">grep</span> foo</span><br><span class="line">libfoo.<span class="keyword">so</span> (libc6) =&gt; /usr/lib/libfoo.<span class="keyword">so</span></span><br></pre></td></tr></table></figure>
<p>现在我们的库已安装。  在我们测试之前，我们必须清理一些东西： </p>
<p>再次清除我们的 LD_LIBRARY_PATH，以防万一： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">unset</span> LD_LIBRARY_PATH</span></span><br></pre></td></tr></table></figure>
<p>重新链接我们的可执行文件。  请注意，我们不需要 -L 选项，因为我们的库存储在默认位置并且我们没有使用 rpath 选项： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gcc -Wall -o <span class="built_in">test</span> main.c -lfoo</span></span><br></pre></td></tr></table></figure>
<p>让我们确保使用 ldd 使用库的 /usr/lib 实例： </p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ldd <span class="keyword">test</span> | grep foo</span><br><span class="line">libfoo.<span class="keyword">so</span> =&gt; /usr/lib/libfoo.<span class="keyword">so</span> (0x00a42000)</span><br></pre></td></tr></table></figure>
<p>好，现在让我们运行它： </p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ ./test</span><br><span class="line">This <span class="keyword">is</span> a <span class="keyword">shared</span> <span class="keyword">library</span> test...</span><br><span class="line">Hello, I am a <span class="keyword">shared</span> <span class="keyword">library</span></span><br></pre></td></tr></table></figure>
<p>就这样结束了。  我们已经介绍了如何构建共享库、如何与其链接，以及如何解决共享库中最常见的加载器问题——以及不同方法的优缺点。 </p>
<ol>
<li>它在可执行文件的 DT_RPATH 部分中查找，除非有 DT_RUNPATH 部分。 </li>
<li>它在 LD_LIBRARY_PATH 中查找。  如果出于安全原因，可执行文件是 setuid/setgid，则跳过此步骤。 </li>
<li>除非设置了 setuid/setgid 位（出于安全原因），否则它会在可执行文件的 DT_RUNPATH 部分中查找。 </li>
<li>它在缓存文件 /etc/ld/so/cache 中查找（使用 -z nodeflib 链接器选项禁用）。 </li>
<li><p>它在默认目录 /lib 和 /usr/lib 中查找（使用 -z nodeflib 链接器选项禁用）。 </p>
</li>
<li><p>什么是位置无关代码？ PIC 是无论放在内存中的哪个位置都可以运行的代码。 因为几个不同的程序都可以使用共享库的一个实例，所以库不能在固定地址存储东西，因为该库在内存中的位置因程序而异。 <a href="https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html#fnref:pic" target="_blank" rel="noopener">↩ </a></p>
</li>
<li>GCC 首先在 /usr/local/lib 中搜索库，然后在 /usr/lib 中搜索。 然后，它按照命令行上指定的顺序在 -L 参数指定的目录中搜索库。 <a href="https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html#fnref:gcclist" target="_blank" rel="noopener">↩ </a></li>
<li>默认的 GNU 加载器 ld.so 按以下顺序查找库： <a href="https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html#fnref:loadorder" target="_blank" rel="noopener">↩ </a></li>
</ol>
<p>Cmake 文件，动态库：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">2.8</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_VERBOSE_MAKEFILE <span class="keyword">on</span>)</span><br><span class="line"><span class="keyword">project</span>(jvad)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_BUILD_TYPE DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">"$&#123;CMAKE_CXX_FLAGS&#125; -std=c++11"</span>)</span><br><span class="line"><span class="comment">#set(CMAKE_C_STANDARD 99)</span></span><br><span class="line"><span class="keyword">file</span>(GLOB SRC_FILES src/*.c src/*.h thirdparty/webrtc/common_audio/*/*.c thirdparty/webrtc/rtc_base/*.c*)</span><br><span class="line"><span class="keyword">include_directories</span>(thirdparty/webrtc) <span class="comment">#thirdparty/include/webrtc</span></span><br><span class="line"><span class="comment"># 这一句生成可执行文件</span></span><br><span class="line"><span class="keyword">add_executable</span>(jvad <span class="variable">$&#123;SRC_FILES&#125;</span>)</span><br><span class="line"><span class="comment"># 这里生成so共享库</span></span><br><span class="line"><span class="keyword">add_library</span>(jvad.<span class="number">3</span> SHARED <span class="variable">$&#123;SRC_FILES&#125;</span>)</span><br><span class="line"><span class="comment"># gcc VadDebug.c -I . -L. -ljvad.2 -lpthread -o main</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(jvad pthread)</span><br></pre></td></tr></table></figure>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/2022/Linux-Applications/" data-toggle="tooltip" data-placement="top" title="Linux Applications">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/2022/Java-Notes/" data-toggle="tooltip" data-placement="top" title="Java Notes">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <div class="tip">
          <p>
            If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
          </p>
        </div>
        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=C Notes&body=Hi,I found this website and thought you might like it https://rmshadows.gitee.io/2022/C-Notes/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!--修改--artalk-->
<!-- 0.artalk安装代码 -->

<!-- CSS -->
<link href="https://civiccccc.ltd/artalk/dist/Artalk.css" rel="stylesheet" />
<link href="https://civiccccc.ltd/artalk/dist/Artalk.css" rel="stylesheet" />
<!-- JS -->
<script src="https://civiccccc.ltd/artalk/dist/Artalk.js"></script>
<!-- Artalk -->
<div id="Comments"></div>
<script>
  Artalk.init({
    el: '#Comments', // 绑定元素的 Selector
    pageKey: 'https://rmshadows.gitee.io/2022/C-Notes/', // 固定链接
    pageTitle: '关于引入 Artalk 的这档子事', // 页面标题 (留空自动获取)
    server: 'https://civiccccc.ltd/artalk', // 后端地址
    site: 'CIVICCCCC的博客', // 你的站点名
  })
</script>
<!-- artalk安装代码已完成 -->



<!-- 1. gitalk comment -->



<!-- 2. gitment comment -->



<!-- 3. disqus comment -->


<!--修改--Livere-->


<!--修改--ISSO-->

        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <!--div id="toc" class="toc-article" -->
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          
            <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#C-amp-C-Notes"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">C &amp; C++ Notes</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#环境配置"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">环境配置</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#头文件"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">头文件</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#共享库生成与调用-Share-Lib"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">共享库生成与调用 - Share Lib</span></a></li></ol></li></ol>
          
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#C" title="C">C</a>
            
            <a class="tag" href="/tags/#C++" title="C++">C++</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://civiccccc.ltd" target="_blank">主站</a>
          </li>
          
          <li>
            <a href="https://github.com/xjx0106" target="_blank">国庆电播小弟</a>
          </li>
          
          <li>
            <a href="https://github.com/itcast-ying" target="_blank">itcast-ying</a>
          </li>
          
          <li>
            <a href="https://github.com/cjj19970505" target="_blank">Xeon-J</a>
          </li>
          
          <li>
            <a href="https://github.com/XeonKHJ" target="_blank">Xeon-H</a>
          </li>
          
          <li>
            <a href="https://gitee.com/rmshadows" target="_blank">Gitee - Ryan Yim</a>
          </li>
          
          <li>
            <a href="https://rmshadows.gitee.io/404" target="_blank">404 No Found Page</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



    <!-- Footer (contains ThemeColor、viewer) -->
    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          
            <li>
              <a href="/feed.xml">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          
            <li>
              <a target="_blank" href="https://github.com/rmshadows">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          
            <li>
              <a target="_blank" href="https://www.instagram.com/just_aaaa_r">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          
            <li>
              <a target="_blank" href="https://www.zhihu.com/people/rmshadows">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse">知</i>
                </span>
              </a>
            </li>
          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Ryan Yim
          2025
          <br>
          Theme by
          <a href="http://beantech.org" target="_blank" rel="noopener">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a href="https://v-vincen.life/" target="_blank" rel="noopener">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>

<!-- jQuery -->
<script type="text/javascript" src="/js/jquery.min.js"></script>
<!-- <script type="text/javascript" src="/js/jquery.js"></script> -->
<!-- <script type="text/javascript" src="//cdnjs.loli.net/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->

<!-- Bootstrap Core JavaScript -->
<script type="text/javascript" src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<!--2022-03-28 添加了随机丝带特效-->

  <script type="text/javascript" src="/js/ribbonDynamic.js"></script>

<script type="text/javascript" src="/js/hux-blog.min.js"></script>

<!-- catalog -->
<script type="text/javascript" async="true" src="/js/catalog.js?v=1.0.0"></script>

<!-- totop(rocket) -->
<script type="text/javascript" async="true" src="/js/totop.js?v=1.0.0"></script>

<!-- Busuanzi JavaScript -->

  <!-- <script type="text/javascript" async="true" src="/js/busuanzi.pure.mini.js"></script> -->
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



  <!-- Scroll start -->
  <script type="text/javascript" src="/js/scroll.js"></script>
  <!-- Scroll end -->



  <!-- ThemeColor start -->
  <script type="text/javascript" src="/js/themecolor.js"></script>
  <!-- ThemeColor end -->





  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  <script type="text/javascript" src="/js/viewer/viewer.min.js"></script>
  <script type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){ hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if($('#tag_cloud').length !== 0){ async("https://rmshadows.gitee.io/js/jquery.tagcloud.js",function(){ $.fn.tagcloud.defaults = { //size: {start: 1, end: 1, unit: 'em'}, color: {start:
'#bbbbee', end: '#0085a1'}, }; $('#tag_cloud a').tagcloud(); }) } </script> -->

    
    <!---自定义的代码 所有页面-->
    
        <script type="text/javascript" src="/js/on_mouse_clicked/emotions.js"></script>
    

    <!-- Search -->
    
    <div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="Search..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  <script src="/js/ziploader.js"></script>
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;

            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


    

    <!-- Image to hack wechat -->
    <!-- <img src="https://rmshadows.gitee.io/img/icon_wechat.png" width="0" height="0" /> -->
    <!-- Migrate from head to bottom, no longer block render and still work -->

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>

</html>
